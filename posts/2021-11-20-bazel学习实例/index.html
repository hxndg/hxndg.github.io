<!doctype html><html lang=cn dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>bazel学习实例 &#183; 菜狗的blog</title>
<meta name=title content="bazel学习实例 &#183; 菜狗的blog"><meta name=description content="菜狗's website"><meta name=keywords content="bazel,debug,"><link rel=canonical href=https://hxndg.github.io/posts/2021-11-20-bazel%E5%AD%A6%E4%B9%A0%E5%AE%9E%E4%BE%8B/><link type=text/css rel=stylesheet href=/css/main.bundle.min.ba3775bebd52a2b4837f8da64e32ee36e5c52bf284a0ce2262562782398b701543947527ad1498487717b1b96fe2a4e48d365a02e0b5d00e224893052e99d83c.css integrity><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.764eb2fe8d6a6b086c7c58f87d12c64fa79a7585117fc27eb53f688f80c287a6eff16277f9d186cd223a39ff700e294d64482834faece5e07ee0498fa042d056.js integrity="sha512-dk6y/o1qawhsfFj4fRLGT6eadYURf8J+tT9oj4DCh6bv8WJ3+dGGzSI6Of9wDilNZEgoNPrs5eB+4EmPoELQVg==" data-copy data-copied></script><script src=/lib/zoom/zoom.min.3530c2657381259433194af312ec3d322a97a2ad85661810299757fe793b24c3b8e07ab97fa8e5cf96cff1208f271e75394b6eaa56c2e39e7e2c3ca49fb1921c.js integrity="sha512-NTDCZXOBJZQzGUrzEuw9MiqXoq2FZhgQKZdX/nk7JMO44Hq5f6jlz5bP8SCPJx51OUtuqlbC455+LDykn7GSHA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://hxndg.github.io/posts/2021-11-20-bazel%E5%AD%A6%E4%B9%A0%E5%AE%9E%E4%BE%8B/"><meta property="og:site_name" content="菜狗的blog"><meta property="og:title" content="bazel学习实例"><meta property="og:description" content="菜狗's website"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-20T00:00:00+00:00"><meta property="article:modified_time" content="2021-11-20T00:00:00+00:00"><meta property="article:tag" content="Bazel"><meta property="article:tag" content="Debug"><meta name=twitter:card content="summary"><meta name=twitter:title content="bazel学习实例"><meta name=twitter:description content="菜狗's website"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"bazel学习实例","headline":"bazel学习实例","inLanguage":"zh-cn","url":"https:\/\/hxndg.github.io\/posts\/2021-11-20-bazel%E5%AD%A6%E4%B9%A0%E5%AE%9E%E4%BE%8B\/","author":{"@type":"Person","name":"菜狗"},"copyrightYear":"2021","dateCreated":"2021-11-20T00:00:00\u002b00:00","datePublished":"2021-11-20T00:00:00\u002b00:00","dateModified":"2021-11-20T00:00:00\u002b00:00","keywords":["bazel","debug"],"mainEntityOfPage":"true","wordCount":"53999"}]</script><meta name=author content="菜狗"><script src=/lib/jquery/jquery.slim.min.03cb160e3cfdb2667a2e2c80d283bebcf63ff8bbc4b629c9ab2babf6fae1d0c07ad470edae783efa4fabda2ac01c58d60e63b98b3c336be8208460f08f4354f5.js integrity="sha512-A8sWDjz9smZ6LiyA0oO+vPY/+LvEtinJqyur9vrh0MB61HDtrng++k+r2irAHFjWDmO5izwza+gghGDwj0NU9Q=="></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>跳过正文</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">菜狗的blog</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Home</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Posts</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Tags</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Home</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Posts</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Tags</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">bazel学习实例</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2021-11-20T00:00:00+00:00>2021 年 11 月 20 日</time><span class="px-2 text-primary-500">&#183;</span><span>53999 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>108 分钟</span></div></div><div class="flex author"><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">菜狗</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Focus</div><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-hiredis的编译>1 hiredis的编译</a><ul><li><ul><li><a href=#11-hiredis-的bazel转换>1.1 hiredis 的bazel转换</a></li><li><a href=#11-转换时学习bazel的行为>1.1 转换时学习bazel的行为</a></li></ul></li></ul></li><li><a href=#2-openssl--libuv的编译>2 openssl & libuv的编译。</a><ul><li><a href=#21-openssl的编译--libuv>2.1 openssl的编译 & libuv</a></li><li><a href=#22-rules_foreign_cc的相关问题>2.2 rules_foreign_cc的相关问题</a></li><li><a href=#23-bazel的学习>2.3 bazel的学习</a></li></ul></li><li><a href=#redis的编译>redis++的编译</a><ul><li><a href=#32-bazel的学习>3.2 bazel的学习</a></li><li><a href=#33-bazel的有趣问题>3.3 bazel的有趣问题</a><ul><li><a href=#331-bazel-sandbox>3.3.1 bazel sandbox</a></li><li><a href=#332-记录bazel的输出>3.3.2 记录bazel的输出</a></li><li><a href=#333-bazel-test-group>3.3.3 bazel test group</a></li></ul></li><li><a href=#34-bazel-codebase>3.4 bazel codebase</a><ul><li><a href=#341-clietserver架构>3.4.1 cliet/server架构</a></li><li><a href=#342-目录布局>3.4.2 目录布局</a></li><li><a href=#344-执行命令流程>3.4.4 执行命令流程</a></li><li><a href=#345-命令行选项>3.4.5 命令行选项</a></li><li><a href=#346-存储库>3.4.6 存储库</a></li><li><a href=#347-packages>3.4.7 packages</a></li></ul></li><li><a href=#标签目标和规则>标签、目标和规则</a></li></ul></li><li><a href=#星雀>星雀</a></li><li><a href=#加载分析阶段>加载/分析阶段</a><ul><li><a href=#配置>配置</a></li><li><a href=#传递信息提供者>传递信息提供者</a></li><li><a href=#配置的目标>配置的目标</a></li><li><a href=#运行文件>运行文件</a></li><li><a href=#aspect>aspect</a></li></ul></li><li><a href=#heading></a><ul><li><a href=#平台和工具链>平台和工具链</a></li><li><a href=#约束>约束</a><ul><li><a href=#environment_group-和-environment>environment_group() 和 environment()</a></li><li><a href=#平台限制>平台限制</a></li></ul></li><li><a href=#能见度>能见度</a></li><li><a href=#嵌套集>嵌套集</a></li><li><a href=#工件和动作>工件和动作</a></li><li><a href=#共享操作>共享操作</a></li></ul></li><li><a href=#执行阶段>执行阶段</a><ul><li><a href=#本地动作缓存>本地动作缓存</a></li><li><a href=#输入发现和输入修剪>输入发现和输入修剪</a></li><li><a href=#运行操作的各种方式策略actioncontexts>运行操作的各种方式：策略/ActionContexts</a></li><li><a href=#本地资源管理器>本地资源管理器</a></li><li><a href=#输出目录结构>输出目录结构</a></li></ul></li><li><a href=#测试>测试</a><ul><li><a href=#确定要运行的测试>确定要运行的测试</a></li><li><a href=#运行测试>运行测试</a></li><li><a href=#覆盖收集>覆盖收集</a></li></ul></li><li><a href=#查询引擎>查询引擎</a><ul><li><a href=#查找依赖>查找依赖</a></li><li><a href=#查找两个target怎么建立的依赖>查找两个target怎么建立的依赖</a></li><li><a href=#aside-implicit-dependencies>Aside: implicit dependencies</a></li><li><a href=#查找反向的依赖>查找反向的依赖</a><ul><li><a href=#what-packages-exist-beneath-foo>What packages exist beneath <code>foo</code>?</a></li><li><a href=#what-rules-are-defined-in-the-foo-package>What rules are defined in the <code>foo</code> package?</a></li><li><a href=#what-files-are-generated-by-rules-in-the-foo-package>What files are generated by rules in the <code>foo</code> package?</a></li><li><a href=#what-targets-are-generated-by-starlark-macro-foo>What targets are generated by starlark macro <code>foo</code>?</a></li><li><a href=#whats-the-set-of-build-files-needed-to-build-foo>What&rsquo;s the set of BUILD files needed to build <code>//foo</code>?</a></li><li><a href=#what-are-the-individual-tests-that-a-test_suite-expands-to>What are the individual tests that a <code>test_suite</code> expands to?</a></li><li><a href=#which-of-those-are-c-tests>Which of those are C++ tests?</a></li><li><a href=#which-of-those-are-small-medium-large>Which of those are small? Medium? Large?</a></li><li><a href=#what-are-the-tests-beneath-foo-that-match-a-pattern>What are the tests beneath <code>foo</code> that match a pattern?</a></li><li><a href=#what-package-contains-file-pathtofilebarjava>What package contains file <code>path/to/file/bar.java</code>?</a></li><li><a href=#what-is-the-build-label-for-pathtofilebarjava>What is the build label for <code>path/to/file/bar.java?</code></a></li><li><a href=#what-rule-targets-contain-file-pathtofilebarjava-as-a-source>What rule target(s) contain file <code>path/to/file/bar.java</code> as a source?</a></li></ul></li><li><a href=#what-package-dependencies-exist->What package dependencies exist &mldr;</a><ul><li><a href=#what-packages-does-foo-depend-on-what-do-i-need-to-check-out-to-build-foo>What packages does <code>foo</code> depend on? (What do I need to check out to build <code>foo</code>)</a></li><li><a href=#what-packages-does-the-foo-tree-depend-on-excluding-foocontrib>What packages does the <code>foo</code> tree depend on, excluding <code>foo/contrib</code>?</a></li></ul></li><li><a href=#what-rule-dependencies-exist->What rule dependencies exist &mldr;</a><ul><li><a href=#what-genproto-rules-does-bar-depend-upon>What genproto rules does bar depend upon?</a></li><li><a href=#find-the-definition-of-some-jni-c-library-that-is-transitively-depended-upon-by-a-java-binary-rule-in-the-servlet-tree>Find the definition of some JNI (C++) library that is transitively depended upon by a Java binary rule in the servlet tree.</a></li></ul></li><li><a href=#what-file-dependencies-exist->What file dependencies exist &mldr;</a><ul><li><a href=#whats-the-complete-set-of-java-source-files-required-to-build-foo>What&rsquo;s the complete set of Java source files required to build foo?</a></li><li><a href=#what-is-the-complete-set-of-java-source-files-required-to-build-quxs-tests>What is the complete set of Java source files required to build QUX&rsquo;s tests?</a></li></ul></li><li><a href=#what-differences-in-dependencies-between-x-and-y-exist->What differences in dependencies between X and Y exist &mldr;</a><ul><li><a href=#what-targets-does-foo-depend-on-that-foofoolib-does-not>What targets does <code>//foo</code> depend on that <code>//foo:foolib</code> does not?</a></li><li><a href=#what-c-libraries-do-the-foo-tests-depend-on-that-the-foo-production-binary-does-not-depend-on>What C++ libraries do the <code>foo</code> tests depend on that the <code>//foo</code> production binary does <em>not</em> depend on?</a></li></ul></li><li><a href=#why-does-this-dependency-exist->Why does this dependency exist &mldr;</a><ul><li><a href=#why-does-bar-depend-on-groups2>Why does <code>bar</code> depend on <code>groups2</code>?</a></li><li><a href=#show-me-a-path-from-dockerupdaterupdater_systest-a-py_test-to-some-cc_library-that-it-depends-upon>Show me a path from <code>docker/updater:updater_systest</code> (a <code>py_test</code>) to some <code>cc_library</code> that it depends upon:</a></li><li><a href=#why-does-library-photosfrontendlib-depend-on-two-variants-of-the-same-library-third_partyjpeglib-and-third_partyjpeg>Why does library <code>//photos/frontend:lib</code> depend on two variants of the same library <code>//third_party/jpeglib</code> and <code>//third_party/jpeg</code>?</a></li></ul></li><li><a href=#what-depends-on->What depends on &mldr;</a><ul><li><a href=#what-rules-under-bar-depend-on-y>What rules under bar depend on Y?</a></li><li><a href=#what-targets-directly-depend-on-t-in-ts-package>What targets directly depend on T, in T&rsquo;s package?</a></li></ul></li><li><a href=#how-do-i-break-a-dependency->How do I break a dependency &mldr;</a><ul><li><a href=#what-dependency-paths-do-i-have-to-break-to-make-bar-no-longer-depend-on-x>What dependency paths do I have to break to make <code>bar</code> no longer depend on X?</a></li></ul></li><li><a href=#misc->Misc &mldr;</a><ul><li><a href=#how-many-sequential-steps-are-there-in-the-foo-tests-build>How many sequential steps are there in the <code>//foo-tests</code> build?</a></li></ul></li><li><a href=#性能评估>性能评估</a></li></ul></li><li><a href=#模块系统>模块系统</a></li><li><a href=#活动巴士>活动巴士</a></li><li><a href=#外部存储库>外部存储库</a><ul><li><a href=#工作空间文件>工作空间文件</a></li><li><a href=#获取存储库>获取存储库</a></li><li><a href=#托管目录>托管目录</a></li><li><a href=#存储库映射>存储库映射</a></li></ul></li></ul><ul><li><a href=#shardinstance-server相关代码阅读>ShardInstance Server相关代码阅读</a></li><li><a href=#backplane相关>BackPlane相关</a></li><li><a href=#shardinstance-worker相关代码阅读>ShardInstance Worker相关代码阅读</a></li><li><a href=#buildfarm的奇怪问题>BUILDFARM的奇怪问题</a><ul><li><a href=#1-buildfarm上传模型失败>1 BUILDFARM上传模型失败</a></li><li><a href=#2-buildfarm-worker-stuck>2 BUILDFARM WORKER STUCK</a></li><li><a href=#3-build-任务很慢>3 BUILD 任务很慢</a></li><li><a href=#4-buildfarm-use-two-service-at-same-time>4 BUILDFARM USE TWO SERVICE AT SAME TIME</a></li><li><a href=#5-bazel的内存占用>5 BAZEL的内存占用</a></li><li><a href=#6-buildfarm的代理优化>6 BUILDFARM的代理优化</a></li><li><a href=#7-sandbox的选择>7 SANDBOX的选择</a></li><li><a href=#8-buildfarm-stuck-20>8 BUILDFARM STUCK 2.0</a></li><li><a href=#9-buildfarm-entry-size>9 BUILDFARM ENTRY SIZE</a></li><li><a href=#10-bazel-analysis-阶段大量时间消耗>10 BAZEL ANALYSIS 阶段大量时间消耗</a></li><li><a href=#11-buildfarm的shm>11 buildfarm的shm</a></li><li><a href=#12-buildfarm的cache瓶颈>12 buildfarm的cache瓶颈</a></li><li><a href=#devsecops-bazel>Devsecops bazel</a><ul><li><a href=#dta-parts>DTA PARTS</a></li></ul></li></ul></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-hiredis的编译>1 hiredis的编译</a><ul><li><ul><li><a href=#11-hiredis-的bazel转换>1.1 hiredis 的bazel转换</a></li><li><a href=#11-转换时学习bazel的行为>1.1 转换时学习bazel的行为</a></li></ul></li></ul></li><li><a href=#2-openssl--libuv的编译>2 openssl & libuv的编译。</a><ul><li><a href=#21-openssl的编译--libuv>2.1 openssl的编译 & libuv</a></li><li><a href=#22-rules_foreign_cc的相关问题>2.2 rules_foreign_cc的相关问题</a></li><li><a href=#23-bazel的学习>2.3 bazel的学习</a></li></ul></li><li><a href=#redis的编译>redis++的编译</a><ul><li><a href=#32-bazel的学习>3.2 bazel的学习</a></li><li><a href=#33-bazel的有趣问题>3.3 bazel的有趣问题</a><ul><li><a href=#331-bazel-sandbox>3.3.1 bazel sandbox</a></li><li><a href=#332-记录bazel的输出>3.3.2 记录bazel的输出</a></li><li><a href=#333-bazel-test-group>3.3.3 bazel test group</a></li></ul></li><li><a href=#34-bazel-codebase>3.4 bazel codebase</a><ul><li><a href=#341-clietserver架构>3.4.1 cliet/server架构</a></li><li><a href=#342-目录布局>3.4.2 目录布局</a></li><li><a href=#344-执行命令流程>3.4.4 执行命令流程</a></li><li><a href=#345-命令行选项>3.4.5 命令行选项</a></li><li><a href=#346-存储库>3.4.6 存储库</a></li><li><a href=#347-packages>3.4.7 packages</a></li></ul></li><li><a href=#标签目标和规则>标签、目标和规则</a></li></ul></li><li><a href=#星雀>星雀</a></li><li><a href=#加载分析阶段>加载/分析阶段</a><ul><li><a href=#配置>配置</a></li><li><a href=#传递信息提供者>传递信息提供者</a></li><li><a href=#配置的目标>配置的目标</a></li><li><a href=#运行文件>运行文件</a></li><li><a href=#aspect>aspect</a></li></ul></li><li><a href=#heading></a><ul><li><a href=#平台和工具链>平台和工具链</a></li><li><a href=#约束>约束</a><ul><li><a href=#environment_group-和-environment>environment_group() 和 environment()</a></li><li><a href=#平台限制>平台限制</a></li></ul></li><li><a href=#能见度>能见度</a></li><li><a href=#嵌套集>嵌套集</a></li><li><a href=#工件和动作>工件和动作</a></li><li><a href=#共享操作>共享操作</a></li></ul></li><li><a href=#执行阶段>执行阶段</a><ul><li><a href=#本地动作缓存>本地动作缓存</a></li><li><a href=#输入发现和输入修剪>输入发现和输入修剪</a></li><li><a href=#运行操作的各种方式策略actioncontexts>运行操作的各种方式：策略/ActionContexts</a></li><li><a href=#本地资源管理器>本地资源管理器</a></li><li><a href=#输出目录结构>输出目录结构</a></li></ul></li><li><a href=#测试>测试</a><ul><li><a href=#确定要运行的测试>确定要运行的测试</a></li><li><a href=#运行测试>运行测试</a></li><li><a href=#覆盖收集>覆盖收集</a></li></ul></li><li><a href=#查询引擎>查询引擎</a><ul><li><a href=#查找依赖>查找依赖</a></li><li><a href=#查找两个target怎么建立的依赖>查找两个target怎么建立的依赖</a></li><li><a href=#aside-implicit-dependencies>Aside: implicit dependencies</a></li><li><a href=#查找反向的依赖>查找反向的依赖</a><ul><li><a href=#what-packages-exist-beneath-foo>What packages exist beneath <code>foo</code>?</a></li><li><a href=#what-rules-are-defined-in-the-foo-package>What rules are defined in the <code>foo</code> package?</a></li><li><a href=#what-files-are-generated-by-rules-in-the-foo-package>What files are generated by rules in the <code>foo</code> package?</a></li><li><a href=#what-targets-are-generated-by-starlark-macro-foo>What targets are generated by starlark macro <code>foo</code>?</a></li><li><a href=#whats-the-set-of-build-files-needed-to-build-foo>What&rsquo;s the set of BUILD files needed to build <code>//foo</code>?</a></li><li><a href=#what-are-the-individual-tests-that-a-test_suite-expands-to>What are the individual tests that a <code>test_suite</code> expands to?</a></li><li><a href=#which-of-those-are-c-tests>Which of those are C++ tests?</a></li><li><a href=#which-of-those-are-small-medium-large>Which of those are small? Medium? Large?</a></li><li><a href=#what-are-the-tests-beneath-foo-that-match-a-pattern>What are the tests beneath <code>foo</code> that match a pattern?</a></li><li><a href=#what-package-contains-file-pathtofilebarjava>What package contains file <code>path/to/file/bar.java</code>?</a></li><li><a href=#what-is-the-build-label-for-pathtofilebarjava>What is the build label for <code>path/to/file/bar.java?</code></a></li><li><a href=#what-rule-targets-contain-file-pathtofilebarjava-as-a-source>What rule target(s) contain file <code>path/to/file/bar.java</code> as a source?</a></li></ul></li><li><a href=#what-package-dependencies-exist->What package dependencies exist &mldr;</a><ul><li><a href=#what-packages-does-foo-depend-on-what-do-i-need-to-check-out-to-build-foo>What packages does <code>foo</code> depend on? (What do I need to check out to build <code>foo</code>)</a></li><li><a href=#what-packages-does-the-foo-tree-depend-on-excluding-foocontrib>What packages does the <code>foo</code> tree depend on, excluding <code>foo/contrib</code>?</a></li></ul></li><li><a href=#what-rule-dependencies-exist->What rule dependencies exist &mldr;</a><ul><li><a href=#what-genproto-rules-does-bar-depend-upon>What genproto rules does bar depend upon?</a></li><li><a href=#find-the-definition-of-some-jni-c-library-that-is-transitively-depended-upon-by-a-java-binary-rule-in-the-servlet-tree>Find the definition of some JNI (C++) library that is transitively depended upon by a Java binary rule in the servlet tree.</a></li></ul></li><li><a href=#what-file-dependencies-exist->What file dependencies exist &mldr;</a><ul><li><a href=#whats-the-complete-set-of-java-source-files-required-to-build-foo>What&rsquo;s the complete set of Java source files required to build foo?</a></li><li><a href=#what-is-the-complete-set-of-java-source-files-required-to-build-quxs-tests>What is the complete set of Java source files required to build QUX&rsquo;s tests?</a></li></ul></li><li><a href=#what-differences-in-dependencies-between-x-and-y-exist->What differences in dependencies between X and Y exist &mldr;</a><ul><li><a href=#what-targets-does-foo-depend-on-that-foofoolib-does-not>What targets does <code>//foo</code> depend on that <code>//foo:foolib</code> does not?</a></li><li><a href=#what-c-libraries-do-the-foo-tests-depend-on-that-the-foo-production-binary-does-not-depend-on>What C++ libraries do the <code>foo</code> tests depend on that the <code>//foo</code> production binary does <em>not</em> depend on?</a></li></ul></li><li><a href=#why-does-this-dependency-exist->Why does this dependency exist &mldr;</a><ul><li><a href=#why-does-bar-depend-on-groups2>Why does <code>bar</code> depend on <code>groups2</code>?</a></li><li><a href=#show-me-a-path-from-dockerupdaterupdater_systest-a-py_test-to-some-cc_library-that-it-depends-upon>Show me a path from <code>docker/updater:updater_systest</code> (a <code>py_test</code>) to some <code>cc_library</code> that it depends upon:</a></li><li><a href=#why-does-library-photosfrontendlib-depend-on-two-variants-of-the-same-library-third_partyjpeglib-and-third_partyjpeg>Why does library <code>//photos/frontend:lib</code> depend on two variants of the same library <code>//third_party/jpeglib</code> and <code>//third_party/jpeg</code>?</a></li></ul></li><li><a href=#what-depends-on->What depends on &mldr;</a><ul><li><a href=#what-rules-under-bar-depend-on-y>What rules under bar depend on Y?</a></li><li><a href=#what-targets-directly-depend-on-t-in-ts-package>What targets directly depend on T, in T&rsquo;s package?</a></li></ul></li><li><a href=#how-do-i-break-a-dependency->How do I break a dependency &mldr;</a><ul><li><a href=#what-dependency-paths-do-i-have-to-break-to-make-bar-no-longer-depend-on-x>What dependency paths do I have to break to make <code>bar</code> no longer depend on X?</a></li></ul></li><li><a href=#misc->Misc &mldr;</a><ul><li><a href=#how-many-sequential-steps-are-there-in-the-foo-tests-build>How many sequential steps are there in the <code>//foo-tests</code> build?</a></li></ul></li><li><a href=#性能评估>性能评估</a></li></ul></li><li><a href=#模块系统>模块系统</a></li><li><a href=#活动巴士>活动巴士</a></li><li><a href=#外部存储库>外部存储库</a><ul><li><a href=#工作空间文件>工作空间文件</a></li><li><a href=#获取存储库>获取存储库</a></li><li><a href=#托管目录>托管目录</a></li><li><a href=#存储库映射>存储库映射</a></li></ul></li></ul><ul><li><a href=#shardinstance-server相关代码阅读>ShardInstance Server相关代码阅读</a></li><li><a href=#backplane相关>BackPlane相关</a></li><li><a href=#shardinstance-worker相关代码阅读>ShardInstance Worker相关代码阅读</a></li><li><a href=#buildfarm的奇怪问题>BUILDFARM的奇怪问题</a><ul><li><a href=#1-buildfarm上传模型失败>1 BUILDFARM上传模型失败</a></li><li><a href=#2-buildfarm-worker-stuck>2 BUILDFARM WORKER STUCK</a></li><li><a href=#3-build-任务很慢>3 BUILD 任务很慢</a></li><li><a href=#4-buildfarm-use-two-service-at-same-time>4 BUILDFARM USE TWO SERVICE AT SAME TIME</a></li><li><a href=#5-bazel的内存占用>5 BAZEL的内存占用</a></li><li><a href=#6-buildfarm的代理优化>6 BUILDFARM的代理优化</a></li><li><a href=#7-sandbox的选择>7 SANDBOX的选择</a></li><li><a href=#8-buildfarm-stuck-20>8 BUILDFARM STUCK 2.0</a></li><li><a href=#9-buildfarm-entry-size>9 BUILDFARM ENTRY SIZE</a></li><li><a href=#10-bazel-analysis-阶段大量时间消耗>10 BAZEL ANALYSIS 阶段大量时间消耗</a></li><li><a href=#11-buildfarm的shm>11 buildfarm的shm</a></li><li><a href=#12-buildfarm的cache瓶颈>12 buildfarm的cache瓶颈</a></li><li><a href=#devsecops-bazel>Devsecops bazel</a><ul><li><a href=#dta-parts>DTA PARTS</a></li></ul></li></ul></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>光看注释和代码不清楚怎么用，不如直接上手写。</p><p>今天的目标就是将redis-plus-plus库（c++库）从cmake编译转换为bazel编译，redis-plus-plus依赖hiredis库，hiredis库使用源码引入，redis-plus-plus依赖的uv库我们使用外部引入。</p><p>包含几个部分：</p><ul><li><p>如何使用bazel编译sync & async 的hiredis，并且查看生成的头文件。生成两个目标hiredis & hiredis_ssl</p></li><li><p>如何使用rules_foreign_cc编译第三方外部依赖（非bazel项目）openssl & libuv，两者分别使用configure_make & cmake</p></li><li><p>如何使用bazel编译生成redis++库，包括sync，async，tls版本</p></li></ul><p>附录部分贴了starlark的东西：</p><h2 class="relative group">1 hiredis的编译<div id=1-hiredis%E7%9A%84%E7%BC%96%E8%AF%91 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-hiredis%E7%9A%84%E7%BC%96%E8%AF%91 aria-label=锚点>#</a></span></h2><h4 class="relative group">1.1 hiredis 的bazel转换<div id=11-hiredis-%E7%9A%84bazel%E8%BD%AC%E6%8D%A2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#11-hiredis-%E7%9A%84bazel%E8%BD%AC%E6%8D%A2 aria-label=锚点>#</a></span></h4><p>我们首先看下目前的cmakelists.txt文件，从而确定我们要生成的BUILD.bazel包含哪些东西。下面的代码我把一些没用的属性，比方说win32才需要的什么的或者一些无关的属性删除掉了。具体的分析的东西实际上在cmakelists.tx文件里面是非常清楚的，看注释即可，就不多解释了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=c># Hiredis requires C99
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>SET</span><span class=p>(</span><span class=s>CMAKE_C_STANDARD</span> <span class=s>99</span><span class=p>)</span>    <span class=c>#C99标准，添加到copt里面即可
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>SET</span><span class=p>(</span><span class=s>CMAKE_POSITION_INDEPENDENT_CODE</span> <span class=s>ON</span><span class=p>)</span>    <span class=c>#fpic标记，编译静态库时需要加上，这样子才能生成的静态库被第三方引用
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>SET</span><span class=p>(</span><span class=s>CMAKE_DEBUG_POSTFIX</span> <span class=s>d</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>hiredis_sources</span>   <span class=c>#下面的.c文件对应于bazel src文件，我们可以看到目前的代码实际上是包含sync和async的，
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=s>alloc.c</span>
</span></span><span class=line><span class=cl>    <span class=s>async.c</span>
</span></span><span class=line><span class=cl>    <span class=s>dict.c</span>
</span></span><span class=line><span class=cl>    <span class=s>hiredis.c</span>
</span></span><span class=line><span class=cl>    <span class=s>net.c</span>
</span></span><span class=line><span class=cl>    <span class=s>read.c</span>
</span></span><span class=line><span class=cl>    <span class=s>sds.c</span>
</span></span><span class=line><span class=cl>    <span class=s>sockcompat.c</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>hiredis_sources</span> <span class=o>${</span><span class=nv>hiredis_sources</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>...
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>ADD_LIBRARY</span><span class=p>(</span><span class=s>hiredis</span> <span class=s>SHARED</span> <span class=o>${</span><span class=nv>hiredis_sources</span><span class=o>}</span><span class=p>)</span>     <span class=c>#要生成这两个库文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>ADD_LIBRARY</span><span class=p>(</span><span class=s>hiredis_static</span> <span class=s>STATIC</span> <span class=o>${</span><span class=nv>hiredis_sources</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET_TARGET_PROPERTIES</span><span class=p>(</span><span class=s>hiredis</span>
</span></span><span class=line><span class=cl>    <span class=s>PROPERTIES</span> <span class=s>WINDOWS_EXPORT_ALL_SYMBOLS</span> <span class=s>TRUE</span>
</span></span><span class=line><span class=cl>    <span class=s>VERSION</span> <span class=s2>&#34;${HIREDIS_SONAME}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET_TARGET_PROPERTIES</span><span class=p>(</span><span class=s>hiredis_static</span>
</span></span><span class=line><span class=cl>    <span class=s>PROPERTIES</span> <span class=s>COMPILE_PDB_NAME</span> <span class=s>hiredis_static</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET_TARGET_PROPERTIES</span><span class=p>(</span><span class=s>hiredis_static</span>
</span></span><span class=line><span class=cl>    <span class=s>PROPERTIES</span> <span class=s>COMPILE_PDB_NAME_DEBUG</span> <span class=s>hiredis_static</span><span class=o>${</span><span class=nv>CMAKE_DEBUG_POSTFIX</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#INSTALL_INTERFACE用于给install的时候指定使用的引用文件，那么INSTALL_INTERFACE又是怎么指定的？看这个https://ravenxrz.ink/archives/e40194d1.html
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>TARGET_INCLUDE_DIRECTORIES</span><span class=p>(</span><span class=s>hiredis</span> <span class=s>PUBLIC</span> <span class=o>$&lt;</span><span class=nv>INSTALL_INTERFACE:include</span><span class=o>&gt;</span> <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>TARGET_INCLUDE_DIRECTORIES</span><span class=p>(</span><span class=s>hiredis_static</span> <span class=s>PUBLIC</span> <span class=o>$&lt;</span><span class=nv>INSTALL_INTERFACE:include</span><span class=o>&gt;</span> <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#CONFIGURE_FILE替换原本的普通文件的内容，给pkg用的，不需要了，所以去掉
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>CONFIGURE_FILE</span><span class=p>(</span><span class=s>hiredis.pc.in</span> <span class=s>hiredis.pc</span> <span class=s>@ONLY</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>...
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#Cpack打包的内容，直接省略了，关系并不大
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>...
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>IF</span><span class=p>(</span><span class=s>ENABLE_SSL</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>IF</span> <span class=p>(</span><span class=s>NOT</span> <span class=s>OPENSSL_ROOT_DIR</span><span class=p>)</span>  <span class=c>#这个是export的openssl根目录，用来判断找openssl
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=nb>IF</span> <span class=p>(</span><span class=s>APPLE</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=nb>SET</span><span class=p>(</span><span class=s>OPENSSL_ROOT_DIR</span> <span class=s2>&#34;/usr/local/opt/openssl&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>ENDIF</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>ENDIF</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>FIND_PACKAGE</span><span class=p>(</span><span class=s>OpenSSL</span> <span class=s>REQUIRED</span><span class=p>)</span>  <span class=c>#找到依赖的openssl库
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nb>SET</span><span class=p>(</span><span class=s>hiredis_ssl_sources</span>         <span class=c>#编译hiredis_ssl库的源文件
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=s>ssl.c</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>ADD_LIBRARY</span><span class=p>(</span><span class=s>hiredis_ssl</span> <span class=s>SHARED</span>  
</span></span><span class=line><span class=cl>            <span class=o>${</span><span class=nv>hiredis_ssl_sources</span><span class=o>}</span><span class=p>)</span> <span class=c>#设定生成的库文件
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nb>ADD_LIBRARY</span><span class=p>(</span><span class=s>hiredis_ssl_static</span> <span class=s>STATIC</span>
</span></span><span class=line><span class=cl>            <span class=o>${</span><span class=nv>hiredis_ssl_sources</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=err>...
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>SET_TARGET_PROPERTIES</span><span class=p>(</span><span class=s>hiredis_ssl_static</span>
</span></span><span class=line><span class=cl>        <span class=s>PROPERTIES</span> <span class=s>COMPILE_PDB_NAME</span> <span class=s>hiredis_ssl_static</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>SET_TARGET_PROPERTIES</span><span class=p>(</span><span class=s>hiredis_ssl_static</span>
</span></span><span class=line><span class=cl>        <span class=s>PROPERTIES</span> <span class=s>COMPILE_PDB_NAME_DEBUG</span> <span class=s>hiredis_ssl_static</span><span class=o>${</span><span class=nv>CMAKE_DEBUG_POSTFIX</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>TARGET_INCLUDE_DIRECTORIES</span><span class=p>(</span><span class=s>hiredis_ssl</span> <span class=s>PRIVATE</span> <span class=s2>&#34;${OPENSSL_INCLUDE_DIR}&#34;</span><span class=p>)</span>  <span class=c>#引入openssl包裹的头文件，只给自己用。不会暴露给hiredis_ssl的使用者
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nb>TARGET_INCLUDE_DIRECTORIES</span><span class=p>(</span><span class=s>hiredis_ssl_static</span> <span class=s>PRIVATE</span> <span class=s2>&#34;${OPENSSL_INCLUDE_DIR}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>TARGET_LINK_LIBRARIES</span><span class=p>(</span><span class=s>hiredis_ssl</span> <span class=s>PRIVATE</span> <span class=o>${</span><span class=nv>OPENSSL_LIBRARIES</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>...
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>INSTALL</span><span class=p>(</span><span class=s>TARGETS</span> <span class=s>hiredis_ssl</span> <span class=s>hiredis_ssl_static</span>
</span></span><span class=line><span class=cl>        <span class=s>EXPORT</span> <span class=s>hiredis_ssl-targets</span>
</span></span><span class=line><span class=cl>        <span class=s>RUNTIME</span> <span class=s>DESTINATION</span> <span class=o>${</span><span class=nv>CMAKE_INSTALL_BINDIR</span><span class=o>}</span>    <span class=c>#安装bin文件的位置
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=s>LIBRARY</span> <span class=s>DESTINATION</span> <span class=o>${</span><span class=nv>CMAKE_INSTALL_LIBDIR</span><span class=o>}</span>    <span class=c>#安装动态库的位置
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=s>ARCHIVE</span> <span class=s>DESTINATION</span> <span class=o>${</span><span class=nv>CMAKE_INSTALL_LIBDIR</span><span class=o>}</span><span class=p>)</span>   <span class=c>#安装静态库的位置
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>...
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>INSTALL</span><span class=p>(</span><span class=s>FILES</span> <span class=s>hiredis_ssl.h</span>   
</span></span><span class=line><span class=cl>        <span class=s>DESTINATION</span> <span class=o>${</span><span class=nv>CMAKE_INSTALL_INCLUDEDIR</span><span class=o>}</span><span class=s>/hiredis</span><span class=p>)</span>        <span class=c>#可以看到安装头文件的位置，将hiredis_ssl.h搞到了安装头文件hiredis里面
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>INSTALL</span><span class=p>(</span><span class=s>FILES</span> <span class=o>${</span><span class=nv>CMAKE_CURRENT_BINARY_DIR</span><span class=o>}</span><span class=s>/hiredis_ssl.pc</span>    <span class=c>#提供给pkg安装用的，不用关注
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=s>DESTINATION</span> <span class=o>${</span><span class=nv>CMAKE_INSTALL_LIBDIR</span><span class=o>}</span><span class=s>/pkgconfig</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>export</span><span class=p>(</span><span class=s>EXPORT</span> <span class=s>hiredis_ssl-targets</span>
</span></span><span class=line><span class=cl>           <span class=s>FILE</span> <span class=s2>&#34;${CMAKE_CURRENT_BINARY_DIR}/hiredis_ssl-targets.cmake&#34;</span>
</span></span><span class=line><span class=cl>           <span class=s>NAMESPACE</span> <span class=s>hiredis::</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>SET</span><span class=p>(</span><span class=s>CMAKE_CONF_INSTALL_DIR</span> <span class=s>share/hiredis_ssl</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=err>...
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>ENDIF</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>...
</span></span></span></code></pre></div><p>有几点需要单独解释。</p><p>头文件可见性控制：无论是bazel还是cmake，实际上都在追究一个头文件可见性。一些老的c/c++代码是直接把头文件和代码放到一起，然后直接<code>include "foo.h"</code>。cmake通过指定TARGET_INCLUDE_DIRECTORIES来确定引用哪些目录，然后调用者可以类似上面<code>include "foo.h"</code>调用头文件。这里面引发一个问题，直接<code>target_link_libraries</code>，头文件会使用库引入而直接暴露的头文件，也就是上一层库暴露的头文件，这里<code>TARGET_INCLUDE_DIRECTORIES(hiredis PUBLIC $&lt;INSTALL_INTERFACE:include> $&lt;BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>)</code>就是公开包，打包openssl的时候就是私有包<code>TARGET_INCLUDE_DIRECTORIES(hiredis_ssl PRIVATE "${OPENSSL_INCLUDE_DIR}")</code>参考链接：https://ravenxrz.ink/archives/e40194d1.html，而bazel是采用相对于workspace的相对路径来引用具体的文件。</p><p>需要简单解释INSTALL_INTERFACE & BUILD_INTERFACE的意思，两者分别指定了编译/安装的时候需要执行的操作，在target_include_directories的时候，我理解就是找到引用的头文件。BUILD_INTERFACE是指编译的时候会使用这些指定的头文件。而安装的时候会指定使用INSTALL_INTERFACE的头文件，Nmmm，但是我实际上没明白的是，到了安装的时候，我应该只暴露一个单独的给外界使用的外部接口的头文件和库文件，干嘛还需要依赖依赖头文件呢？我又仔细想了下，觉得可能这个所谓的install_interface不是常见的直接找头文件和lib库的方式，可能是一种所谓的modern cmake，即找到其它的依托cmake的build，然后使用里面的引用的头文件，举一个简单的例子，下面的例子是先find_package，不行了才执行find_library命令。而find_package即为modern cmake的部分，即从找二进制文件脱离到一个包上，从而可以指定版本，组件等信息。具体可以参考《Professional-CMake》23章。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># hiredis dependency
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>find_package</span><span class=p>(</span><span class=s>hiredis</span> <span class=s>QUIET</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>hiredis_FOUND</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_HIREDIS_LIBS</span> <span class=s>hiredis::hiredis</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_USE_TLS</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>find_package</span><span class=p>(</span><span class=s>hiredis_ssl</span> <span class=s>REQUIRED</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_HIREDIS_LIBS</span> <span class=s>hiredis::hiredis_ssl</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>find_path</span><span class=p>(</span><span class=s>HIREDIS_HEADER</span> <span class=s>hiredis</span> <span class=s>REQUIRED</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>find_library</span><span class=p>(</span><span class=s>HIREDIS_LIB</span> <span class=s>hiredis</span> <span class=s>REQUIRED</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_HIREDIS_LIBS</span> <span class=o>${</span><span class=nv>HIREDIS_LIB</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_USE_TLS</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>find_library</span><span class=p>(</span><span class=s>HIREDIS_TLS_LIB</span> <span class=s>hiredis_ssl</span> <span class=s>REQUIRED</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_HIREDIS_LIBS</span> <span class=o>${</span><span class=nv>HIREDIS_TLS_LIB</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span></code></pre></div><p>如果对cmake还有疑问，建议直接看这个https://zhuanlan.zhihu.com/p/393316878，国内写的很详尽的内容。或者直接看官方文档https://cmake.org/cmake/help/git-stage/guide/importing-exporting/index.html#exporting-targets, 如果对modern cmake有疑问，建议看看https://zhuanlan.zhihu.com/p/76975231，这个知乎的专栏写的比较清楚了。</p><p>xxx.pc是什么：<strong>CFLAGS：</strong> 指定头文件（.h文件）的路径，如：CFLAGS=-I/usr/include -I/path/include。同样地，安装一个包时会在安装路径下建立一个include目录，当安装过程中出现问题时，试着把以前安装的包的include目录加入到该变量中来。可以看到下面制定了具体安装的路径是默认的prefix/include/hiredis。当然因为我们不适用pkg软件了，所以实际上我们不需要关注这个。上面的代码我注释掉了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>prefix</span><span class=o>=</span>@CMAKE_INSTALL_PREFIX@
</span></span><span class=line><span class=cl><span class=nv>install_libdir</span><span class=o>=</span>@CMAKE_INSTALL_LIBDIR@
</span></span><span class=line><span class=cl><span class=nv>exec_prefix</span><span class=o>=</span><span class=si>${</span><span class=nv>prefix</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=nv>libdir</span><span class=o>=</span><span class=si>${</span><span class=nv>exec_prefix</span><span class=si>}</span>/<span class=si>${</span><span class=nv>install_libdir</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=nv>includedir</span><span class=o>=</span><span class=si>${</span><span class=nv>prefix</span><span class=si>}</span>/include
</span></span><span class=line><span class=cl><span class=nv>pkgincludedir</span><span class=o>=</span><span class=si>${</span><span class=nv>includedir</span><span class=si>}</span>/hiredis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>Name</span><span class=o>:</span> <span class=n>hiredis</span>
</span></span><span class=line><span class=cl><span class=nf>Description</span><span class=o>:</span> <span class=n>Minimalistic</span> <span class=n>C</span> <span class=n>client</span> <span class=n>library</span> <span class=n>for</span> <span class=n>Redis</span>.
</span></span><span class=line><span class=cl><span class=nf>Version</span><span class=o>:</span> @<span class=n>PROJECT_VERSION</span>@
</span></span><span class=line><span class=cl><span class=nf>Libs</span><span class=o>:</span> -<span class=n>L</span>${<span class=n>libdir</span>} -<span class=n>lhiredis</span>
</span></span><span class=line><span class=cl><span class=nf>Cflags</span><span class=o>:</span> -<span class=n>I</span>${<span class=n>pkgincludedir</span>} -<span class=n>D_FILE_OFFSET_BITS</span>=64
</span></span></code></pre></div><p>使用编译安装的时候还遇到一个问题，即async.c文件44行引用的是个dict.c文件，解决方法有两种：将这个改成dict.h，这个dict.c加到hdrs里面作为头文件引入。最终的BUILD文件如下。在公司的时候和同事聊确认一点，不推荐修改代码。修改代码的方式很糟糕。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-BUILD data-lang=BUILD><span class=line><span class=cl><span class=n>cc_library</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;hiredis&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>srcs</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;alloc.c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;dict.c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;async.c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;hiredis.c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;net.c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;read.c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sds.c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sockcompat.c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>hdrs</span> <span class=o>=</span> <span class=n>glob</span><span class=p>([</span><span class=s2>&#34;*.h&#34;</span><span class=p>])</span><span class=o>+</span><span class=n>glob</span><span class=p>([</span><span class=s2>&#34;adapters/*.h&#34;</span><span class=p>])</span><span class=o>+</span><span class=p>[</span><span class=s2>&#34;dict.c&#34;</span><span class=p>,],</span>  <span class=c1>#dict.c的引入是因为被async.c引了，而adapters是编译async时候别的库要使用</span>
</span></span><span class=line><span class=cl>    <span class=n>include_prefix</span> <span class=o>=</span> <span class=s2>&#34;hiredis&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>visibility</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;//visibility:public&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cc_library</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;hiredis_ssl&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>srcs</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ssl.c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>hdrs</span> <span class=o>=</span> <span class=n>glob</span><span class=p>([</span><span class=s2>&#34;*.h&#34;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>    <span class=n>deps</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;//third_party/openssl:openssl&#34;</span><span class=p>,</span>   <span class=c1>#我们重点关注下这个是怎么引入的</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>include_prefix</span> <span class=o>=</span> <span class=s2>&#34;hiredis&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>visibility</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;//visibility:public&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><h4 class="relative group">1.1 转换时学习bazel的行为<div id=11-%E8%BD%AC%E6%8D%A2%E6%97%B6%E5%AD%A6%E4%B9%A0bazel%E7%9A%84%E8%A1%8C%E4%B8%BA class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#11-%E8%BD%AC%E6%8D%A2%E6%97%B6%E5%AD%A6%E4%B9%A0bazel%E7%9A%84%E8%A1%8C%E4%B8%BA aria-label=锚点>#</a></span></h4><p>bazel是一个追求编译速度的软件，编译hiredis_ssl的时候，这里要注意一点，如果头文件第一次拷贝过了，以后修改hdrs不需要了，它是不会删除的，依然会保留那些不用的；如果不存在才会再次拷贝。换言之，按需拷贝。另外头文件的路径是按照hdrs里面写的相对路径组织的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@3f01551b38dd:~/code_test/cmake2bazel# ls  bazel-out/k8-fastbuild/bin/third_party/hiredis/_virtual_includes/hiredis_ssl/hiredis_ssl/
</span></span><span class=line><span class=cl>alloc.h  async.h  async_private.h  dict.h  fmacros.h  hiredis.h  hiredis_ssl.h  net.h  read.h  sds.h  sdsalloc.h  sockcompat.h  win32.h
</span></span></code></pre></div><p>我们再看编译redis++的时候虚拟头文件是什么，我们知道hdrs是这么写的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>hdrs</span> <span class=o>=</span> glob<span class=o>([</span><span class=s2>&#34;src/sw/redis++/*.h&#34;</span><span class=o>])</span>+glob<span class=o>([</span><span class=s2>&#34;src/sw/redis++/*.hpp&#34;</span><span class=o>])</span>+glob<span class=o>([</span><span class=s2>&#34;src/sw/redis++/cxx17/*.h&#34;</span><span class=o>])</span>+glob<span class=o>([</span><span class=s2>&#34;src/sw/redis++/no_tls/*.h&#34;</span><span class=o>])</span>
</span></span></code></pre></div><p>它会按照文件的布局，组织头文件和目录拷贝到对应的<code>/文件目标名字/文件目标名字</code>下面，但是引用的时候按照最顶级的共享目录的名字来引用。参照下面的diff，我想使用tls.h的时候，可以<code>#include "third_party/redis-plus-plus/src/sw/redis++/no_tls/tls.h"</code>，那么为什么也可以<code>#include "no_tls/tls.h"</code>呢，因为我们保持了相对路径的正确性。第一种写法是相对于cmake2bazel的WORKSPCE的路径，而第二种是直接找的索引的最根本的想对路径。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@3f01551b38dd:~/code_test/cmake2bazel# ll bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_virtual_includes/redis++/redis++/src/sw/redis++/
</span></span><span class=line><span class=cl>total <span class=m>136</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>4</span> root root <span class=m>4096</span> Nov <span class=m>20</span> 21:45 ./
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>3</span> root root <span class=m>4096</span> Nov <span class=m>20</span> 21:45 ../
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>89</span> Nov <span class=m>20</span> 21:45 async_connection.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_connection.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>94</span> Nov <span class=m>20</span> 21:45 async_connection_pool.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_connection_pool.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>86</span> Nov <span class=m>20</span> 21:45 async_redis++.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_redis++.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>84</span> Nov <span class=m>20</span> 21:45 async_redis.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_redis.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>92</span> Nov <span class=m>20</span> 21:45 async_redis_cluster.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_redis_cluster.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>87</span> Nov <span class=m>20</span> 21:45 async_sentinel.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_sentinel.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>90</span> Nov <span class=m>20</span> 21:45 async_shards_pool.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_shards_pool.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>86</span> Nov <span class=m>20</span> 21:45 cmd_formatter.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/cmd_formatter.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>80</span> Nov <span class=m>20</span> 21:45 command.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/command.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>85</span> Nov <span class=m>20</span> 21:45 command_args.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/command_args.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>88</span> Nov <span class=m>20</span> 21:45 command_options.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/command_options.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>83</span> Nov <span class=m>20</span> 21:45 connection.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/connection.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>88</span> Nov <span class=m>20</span> 21:45 connection_pool.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/connection_pool.h
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root <span class=m>4096</span> Nov <span class=m>20</span> 21:45 cxx17/
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>79</span> Nov <span class=m>20</span> 21:45 errors.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/errors.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>83</span> Nov <span class=m>20</span> 21:45 event_loop.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/event_loop.h
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root <span class=m>4096</span> Nov <span class=m>20</span> 21:45 no_tls/
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>81</span> Nov <span class=m>20</span> 21:45 pipeline.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/pipeline.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>85</span> Nov <span class=m>20</span> 21:45 queued_redis.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/queued_redis.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>87</span> Nov <span class=m>20</span> 21:45 queued_redis.hpp -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/queued_redis.hpp
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>80</span> Nov <span class=m>20</span> 21:45 redis++.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/redis++.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>78</span> Nov <span class=m>20</span> 21:45 redis.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/redis.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>80</span> Nov <span class=m>20</span> 21:45 redis.hpp -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/redis.hpp
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>86</span> Nov <span class=m>20</span> 21:45 redis_cluster.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/redis_cluster.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>88</span> Nov <span class=m>20</span> 21:45 redis_cluster.hpp -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/redis_cluster.hpp
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>78</span> Nov <span class=m>20</span> 21:45 reply.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/reply.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>81</span> Nov <span class=m>20</span> 21:45 sentinel.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/sentinel.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>79</span> Nov <span class=m>20</span> 21:45 shards.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/shards.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>84</span> Nov <span class=m>20</span> 21:45 shards_pool.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/shards_pool.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>83</span> Nov <span class=m>20</span> 21:45 subscriber.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/subscriber.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>84</span> Nov <span class=m>20</span> 21:45 transaction.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/transaction.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root   <span class=m>78</span> Nov <span class=m>20</span> 21:45 utils.h -&gt; /root/code_test/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/utils.h
</span></span></code></pre></div><p>现在我们考虑另一个问题，引用的第三方头文件在哪里？redis++引用hiredis，具体的代码可以参考下面的diff，它引用的目录是hiredis/redis.h。为什么能够直接找到呢？因为hiredis的BUILD里面有一句<code>include_prefix = "hiredis"</code>，从而将头文件的相对位置补齐了，从而redis++能够从hiredis目录找到具体的hiredis.h文件。查找include_prefix的定义会发现</p><blockquote><p>The prefix to add to the paths of the headers of this rule.</p><p>When set, the headers in the <code>hdrs</code> attribute of this rule are accessible at is the value of this attribute prepended to their repository-relative path.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@3f01551b38dd:~/code_test/cmake2bazel/third_party/redis-plus-plus# egrep -R <span class=s2>&#34;hiredis.h&#34;</span>
</span></span><span class=line><span class=cl>src/sw/redis++/cmd_formatter.h:#include &lt;hiredis/hiredis.h&gt;
</span></span><span class=line><span class=cl>src/sw/redis++/tls/tls.h:#include &lt;hiredis/hiredis.h&gt;
</span></span><span class=line><span class=cl>src/sw/redis++/tls/tls.h:#include &lt;hiredis/hiredis_ssl.h&gt;
</span></span><span class=line><span class=cl>src/sw/redis++/redis.cpp:#include &lt;hiredis/hiredis.h&gt;
</span></span><span class=line><span class=cl>src/sw/redis++/redis_cluster.cpp:#include &lt;hiredis/hiredis.h&gt;
</span></span><span class=line><span class=cl>src/sw/redis++/no_tls/tls.h:#include &lt;hiredis/hiredis.h&gt;
</span></span><span class=line><span class=cl>src/sw/redis++/reply.h:#include &lt;hiredis/hiredis.h&gt;
</span></span><span class=line><span class=cl>src/sw/redis++/connection.h:#include &lt;hiredis/hiredis.h&gt;
</span></span><span class=line><span class=cl>src/sw/redis++/errors.h:#include &lt;hiredis/hiredis.h&gt;
</span></span></code></pre></div><p>编译redis++的时候，_virtual_includes下面包含的文件</p><p>如果去掉了include_prefix我们再看具体的编译输出代码，重点看具体编译的命令。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@3f01551b38dd:~/code_test/cmake2bazel# bazel build //third_party/redis-plus-plus:redis++   --sandbox_debug
</span></span><span class=line><span class=cl>INFO: Analyzed target //third_party/redis-plus-plus:redis++ <span class=o>(</span><span class=m>1</span> packages loaded, <span class=m>23</span> targets configured<span class=o>)</span>.
</span></span><span class=line><span class=cl>INFO: Found <span class=m>1</span> target...
</span></span><span class=line><span class=cl>INFO: From Compiling third_party/hiredis/dict.c:
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:277:19: warning: <span class=s1>&#39;dictNext&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=m>277</span> <span class=p>|</span> static dictEntry *dictNext<span class=o>(</span>dictIterator *iter<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>                   ^~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:270:13: warning: <span class=s1>&#39;dictInitIterator&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=m>270</span> <span class=p>|</span> static void dictInitIterator<span class=o>(</span>dictIterator *iter, dict *ht<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>             ^~~~~~~~~~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:250:13: warning: <span class=s1>&#39;dictRelease&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=m>250</span> <span class=p>|</span> static void dictRelease<span class=o>(</span>dict *ht<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>             ^~~~~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:194:12: warning: <span class=s1>&#39;dictDelete&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=m>194</span> <span class=p>|</span> static int dictDelete<span class=o>(</span>dict *ht, const void *key<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>            ^~~~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:169:12: warning: <span class=s1>&#39;dictReplace&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=m>169</span> <span class=p>|</span> static int dictReplace<span class=o>(</span>dict *ht, void *key, void *val<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>            ^~~~~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:74:14: warning: <span class=s1>&#39;dictCreate&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>   <span class=m>74</span> <span class=p>|</span> static dict *dictCreate<span class=o>(</span>dictType *type, void *privDataPtr<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>              ^~~~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:54:21: warning: <span class=s1>&#39;dictGenHashFunction&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>   <span class=m>54</span> <span class=p>|</span> static unsigned int dictGenHashFunction<span class=o>(</span>const unsigned char *buf, int len<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>                     ^~~~~~~~~~~~~~~~~~~
</span></span><span class=line><span class=cl>Target //third_party/redis-plus-plus:redis++ up-to-date:
</span></span><span class=line><span class=cl>  bazel-bin/third_party/redis-plus-plus/libredis++.a
</span></span><span class=line><span class=cl>  bazel-bin/third_party/redis-plus-plus/libredis++.so
</span></span><span class=line><span class=cl>INFO: Elapsed time: 2.323s, Critical Path: 2.11s
</span></span><span class=line><span class=cl>INFO: <span class=m>24</span> processes: <span class=m>1</span> internal, <span class=m>23</span> processwrapper-sandbox.
</span></span><span class=line><span class=cl>INFO: Build completed successfully, <span class=m>24</span> total actions
</span></span><span class=line><span class=cl>root@3f01551b38dd:~/code_test/cmake2bazel# vim third_party/hiredis/BUILD
</span></span><span class=line><span class=cl>root@3f01551b38dd:~/code_test/cmake2bazel# bazel build //third_party/redis-plus-plus:redis++   --sandbox_debug
</span></span><span class=line><span class=cl>INFO: Analyzed target //third_party/redis-plus-plus:redis++ <span class=o>(</span><span class=m>1</span> packages loaded, <span class=m>23</span> targets configured<span class=o>)</span>.
</span></span><span class=line><span class=cl>INFO: Found <span class=m>1</span> target...
</span></span><span class=line><span class=cl>INFO: From Compiling third_party/hiredis/dict.c:
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:277:19: warning: <span class=s1>&#39;dictNext&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=m>277</span> <span class=p>|</span> static dictEntry *dictNext<span class=o>(</span>dictIterator *iter<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>                   ^~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:270:13: warning: <span class=s1>&#39;dictInitIterator&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=m>270</span> <span class=p>|</span> static void dictInitIterator<span class=o>(</span>dictIterator *iter, dict *ht<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>             ^~~~~~~~~~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:250:13: warning: <span class=s1>&#39;dictRelease&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=m>250</span> <span class=p>|</span> static void dictRelease<span class=o>(</span>dict *ht<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>             ^~~~~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:194:12: warning: <span class=s1>&#39;dictDelete&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=m>194</span> <span class=p>|</span> static int dictDelete<span class=o>(</span>dict *ht, const void *key<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>            ^~~~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:169:12: warning: <span class=s1>&#39;dictReplace&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=m>169</span> <span class=p>|</span> static int dictReplace<span class=o>(</span>dict *ht, void *key, void *val<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>            ^~~~~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:74:14: warning: <span class=s1>&#39;dictCreate&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>   <span class=m>74</span> <span class=p>|</span> static dict *dictCreate<span class=o>(</span>dictType *type, void *privDataPtr<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>              ^~~~~~~~~~
</span></span><span class=line><span class=cl>third_party/hiredis/dict.c:54:21: warning: <span class=s1>&#39;dictGenHashFunction&#39;</span> defined but not used <span class=o>[</span>-Wunused-function<span class=o>]</span>
</span></span><span class=line><span class=cl>   <span class=m>54</span> <span class=p>|</span> static unsigned int dictGenHashFunction<span class=o>(</span>const unsigned char *buf, int len<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>                     ^~~~~~~~~~~~~~~~~~~
</span></span><span class=line><span class=cl>ERROR: /root/code_test/cmake2bazel/third_party/redis-plus-plus/BUILD:1:11: Compiling third_party/redis-plus-plus/src/sw/redis++/command_options.cpp failed: <span class=o>(</span>Exit 1<span class=o>)</span>: process-wrapper failed: error executing <span class=nb>command</span>
</span></span><span class=line><span class=cl>  <span class=o>(</span><span class=nb>cd</span> /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/sandbox/processwrapper-sandbox/52/execroot/cmake2bazel <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=nb>exec</span> env - <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PATH</span><span class=o>=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PWD</span><span class=o>=</span>/proc/self/cwd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>TMPDIR</span><span class=o>=</span>/tmp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  /root/.cache/bazel/_bazel_root/install/ee8d7e4b6774884ed2cd0aece6fc9fda/process-wrapper <span class=s1>&#39;--timeout=0&#39;</span> <span class=s1>&#39;--kill_delay=15&#39;</span> /usr/bin/gcc -U_FORTIFY_SOURCE -fstack-protector -Wall -Wunused-but-set-parameter -Wno-free-nonheap-object -fno-omit-frame-pointer <span class=s1>&#39;-std=c++0x&#39;</span> -MD -MF bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_objs/redis++/command_options.pic.d <span class=s1>&#39;-frandom-seed=bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_objs/redis++/command_options.pic.o&#39;</span> -fPIC -iquote . -iquote bazel-out/k8-fastbuild/bin -Ibazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_virtual_includes/redis++ <span class=s1>&#39;-std=c++17&#39;</span> -fno-canonical-system-headers -Wno-builtin-macro-redefined <span class=s1>&#39;-D__DATE__=&#34;redacted&#34;&#39;</span> <span class=s1>&#39;-D__TIMESTAMP__=&#34;redacted&#34;&#39;</span> <span class=s1>&#39;-D__TIME__=&#34;redacted&#34;&#39;</span> -c third_party/redis-plus-plus/src/sw/redis++/command_options.cpp -o bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_objs/redis++/command_options.pic.o<span class=o>)</span>
</span></span><span class=line><span class=cl>In file included from third_party/redis-plus-plus/src/sw/redis++/command_options.cpp:18:
</span></span><span class=line><span class=cl>third_party/redis-plus-plus/src/sw/redis++/errors.h:22:10: fatal error: hiredis/hiredis.h: No such file or directory
</span></span><span class=line><span class=cl>   <span class=m>22</span> <span class=p>|</span> <span class=c1>#include &lt;hiredis/hiredis.h&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>          ^~~~~~~~~~~~~~~~~~~
</span></span><span class=line><span class=cl>compilation terminated.
</span></span><span class=line><span class=cl>Target //third_party/redis-plus-plus:redis++ failed to build
</span></span><span class=line><span class=cl>Use --verbose_failures to see the <span class=nb>command</span> lines of failed build steps.
</span></span><span class=line><span class=cl>INFO: Elapsed time: 0.284s, Critical Path: 0.13s
</span></span><span class=line><span class=cl>INFO: <span class=m>24</span> processes: <span class=m>16</span> internal, <span class=m>8</span> processwrapper-sandbox.
</span></span><span class=line><span class=cl>FAILED: Build did NOT <span class=nb>complete</span> successfully
</span></span></code></pre></div><p>调用process-wrapper去编译代码，引用头文件的目录的选项和具体设置为<code>-Ibazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_virtual_includes/redis++</code>而编译的文件为<code>-c third_party/redis-plus-plus/src/sw/redis++/command.cpp</code>，生成的中间文件为<code>-o bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_objs/redis++/command.pic.o</code>。但是我们很清楚gcc不会递归查找头文件，那么头文件是怎么找到的呢？</p><blockquote><p>/root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/sandbox/processwrapper-sandbox/52/execroot/cmake2bazel</p></blockquote><p>这里就可以看到具体的执行的路径了，换言之是在这个路径下的找到<code>third_party/redis-plus-plus/src/sw/redis++/command.cpp</code>，而相应的头文件也是拷贝到这个文件夹下面的相对路径。而不是我们本身的WORKSPACE所在的相对路径。可以看到只包含了要编译的cpp文件，和redis++里面的头文件，那么hiredis的头文件如何引入呢？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@3f01551b38dd:~/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/sandbox/processwrapper-sandbox/52/execroot/cmake2bazel# ll third_party/redis-plus-plus/src/sw/redis++/
</span></span><span class=line><span class=cl>total <span class=m>140</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>4</span> root root <span class=m>4096</span> Nov <span class=m>21</span> 14:05 ./
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>3</span> root root <span class=m>4096</span> Nov <span class=m>21</span> 14:05 ../
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>146</span> Nov <span class=m>21</span> 14:05 async_connection.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_connection.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>151</span> Nov <span class=m>21</span> 14:05 async_connection_pool.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_connection_pool.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>143</span> Nov <span class=m>21</span> 14:05 async_redis++.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_redis++.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>141</span> Nov <span class=m>21</span> 14:05 async_redis.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_redis.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>149</span> Nov <span class=m>21</span> 14:05 async_redis_cluster.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_redis_cluster.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>144</span> Nov <span class=m>21</span> 14:05 async_sentinel.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_sentinel.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>147</span> Nov <span class=m>21</span> 14:05 async_shards_pool.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/async_shards_pool.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>143</span> Nov <span class=m>21</span> 14:05 cmd_formatter.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/cmd_formatter.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>137</span> Nov <span class=m>21</span> 14:05 command.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/command.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>142</span> Nov <span class=m>21</span> 14:05 command_args.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/command_args.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>147</span> Nov <span class=m>21</span> 14:05 command_options.cpp -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/command_options.cpp
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>145</span> Nov <span class=m>21</span> 14:05 command_options.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/command_options.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>140</span> Nov <span class=m>21</span> 14:05 connection.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/connection.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>145</span> Nov <span class=m>21</span> 14:05 connection_pool.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/connection_pool.h
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root <span class=m>4096</span> Nov <span class=m>21</span> 14:05 cxx17/
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>136</span> Nov <span class=m>21</span> 14:05 errors.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/errors.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>140</span> Nov <span class=m>21</span> 14:05 event_loop.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/event_loop.h
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root <span class=m>4096</span> Nov <span class=m>21</span> 14:05 no_tls/
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>138</span> Nov <span class=m>21</span> 14:05 pipeline.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/pipeline.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>142</span> Nov <span class=m>21</span> 14:05 queued_redis.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/queued_redis.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>144</span> Nov <span class=m>21</span> 14:05 queued_redis.hpp -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/queued_redis.hpp
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>137</span> Nov <span class=m>21</span> 14:05 redis++.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/redis++.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>135</span> Nov <span class=m>21</span> 14:05 redis.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/redis.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>137</span> Nov <span class=m>21</span> 14:05 redis.hpp -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/redis.hpp
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>143</span> Nov <span class=m>21</span> 14:05 redis_cluster.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/redis_cluster.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>145</span> Nov <span class=m>21</span> 14:05 redis_cluster.hpp -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/redis_cluster.hpp
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>135</span> Nov <span class=m>21</span> 14:05 reply.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/reply.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>138</span> Nov <span class=m>21</span> 14:05 sentinel.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/sentinel.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>136</span> Nov <span class=m>21</span> 14:05 shards.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/shards.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>141</span> Nov <span class=m>21</span> 14:05 shards_pool.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/shards_pool.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>140</span> Nov <span class=m>21</span> 14:05 subscriber.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/subscriber.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>141</span> Nov <span class=m>21</span> 14:05 transaction.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/transaction.h
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>135</span> Nov <span class=m>21</span> 14:05 utils.h -&gt; /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/execroot/cmake2bazel/third_party/redis-plus-plus/src/sw/redis++/utils.h
</span></span></code></pre></div><p>所以有个问题，什么是virutal include folder。bazel使用virual includes来管理</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#如果没有加prefix，在那个目录查找hiredis.h</span>
</span></span><span class=line><span class=cl>root@3f01551b38dd:~/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/sandbox/processwrapper-sandbox/52/execroot/cmake2bazel# find ./ -name hiredis.h
</span></span><span class=line><span class=cl>./third_party/hiredis/hiredis.h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#不加prefix，看看redis++的编译报错，可以看到没有直接引入hiredis.h文件。这是怎么回事呢？</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@3f01551b38dd:~/code_test/cmake2bazel# bazel build //third_party/redis-plus-plus:redis++   --sandbox_debug
</span></span><span class=line><span class=cl>INFO: Analyzed target //third_party/redis-plus-plus:redis++ <span class=o>(</span><span class=m>1</span> packages loaded, <span class=m>23</span> targets configured<span class=o>)</span>.
</span></span><span class=line><span class=cl>INFO: Found <span class=m>1</span> target...
</span></span><span class=line><span class=cl>ERROR: /root/code_test/cmake2bazel/third_party/redis-plus-plus/BUILD:1:11: Compiling third_party/redis-plus-plus/src/sw/redis++/command_options.cpp failed: <span class=o>(</span>Exit 1<span class=o>)</span>: process-wrapper failed: error executing <span class=nb>command</span>
</span></span><span class=line><span class=cl>  <span class=o>(</span><span class=nb>cd</span> /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/sandbox/processwrapper-sandbox/147/execroot/cmake2bazel <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=nb>exec</span> env - <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PATH</span><span class=o>=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PWD</span><span class=o>=</span>/proc/self/cwd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>TMPDIR</span><span class=o>=</span>/tmp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  /root/.cache/bazel/_bazel_root/install/ee8d7e4b6774884ed2cd0aece6fc9fda/process-wrapper <span class=s1>&#39;--timeout=0&#39;</span> <span class=s1>&#39;--kill_delay=15&#39;</span> /usr/bin/gcc -U_FORTIFY_SOURCE -fstack-protector -Wall -Wunused-but-set-parameter -Wno-free-nonheap-object -fno-omit-frame-pointer <span class=s1>&#39;-std=c++0x&#39;</span> -MD -MF bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_objs/redis++/command_options.pic.d <span class=s1>&#39;-frandom-seed=bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_objs/redis++/command_options.pic.o&#39;</span> -fPIC -iquote . -iquote bazel-out/k8-fastbuild/bin -Ibazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_virtual_includes/redis++ <span class=s1>&#39;-std=c++17&#39;</span> -fno-canonical-system-headers -Wno-builtin-macro-redefined <span class=s1>&#39;-D__DATE__=&#34;redacted&#34;&#39;</span> <span class=s1>&#39;-D__TIMESTAMP__=&#34;redacted&#34;&#39;</span> <span class=s1>&#39;-D__TIME__=&#34;redacted&#34;&#39;</span> -c third_party/redis-plus-plus/src/sw/redis++/command_options.cpp -o bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_objs/redis++/command_options.pic.o<span class=o>)</span>
</span></span><span class=line><span class=cl>In file included from third_party/redis-plus-plus/src/sw/redis++/command_options.cpp:18:
</span></span><span class=line><span class=cl>third_party/redis-plus-plus/src/sw/redis++/errors.h:22:10: fatal error: hiredis/hiredis.h: No such file or directory
</span></span><span class=line><span class=cl>   <span class=m>22</span> <span class=p>|</span> <span class=c1>#include &lt;hiredis/hiredis.h&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>          ^~~~~~~~~~~~~~~~~~~
</span></span><span class=line><span class=cl>compilation terminated.
</span></span><span class=line><span class=cl>Target //third_party/redis-plus-plus:redis++ failed to build
</span></span><span class=line><span class=cl>Use --verbose_failures to see the <span class=nb>command</span> lines of failed build steps.
</span></span><span class=line><span class=cl>INFO: Elapsed time: 0.204s, Critical Path: 0.07s
</span></span><span class=line><span class=cl>INFO: <span class=m>19</span> processes: <span class=m>17</span> internal, <span class=m>2</span> processwrapper-sandbox.
</span></span><span class=line><span class=cl>FAILED: Build did NOT <span class=nb>complete</span> successfully
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#如果加了prefix，查找hiredis.h</span>
</span></span><span class=line><span class=cl>root@3f01551b38dd:~/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/sandbox/processwrapper-sandbox/88/execroot/cmake2bazel# find ./ -name hiredis.h
</span></span><span class=line><span class=cl>./third_party/hiredis/hiredis.h        <span class=c1>#可以看到，这个路径是相对于WORKSPACE的路径，是一直存在的，无论编译与否都不会出错。这个也是推荐的编译目录</span>
</span></span><span class=line><span class=cl>./bazel-out/k8-fastbuild/bin/third_party/hiredis/_virtual_includes/hiredis/hiredis/hiredis.h  <span class=c1>#这个就是加了include_prefix之后生成的假的include folder</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#如果加了prefix我们在看编译redis++的命令（我加了一个未导入的文件hxndg.hcc来打断生成的文件）</span>
</span></span><span class=line><span class=cl><span class=c1>#可以看到引用的头文件目录多了两个，为：</span>
</span></span><span class=line><span class=cl><span class=c1>#bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_virtual_includes/redis++</span>
</span></span><span class=line><span class=cl><span class=c1>#-Ibazel-out/k8-fastbuild/bin/third_party/hiredis/_virtual_includes/hiredis</span>
</span></span><span class=line><span class=cl>root@3f01551b38dd:~/code_test/cmake2bazel# bazel build //third_party/redis-plus-plus:redis++   --sandbox_debug
</span></span><span class=line><span class=cl>INFO: Analyzed target //third_party/redis-plus-plus:redis++ <span class=o>(</span><span class=m>0</span> packages loaded, <span class=m>0</span> targets configured<span class=o>)</span>.
</span></span><span class=line><span class=cl>INFO: Found <span class=m>1</span> target...
</span></span><span class=line><span class=cl>ERROR: /root/code_test/cmake2bazel/third_party/redis-plus-plus/BUILD:1:11: Compiling third_party/redis-plus-plus/src/sw/redis++/command.cpp failed: <span class=o>(</span>Exit 1<span class=o>)</span>: process-wrapper failed: error executing <span class=nb>command</span>
</span></span><span class=line><span class=cl>  <span class=o>(</span><span class=nb>cd</span> /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/sandbox/processwrapper-sandbox/137/execroot/cmake2bazel <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=nb>exec</span> env - <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PATH</span><span class=o>=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PWD</span><span class=o>=</span>/proc/self/cwd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>TMPDIR</span><span class=o>=</span>/tmp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  /root/.cache/bazel/_bazel_root/install/ee8d7e4b6774884ed2cd0aece6fc9fda/process-wrapper <span class=s1>&#39;--timeout=0&#39;</span> <span class=s1>&#39;--kill_delay=15&#39;</span> /usr/bin/gcc -U_FORTIFY_SOURCE -fstack-protector -Wall -Wunused-but-set-parameter -Wno-free-nonheap-object -fno-omit-frame-pointer <span class=s1>&#39;-std=c++0x&#39;</span> -MD -MF bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_objs/redis++/command.pic.d <span class=s1>&#39;-frandom-seed=bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_objs/redis++/command.pic.o&#39;</span> -fPIC -iquote . -iquote bazel-out/k8-fastbuild/bin -Ibazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_virtual_includes/redis++ -Ibazel-out/k8-fastbuild/bin/third_party/hiredis/_virtual_includes/hiredis <span class=s1>&#39;-std=c++17&#39;</span> -fno-canonical-system-headers -Wno-builtin-macro-redefined <span class=s1>&#39;-D__DATE__=&#34;redacted&#34;&#39;</span> <span class=s1>&#39;-D__TIMESTAMP__=&#34;redacted&#34;&#39;</span> <span class=s1>&#39;-D__TIME__=&#34;redacted&#34;&#39;</span> -c third_party/redis-plus-plus/src/sw/redis++/command.cpp -o bazel-out/k8-fastbuild/bin/third_party/redis-plus-plus/_objs/redis++/command.pic.o<span class=o>)</span>
</span></span><span class=line><span class=cl>third_party/redis-plus-plus/src/sw/redis++/command.cpp:18:10: fatal error: hxndg.hcc: No such file or directory
</span></span><span class=line><span class=cl>   <span class=m>18</span> <span class=p>|</span> <span class=c1>#include &#34;hxndg.hcc&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>          ^~~~~~~~~~~
</span></span><span class=line><span class=cl>compilation terminated.
</span></span><span class=line><span class=cl>Target //third_party/redis-plus-plus:redis++ failed to build
</span></span><span class=line><span class=cl>Use --verbose_failures to see the <span class=nb>command</span> lines of failed build steps.
</span></span><span class=line><span class=cl>INFO: Elapsed time: 0.223s, Critical Path: 0.12s
</span></span><span class=line><span class=cl>INFO: <span class=m>15</span> processes: <span class=m>15</span> internal.
</span></span><span class=line><span class=cl>FAILED: Build did NOT <span class=nb>complete</span> successfully
</span></span></code></pre></div><p>这里存在一个问题，在modern cmake里面我们经常希望能够控制头文件/库文件的暴露，bazel是如何控制头文件暴露的？</p><blockquote><p>For <code>cc_library</code> rules, headers in <code>hdrs</code> comprise the public interface of the library and can be directly included both from the files in <code>hdrs</code> and <code>srcs</code> of the library itself as well as from files in <code>hdrs</code> and <code>srcs</code> of <code>cc_*</code> rules that list the library in their <code>deps</code>. Headers in <code>srcs</code> must only be directly included from the files in <code>hdrs</code> and <code>srcs</code> of the library itself.</p></blockquote><p><code>cc_library</code>的<code>hdrs</code>里面的描述</p><blockquote><p>The list of header files published by this library to be directly included by sources in dependent rules.</p><p>This is the strongly preferred location for declaring header files that describe the interface for the library. These headers will be made available for inclusion by sources in this rule or in dependent rules. Headers not meant to be included by a client of this library should be listed in the <code>srcs</code> attribute instead, even if they are included by a published header</p></blockquote><p>可见我们想直接暴露的头文件应当写到<code>cc_library</code>的<code>hdrs</code>里面，而内部使用的头文件写到<code>src</code>里面。</p><p>具体存储了什么看这里：https://docs.bazel.build/versions/main/output_directories.html</p><p>具体代码参考<code>bazel-master\src\main\java\com\google\devtools\build\lib\rules\cpp\CcCompilationHelper.java</code>，想理解代码建议阅读CODEBASE.md文件</p><p>bazel-out存储了中间文件，运行的环境实际上就在bazel-out里面，</p><h2 class="relative group">2 openssl & libuv的编译。<div id=2-openssl--libuv%E7%9A%84%E7%BC%96%E8%AF%91 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-openssl--libuv%E7%9A%84%E7%BC%96%E8%AF%91 aria-label=锚点>#</a></span></h2><h3 class="relative group">2.1 openssl的编译 & libuv<div id=21-openssl%E7%9A%84%E7%BC%96%E8%AF%91--libuv class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#21-openssl%E7%9A%84%E7%BC%96%E8%AF%91--libuv aria-label=锚点>#</a></span></h3><p>首先，我们需要下载openssl的源码和Libuv的源代码，因此修改WORKSPACE如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-WORKSPACE data-lang=WORKSPACE><span class=line><span class=cl><span class=n>workspace</span><span class=p>(</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;cmake2bazel&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>load</span><span class=p>(</span><span class=s2>&#34;@bazel_tools//tools/build_defs/repo:http.bzl&#34;</span><span class=p>,</span> <span class=s2>&#34;http_archive&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 1.0版本的rules_foreign_cc，非常老旧了，网上我就搜到一个老外博客写怎么用这个的，就是用的1.0的版本</span>
</span></span><span class=line><span class=cl><span class=c1>#http_archive(</span>
</span></span><span class=line><span class=cl><span class=c1>#   name = &#34;rules_foreign_cc&#34;,</span>
</span></span><span class=line><span class=cl><span class=c1>#   sha256 = &#34;c2cdcf55ffaf49366725639e45dedd449b8c3fe22b54e31625eb80ce3a240f1e&#34;,</span>
</span></span><span class=line><span class=cl><span class=c1>#   strip_prefix = &#34;rules_foreign_cc-0.1.0&#34;,</span>
</span></span><span class=line><span class=cl><span class=c1>#   url = &#34;https://github.com/bazelbuild/rules_foreign_cc/archive/0.1.0.zip&#34;,</span>
</span></span><span class=line><span class=cl><span class=c1>#)</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#load(&#34;@rules_foreign_cc//foreign_cc:repositories.bzl&#34;, &#34;rules_foreign_cc_dependencies&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>http_archive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;rules_foreign_cc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=n>strip_prefix</span> <span class=o>=</span> <span class=s2>&#34;rules_foreign_cc-4010620160e0df4d894b61496d3d3b6fc8323212&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>sha256</span> <span class=o>=</span> <span class=s2>&#34;07e3414cc841b1f4d16e5231eb818e5c5e03e2045827f5306a55709e5045c7fd&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;https://github.com/bazelbuild/rules_foreign_cc/archive/4010620160e0df4d894b61496d3d3b6fc8323212.zip&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>load</span><span class=p>(</span><span class=s2>&#34;@rules_foreign_cc//foreign_cc:repositories.bzl&#34;</span><span class=p>,</span> <span class=s2>&#34;rules_foreign_cc_dependencies&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rules_foreign_cc_dependencies</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>all_content</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;filegroup(name = &#34;all&#34;, srcs = glob([&#34;**&#34;]), visibility = [&#34;//visibility:public&#34;])&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># openssl</span>
</span></span><span class=line><span class=cl><span class=n>http_archive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;openssl&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>build_file_content</span> <span class=o>=</span> <span class=n>all_content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>strip_prefix</span> <span class=o>=</span> <span class=s2>&#34;openssl-OpenSSL_1_1_1d&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>urls</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;https://github.com/openssl/openssl/archive/OpenSSL_1_1_1d.tar.gz&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># uv</span>
</span></span><span class=line><span class=cl><span class=n>http_archive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;libuv&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>build_file_content</span> <span class=o>=</span> <span class=n>all_content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>strip_prefix</span> <span class=o>=</span> <span class=s2>&#34;libuv-1.42.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>urls</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;https://github.com/libuv/libuv/archive/refs/tags/v1.42.0.tar.gz&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>thirdy_party/openssl/BUILD文件直接引用第三方仓库，然后调用rules_foreign_cc的configure_make进行安装和编译，libuv也能使用configure_make的命令进行编译，他也依托auto_gen生成代码，下面的BUILD文件使用了cmake命令。</p><p>整个的过程可以说是非常简单了，指定源码，指定编译出来的文件，然后就没有了。</p><p>如果对rules_foreign_cc有疑问就看这个链接https://github.com/bazelbuild/rules_foreign_cc/blob/main/docs/README.md。如果想学能够看懂rules_foreign_cc的代码，得看starlark的语言教程，参考：https://github.com/bazelbuild/starlark/blob/master/spec.md</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># See https://github.com/bazelbuild/rules_foreign_cc</span>
</span></span><span class=line><span class=cl>load<span class=o>(</span><span class=s2>&#34;@rules_foreign_cc//foreign_cc:defs.bzl&#34;</span>, <span class=s2>&#34;configure_make&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>config_setting<span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nv>name</span> <span class=o>=</span> <span class=s2>&#34;darwin_build&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>values</span> <span class=o>=</span> <span class=o>{</span><span class=s2>&#34;cpu&#34;</span>: <span class=s2>&#34;darwin&#34;</span><span class=o>}</span>,
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># See https://wiki.openssl.org/index.php/Compilation_and_Installation</span>
</span></span><span class=line><span class=cl><span class=c1># See https://github.com/bazelbuild/rules_foreign_cc/issues/338</span>
</span></span><span class=line><span class=cl><span class=c1>#可以通过指定out_lib_dir选项指定编译出来的lib放在哪里，aka The path to where the compiled library binaries will be written to following a successful build</span>
</span></span><span class=line><span class=cl><span class=c1>#对于使用configure-make形式的代码编译的方式，</span>
</span></span><span class=line><span class=cl>configure_make<span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nv>name</span> <span class=o>=</span> <span class=s2>&#34;openssl&#34;</span>,
</span></span><span class=line><span class=cl><span class=c1>#实际上调用configure的命令，默认是调用configure，这里可以找到openssl里面调用的是config</span>
</span></span><span class=line><span class=cl>    <span class=nv>configure_command</span> <span class=o>=</span> <span class=s2>&#34;config&#34;</span>,
</span></span><span class=line><span class=cl><span class=c1>#Any options to be put on the &#39;configure&#39; command line.</span>
</span></span><span class=line><span class=cl>    <span class=nv>configure_options</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>select</span><span class=o>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;:darwin_build&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;shared&#34;</span>,
</span></span><span class=line><span class=cl>              <span class=s2>&#34;ARFLAGS=r&#34;</span>,
</span></span><span class=line><span class=cl>              <span class=s2>&#34;enable-ec_nistp_64_gcc_128&#34;</span>,
</span></span><span class=line><span class=cl>              <span class=s2>&#34;no-ssl2&#34;</span>, <span class=s2>&#34;no-ssl3&#34;</span>, <span class=s2>&#34;no-comp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;//conditions:default&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>            <span class=o>]})</span>,
</span></span><span class=line><span class=cl>    <span class=c1>#defines = [&#34;NDEBUG&#34;], Don&#39;t know how to use -D; NDEBUG seems to be the default anyway</span>
</span></span><span class=line><span class=cl><span class=c1>#指定OPENSSL编译lib的源代码文件，aka Where the library source code is for openssl</span>
</span></span><span class=line><span class=cl>    <span class=nv>lib_source</span> <span class=o>=</span> <span class=s2>&#34;@openssl//:all&#34;</span>,               
</span></span><span class=line><span class=cl>    <span class=nv>visibility</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;//visibility:public&#34;</span><span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=c1>#Environment variables to be set for the &#39;configure&#39; invocation.</span>
</span></span><span class=line><span class=cl>    <span class=nv>configure_env_vars</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>select</span><span class=o>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;:darwin_build&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;OSX_DEPLOYMENT_TARGET&#34;</span>: <span class=s2>&#34;10.14&#34;</span>,
</span></span><span class=line><span class=cl>              <span class=s2>&#34;AR&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;//conditions:default&#34;</span>: <span class=o>{}})</span>,
</span></span><span class=line><span class=cl><span class=c1>#用来指定共享出来的动态库、动态文件是什么，可以使用static_libraries属性来共享动态库</span>
</span></span><span class=line><span class=cl>    <span class=nv>out_shared_libs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>select</span><span class=o>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;:darwin_build&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;libssl.dylib&#34;</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;libcrypto.dylib&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;//conditions:default&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;libssl.so&#34;</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;libcrypto.so&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=o>})</span>
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span></code></pre></div><p>third_party/libuv/BUILD文件</p><p>这里要注意一点，生成静态库文件的时候是文件名字为libuv_a.a，一开始我写的是libuv.a，然后报错没想明白咋回事，后来去找了libuv的编译过程看了下才发现静态库文件是libuv_a.a，如果想使用动态库，就用out_shared_libs即可。那么现在问题就来了，从rules_foreign_cc是怎么到具体的生成的头文件和静态库文件呢？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># See https://github.com/bazelbuild/rules_foreign_cc</span>
</span></span><span class=line><span class=cl><span class=n>load</span><span class=p>(</span><span class=s2>&#34;@rules_foreign_cc//foreign_cc:defs.bzl&#34;</span><span class=p>,</span> <span class=s2>&#34;cmake&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cmake</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;libuv&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>lib_source</span> <span class=o>=</span> <span class=s2>&#34;@libuv//:all&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>#out_static_libs = [&#34;libuv.a&#34;],</span>
</span></span><span class=line><span class=cl>    <span class=n>out_static_libs</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;libuv_a.a&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=c1>#out_shared_libs = [&#34;libuv.so.1.0.0&#34;],  libuv.so是个链接，直接编译会报错</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>libuv编译时候的代码为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>qcraft@BJ-vgdog:~/code_test/cmake2bazel$ bazelisk-linux-amd64 build //third_party/libuv:libuv
</span></span><span class=line><span class=cl>DEBUG: Rule <span class=s1>&#39;libuv&#39;</span> indicated that a canonical reproducible form can be obtained by modifying arguments <span class=nv>sha256</span> <span class=o>=</span> <span class=s2>&#34;371e5419708f6aaeb8656671f89400b92a9bba6443369af1bb70bcd6e4b3c764&#34;</span>
</span></span><span class=line><span class=cl>DEBUG: Repository libuv instantiated at:
</span></span><span class=line><span class=cl>  /home/qcraft/code_test/cmake2bazel/WORKSPACE:36:13: in &lt;toplevel&gt;
</span></span><span class=line><span class=cl>Repository rule http_archive defined at:
</span></span><span class=line><span class=cl>  /home/qcraft/.cache/bazel/_bazel_qcraft/66cfb4dff202f299686aa7bc701960fa/external/bazel_tools/tools/build_defs/repo/http.bzl:336:31: in &lt;toplevel&gt;
</span></span><span class=line><span class=cl>INFO: Analyzed target //third_party/libuv:libuv <span class=o>(</span><span class=m>1</span> packages loaded, <span class=m>1</span> target configured<span class=o>)</span>.
</span></span><span class=line><span class=cl>INFO: Found <span class=m>1</span> target...
</span></span><span class=line><span class=cl>Target //third_party/libuv:libuv up-to-date:
</span></span><span class=line><span class=cl>  bazel-bin/third_party/libuv/libuv/include
</span></span><span class=line><span class=cl>  bazel-bin/third_party/libuv/libuv/lib/libuv_a.a
</span></span><span class=line><span class=cl>  bazel-bin/third_party/libuv/copy_libuv/libuv
</span></span><span class=line><span class=cl>INFO: Elapsed time: 31.269s, Critical Path: 30.97s
</span></span><span class=line><span class=cl>INFO: <span class=m>2</span> processes: <span class=m>1</span> internal, <span class=m>1</span> linux-sandbox.
</span></span><span class=line><span class=cl>INFO: Build completed successfully, <span class=m>2</span> total actions
</span></span></code></pre></div><p>有另外一个问题，rules_foreign_cc能否正确处理第三方的依赖，也就是引入的库还依赖别的库？我们还是用简单的试下好了，</p><h3 class="relative group">2.2 rules_foreign_cc的相关问题<div id=22-rules_foreign_cc%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#22-rules_foreign_cc%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h3><p>目前存在两个相关rules_foreign_cc的问题：</p><ul><li>rules_foreign_cc能不能起到和bazel相同的功能？能不能编译生成的文件和cmake一样？简单来说就是能不能保证编译出来的文件和头文件一致呢？</li><li>rules_foreign_cc到底干了什么？我们需要看看源代码到底干了什么?</li></ul><p>我们先关注问题1，</p><p>再看问题2，</p><h3 class="relative group">2.3 bazel的学习<div id=23-bazel%E7%9A%84%E5%AD%A6%E4%B9%A0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#23-bazel%E7%9A%84%E5%AD%A6%E4%B9%A0 aria-label=锚点>#</a></span></h3><p>有个问题冒出来了，openssl的头文件是怎么找到的呢？我改了一下hireds/ssl.c的代码，引入了一个不存在的头文件，然后执行编译命令。看到这句话<code>-isystem bazel-out/k8-fastbuild/bin/third_party/openssl/openssl/include</code>，这个路径下有openssl文件夹</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@3f01551b38dd:~/code_test/cmake2bazel# bazel build //third_party/hiredis:hiredis_ssl
</span></span><span class=line><span class=cl>INFO: Analyzed target //third_party/hiredis:hiredis_ssl <span class=o>(</span><span class=m>4</span> packages loaded, <span class=m>3059</span> targets configured<span class=o>)</span>.
</span></span><span class=line><span class=cl>INFO: Found <span class=m>1</span> target...
</span></span><span class=line><span class=cl>ERROR: /root/code_test/cmake2bazel/third_party/hiredis/BUILD:18:11: Compiling third_party/hiredis/ssl.c failed: <span class=o>(</span>Exit 1<span class=o>)</span>: gcc failed: error executing <span class=nb>command</span> /usr/bin/gcc -U_FORTIFY_SOURCE -fstack-protector -Wall -Wunused-but-set-parameter -Wno-free-nonheap-object -fno-omit-frame-pointer -MD -MF ... <span class=o>(</span>remaining <span class=m>19</span> argument<span class=o>(</span>s<span class=o>)</span> skipped<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Use --sandbox_debug to see verbose messages from the sandbox
</span></span><span class=line><span class=cl>third_party/hiredis/ssl.c:48:10: fatal error: hxndg.hcc: No such file or directory
</span></span><span class=line><span class=cl>   <span class=m>48</span> <span class=p>|</span> <span class=c1>#include &#34;hxndg.hcc&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>          ^~~~~~~~~~~
</span></span><span class=line><span class=cl>compilation terminated.
</span></span><span class=line><span class=cl>Target //third_party/hiredis:hiredis_ssl failed to build
</span></span><span class=line><span class=cl>Use --verbose_failures to see the <span class=nb>command</span> lines of failed build steps.
</span></span><span class=line><span class=cl>INFO: Elapsed time: 1.350s, Critical Path: 0.54s
</span></span><span class=line><span class=cl>INFO: <span class=m>14</span> processes: <span class=m>14</span> internal.
</span></span><span class=line><span class=cl>FAILED: Build did NOT <span class=nb>complete</span> successfully
</span></span><span class=line><span class=cl>root@3f01551b38dd:~/code_test/cmake2bazel# bazel build //third_party/hiredis:hiredis_ssl --sandbox_debug
</span></span><span class=line><span class=cl>INFO: Analyzed target //third_party/hiredis:hiredis_ssl <span class=o>(</span><span class=m>0</span> packages loaded, <span class=m>0</span> targets configured<span class=o>)</span>.
</span></span><span class=line><span class=cl>INFO: Found <span class=m>1</span> target...
</span></span><span class=line><span class=cl>ERROR: /root/code_test/cmake2bazel/third_party/hiredis/BUILD:18:11: Compiling third_party/hiredis/ssl.c failed: <span class=o>(</span>Exit 1<span class=o>)</span>: process-wrapper failed: error executing <span class=nb>command</span>
</span></span><span class=line><span class=cl>  <span class=o>(</span><span class=nb>cd</span> /root/.cache/bazel/_bazel_root/40ee89a49d5eb376cc6e6e5356870e5a/sandbox/processwrapper-sandbox/165/execroot/cmake2bazel <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=nb>exec</span> env - <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PATH</span><span class=o>=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PWD</span><span class=o>=</span>/proc/self/cwd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>TMPDIR</span><span class=o>=</span>/tmp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  /root/.cache/bazel/_bazel_root/install/ee8d7e4b6774884ed2cd0aece6fc9fda/process-wrapper <span class=s1>&#39;--timeout=0&#39;</span> <span class=s1>&#39;--kill_delay=15&#39;</span> /usr/bin/gcc -U_FORTIFY_SOURCE -fstack-protector -Wall -Wunused-but-set-parameter -Wno-free-nonheap-object -fno-omit-frame-pointer -MD -MF bazel-out/k8-fastbuild/bin/third_party/hiredis/_objs/hiredis_ssl/ssl.pic.d <span class=s1>&#39;-frandom-seed=bazel-out/k8-fastbuild/bin/third_party/hiredis/_objs/hiredis_ssl/ssl.pic.o&#39;</span> -fPIC -iquote . -iquote bazel-out/k8-fastbuild/bin -Ibazel-out/k8-fastbuild/bin/third_party/hiredis/_virtual_includes/hiredis_ssl -isystem bazel-out/k8-fastbuild/bin/third_party/openssl/openssl/include -fno-canonical-system-headers -Wno-builtin-macro-redefined <span class=s1>&#39;-D__DATE__=&#34;redacted&#34;&#39;</span> <span class=s1>&#39;-D__TIMESTAMP__=&#34;redacted&#34;&#39;</span> <span class=s1>&#39;-D__TIME__=&#34;redacted&#34;&#39;</span> -c third_party/hiredis/ssl.c -o bazel-out/k8-fastbuild/bin/third_party/hiredis/_objs/hiredis_ssl/ssl.pic.o<span class=o>)</span>
</span></span><span class=line><span class=cl>third_party/hiredis/ssl.c:48:10: fatal error: hxndg.hcc: No such file or directory
</span></span><span class=line><span class=cl>   <span class=m>48</span> <span class=p>|</span> <span class=c1>#include &#34;hxndg.hcc&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>|</span>          ^~~~~~~~~~~
</span></span><span class=line><span class=cl>compilation terminated.
</span></span><span class=line><span class=cl>Target //third_party/hiredis:hiredis_ssl failed to build
</span></span><span class=line><span class=cl>Use --verbose_failures to see the <span class=nb>command</span> lines of failed build steps.
</span></span><span class=line><span class=cl>INFO: Elapsed time: 0.232s, Critical Path: 0.06s
</span></span><span class=line><span class=cl>INFO: <span class=m>2</span> processes: <span class=m>2</span> internal.
</span></span><span class=line><span class=cl>FAILED: Build did NOT <span class=nb>complete</span> successfully
</span></span></code></pre></div><h2 class="relative group">redis++的编译<div id=redis%E7%9A%84%E7%BC%96%E8%AF%91 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#redis%E7%9A%84%E7%BC%96%E8%AF%91 aria-label=锚点>#</a></span></h2><p>贴上cmakelist文件的代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=err>...
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>set</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_DEFAULT_CXX_STANDARD</span> <span class=s>17</span><span class=p>)</span> <span class=c>#设定一个变量指代代码标准为c++17
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>...
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>NOT</span> <span class=s>WIN32</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>CMAKE_CXX_FLAGS</span> <span class=s2>&#34;${CMAKE_CXX_FLAGS} -std=c++${REDIS_PLUS_PLUS_CXX_STANDARD}&#34;</span><span class=p>)</span>  <span class=c>#设定代码标准为c++17
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>CMAKE_CXX_FLAGS</span> <span class=s2>&#34;${CMAKE_CXX_FLAGS} /std:c++${REDIS_PLUS_PLUS_CXX_STANDARD}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_ASYNC</span><span class=p>)</span>          <span class=c>#是否编译ASYNC代码
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_ASYNC</span> <span class=s>STREQUAL</span> <span class=s2>&#34;libuv&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s>STATUS</span> <span class=s2>&#34;redis-plus-plus build async interface with libuv&#34;</span><span class=p>)</span>   <span class=c>#如果编译async的代码，那么需要找到libuv头文件和库，我在代码中通过rules_foreign_cc解决
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=c># libuv dependency
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=nb>find_path</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_ASYNC_LIB_HEADER</span> <span class=s>NAMES</span> <span class=s>uv.h</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>find_library</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_ASYNC_LIB</span> <span class=s>uv</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s>FATAL_ERROR</span> <span class=s2>&#34;invalid REDIS_PLUS_PLUS_BUILD_ASYNC&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>set</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_SOURCE_DIR</span> <span class=s>src/sw/redis++</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>set</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_SOURCES</span>                        <span class=c>#sync的源文件
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/command.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/command_options.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/connection.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/connection_pool.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/crc16.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/errors.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/pipeline.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/redis.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/redis_cluster.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/reply.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/sentinel.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/shards.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/shards_pool.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/subscriber.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/transaction.cpp&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_ASYNC</span><span class=p>)</span>                    <span class=c>#async还得加上这些源文件
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_SOURCES</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/async_connection.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/async_connection_pool.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/async_redis.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/event_loop.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/async_sentinel.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/async_redis_cluster.cpp&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/async_shards_pool.cpp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>NOT</span> <span class=s>REDIS_PLUS_PLUS_ASYNC_FUTURE</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>set</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_ASYNC_FUTURE</span> <span class=s2>&#34;std&#34;</span><span class=p>)</span>            <span class=c>#使用标准库的std::future特性，std17已经支持了.
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_ASYNC_FUTURE</span> <span class=s>STREQUAL</span> <span class=s2>&#34;std&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>set</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_ASYNC_FUTURE_HEADER</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/future/std&#34;</span><span class=p>)</span>   <span class=c>#链进来的future/std头文件
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nb>elseif</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_ASYNC_FUTURE</span> <span class=s>STREQUAL</span> <span class=s2>&#34;boost&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>set</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_ASYNC_FUTURE_HEADER</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/future/boost&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>find_package</span><span class=p>(</span><span class=s>Boost</span> <span class=s>REQUIRED</span> <span class=s>COMPONENTS</span> <span class=s>system</span> <span class=s>thread</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s>FATAL_ERROR</span> <span class=s2>&#34;invalid REDIS_PLUS_PLUS_ASYNC_FUTURE&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># cxx utils
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_CXX_STANDARD</span> <span class=s>LESS</span> <span class=s>17</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>CXX_UTILS_DIR</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/cxx11&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>CXX_UTILS_DIR</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/cxx17&#34;</span><span class=p>)</span>           <span class=c>#链接cxx17的头文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># TLS support
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>option</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_USE_TLS</span> <span class=s2>&#34;Build with TLS support&#34;</span> <span class=s>OFF</span><span class=p>)</span>            <span class=c>#默认tls是关闭的
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>message</span><span class=p>(</span><span class=s>STATUS</span> <span class=s2>&#34;redis-plus-plus TLS support: ${REDIS_PLUS_PLUS_USE_TLS}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_USE_TLS</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>TLS_SUB_DIR</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/tls&#34;</span><span class=p>)</span>                <span class=c>#如果使用tls，头文件里面引用源码目录下的tls文件夹
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_SOURCES</span> <span class=s2>&#34;${TLS_SUB_DIR}/tls.cpp&#34;</span><span class=p>)</span>       <span class=c>#如果要使用tls，那么sync &amp; async都得加上tls的cpp文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_DEPENDS</span> <span class=s2>&#34;hiredis,hiredis_ssl&#34;</span><span class=p>)</span>                  <span class=c>#使用tls，就依赖hiredis和hiredis_ssl
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>TLS_SUB_DIR</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/no_tls&#34;</span><span class=p>)</span>             <span class=c>#不使用tls，头文件里面引用no_tls文件夹
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_DEPENDS</span> <span class=s2>&#34;hiredis&#34;</span><span class=p>)</span>     <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># hiredis dependency
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>find_package</span><span class=p>(</span><span class=s>hiredis</span> <span class=s>QUIET</span><span class=p>)</span>                   <span class=c>#依赖hiredis文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>if</span><span class=p>(</span><span class=s>hiredis_FOUND</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_HIREDIS_LIBS</span> <span class=s>hiredis::hiredis</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_USE_TLS</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>find_package</span><span class=p>(</span><span class=s>hiredis_ssl</span> <span class=s>REQUIRED</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_HIREDIS_LIBS</span> <span class=s>hiredis::hiredis_ssl</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>find_path</span><span class=p>(</span><span class=s>HIREDIS_HEADER</span> <span class=s>hiredis</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>find_library</span><span class=p>(</span><span class=s>HIREDIS_LIB</span> <span class=s>hiredis</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_HIREDIS_LIBS</span> <span class=o>${</span><span class=nv>HIREDIS_LIB</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_USE_TLS</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>find_library</span><span class=p>(</span><span class=s>HIREDIS_TLS_LIB</span> <span class=s>hiredis_ssl</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_HIREDIS_LIBS</span> <span class=o>${</span><span class=nv>HIREDIS_TLS_LIB</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Build static library
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>option</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_STATIC</span> <span class=s2>&#34;Build static library&#34;</span> <span class=s>ON</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>message</span><span class=p>(</span><span class=s>STATUS</span> <span class=s2>&#34;redis-plus-plus build static library: ${REDIS_PLUS_PLUS_BUILD_STATIC}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_STATIC</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>STATIC_LIB</span> <span class=s>redis++_static</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>add_library</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>STATIC</span> <span class=o>${</span><span class=nv>REDIS_PLUS_PLUS_SOURCES</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>add_library</span><span class=p>(</span><span class=s>redis++::</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>ALIAS</span> <span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_TARGETS</span> <span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>target_include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span>
</span></span><span class=line><span class=cl>            <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${REDIS_PLUS_PLUS_SOURCE_DIR}</span><span class=o>&gt;</span>    <span class=c>#编译时候的头文件包含这三个目录
</span></span></span><span class=line><span class=cl><span class=c></span>            <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${TLS_SUB_DIR}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${CXX_UTILS_DIR}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>$&lt;</span><span class=nv>INSTALL_INTERFACE:include</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>hiredis_FOUND</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_link_libraries</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span> <span class=o>${</span><span class=nv>REDIS_PLUS_PLUS_HIREDIS_LIBS</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span> <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${HIREDIS_HEADER}</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_ASYNC</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span> <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${REDIS_PLUS_PLUS_ASYNC_FUTURE_HEADER}</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span> <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${REDIS_PLUS_PLUS_ASYNC_LIB_HEADER}</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_ASYNC_FUTURE</span> <span class=s>STREQUAL</span> <span class=s2>&#34;boost&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=nb>target_include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>SYSTEM</span> <span class=s>PUBLIC</span> <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${Boost_INCLUDE_DIR}</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span> <span class=p>(</span><span class=s>WIN32</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>...
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_compile_options</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>PRIVATE</span> <span class=s2>&#34;-Wall&#34;</span> <span class=s2>&#34;-W&#34;</span> <span class=s2>&#34;-Werror&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>set_target_properties</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>OUTPUT_NAME</span> <span class=s>redis++</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set_target_properties</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>CLEAN_DIRECT_OUTPUT</span> <span class=s>1</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set_target_properties</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>CXX_EXTENSIONS</span> <span class=s>OFF</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>option</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_STATIC_WITH_PIC</span> <span class=s2>&#34;Build static library with position independent code&#34;</span> <span class=s>ON</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>message</span><span class=p>(</span><span class=s>STATUS</span> <span class=s2>&#34;redis-plus-plus build static library with position independent code: ${REDIS_PLUS_PLUS_BUILD_STATIC_WITH_PIC}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_STATIC_WITH_PIC</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>set_target_properties</span><span class=p>(</span><span class=o>${</span><span class=nv>STATIC_LIB</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>POSITION_INDEPENDENT_CODE</span> <span class=s>ON</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Build shared library
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>option</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_SHARED</span> <span class=s2>&#34;Build shared library&#34;</span> <span class=s>ON</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>message</span><span class=p>(</span><span class=s>STATUS</span> <span class=s2>&#34;redis-plus-plus build shared library: ${REDIS_PLUS_PLUS_BUILD_SHARED}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_SHARED</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>SHARED_LIB</span> <span class=s>redis++</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>add_library</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>SHARED</span> <span class=o>${</span><span class=nv>REDIS_PLUS_PLUS_SOURCES</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>add_library</span><span class=p>(</span><span class=s>redis++::</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>ALIAS</span> <span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>REDIS_PLUS_PLUS_TARGETS</span> <span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>target_include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span>
</span></span><span class=line><span class=cl>            <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${REDIS_PLUS_PLUS_SOURCE_DIR}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${TLS_SUB_DIR}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${CXX_UTILS_DIR}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>$&lt;</span><span class=nv>INSTALL_INTERFACE:include</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>hiredis_FOUND</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_link_libraries</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span> <span class=o>${</span><span class=nv>REDIS_PLUS_PLUS_HIREDIS_LIBS</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span> <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${HIREDIS_HEADER}</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_link_libraries</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span> <span class=o>${</span><span class=nv>REDIS_PLUS_PLUS_HIREDIS_LIBS</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_ASYNC</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span> <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/${REDIS_PLUS_PLUS_ASYNC_FUTURE_HEADER}</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span> <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${REDIS_PLUS_PLUS_ASYNC_LIB_HEADER}</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_link_libraries</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PUBLIC</span> <span class=o>${</span><span class=nv>REDIS_PLUS_PLUS_ASYNC_LIB</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_ASYNC_FUTURE</span> <span class=s>STREQUAL</span> <span class=s2>&#34;boost&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=nb>target_include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>SYSTEM</span> <span class=s>PUBLIC</span> <span class=o>$&lt;</span><span class=nv>BUILD_INTERFACE:${Boost_INCLUDE_DIR}</span><span class=o>&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>WIN32</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=err>...
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_compile_options</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PRIVATE</span> <span class=s2>&#34;-Wall&#34;</span> <span class=s2>&#34;-W&#34;</span> <span class=s2>&#34;-Werror&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set_target_properties</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>OUTPUT_NAME</span> <span class=s>redis++</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set_target_properties</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>CLEAN_DIRECT_OUTPUT</span> <span class=s>1</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set_target_properties</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>CXX_EXTENSIONS</span> <span class=s>OFF</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set_target_properties</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>POSITION_INDEPENDENT_CODE</span> <span class=s>ON</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set_target_properties</span><span class=p>(</span><span class=o>${</span><span class=nv>SHARED_LIB</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>VERSION</span> <span class=o>${</span><span class=nv>PROJECT_VERSION</span><span class=o>}</span> <span class=s>SOVERSION</span> <span class=o>${</span><span class=nv>PROJECT_VERSION_MAJOR</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>option</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_TEST</span> <span class=s2>&#34;Build tests for redis++&#34;</span> <span class=s>ON</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>message</span><span class=p>(</span><span class=s>STATUS</span> <span class=s2>&#34;redis-plus-plus build test: ${REDIS_PLUS_PLUS_BUILD_TEST}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_BUILD_TEST</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>add_subdirectory</span><span class=p>(</span><span class=s>test</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>install</span><span class=p>(</span><span class=s>TARGETS</span> <span class=o>${</span><span class=nv>REDIS_PLUS_PLUS_TARGETS</span><span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=s>EXPORT</span> <span class=s>redis++-targets</span>
</span></span><span class=line><span class=cl>        <span class=s>LIBRARY</span> <span class=s>DESTINATION</span> <span class=s>lib</span>
</span></span><span class=line><span class=cl>        <span class=s>ARCHIVE</span> <span class=s>DESTINATION</span> <span class=s>lib</span>
</span></span><span class=line><span class=cl>        <span class=s>RUNTIME</span> <span class=s>DESTINATION</span> <span class=s>bin</span>
</span></span><span class=line><span class=cl>        <span class=s>INCLUDES</span> <span class=s>DESTINATION</span> <span class=s>include</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>set</span><span class=p>(</span><span class=s>REDIS_PLUS_PLUS_CMAKE_DESTINATION</span> <span class=s>share/cmake/redis++</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>install</span><span class=p>(</span><span class=s>EXPORT</span> <span class=s>redis++-targets</span>
</span></span><span class=line><span class=cl>        <span class=s>FILE</span> <span class=s>redis++-targets.cmake</span>
</span></span><span class=line><span class=cl>        <span class=s>NAMESPACE</span> <span class=s>redis++::</span>
</span></span><span class=line><span class=cl>        <span class=s>DESTINATION</span> <span class=o>${</span><span class=nv>REDIS_PLUS_PLUS_CMAKE_DESTINATION</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Install headers.
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>set</span><span class=p>(</span><span class=s>HEADER_PATH</span> <span class=s2>&#34;sw/redis++&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>file</span><span class=p>(</span><span class=s>GLOB</span> <span class=s>HEADERS</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/*.h*&#34;</span> <span class=s2>&#34;${TLS_SUB_DIR}/*.h&#34;</span> <span class=s2>&#34;${CXX_UTILS_DIR}/*.h&#34;</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_ASYNC_FUTURE_HEADER}/*.h&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>NOT</span> <span class=s>REDIS_PLUS_PLUS_BUILD_ASYNC</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>file</span><span class=p>(</span><span class=s>GLOB</span> <span class=s>ASYNC_HEADERS</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/async_*.h&#34;</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_SOURCE_DIR}/event_*.h&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>list</span><span class=p>(</span><span class=s>REMOVE_ITEM</span> <span class=s>HEADERS</span> <span class=o>${</span><span class=nv>ASYNC_HEADERS</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>install</span><span class=p>(</span><span class=s>FILES</span> <span class=o>${</span><span class=nv>HEADERS</span><span class=o>}</span> <span class=s>DESTINATION</span> <span class=o>${</span><span class=nv>CMAKE_INSTALL_PREFIX</span><span class=o>}</span><span class=s>/include/</span><span class=o>${</span><span class=nv>HEADER_PATH</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>include</span><span class=p>(</span><span class=s>CMakePackageConfigHelpers</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>write_basic_package_version_file</span><span class=p>(</span><span class=s2>&#34;${CMAKE_CURRENT_BINARY_DIR}/cmake/redis++-config-version.cmake&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>VERSION</span> <span class=o>${</span><span class=nv>PROJECT_VERSION</span><span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=s>COMPATIBILITY</span> <span class=s>AnyNewerVersion</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>configure_package_config_file</span><span class=p>(</span><span class=s2>&#34;${CMAKE_CURRENT_SOURCE_DIR}/cmake/redis++-config.cmake.in&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${CMAKE_CURRENT_BINARY_DIR}/cmake/redis++-config.cmake&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>INSTALL_DESTINATION</span> <span class=o>${</span><span class=nv>REDIS_PLUS_PLUS_CMAKE_DESTINATION</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>install</span><span class=p>(</span><span class=s>FILES</span> <span class=s2>&#34;${CMAKE_CURRENT_BINARY_DIR}/cmake/redis++-config.cmake&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${CMAKE_CURRENT_BINARY_DIR}/cmake/redis++-config-version.cmake&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>DESTINATION</span> <span class=o>${</span><span class=nv>REDIS_PLUS_PLUS_CMAKE_DESTINATION</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>export</span><span class=p>(</span><span class=s>EXPORT</span> <span class=s>redis++-targets</span>
</span></span><span class=line><span class=cl>        <span class=s>FILE</span> <span class=s2>&#34;${CMAKE_CURRENT_BINARY_DIR}/cmake/redis++-targets.cmake&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>NAMESPACE</span> <span class=s>redis++::</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>configure_file</span><span class=p>(</span><span class=s2>&#34;${CMAKE_CURRENT_SOURCE_DIR}/cmake/redis++.pc.in&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;${CMAKE_CURRENT_BINARY_DIR}/cmake/redis++.pc&#34;</span> <span class=s>@ONLY</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>install</span><span class=p>(</span><span class=s>FILES</span> <span class=s2>&#34;${CMAKE_CURRENT_BINARY_DIR}/cmake/redis++.pc&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>DESTINATION</span> <span class=s2>&#34;lib/pkgconfig&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># All the Debian-specific cpack defines.
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>if</span><span class=p>(</span><span class=o>${</span><span class=nv>CMAKE_VERSION</span><span class=o>}</span> <span class=s>VERSION_GREATER</span> <span class=s>3.6</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=nb>SET</span><span class=p>(</span><span class=s>CPACK_DEBIAN_PACKAGE_GENERATE_SHLIBS</span> <span class=s2>&#34;ON&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>NOT</span> <span class=s>DEFINED</span> <span class=s>CPACK_DEBIAN_PACKAGE_DEPENDS</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=nb>SET</span><span class=p>(</span><span class=s>CPACK_DEBIAN_PACKAGE_DEPENDS</span> <span class=s2>&#34;libstdc++6, libhiredis-dev&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>CPACK_DEBIAN_FILE_NAME</span> <span class=s>DEB-DEFAULT</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>CPACK_DEBIAN_PACKAGE_VERSION</span> <span class=s2>&#34;${REDIS_PLUS_PLUS_VERSION}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>CPACK_DEBIAN_PACKAGE_SOURCE</span> <span class=s2>&#34;https://github.com/sewenew/redis-plus-plus&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>message</span><span class=p>(</span><span class=s>STATUS</span> <span class=s2>&#34;Debian package name: ${CPACK_PACKAGE_FILE_NAME}.deb&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># All the common cpack defines.
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>if</span><span class=p>(</span><span class=s>NOT</span> <span class=s>DEFINED</span> <span class=s>CPACK_PACKAGE_NAME</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>SET</span><span class=p>(</span><span class=s>CPACK_PACKAGE_NAME</span> <span class=s2>&#34;libredis++-dev&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>CPACK_INSTALL_PREFIX</span> <span class=s2>&#34;${CMAKE_INSTALL_PREFIX}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>CPACK_PACKAGE_DESCRIPTION</span> <span class=s2>&#34;A pure C++ client for Redis, based on hiredis.&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>CPACK_PACKAGE_CONTACT</span> <span class=s2>&#34;anonymous&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>CPACK_GENERATOR</span> <span class=s2>&#34;DEB&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>INCLUDE</span><span class=p>(</span><span class=s>CPack</span><span class=p>)</span><span class=err>
</span></span></span></code></pre></div><p>最终的生成的BUILD文件</p><pre tabindex=0><code class=language-bazel data-lang=bazel>#如果使用tls的话，把下面的src/sw/redis++/no_tls/改成src/sw/redis++/tls/，并且把对hiredis_ssl的依赖前面的#去掉，还有就是代码里面的tls.cpp前面的井号去掉
cc_library(
    name = &#34;sync_redis++&#34;,
    srcs = [
        &#34;src/sw/redis++/command.cpp&#34;,
        &#34;src/sw/redis++/command_options.cpp&#34;,
        &#34;src/sw/redis++/connection.cpp&#34;,
        &#34;src/sw/redis++/connection_pool.cpp&#34;,
        &#34;src/sw/redis++/crc16.cpp&#34;,
        &#34;src/sw/redis++/errors.cpp&#34;,
        &#34;src/sw/redis++/pipeline.cpp&#34;,
        &#34;src/sw/redis++/redis.cpp&#34;,
        &#34;src/sw/redis++/redis_cluster.cpp&#34;,
        &#34;src/sw/redis++/reply.cpp&#34;,
        &#34;src/sw/redis++/sentinel.cpp&#34;,
        &#34;src/sw/redis++/shards.cpp&#34;,
        &#34;src/sw/redis++/shards_pool.cpp&#34;,
        &#34;src/sw/redis++/subscriber.cpp&#34;,
        &#34;src/sw/redis++/transaction.cpp&#34;,
        #&#34;src/sw/redis++/tls/tls.cpp&#34;，
    ],
    hdrs = glob([&#34;src/sw/redis++/*.h&#34;])+glob([&#34;src/sw/redis++/*.hpp&#34;])+glob([&#34;src/sw/redis++/cxx17/*.h&#34;])+glob([&#34;src/sw/redis++/no_tls/*.h&#34;]),
    deps = [
    	&#34;//third_party/hiredis:hiredis&#34;,
    	#&#34;//third_party/hiredis:hiredis_ssl&#34;,
    ],
    copts = [&#34;-std=c++17&#34;,],
    visibility = [&#34;//visibility:public&#34;],
)

cc_library(
    name = &#34;async_redis++&#34;,
    srcs = [
        &#34;src/sw/redis++/command.cpp&#34;,
        &#34;src/sw/redis++/command_options.cpp&#34;,
        &#34;src/sw/redis++/connection.cpp&#34;,
        &#34;src/sw/redis++/connection_pool.cpp&#34;,
        &#34;src/sw/redis++/crc16.cpp&#34;,
        &#34;src/sw/redis++/errors.cpp&#34;,
        &#34;src/sw/redis++/pipeline.cpp&#34;,
        &#34;src/sw/redis++/redis.cpp&#34;,
        &#34;src/sw/redis++/redis_cluster.cpp&#34;,
        &#34;src/sw/redis++/reply.cpp&#34;,
        &#34;src/sw/redis++/sentinel.cpp&#34;,
        &#34;src/sw/redis++/shards.cpp&#34;,
        &#34;src/sw/redis++/shards_pool.cpp&#34;,
        &#34;src/sw/redis++/subscriber.cpp&#34;,
        &#34;src/sw/redis++/transaction.cpp&#34;,
        &#34;src/sw/redis++/async_connection.cpp&#34;,
        &#34;src/sw/redis++/async_connection_pool.cpp&#34;,
        &#34;src/sw/redis++/async_redis.cpp&#34;,
        &#34;src/sw/redis++/event_loop.cpp&#34;,
        &#34;src/sw/redis++/async_sentinel.cpp&#34;,
        &#34;src/sw/redis++/async_redis_cluster.cpp&#34;,
        &#34;src/sw/redis++/async_shards_pool.cpp&#34;,
    ],
    #如果使用tls的话，把下面的src/sw/redis++/no_tls/改成src/sw/redis++/tls/，并且把对hiredis_ssl的依赖前面的#去掉
    hdrs = glob([&#34;src/sw/redis++/*.h&#34;])+glob([&#34;src/sw/redis++/*.hpp&#34;])+glob([&#34;src/sw/redis++/cxx17/*.h&#34;])+glob([&#34;src/sw/redis++/no_tls/*.h&#34;])+glob([&#34;src/sw/redis++/future/std/*.h&#34;]),
    deps = [
      &#34;//third_party/hiredis:hiredis&#34;,
      #&#34;//third_party/hiredis:hiredis_ssl&#34;,
      &#34;//third_party/libuv:libuv&#34;,
      ],
    copts = [&#34;-std=c++17&#34;,],
    visibility = [&#34;//visibility:public&#34;],
)
</code></pre><p>编译async & sync的时候，不需要ssl的代码需要修改的patch。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>qcraft@BJ-vgdog:~/code_test/cmake2bazel/third_party/redis-plus-plus$ git diff
</span></span><span class=line><span class=cl><span class=gh>diff --git a/src/sw/redis++/async_connection.h b/src/sw/redis++/async_connection.h
</span></span></span><span class=line><span class=cl><span class=gh>index 6cccb96..5fa3f75 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/src/sw/redis++/async_connection.h
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/sw/redis++/async_connection.h
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -27,8 +27,8 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> #include &#34;connection.h&#34;
</span></span><span class=line><span class=cl> #include &#34;command_args.h&#34;
</span></span><span class=line><span class=cl> #include &#34;event_loop.h&#34;
</span></span><span class=line><span class=cl><span class=gd>-#include &#34;async_utils.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd>-#include &#34;tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+#include &#34;future/std/async_utils.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi>+#include &#34;no_tls/tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> #include &#34;shards.h&#34;
</span></span><span class=line><span class=cl> #include &#34;cmd_formatter.h&#34;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=gh>diff --git a/src/sw/redis++/connection.h b/src/sw/redis++/connection.h
</span></span></span><span class=line><span class=cl><span class=gh>index 3403755..78b9e02 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/src/sw/redis++/connection.h
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/sw/redis++/connection.h
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -28,7 +28,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> #include &#34;errors.h&#34;
</span></span><span class=line><span class=cl> #include &#34;reply.h&#34;
</span></span><span class=line><span class=cl> #include &#34;utils.h&#34;
</span></span><span class=line><span class=cl><span class=gd>-#include &#34;tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+#include &#34;no_tls/tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> namespace sw {
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=gh>diff --git a/src/sw/redis++/sentinel.h b/src/sw/redis++/sentinel.h
</span></span></span><span class=line><span class=cl><span class=gh>index 6f99879..f08d527 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/src/sw/redis++/sentinel.h
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/sw/redis++/sentinel.h
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -25,7 +25,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> #include &#34;connection.h&#34;
</span></span><span class=line><span class=cl> #include &#34;shards.h&#34;
</span></span><span class=line><span class=cl> #include &#34;reply.h&#34;
</span></span><span class=line><span class=cl><span class=gd>-#include &#34;tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+#include &#34;no_tls/tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> namespace sw {
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=gh>diff --git a/src/sw/redis++/utils.h b/src/sw/redis++/utils.h
</span></span></span><span class=line><span class=cl><span class=gh>index f77f796..1d9a624 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/src/sw/redis++/utils.h
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/sw/redis++/utils.h
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -20,7 +20,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> #include &lt;cstring&gt;
</span></span><span class=line><span class=cl> #include &lt;string&gt;
</span></span><span class=line><span class=cl> #include &lt;type_traits&gt;
</span></span><span class=line><span class=cl><span class=gd>-#include &#34;cxx_utils.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+#include &#34;cxx17/cxx_utils.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> namespace sw {
</span></span></code></pre></div><p>编译async & sync的时候使用ssl的diff文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>qcraft@BJ-vgdog:~/code_test/cmake2bazel/third_party/redis-plus-plus$ git diff
</span></span><span class=line><span class=cl><span class=gh>diff --git a/src/sw/redis++/async_connection.h b/src/sw/redis++/async_connection.h
</span></span></span><span class=line><span class=cl><span class=gh>index 6cccb96..b76b2a2 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/src/sw/redis++/async_connection.h
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/sw/redis++/async_connection.h
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -27,8 +27,8 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> #include &#34;connection.h&#34;
</span></span><span class=line><span class=cl> #include &#34;command_args.h&#34;
</span></span><span class=line><span class=cl> #include &#34;event_loop.h&#34;
</span></span><span class=line><span class=cl><span class=gd>-#include &#34;async_utils.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd>-#include &#34;tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+#include &#34;future/std/async_utils.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi>+#include &#34;tls/tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> #include &#34;shards.h&#34;
</span></span><span class=line><span class=cl> #include &#34;cmd_formatter.h&#34;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=gh>diff --git a/src/sw/redis++/connection.h b/src/sw/redis++/connection.h
</span></span></span><span class=line><span class=cl><span class=gh>index 3403755..547ddb3 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/src/sw/redis++/connection.h
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/sw/redis++/connection.h
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -28,7 +28,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> #include &#34;errors.h&#34;
</span></span><span class=line><span class=cl> #include &#34;reply.h&#34;
</span></span><span class=line><span class=cl> #include &#34;utils.h&#34;
</span></span><span class=line><span class=cl><span class=gd>-#include &#34;tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+#include &#34;tls/tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> namespace sw {
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=gh>diff --git a/src/sw/redis++/sentinel.h b/src/sw/redis++/sentinel.h
</span></span></span><span class=line><span class=cl><span class=gh>index 6f99879..2110573 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/src/sw/redis++/sentinel.h
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/sw/redis++/sentinel.h
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -25,7 +25,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> #include &#34;connection.h&#34;
</span></span><span class=line><span class=cl> #include &#34;shards.h&#34;
</span></span><span class=line><span class=cl> #include &#34;reply.h&#34;
</span></span><span class=line><span class=cl><span class=gd>-#include &#34;tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+#include &#34;tls/tls.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> namespace sw {
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=gh>diff --git a/src/sw/redis++/tls/tls.cpp b/src/sw/redis++/tls/tls.cpp
</span></span></span><span class=line><span class=cl><span class=gh>index 1ee4309..0d79a01 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/src/sw/redis++/tls/tls.cpp
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/sw/redis++/tls/tls.cpp
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -15,7 +15,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span>  *************************************************************************/
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> #include &#34;tls.h&#34;
</span></span><span class=line><span class=cl><span class=gd>-#include &#34;errors.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+#include &#34;../errors.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> namespace sw {
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=gh>diff --git a/src/sw/redis++/utils.h b/src/sw/redis++/utils.h
</span></span></span><span class=line><span class=cl><span class=gh>index f77f796..1d9a624 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/src/sw/redis++/utils.h
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/sw/redis++/utils.h
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -20,7 +20,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> #include &lt;cstring&gt;
</span></span><span class=line><span class=cl> #include &lt;string&gt;
</span></span><span class=line><span class=cl> #include &lt;type_traits&gt;
</span></span><span class=line><span class=cl><span class=gd>-#include &#34;cxx_utils.h&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+#include &#34;cxx17/cxx_utils.h&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> namespace sw {
</span></span></code></pre></div><h3 class="relative group">3.2 bazel的学习<div id=32-bazel%E7%9A%84%E5%AD%A6%E4%B9%A0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#32-bazel%E7%9A%84%E5%AD%A6%E4%B9%A0 aria-label=锚点>#</a></span></h3><p>bazel remote cache缓存的信息action和文件，每个 action有inputs, output names, a command line, and environment variables. Required inputs and expected outputs are declared explicitly for each action.</p><p>具体缓存的数据如下，这里注意除了缓存的生成的文件，也缓存具体的std_out和std_err信息，所以test实际上也是缓存的</p><ul><li>action缓存的是一个map，key为action的hash值，value为action result metadata.</li><li>一系列可以进行寻址的文件</li></ul><p>这里面就引入了一个有趣的问题，bazel build &ndash;nobuild到底干了什么?这个问题是因为我今天发现CI rebase了一个同学的代码，然后错误的把直接依赖给去了。直接依赖去了以后bazel build &ndash;nobuild没检测出来代码用了头文件而deps里面没有的问题，然后发现bazel build &ndash;nobuild只是构建build action，也就是只看BUILD，分析里面各种target的关系，但是不看代码里面头文件的引用的。所以没检测出来这个问题。</p><p>那么bazel到底是怎么回事？</p><h3 class="relative group">3.3 bazel的有趣问题<div id=33-bazel%E7%9A%84%E6%9C%89%E8%B6%A3%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#33-bazel%E7%9A%84%E6%9C%89%E8%B6%A3%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h3><h4 class="relative group">3.3.1 bazel sandbox<div id=331-bazel-sandbox class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#331-bazel-sandbox aria-label=锚点>#</a></span></h4><p>sandbox的选择:这两天在用bazel管理一个sh_test的时候遇到了一个有趣的问题，在本地机器跑一个sh_test的时候，能够执行aws login操作(会修改/home/config.json)，而在ci executor上没办法修改/home/config.json，最后发现是因为本地用的是processwrapper-sandbox，而ci机器用的linux-sandbox，linux-sandbox的权限管理更严格。</p><p>问题的解决就变成了两个方向的选择:</p><ul><li>让ci机器也用processwrapper-sandbox</li><li>让ci机器在linux-sandbox里面也能修改/home/config.json</li></ul><p>第一个方法将ci机器和本地机器对齐，这种方法实际上包含着第二种允许改动文件，但是这种对齐是一种比较好的方法。具体手段是在加上加上一个flag:&ndash;spawn_strategy=processwrapper-sandbox，这里要注意个processwrapper-sandbox是offdocument的。</p><p>第二种方法实际上是指定可以修改的路径，但是这个就会导致ci机器和本地机器行为不同，对分析会造成恶劣的影响。使用的flag是&ndash;sandbox_writable_path=xxx</p><h4 class="relative group">3.3.2 记录bazel的输出<div id=332-%E8%AE%B0%E5%BD%95bazel%E7%9A%84%E8%BE%93%E5%87%BA class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#332-%E8%AE%B0%E5%BD%95bazel%E7%9A%84%E8%BE%93%E5%87%BA aria-label=锚点>#</a></span></h4><p>今天有个问题，有一个脚本，编译&运行bazel编译出来的程序，然后定时发送信号测试程序是否退出的错误码正常。我现在想用sh_test来进行管理，这样子能够节省时间，因为如果代码没变依赖没变，那么就可以直接输出缓存的结果。但是在移植的时候有个问题，bazel运行的日志怎么输出呢？答案很简单，如下:</p><pre tabindex=0><code> 2&gt;&amp;1 | tee original_lite_integration_test.log
</code></pre><h4 class="relative group">3.3.3 bazel test group<div id=333-bazel-test-group class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#333-bazel-test-group aria-label=锚点>#</a></span></h4><p>我们目前运行运行test是直接一起运行的，希望能够同时运行不同的test group。直接看了下，似乎没有test group的概念，唯一一个相关的exec group和平台相关。那么如何进行管理呢？翻文档的时候看到https://docs.bazel.build/versions/main/be/common-definitions.html 里面提到了test_suite，所以查了下，具体参考https://docs.bazel.build/versions/main/be/general.html#test_suite</p><p>我们现在的目的是将不同的test_suite执行，其中test_suite A并行的程度为5，test_suite B并行的程度为1.那么是不是需要加上test_shardl呢?</p><h3 class="relative group">3.4 bazel codebase<div id=34-bazel-codebase class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#34-bazel-codebase aria-label=锚点>#</a></span></h3><p>参考的是https://github.com/bazelbuild/bazel/blob/master/CODEBASE.md。可以把下面的看成是翻译和部分对源代码的分析</p><h4 class="relative group">3.4.1 cliet/server架构<div id=341-clietserver%E6%9E%B6%E6%9E%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#341-clietserver%E6%9E%B6%E6%9E%84 aria-label=锚点>#</a></span></h4><p>bazel实际上是client/server架构的服务，客户端为C++，启动时检查是不是有server实例&ndash;检查<code>$OUTPUT_BASE/serve</code>下是不是有lockfile。如果启动配置/输出路径没出错，继续使用server，否则杀掉旧server，新建一个server。server端创建完成，客户端和服务端使用grpc进行通信，每次只能运行一个job。客户端的源代码在下面<code>src/main/cpp</code>，与服务器通信的协议在<code>src/main/protobuf/command_server.proto</code>。服务器的主要入口点是<code>BlazeRuntime.main()</code>，来自客户端的 gRPC 由<code>GrpcServerImpl.run()</code>.调用。</p><h4 class="relative group">3.4.2 目录布局<div id=342-%E7%9B%AE%E5%BD%95%E5%B8%83%E5%B1%80 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#342-%E7%9B%AE%E5%BD%95%E5%B8%83%E5%B1%80 aria-label=锚点>#</a></span></h4><h4 class="relative group">3.4.4 执行命令流程<div id=344-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%B5%81%E7%A8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#344-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%B5%81%E7%A8%8B aria-label=锚点>#</a></span></h4><p>当Bazel 服务器获得控制权并获得需要执行的命令，就会发生以下事件：</p><ol><li><code>BlazeCommandDispatcher</code>被告知新的请求。它检查命令是否需要WORKSPACE才能运行（几乎所有命令，除了与源代码没有任何关系的命令，例如版本或帮助）也会检查目前是否正在运行另一个命令。</li><li>找到需要执行的正确的命令。每个命令都必须实现接口 <code>BlazeCommand</code>并且必须有<code>@Command</code>注解（这有点反模式，如果命令需要的所有元数据都由 on 方法描述就好了<code>BlazeCommand</code>）</li><li>命令行参数被解析。每个命令都有不同的命令行参数，<code>@Command</code>注释中对此进行了描述。</li><li>创建了一个事件总线。事件总线是构建期间发生的事件的流。其中一些在构建事件协议的支持下被导出到 Bazel 之外，以便告诉世界构建是如何进行的。</li><li>待执行的command获得控制权。最有趣的命令是那些运行构建的命令：构建、测试、运行、覆盖等：此功能由<code>BuildTool</code>.实现</li><li>待执行的命令，所涉及到的targets被解析，诸如通配符 <code>//pkg:all</code>和<code>//pkg/...</code>也被解析。这<code>AnalysisPhaseRunner.evaluateTargetPatterns()</code>在 Skyframe 中实现 并具体化为 <code>TargetPatternPhaseValue</code>.</li><li>运行加载/分析阶段(loading/analysis phase) 以生成action图（需要为构建执行的命令的有向无环图）。</li><li>执行阶段运行。这意味着运行构建请求的顶级目标所需的每个操作。</li></ol><h4 class="relative group">3.4.5 命令行选项<div id=345-%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%80%89%E9%A1%B9 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#345-%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%80%89%E9%A1%B9 aria-label=锚点>#</a></span></h4><p>Bazel 调用的命令行选项在一个<code>OptionsParsingResult</code>对象中描述，该对象包含一个从“option classes”到"option"的映射map。“option classes”是<code>OptionsBase</code>的子类和相互关联的命令行选项的组合。例如：</p><ol><li>与编程语言（<code>CppOptions</code>或<code>JavaOptions</code>）相关的选项。这些应该是一个<code>FragmentOptions</code>子类，并最终被包装到一个<code>BuildOptions</code>对象中。</li><li>与 Bazel 执行操作的方式相关的选项 ( <code>ExecutionOptions</code>)</li></ol><p>这些选项旨在用于analysis phase和（通过Java的<code>RuleContext.getFragment()</code> 或Starlark的<code>ctx.fragments</code>）。其中一些（例如，是否执行 C++ 包括扫描）在执行阶段读取，但这始终需要显式管道，因为那时 <code>BuildConfiguration</code>不可用。有关详细信息，请参阅“配置”部分。</p><p>**警告：**我们喜欢假装<code>OptionsBase</code>实例是不可变的并以这种方式使用它们（例如，作为 的一部分<code>SkyKeys</code>）。情况并非如此，修改它们是一种以难以调试的微妙方式破坏 Bazel 的非常好的方法。不幸的是，使它们实际上不可变是一项巨大的努力。（<code>FragmentOptions</code>在其他人有机会保留对它的引用之前，在构造之后立即修改它，<code>equals()</code>或者<code>hashCode()</code>在它被调用之前修改它是可以的。）</p><p>Bazel 通过以下方式获得option class：</p><ol><li>有些是hardcoded到 Bazel ( <code>CommonCommandOptions</code>)</li><li>来自每个 Bazel 命令的 @Command 注释</li><li>From <code>ConfiguredRuleClassProvider</code>（这些是与各个编程语言相关的命令行选项）</li><li>Starlark 规则也可以定义自己的选项（见 <a href=https://docs.bazel.build/versions/main/skylark/config.html target=_blank>这里</a>）</li></ol><p>每个选项（不包括 Starlark 定义的选项）都是<code>FragmentOptions</code>具有<code>@Option</code>注释的子类的成员变量， 该注释指定命令行选项的名称和类型以及一些帮助文本。</p><p>命令行选项值的 Java 类型通常很简单（字符串、整数、布尔值、标签等）。但是，我们也支持更复杂类型的选项；在这种情况下，从命令行字符串转换为数据类型的工作落到了 <code>com.google.devtools.common.options.Converter</code>.</p><h4 class="relative group">3.4.6 存储库<div id=346-%E5%AD%98%E5%82%A8%E5%BA%93 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#346-%E5%AD%98%E5%82%A8%E5%BA%93 aria-label=锚点>#</a></span></h4><p>“存储库”是开发人员在其上工作的源代码树；它通常代表一个项目。Bazel 的祖先 Blaze 在 一个大的整体代码库上运行，即包含任何涉及到的项目的所有源代码的大源码库(就是不能引入外部源码)。相比之下，Bazel 支持源代码跨越多个代码库的项目(可以引入外部代码)。调用 Bazel 的存储库称为“主存储库”，其他存储库称为“外部存储库”。</p><p>存储库由其根目录中名为<code>WORKSPACE</code>（或<code>WORKSPACE.bazel</code>）的文件标记。此文件的内容包含对内部任何BUILD可见的“全局”信息，例如，可用的外部存储库集。它像普通的 Starlark 文件一样工作，这意味着可以使用<code>load()</code>来载入其他 Starlark 文件。这通常用于引入显式引用的存储库所需的存储库（我们称之为“<code>deps.bzl</code>模式”）</p><p>外部存储库的代码通过软连接或下载方式置于 <code>$OUTPUT_BASE/external</code>.</p><p>运行构建时，需要将整个源代码树拼凑在一起；这是由 SymlinkForest 完成的，它将主存储库中的每个包链接到<code>$EXECROOT</code>下，每个外部存储库符号链接到<code>$EXECROOT/external</code>或 <code>$EXECROOT/..</code>（当然前者使得<code>external</code>在主存储库中调用包是不可能的；这就是我们要从它迁移的原因）</p><h4 class="relative group">3.4.7 packages<div id=347-packages class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#347-packages aria-label=锚点>#</a></span></h4><p>每个存储库都由package组成，用于组织文件(集合)并且指定依赖。名为<code>BUILD</code>或 <code>BUILD.bazel</code>的文件用来指定package。如果两者都存在，Bazel 更喜欢<code>BUILD.bazel</code>; BUILD 文件仍然被接受的原因是，Bazel 的祖先 Blaze 使用了这个文件名。</p><p>包是相互独立的：一个包的BUILD文件的改变不会导致其他包的改变。添加或删除 BUILD 文件 _can _change 其他包，因为递归 glob 在包边界处停止，因此 BUILD 文件的存在会停止递归。</p><p>BUILD 文件的评估称为“package loading”。它由class <code>PackageFactory</code>实现，通过调用 Starlark interpreter工作，并且需要了解可用规则类的集合。包加载的结果是一个<code>Package</code>对象。它主要是从字符串（目标名称）到目标本身的映射。</p><p>包加载过程中的一大块内容是和globbing相关的：Bazel 不需要显式列出每个源文件，而是可以运行 glob（例如<code>glob(["**/*.java"])</code>）。与 shell 不同，它支持下降到子目录（但不下降到子package）的递归 glob。这需要访问文件系统，因为这可能会很慢，所以我们实施了各种技巧以使其尽可能高效地并行运行。</p><p>Globbing 在以下类中实现：</p><ul><li><code>LegacyGlobber</code>，一个快速而幸福的Skyframe-unaware 不知道的 globber</li><li><code>SkyframeHybridGlobber</code>，一个使用 Skyframe 并恢复到旧 globber 的版本，以避免“Skyframe 重新启动”（如下所述）</li></ul><p>在<code>Package</code>类本身包含一些成员，专门用于分析工作区文件并没有真正的包才有意义。这是一个设计缺陷，因为描述常规包的对象不应包含描述其他内容的字段。这些包括：</p><ul><li>存储库映射</li><li>注册的工具链</li><li>注册的执行平台</li></ul><p>理想情况下，解析 WORKSPACE 文件与解析常规包之间会有更多的分离，因此<code>Package</code>不需要同时满足两者的需求。不幸的是，这很难做到，因为这两者交织得很深。</p><h3 class="relative group">标签、目标和规则<div id=%E6%A0%87%E7%AD%BE%E7%9B%AE%E6%A0%87%E5%92%8C%E8%A7%84%E5%88%99 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%A0%87%E7%AD%BE%E7%9B%AE%E6%A0%87%E5%92%8C%E8%A7%84%E5%88%99 aria-label=锚点>#</a></span></h3><p>包由目标组成，这些目标具有以下类型：</p><ol><li>**文件：**作为构建的输入或输出的东西。在 Bazel 的说法中，我们称它们为<em>人工制品</em>（在别处讨论过）。并非所有在构建期间创建的文件都是目标；Bazel 的输出通常没有关联的标签。</li><li>**规则：**这些描述了从输入中导出其输出的步骤。它们通常与编程语言相关联（例如<code>cc_library</code>， <code>java_library</code>或<code>py_library</code>），但也有一些与语言无关的（例如，<code>genrule</code>或<code>filegroup</code>）</li><li>**包组：**在<a href=https://github.com/bazelbuild/bazel/blob/master/CODEBASE.md#visibility target=_blank>可见性</a>部分讨论。</li></ol><p>目标的名称称为<em>标签</em>。标签的语法是<code>@repo//pac/kage:name</code>，其中<code>repo</code>是标签 所在的存储库的名称，<code>pac/kage</code>是它的 BUILD 文件所在的目录，是<code>name</code>文件相对于包目录的路径（如果标签是指源文件） . 在命令行上引用目标时，标签的某些部分可以省略：</p><ol><li>如果省略了存储库，则将标签视为在主存储库中。</li><li>如果省略了包部分（例如<code>name</code>或<code>:name</code>），则将标签视为当前工作目录的包中（不允许包含上级引用 (..) 的相对路径）</li></ol><p>一种规则（例如“C++ 库”）称为“规则类”。规则类可以在 Starlark（<code>rule()</code>函数）或 Java（所谓的“原生规则”，type <code>RuleClass</code>）中实现。从长远来看，每个特定语言的规则都将在 Starlark 中实现，但一些遗留规则系列（例如 Java 或 C++）暂时仍使用 Java。</p><p>Starlark 规则类需要在 BUILD 文件的开头使用<code>load()</code>语句导入，而 Java 规则类是 Bazel “天生”知道的，因为它是在<code>ConfiguredRuleClassProvider</code>.</p><p>规则类包含以下信息：</p><ol><li>它的属性（如<code>srcs</code>，<code>deps</code>）：它们的类型，默认值，约束等</li><li>附加到每个属性的配置转换和方面（如果有）</li><li>规则的实施</li><li>规则“通常”创建的传递信息提供者</li></ol><p>**术语说明：**在代码库中，我们经常使用“规则”来表示由规则类创建的目标。但在 Starlark 和面向用户的文档中，“Rule”应该专门用于指代规则类本身；目标只是一个“目标”。另请注意，尽管名称中<code>RuleClass</code>有“类”，但规则类和该类型的目标之间没有 Java 继承关系。</p><ul><li>bazel</li><li>genrule，可以关注https://github.com/bazelbuild/examples/tree/main/rules, <a href=https://docs.bazel.build/versions/main/be/general.html#genrule target=_blank>https://docs.bazel.build/versions/main/be/general.html#genrule</a></li></ul><p>Bazel 底层的评估框架称为 Skyframe。它的模型是，在构建过程中需要构建的所有内容都被组织成一个有向无环图，其边从任何数据片段指向其依赖项，即构建它需要知道的其他数据片段。</p><p>图中的节点称为<code>SkyValue</code>s，它们的名称称为 <code>SkyKey</code>s。两者都是不可变的，即只有不可变的对象应该可以从它们访问。这个不变量几乎总是成立，如果它不成立（例如，对于单个选项类<code>BuildOptions</code>，它是<code>BuildConfigurationValue</code>及其成员 <code>SkyKey</code>），我们非常努力地不改变它们或仅以无法从观察到的方式改变它们外部。由此可见，在 Skyframe 中计算的所有内容（例如配置的目标）也必须是不可变的。</p><p>观察 Skyframe 图形最方便的方法是运行<code>bazel dump --skyframe=detailed</code>，它会转储图形，<code>SkyValue</code>每行一个。最好为小型构建执行此操作，因为它可能会变得非常大。</p><p>Skyframe 位于<code>com.google.devtools.build.skyframe</code>包装中。类似名称的包<code>com.google.devtools.build.lib.skyframe</code>包含在 Skyframe 之上的 Bazel 实现。有关 Skyframe 的更多信息，请<a href=https://bazel.build/designs/skyframe.html target=_blank>点击此处</a>。</p><p>生成一个新的<code>SkyValue</code>涉及以下步骤：</p><ol><li>运行相关联 <code>SkyFunction</code></li><li>声明需要完成其工作的依赖项（即<code>SkyValue</code>s）<code>SkyFunction</code>。这是通过调用 <code>SkyFunction.Environment.getValue()</code>.</li><li>如果依赖项不可用，Skyframe 会通过从<code>getValue()</code>. 在这种情况下，<code>SkyFunction</code>期望通过返回 null 将控制权交给 Skyframe，然后 Skyframe 评估尚未评估的依赖项并<code>SkyFunction</code> 再次调用，从而返回 (1)。</li><li>构建结果 <code>SkyValue</code></li></ol><p>这样做的结果是，如果在 (3) 中并非所有依赖项都可用，则需要完全重新启动函数，因此需要重新进行计算，这显然是低效的。<code>SkyFunction.Environment.getState()</code> 让我们通过让 Skyframe<code>SkyKeyComputeState</code>在<code>SkyFunction.compute</code>对相同的调用之间维护实例来直接解决这个问题 <code>SkyKey</code>。查看 javadoc 中的示例 <code>SkyFunction.Environment.getState()</code>，以及 Bazel 代码库中的实际用法。</p><p>其他间接解决方法：</p><ol><li><code>SkyFunction</code>在组中声明s 的依赖关系，这样如果一个函数有 10 个依赖关系，它只需要重新启动一次而不是十次。</li><li>拆分<code>SkyFunction</code>s 使得一个功能不需要多次重启。这具有将数据实习到可能是内部的 Skyframe 的副作用<code>SkyFunction</code>，从而增加了内存使用。</li></ol><p>这些只是针对 Skyframe 限制的解决方法，这主要是由于 Java 不支持轻量级线程并且我们通常有数十万个运行中的 Skyframe 节点。</p><h2 class="relative group">星雀<div id=%E6%98%9F%E9%9B%80 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%98%9F%E9%9B%80 aria-label=锚点>#</a></span></h2><p>Starlark 是人们用来配置和扩展 Bazel 的特定领域语言。它被认为是 Python 的一个受限子集，它的类型少得多，对控制流的限制更多，最重要的是，强大的不变性保证可以实现并发读取。它不是图灵完备的，这会阻止一些（但不是所有）用户尝试在该语言中完成一般的编程任务。</p><p>Starlark 在<code>com.google.devtools.build.lib.syntax</code>包中实现。它<a href=https://github.com/google/starlark-go target=_blank>在这里</a>也有一个独立的 Go 实现 。Bazel 中使用的 Java 实现目前是一个解释器。</p><p>Starlark 在四种情况下使用：</p><ol><li>**构建语言。**这是定义新规则的地方。在此上下文中运行的 Starlark 代码只能访问 BUILD 文件本身和由它加载的 Starlark 文件的内容。</li><li>**规则定义。**这就是新规则（例如对新语言的支持）的定义方式。在此上下文中运行的 Starlark 代码可以访问其直接依赖项提供的配置和数据（稍后会详细介绍）。</li><li>**工作空间文件。**这是定义外部存储库（不在主源代码树中的代码）的地方。</li><li>**存储库规则定义。**这是定义新的外部存储库类型的地方。在此上下文中运行的 Starlark 代码可以在运行 Bazel 的机器上运行任意代码，并到达工作区之外。</li></ol><p>BUILD 和 .bzl 文件可用的方言略有不同，因为它们表达不同的东西。<a href=https://docs.bazel.build/versions/main/skylark/language.html#differences-between-build-and-bzl-files target=_blank>此处</a>提供了差异列表 。</p><p>有关 Starlark 的更多信息，请 <a href=https://docs.bazel.build/versions/main/skylark/language.html target=_blank>点击此处</a>。</p><h2 class="relative group">加载/分析阶段<div id=%E5%8A%A0%E8%BD%BD%E5%88%86%E6%9E%90%E9%98%B6%E6%AE%B5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%8A%A0%E8%BD%BD%E5%88%86%E6%9E%90%E9%98%B6%E6%AE%B5 aria-label=锚点>#</a></span></h2><p>加载/分析阶段是 Bazel 确定构建特定规则所需的操作的地方。它的基本单元是一个“已配置的目标”，相当明智地是一个（目标，配置）对。</p><p>它被称为“加载/分析阶段”，因为它可以分为两个不同的部分，这些部分过去是序列化的，但现在它们可以在时间上重叠：</p><ol><li>加载包，即将BUILD文件转换为<code>Package</code>代表它们的对象</li><li>分析配置的目标，即运行规则的实现以生成动作图</li></ol><p>在命令行上请求的已配置目标的传递闭包中的每个已配置目标都必须自下而上进行分析，即首先分析叶节点，然后再分析命令行上的叶节点。分析单个配置目标的输入是：</p><ol><li><strong>配置。</strong>（“如何”构建该规则；例如，目标平台以及用户希望传递给 C++ 编译器的命令行选项）</li><li>**直接依赖。**他们的传递信息提供者可用于正在分析的规则。之所以这样称呼它们，是因为它们在已配置目标的传递闭包中提供了信息的“汇总”，例如类路径上的所有 .jar 文件或需要链接到 C++ 二进制文件中的所有 .o 文件)</li><li><strong>目标本身</strong>。这是加载目标所在包的结果。对于规则，这包括它的属性，这通常是最重要的。</li><li>**配置目标的执行。**对于规则，这可以是 Starlark 或 Java。所有非规则配置的目标都是用 Java 实现的。</li></ol><p>分析已配置目标的输出是：</p><ol><li>配置依赖于它的目标的传递信息提供者可以访问</li><li>它可以创建的工件以及产生它们的操作。</li></ol><p>提供给 Java 规则的 API 是<code>RuleContext</code>，相当于<code>ctx</code>Starlark 规则的 参数。它的 API 更强大，但同时更容易做 Bad Things™，例如编写时间或空间复杂度为二次（或更糟）的代码，使 Bazel 服务器因 Java 异常而崩溃或违反不变量（例如通过无意中修改 <code>Options</code>实例或使配置的目标可变）</p><p>确定已配置目标的直接依赖关系的算法位于<code>DependencyResolver.dependentNodeMap()</code>.</p><h3 class="relative group">配置<div id=%E9%85%8D%E7%BD%AE class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%85%8D%E7%BD%AE aria-label=锚点>#</a></span></h3><p>配置是构建目标的“方式”：针对什么平台，使用什么命令行选项等。</p><p>可以在同一构建中为多个配置构建相同的目标。这很有用，例如，当相同的代码用于构建期间运行的工具和目标代码并且我们正在交叉编译或构建胖 Android 应用程序（包含用于多 CPU 的本机代码的应用程序时）架构）</p><p>从概念上讲，配置是一个<code>BuildOptions</code>实例。然而，在实践中，<code>BuildOptions</code>被包裹通过<code>BuildConfiguration</code>其提供的功能的附加杂件。它从依赖图的顶部传播到底部。如果它发生变化，则需要重新分析构建。</p><p>这会导致异常，例如，如果请求的测试运行的数量发生变化，则必须重新分析整个构建，即使这只影响测试目标（我们计划“修剪”配置，因此情况并非如此，但事实并非如此准备好了吗）</p><p>当规则实现需要配置的一部分时，它需要在其定义中使用<code>RuleClass.Builder.requiresConfigurationFragments()</code> . 这既是为了避免错误（例如使用 Java 片段的 Python 规则），也是为了便于配置调整，以便例如如果 Python 选项发生变化，则无需重新分析 C++ 目标。</p><p>规则的配置不一定与其“父”规则的配置相同。在依赖边缘中更改配置的过程称为“配置转换”。它可能发生在两个地方：</p><ol><li>在依赖边缘。这些转换在<code>Attribute.Builder.cfg()</code>a <code>Rule</code>（发生转换的地方）和 a <code>BuildOptions</code>（原始配置）到一个或多个<code>BuildOptions</code>（输出配置）中指定 并且是函数。</li><li>在配置目标的任何传入边缘上。这些在 中指定 <code>RuleClass.Builder.cfg()</code>。</li></ol><p>相关类是<code>TransitionFactory</code>和<code>ConfigurationTransition</code>。</p><p>使用配置转换，例如：</p><ol><li>声明在构建期间使用了特定的依赖项，因此应该在执行架构中构建它</li><li>声明必须为多种架构构建特定依赖项（例如，对于胖 Android APK 中的本机代码）</li></ol><p>如果配置转换导致多个配置，则称为 <em>拆分转换。</em></p><p>配置转换也可以在 Starlark 中实现（<a href=https://docs.bazel.build/versions/main/skylark/config.html target=_blank>此处的</a>文档 ）</p><h3 class="relative group">传递信息提供者<div id=%E4%BC%A0%E9%80%92%E4%BF%A1%E6%81%AF%E6%8F%90%E4%BE%9B%E8%80%85 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BC%A0%E9%80%92%E4%BF%A1%E6%81%AF%E6%8F%90%E4%BE%9B%E8%80%85 aria-label=锚点>#</a></span></h3><p>传递信息提供者是配置目标的一种方式（和 _only _way），用于告诉依赖它的其他配置目标。“传递”在他们的名字中的原因是这通常是配置目标的传递闭包的某种汇总。</p><p>Java 传递信息提供者和 Starlark 提供者之间通常存在 1:1 的对应关系（例外是<code>DefaultInfo</code>它是 的合并 <code>FileProvider</code>，<code>FilesToRunProvider</code>并且<code>RunfilesProvider</code>因为该 API 被认为比 Java 的直接音译更类似于 Starlark）。他们的关键是以下事情之一：</p><ol><li>Java 类对象。这仅适用于无法从 Starlark 访问的提供商。这些提供程序是 <code>TransitiveInfoProvider</code>.</li><li>一个字符串。这是遗留问题并且非常不鼓励，因为它容易受到名称冲突的影响。这种传递信息提供者是 <code>build.lib.packages.Info</code>.</li><li>提供者符号。这可以使用该<code>provider()</code> 函数从 Starlark 创建，并且是创建新提供程序的推荐方法。该符号由<code>Provider.Key</code>Java 中的实例表示。</li></ol><p>用 Java 实现的新提供者应该使用<code>BuiltinProvider</code>. <code>NativeProvider</code>已弃用（我们还没有时间删除它）并且 <code>TransitiveInfoProvider</code>无法从 Starlark 访问子类。</p><h3 class="relative group">配置的目标<div id=%E9%85%8D%E7%BD%AE%E7%9A%84%E7%9B%AE%E6%A0%87 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%85%8D%E7%BD%AE%E7%9A%84%E7%9B%AE%E6%A0%87 aria-label=锚点>#</a></span></h3><p>配置的目标实现为<code>RuleConfiguredTargetFactory</code>. 在 Java 中实现的每个规则类都有一个子类。Starlark 配置的目标是通过<code>StarlarkRuleConfiguredTargetUtil.buildRule()</code>.</p><p>配置的目标工厂应该<code>RuleConfiguredTargetBuilder</code>用来构造它们的返回值。它由以下内容组成：</p><ol><li>它们<code>filesToBuild</code>，即“这条规则所代表的文件集”的模糊概念。这些是在配置的目标位于命令行或 genrule 的 srcs 时构建的文件。</li><li>他们的运行文件，常规和数据。</li><li>他们的输出组。这些是规则可以构建的各种“其他文件集”。可以使用 BUILD 中的文件组规则的 output_group 属性和使用<code>OutputGroupInfo</code>Java 中的提供程序来访问它们。</li></ol><h3 class="relative group">运行文件<div id=%E8%BF%90%E8%A1%8C%E6%96%87%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BF%90%E8%A1%8C%E6%96%87%E4%BB%B6 aria-label=锚点>#</a></span></h3><p>一些二进制文件需要数据文件才能运行。一个突出的例子是需要输入文件的测试。这在 Bazel 中由“运行文件”的概念表示。“运行文件树”是特定二进制文件的数据文件的目录树。它在文件系统中创建为符号链接树，其中单个符号链接指向输出树源中的文件。</p><p>一组运行文件表示为一个<code>Runfiles</code>实例。从概念上讲，它是从运行文件树中的文件路径到<code>Artifact</code>表示它的实例的映射。它比单一的<code>Map</code>要复杂一些，原因有两个：</p><ul><li>大多数时候，文件的运行文件路径与其执行路径相同。我们用它来节省一些 RAM。</li><li>运行文件树中有各种遗留类型的条目，它们也需要表示。</li></ul><p>运行文件使用<code>RunfilesProvider</code>以下方法收集：此类的一个实例表示配置目标（例如库）及其传递闭包需要的运行文件，它们像嵌套集一样被收集（实际上，它们是使用嵌套集实现的）：每个目标联合其依赖的运行文件，添加一些自己的，然后将结果集向上发送到依赖图中。一个<code>RunfilesProvider</code>实例包含两个<code>Runfiles</code> 实例，一个用于当规则通过“数据”属性依赖时，一个用于所有其他类型的传入依赖。这是因为目标有时会在通过数据属性依赖时呈现不同的运行文件。这是我们尚未消除的不良遗留行为。</p><p>二进制文件的运行文件表示为<code>RunfilesSupport</code>. 这不同于<code>Runfiles</code>因为<code>RunfilesSupport</code>具有实际构建的能力（不像<code>Runfiles</code>，它只是一个映射）。这需要以下附加组件：</p><ul><li>**输入运行文件清单。**这是运行文件树的序列化描述。它用作运行文件树内容的代理，Bazel 假设当且仅当清单的内容发生更改时，运行文件树才会更改。</li><li>**输出运行文件清单。**这由处理运行文件树的运行时库使用，特别是在 Windows 上，有时不支持符号链接。</li><li>**运行文件中间人。**为了存在运行文件树，需要构建符号链接树和符号链接指向的工件。为了减少依赖边的数量，可以使用运行文件中间人来表示所有这些。</li><li>用于运行<code>RunfilesSupport</code>对象所代表的运行文件的二进制文件的 <strong>命令行参数</strong>。</li></ul><h3 class="relative group">aspect<div id=aspect class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#aspect aria-label=锚点>#</a></span></h3><p>aspect是一种“沿着依赖图传播并执行相关操作”的方法。说人话就是，它可以用来增加构建依赖图的额外信息和操作。一般来说，我们使用aspect往往是为了能够在规则的基础上进行拓展执行一些其它的操作，比方说用到了哪些代码？怎么做代码检查</p><p>When a rule declares an attribute that uses an aspect such as <code>attr.label(aspects = ['foo_aspect']</code>, bazel looks at the definition of the aspect to see what attributes it propogates down. For example, it might say <code>attr_aspects = ['deps]</code>.</p><p>When that rule is invoked, bazel will:</p><ol><li>Traverse down the dependency graph from the originating rule in depth-first fashion, following edges named &lsquo;deps&rsquo;.</li><li>Apply the aspect rule to each matched rule (in this example <code>java_library</code> and <code>java_binary</code>).</li></ol><p>As an aspect implementor, your job is to:</p><ol><li>Get oriented to the kind of rule you are visiting via <code>aspect_ctx.rule.kind</code> property.</li><li>Do something (<code>ctx.file_action</code>, <code>ctx.action</code>, etc..).</li><li>Collect a transitive set of generated output files and pass them off somewhere to be consumed (either from the command line or a another rule).</li></ol><h2 class="relative group"><div id=heading class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#heading aria-label=锚点>#</a></span></h2><p>很多细节的问题可以参考https://github.com/pcj/bazel_aspects</p><h3 class="relative group">平台和工具链<div id=%E5%B9%B3%E5%8F%B0%E5%92%8C%E5%B7%A5%E5%85%B7%E9%93%BE class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%B9%B3%E5%8F%B0%E5%92%8C%E5%B7%A5%E5%85%B7%E9%93%BE aria-label=锚点>#</a></span></h3><p>Bazel 支持多平台构建，即在可能存在运行构建操作的多个体系结构和为其构建代码的多个体系结构的情况下构建。这些架构在 Bazel 用语中被称为<em>平台</em>（完整文档 <a href=https://docs.bazel.build/versions/main/platforms.html target=_blank>在这里</a>）</p><p>平台由从<em>约束设置</em>（例如“CPU 架构”的概念）到<em>约束值</em>（例如 x86_64 等特定 CPU）的键值映射来描述。我们有一个<code>@platforms</code>存储库中最常用的约束设置和值的“字典” 。</p><p><em>工具链</em>的概念来源于这样一个事实：根据构建运行的平台和目标平台，可能需要使用不同的编译器；例如，特定的 C++ 工具链可能在特定的操作系统上运行，并且能够以其他一些操作系统为目标。Bazel 必须根据设置的执行和目标平台确定使用的 C++ 编译器（<a href=https://docs.bazel.build/versions/main/toolchains.html target=_blank>此处</a>的工具链文档 ）。</p><p>为了做到这一点，工具链使用它们支持的一组执行和目标平台约束进行注释。为了做到这一点，工具链的定义分为两部分：</p><ol><li>甲<code>toolchain()</code>的工具链它是描述该组的执行和目标约束的工具链载体和一种告诉什么规则（例如C ++或Java）（后者是由表示<code>toolchain_type()</code>规则）</li><li>描述实际工具链的特定语言规则（例如 <code>cc_toolchain()</code>）</li></ol><p>这样做是因为我们需要知道每个工具链的约束才能进行工具链解析，并且特定于语言的 <code>*_toolchain()</code>规则包含比这更多的信息，因此它们需要更多时间来加载。</p><p>执行平台通过以下方式之一指定：</p><ol><li>在WORKSPACE文件中使用<code>register_execution_platforms()</code>函数</li><li>在命令行上使用 &ndash;extra_execution_platforms 命令行选项</li></ol><p>可用执行平台的集合在 中计算 <code>RegisteredExecutionPlatformsFunction</code>。</p><p>已配置目标的目标平台由 确定 <code>PlatformOptions.computeTargetPlatform()</code>。这是一个平台列表，因为我们最终希望支持多个目标平台，但它还没有实现。</p><p>用于已配置目标的工具链集由 确定 <code>ToolchainResolutionFunction</code>。它是以下功能：</p><ul><li>已注册的工具链集（在 WORKSPACE 文件和配置中）</li><li>所需的执行和目标平台（在配置中）</li><li>已配置目标所需的工具链类型集（在 <code>UnloadedToolchainContextKey)</code></li><li>配置的目标（<code>exec_compatible_with</code>属性）和配置（<code>--experimental_add_exec_constraints_to_targets</code>）的执行平台约束集 ，在 <code>UnloadedToolchainContextKey</code></li></ul><p>其结果是<code>UnloadedToolchainContext</code>，它本质上是从工具链类型（表示为<code>ToolchainTypeInfo</code>实例）到所选工具链的标签的映射。它被称为“卸载”，因为它不包含工具链本身，只包含它们的标签。</p><p>然后工具链被实际加载<code>ResolvedToolchainContext.load()</code> 并由请求它们的配置目标的实现使用。</p><p>我们还有一个遗留系统，它依赖于一个单一的“主机”配置和由各种配置标志表示的目标配置，例如<code>--cpu</code>. 我们正在逐步过渡到上述系统。为了处理人们依赖旧配置值的情况，我们实施了“<a href=https://docs.google.com/document/d/1Vg_tPgiZbSrvXcJ403vZVAGlsWhH9BUDrAxMOYnO0Ls target=_blank>平台映射</a>”来在旧标志和新型平台约束之间进行转换。他们的代码在<code>PlatformMappingFunction</code>并使用非 Starlark 的“小语言”。</p><h3 class="relative group">约束<div id=%E7%BA%A6%E6%9D%9F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%BA%A6%E6%9D%9F aria-label=锚点>#</a></span></h3><p>有时，人们希望将目标指定为仅与少数几个平台兼容。Bazel（不幸的是）有多种机制来实现这一目标：</p><ul><li>特定于规则的约束</li><li><code>environment_group()</code> / <code>environment()</code></li><li>平台限制</li></ul><p>特定于规则的约束主要在 Google for Java 规则中使用；它们即将退出，在 Bazel 中不可用，但源代码可能包含对它的引用。控制这一点的属性称为 <code>constraints=</code>。</p><h4 class="relative group">environment_group() 和 environment()<div id=environment_group-%E5%92%8C-environment class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#environment_group-%E5%92%8C-environment aria-label=锚点>#</a></span></h4><p>这些规则是一种遗留机制，并未广泛使用。</p><p>所有构建规则都可以声明它们可以为哪些“环境”构建，其中“环境”是<code>environment()</code>规则的一个实例。</p><p>可以通过多种方式为规则指定支持的环境：</p><ol><li>通过<code>restricted_to=</code>属性。这是最直接的规范形式；它声明了规则支持该组的确切环境集。</li><li>通过<code>compatible_with=</code>属性。除了默认支持的“标准”环境之外，这还声明了规则支持的环境。</li><li>通过包级属性<code>default_restricted_to=</code>和 <code>default_compatible_with=</code>.</li><li>通过<code>environment_group()</code>规则中的默认规范。每个环境都属于一组主题相关的对等体（例如“CPU 架构”、“JDK 版本”或“移动操作系统”）。如果<code>restricted_to=</code>/<code>environment()</code>属性没有另外指定，环境组的定义包括“默认”应支持哪些环境 。没有此类属性的规则将继承所有默认值。</li><li>通过规则类默认。这会覆盖给定规则类的所有实例的全局默认值。例如，这可以用于使所有<code>*_test</code>规则都可测试，而无需每个实例都必须显式声明此功能。</li></ol><p><code>environment()</code>是作为常规规则实现的，而<code>environment_group()</code> 它既是<code>Target</code>但不是<code>Rule</code>( <code>EnvironmentGroup</code>)的子类，也是默认情况下可从 Starlark ( <code>StarlarkLibrary.environmentGroup()</code>)获得的函数，最终创建同名目标。这是为了避免出现循环依赖，因为每个环境都需要声明它所属的环境组，每个环境组都需要声明其默认环境。</p><p>可以使用<code>--target_environment</code>命令行选项将构建限制在特定环境中 。</p><p>约束检查的实现在 <code>RuleContextConstraintSemantics</code>和 中<code>TopLevelConstraintSemantics</code>。</p><h4 class="relative group">平台限制<div id=%E5%B9%B3%E5%8F%B0%E9%99%90%E5%88%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%B9%B3%E5%8F%B0%E9%99%90%E5%88%B6 aria-label=锚点>#</a></span></h4><p>当前描述目标与哪些平台兼容的“官方”方式是使用用于描述工具链和平台的相同约束。它在 pull request <a href=https://github.com/bazelbuild/bazel/pull/10945 target=_blank>#10945 中</a>正在审查中 。</p><h3 class="relative group">能见度<div id=%E8%83%BD%E8%A7%81%E5%BA%A6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%83%BD%E8%A7%81%E5%BA%A6 aria-label=锚点>#</a></span></h3><p>如果您与许多开发人员（例如在 Google）一起使用大型代码库，您不一定希望其他人都能够依赖您的代码，以便您保留更改您认为是实现细节的事情的自由（否则，根据<a href=https://www.hyrumslaw.com/ target=_blank>Hyrum 定律</a>，人们 <em>将</em>依赖您代码的所有部分）。</p><p>Bazel 通过称为 _visibility 的机制支持这一点：_you 可以声明一个特定的规则只能依赖于使用 visibility 属性（<a href=https://docs.bazel.build/versions/main/be/common-definitions.html#common-attributes target=_blank>此处的</a>文档 ）。这个属性有点特别，因为与其他所有属性不同，它生成的依赖集不仅仅是列出的标签集（是的，这是一个设计缺陷）。</p><p>这是在以下地方实现的：</p><ul><li>该<code>RuleVisibility</code>接口表示可见性声明。它可以是常量（完全公开或完全私有）或标签列表。</li><li>标签可以指包组（包的预定义列表）、包直接（<code>//pkg:__pkg__</code>）或包的子树（<code>//pkg:__subpackages__</code>）。这与使用<code>//pkg:*</code>or的命令行语法不同<code>//pkg/...</code>。</li><li>包组被实现为它们自己的目标和配置的目标类型（<code>PackageGroup</code>和<code>PackageGroupConfiguredTarget</code>）。如果我们愿意，我们可能可以用简单的规则替换这些。</li><li>从可见性标签列表到依赖<code>DependencyResolver.visitTargetVisibility</code>项的转换在 其他一些地方完成。</li><li>实际检查是在 <code>CommonPrerequisiteValidator.validateDirectPrerequisiteVisibility()</code></li></ul><h3 class="relative group">嵌套集<div id=%E5%B5%8C%E5%A5%97%E9%9B%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%B5%8C%E5%A5%97%E9%9B%86 aria-label=锚点>#</a></span></h3><p>通常，已配置的目标从其依赖项中聚合一组文件，添加自己的文件，并将聚合集包装到传递信息提供程序中，以便依赖于它的已配置目标可以执行相同的操作。例子：</p><ul><li>用于构建的 C++ 头文件</li><li>表示传递闭包的目标文件 <code>cc_library</code></li><li>Java 规则编译或运行需要位于类路径上的一组 .jar 文件</li><li>Python 规则的传递闭包中的 Python 文件集</li></ul><p>如果我们通过使用 eg<code>List</code>或以天真的方式做到这一点<code>Set</code>，我们最终会得到二次内存使用：如果有 N 条规则链并且每个规则添加一个文件，我们将有 1+2+&mldr;+N收藏成员。</p><p>为了解决这个问题，我们提出了 a 的概念 <code>NestedSet</code>。它是一种数据结构，由其他<code>NestedSet</code> 实例和它自己的一些成员组成，从而形成集合的有向无环图。它们是不可变的，它们的成员可以被迭代。我们定义了多次迭代顺序（<code>NestedSet.Order</code>）：前序、后序、拓扑（一个节点总是在其祖先之后）和“不关心，但每次都应该相同”。</p><p><code>depset</code>Starlark 中调用了相同的数据结构。</p><h3 class="relative group">工件和动作<div id=%E5%B7%A5%E4%BB%B6%E5%92%8C%E5%8A%A8%E4%BD%9C class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%B7%A5%E4%BB%B6%E5%92%8C%E5%8A%A8%E4%BD%9C aria-label=锚点>#</a></span></h3><p>实际构建包含一组需要运行以生成用户想要的输出的命令。命令表示为类的实例，<code>Action</code>文件表示为类的实例 <code>Artifact</code>。它们排列在称为“动作图”的二分、有向、无环图中。</p><p>工件有两种：源工件（即在 Bazel 开始执行之前可用的工件）和派生工件（需要构建的工件）。派生的工件本身可以是多种：</p><ol><li>**常规文物。**通过计算它们的校验和来检查它们的最新性，mtime 作为快捷方式；如果文件的 ctime 没有改变，我们不会对文件进行校验和。</li><li>**未解决的符号链接工件。**通过调用 readlink() 检查它们的最新性。与常规工件不同，这些可以是悬空符号链接。通常用于将一些文件打包成某种档案的情况。</li><li>**树神器。**这些不是单个文件，而是目录树。通过检查其中的文件集及其内容来检查它们的最新性。它们表示为<code>TreeArtifact</code>.</li><li>**恒定的元数据工件。**对这些工件的更改不会触发重建。这仅用于构建标记信息：我们不想仅仅因为当前时间改变而进行重建。</li></ol><p>源构件不能是树构件或未解析的符号链接构件没有根本原因，只是我们还没有实现它（不过，我们应该——在 BUILD 文件中引用源目录是少数已知的长期项目之一—— Bazel 存在不正确的问题；我们有一个由<code>BAZEL_TRACK_SOURCE_DIRECTORIES=1</code>JVM 属性启用的实现 ）</p><p>一种值得注意的<code>Artifact</code>是中间人。它们由<code>Artifact</code> 作为 的输出的实例指示<code>MiddlemanAction</code>。它们用于特殊情况：</p><ul><li>聚合中间人用于将工件组合在一起。这样一来，如果很多动作使用相同的大输入集，我们就没有 N*M 依赖边，只有 N+M（它们被嵌套集替换）</li><li>调度依赖中间人确保一个动作在另一个动作之前运行。它们主要用于 linting，但也用于 C++ 编译（参见 <code>CcCompilationContext.createMiddleman()</code>解释）</li><li>运行文件中间人用于确保运行文件树的存在，这样就不需要单独依赖输出清单和运行文件树引用的每个工件。</li></ul><p>最好将操作理解为需要运行的命令、它需要的环境以及它产生的一组输出。以下是动作描述的主要组成部分：</p><ul><li>需要运行的命令行</li><li>它需要的输入工件</li><li>需要设置的环境变量</li><li>描述它需要在 \ 中运行的环境（例如平台）的注释</li></ul><p>还有一些其他特殊情况，例如编写内容为 Bazel 所知的文件。它们是 的子类<code>AbstractAction</code>。大多数动作都是一个<code>SpawnAction</code>或一个<code>StarlarkAction</code>（同样，他们应该可以说是没有独立的类），尽管Java和C ++有自己的操作类型（<code>JavaCompileAction</code>，<code>CppCompileAction</code>和<code>CppLinkAction</code>）。</p><p>我们最终希望将所有内容移至<code>SpawnAction</code>; <code>JavaCompileAction</code>非常接近，但是由于 .d 文件解析和包含扫描，C++ 有点特殊。</p><p>动作图主要“嵌入”到 Skyframe 图中：从概念上讲，动作的执行表示为对 <code>ActionExecutionFunction</code>. 从动作图依赖边到 Skyframe 依赖边的映射在 中进行了描述 <code>ActionExecutionFunction.getInputDeps()</code>，<code>Artifact.key()</code>并进行了一些优化，以保持 Skyframe 边的数量较少：</p><ul><li>派生的工件没有自己的<code>SkyValue</code>s。相反， <code>Artifact.getGeneratingActionKey()</code>用于找出生成它的操作的关键</li><li>嵌套集有自己的 Skyframe 键。</li></ul><h3 class="relative group">共享操作<div id=%E5%85%B1%E4%BA%AB%E6%93%8D%E4%BD%9C class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%85%B1%E4%BA%AB%E6%93%8D%E4%BD%9C aria-label=锚点>#</a></span></h3><p>一些动作是由多个配置的目标生成的；Starlark 规则受到更多限制，因为它们只允许将其派生操作放入由其配置和包确定的目录中（但即便如此，同一包中的规则可能会发生冲突），但用 Java 实现的规则可以将派生工件放在任何地方。</p><p>这被认为是一个错误功能，但要摆脱它真的很难，因为当源文件需要以某种方式处理并且该文件被多个规则（handwave-handwave）引用时，它会显着节省执行时间。这是以一些 RAM 为代价的：共享操作的每个实例都需要单独存储在内存中。</p><p>如果两个动作生成相同的输出文件，它们必须完全相同：具有相同的输入、相同的输出并运行相同的命令行。这种等价关系<code>Actions.canBeShared()</code>在分析和执行阶段之间实现，并通过查看每个动作来验证。这是<code>SkyframeActionExecutor.findAndStoreArtifactConflicts()</code> 在 Bazel 中实现的，也是少数几个需要构建“全局”视图的地方之一。</p><h2 class="relative group">执行阶段<div id=%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5 aria-label=锚点>#</a></span></h2><p>这是 Bazel 真正开始运行构建操作的时候，即产生输出的命令。</p><p>Bazel 在分析阶段之后做的第一件事是确定需要构建哪些 Artifact。其逻辑编码在 <code>TopLevelArtifactHelper</code>; 粗略地说，它是<code>filesToBuild</code>命令行上配置的目标和一个特殊输出组的内容，用于明确表达“如果此目标在命令行上，则构建这些工件”。</p><p>下一步是创建执行根。由于 Bazel 可以选择从文件系统 ( <code>--package_path</code>)中的不同位置读取源包，因此它需要为本地执行的操作提供完整的源树。这由类处理，<code>SymlinkForest</code>并通过记录分析阶段使用的每个目标并构建单个目录树来处理，该目录树将每个包与从其实际位置使用的目标进行符号链接。另一种方法是将正确的路径传递给命令（考虑<code>--package_path</code>到）。这是不可取的，因为：</p><ul><li>当一个包从一个包路径条目移动到另一个包时，它会更改操作命令行（过去很常见）</li><li>如果一个动作是远程运行的，它会导致不同的命令行，而不是它在本地运行</li><li>它需要特定于正在使用的工具的命令行转换（考虑 Java 类路径和 C++ 包含路径之间的区别）</li><li>更改操作的命令行会使其操作缓存条目无效</li><li><code>--package_path</code> 正在缓慢而稳定地被弃用</li></ul><p>然后，Bazel 开始遍历动作图（由动作及其输入和输出工件组成的二分有向图）并运行动作。每个动作的执行由<code>SkyValue</code> 类的一个实例表示<code>ActionExecutionValue</code>。</p><p>由于运行一个动作很昂贵，我们有几层缓存可以在 Skyframe 后面命中：</p><ul><li><code>ActionExecutionFunction.stateMap</code>包含使 Skyframe 重新启动<code>ActionExecutionFunction</code>便宜的数据</li><li>本地操作缓存包含有关文件系统状态的数据</li><li>远程执行系统通常也包含自己的缓存</li></ul><h3 class="relative group">本地动作缓存<div id=%E6%9C%AC%E5%9C%B0%E5%8A%A8%E4%BD%9C%E7%BC%93%E5%AD%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%9C%AC%E5%9C%B0%E5%8A%A8%E4%BD%9C%E7%BC%93%E5%AD%98 aria-label=锚点>#</a></span></h3><p>这个缓存是位于 Skyframe 后面的另一层；即使一个动作在 Skyframe 中重新执行，它仍然可以在本地动作缓存中命中。它表示本地文件系统的状态，并被序列化到磁盘，这意味着当启动新的 Bazel 服务器时，即使 Skyframe 图表为空，也可以获得本地操作缓存命中。</p><p>使用 方法检查此缓存的命中 <code>ActionCacheChecker.getTokenIfNeedToExecute()</code>。</p><p>与其名称相反，它是从派生工件的路径到发出它的动作的映射。动作描述为：</p><ol><li>其输入和输出文件的集合及其校验和</li><li>它的“动作键”，通常是执行的命令行，但一般来说，表示输入文件的校验和未捕获的所有内容（例如，对于<code>FileWriteAction</code>，它是写入数据的校验和）</li></ol><p>还有一个仍在开发中的高度实验性的“自上而下的动作缓存”，它使用传递哈希来避免多次访问缓存。</p><h3 class="relative group">输入发现和输入修剪<div id=%E8%BE%93%E5%85%A5%E5%8F%91%E7%8E%B0%E5%92%8C%E8%BE%93%E5%85%A5%E4%BF%AE%E5%89%AA class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BE%93%E5%85%A5%E5%8F%91%E7%8E%B0%E5%92%8C%E8%BE%93%E5%85%A5%E4%BF%AE%E5%89%AA aria-label=锚点>#</a></span></h3><p>有些动作比只有一组输入更复杂。对动作输入集的更改有两种形式：</p><ul><li>一个动作可能会在其执行之前发现新的输入，或者决定它的某些输入实际上是不必要的。典型的例子是 C++，最好从其传递闭包中对 C++ 文件使用哪些头文件进行有根据的猜测，这样我们就不会注意将每个文件发送到远程执行程序；因此，我们可以选择不将每个头文件都注册为“输入”，而是扫描源文件以查找可传递包含的头文件，并且只将这些头文件标记为<code>#include</code>语句中提到的输入（我们高估了我们不需要实现完整的 C 预处理器）此选项目前在 Bazel 中硬连线为“false”，并且仅在 Google 中使用。</li><li>一个动作可能会意识到一些文件在其执行期间没有被使用。在 C++ 中，这称为“.d 文件”：编译器会在事后告知使用了哪些头文件，并且为了避免增量比 Make 更差的尴尬，Bazel 利用了这一事实。这提供了比包含扫描器更好的估计，因为它依赖于编译器。</li></ul><p>这些是使用 Action 上的方法实现的：</p><ol><li><code>Action.discoverInputs()</code>叫做。它应该返回一组被确定为需要的嵌套工件。这些必须是源工件，以便动作图中没有在配置的目标图中没有等效项的依赖边。</li><li>该动作通过调用来执行<code>Action.execute()</code>。</li><li>在 结束时<code>Action.execute()</code>，动作可以调用 <code>Action.updateInputs()</code>告诉 Bazel 并非所有的输入都是需要的。如果已使用的输入报告为未使用，这可能会导致不正确的增量构建。</li></ol><p>当动作缓存返回对新动作实例的命中（例如，在服务器重新启动后创建）时，Bazel 会调用<code>updateInputs()</code>自身，以便输入集反映之前完成的输入发现和修剪的结果。</p><p>Starlark 动作可以利用该工具使用 的<code>unused_inputs_list=</code>参数将 某些输入声明为未使用<code>ctx.actions.run()</code>。</p><h3 class="relative group">运行操作的各种方式：策略/ActionContexts<div id=%E8%BF%90%E8%A1%8C%E6%93%8D%E4%BD%9C%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%B9%E5%BC%8F%E7%AD%96%E7%95%A5actioncontexts class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BF%90%E8%A1%8C%E6%93%8D%E4%BD%9C%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%B9%E5%BC%8F%E7%AD%96%E7%95%A5actioncontexts aria-label=锚点>#</a></span></h3><p>一些动作可以以不同的方式运行。例如，可以在本地、本地但在各种沙箱中或远程执行命令行。体现这一点的概念被称为<code>ActionContext</code>（或<code>Strategy</code>，因为我们成功地只进行了一半的重命名&mldr;&mldr;）</p><p>动作上下文的生命周期如下：</p><ol><li>当执行阶段开始时，<code>BlazeModule</code>会询问实例它们有哪些动作上下文。这发生在 <code>ExecutionTool</code>. 动作上下文类型由 Java<code>Class</code> 实例标识，该实例引用<code>ActionContext</code>动作上下文的子接口以及动作上下文必须实现的接口。</li><li>从可用的动作上下文中选择适当的动作上下文并转发到<code>ActionExecutionContext</code>和<code>BlazeExecutor</code>。</li><li>操作使用<code>ActionExecutionContext.getContext()</code>and 请求上下文<code>BlazeExecutor.getStrategy()</code>（实际上应该只有一种方法可以做到……）</li></ol><p>策略可以自由调用其他策略来完成它们的工作；例如，这用于在本地和远程启动操作的动态策略中，然后使用先完成的操作。</p><p>一种值得注意的策略是实现持久工作进程的策略（<code>WorkerSpawnStrategy</code>）。这个想法是一些工具有很长的启动时间，因此应该在动作之间重用，而不是为每个动作重新启动一个（这确实代表了一个潜在的正确性问题，因为 Bazel 依赖于工作进程的承诺，它不会在各个请求之间携带可观察的状态）</p><p>如果工具发生变化，则需要重新启动工作进程。通过计算使用的工具的校验和来确定工人是否可以重用 <code>WorkerFilesHash</code>。它依赖于知道动作的哪些输入代表工具的一部分，哪些代表输入；这是由 Action 的创建者决定的：<code>Spawn.getToolFiles()</code>并且运行文件<code>Spawn</code>被算作工具的一部分。</p><p>有关策略（或行动背景！）的更多信息：</p><ul><li><a href=https://jmmv.dev/2019/12/bazel-strategies.html target=_blank>此处</a>提供<a href=https://jmmv.dev/2019/12/bazel-strategies.html target=_blank>了</a>有关运行动作的各种策略的信息 。</li><li>关于动态策略的信息，我们在本地和远程运行操作以查看先完成的操作[在这里](<a href=https://jmmv.dev/series.html#Bazel target=_blank>https://jmmv.dev/series.html#Bazel</a> dynamic execution)可用 。</li><li>有关在本地执行操作的复杂性的信息可 <a href=https://jmmv.dev/2019/11/bazel-process-wrapper.html target=_blank>在此处获得</a>。</li></ul><h3 class="relative group">本地资源管理器<div id=%E6%9C%AC%E5%9C%B0%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%9C%AC%E5%9C%B0%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8 aria-label=锚点>#</a></span></h3><p>Bazel<em>可以</em>并行运行许多操作。<em>应该</em>并行运行的本地动作的数量 因动作而异：动作需要的资源越多，同时运行的实例就越少，以避免本地机器过载。</p><p>这是在类中实现的<code>ResourceManager</code>：每个动作都必须用<code>ResourceSet</code>实例（CPU 和 RAM）形式所需的本地资源的估计进行注释 。然后，当操作上下文执行需要本地资源的操作时，它们会调用<code>ResourceManager.acquireResources()</code> 并被阻止，直到所需资源可用为止。</p><p>有关本地资源管理的更详细说明，请参见 <a href=https://jmmv.dev/2019/12/bazel-local-resources.html target=_blank>此处</a>。</p><h3 class="relative group">输出目录结构<div id=%E8%BE%93%E5%87%BA%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BE%93%E5%87%BA%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84 aria-label=锚点>#</a></span></h3><p>每个操作都需要在输出目录中放置一个单独的位置来放置其输出。派生工件的位置通常如下：</p><pre tabindex=0><code>$EXECROOT/bazel-out/&lt;configuration&gt;/bin/&lt;package&gt;/&lt;artifact name&gt;
</code></pre><p>与特定配置关联的目录名称是如何确定的？有两个相互矛盾的理想属性：</p><ol><li>如果两个配置可以发生在同一个构建中，它们应该有不同的目录，这样它们就可以有自己的相同操作版本；否则，如果两个配置在生成相同输出文件的操作的命令行上存在分歧，Bazel 不知道要选择哪个操作（“操作冲突”）</li><li>如果两个配置代表“大致”相同的东西，它们应该具有相同的名称，以便在命令行匹配时可以将在一个中执行的操作重用于另一个：例如，不应该更改 Java 编译器的命令行选项导致重新运行 C++ 编译操作。</li></ol><p>到目前为止，我们还没有想出一个原则性的方法来解决这个问题，这与配置修剪的问题有相似之处。<a href=https://docs.google.com/document/d/1fZI7wHoaS-vJvZy9SBxaHPitIzXE_nL9v4sS4mErrG4/edit target=_blank>此处</a>提供<a href=https://docs.google.com/document/d/1fZI7wHoaS-vJvZy9SBxaHPitIzXE_nL9v4sS4mErrG4/edit target=_blank>了</a>有关选项的更长讨论 。主要的问题领域是 Starlark 规则（其作者通常对 Bazel 并不十分熟悉）和方面，它们为可以生成“相同”输出文件的事物空间增加了另一个维度。</p><p>当前的方法是配置的路径段 <code>&lt;CPU>-&lt;compilation mode></code>添加了各种后缀，以便在 Java 中实现的配置转换不会导致操作冲突。此外，还添加了 Starlark 配置转换集的校验和，以便用户不会导致操作冲突。它远非完美。这是<code>OutputDirectories.buildMnemonic()</code>在每个配置片段中实现 并依赖于将其自己的部分添加到输出目录的名称。</p><h2 class="relative group">测试<div id=%E6%B5%8B%E8%AF%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%B5%8B%E8%AF%95 aria-label=锚点>#</a></span></h2><p>Bazel 对运行测试有丰富的支持。它支持：</p><ul><li>远程运行测试（如果远程执行后端可用）</li><li>并行运行多次测试（用于去剥落或收集时序数据）</li><li>分片测试（将同一测试中的测试用例拆分到多个进程中以提高速度）</li><li>重新运行易碎测试</li><li>将测试分组到测试套件中</li></ul><p>测试是具有 TestProvider 的常规配置目标，它描述了应该如何运行测试：</p><ul><li>构建导致运行测试的工件。这是一个包含序列化<code>TestResultData</code>消息的“缓存状态”文件</li><li>测试应该运行的次数</li><li>测试应该分成的分片数量</li><li>关于如何运行测试的一些参数（例如测试超时）</li></ul><h3 class="relative group">确定要运行的测试<div id=%E7%A1%AE%E5%AE%9A%E8%A6%81%E8%BF%90%E8%A1%8C%E7%9A%84%E6%B5%8B%E8%AF%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%A1%AE%E5%AE%9A%E8%A6%81%E8%BF%90%E8%A1%8C%E7%9A%84%E6%B5%8B%E8%AF%95 aria-label=锚点>#</a></span></h3><p>确定运行哪些测试是一个复杂的过程。</p><p>首先，在目标模式解析期间，测试套件被递归扩展。扩展在<code>TestsForTargetPatternFunction</code>. 一个有点令人惊讶的问题是，如果一个测试套件声明没有测试，它会引用 其包中的<em>每个</em>测试。这是<code>Package.beforeBuild()</code>通过添加一个调用<code>$implicit_tests</code>测试套件规则的隐式属性来实现的。</p><p>然后，根据命令行选项过滤测试的大小、标签、超时和语言。这在目标解析期间实现<code>TestFilter</code>并从其中调用 <code>TargetPatternPhaseFunction.determineTests()</code>，并将结果放入<code>TargetPatternPhaseValue.getTestsToRunLabels()</code>. 可以过滤的规则属性不可配置的原因是这发生在分析阶段之前，因此配置不可用。</p><p>然后进一步处理<code>BuildView.createResult()</code>：分析失败的目标被过滤掉，测试分为排他性和非排他性测试。然后将其放入<code>AnalysisResult</code>，这就是如何 <code>ExecutionTool</code>知道要运行哪些测试。</p><p>为了给这个复杂的过程提供一些透明度，<code>tests()</code> 查询运算符（在 中实现<code>TestsFunction</code>）可用于告诉在命令行上指定特定目标时运行哪些测试。不幸的是，这是一个重新实现，因此它可能以多种微妙的方式偏离上述内容。</p><h3 class="relative group">运行测试<div id=%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95 aria-label=锚点>#</a></span></h3><p>运行测试的方式是请求缓存状态工件。这将导致 a 的执行<code>TestRunnerAction</code>，最终调用 <code>TestActionContext</code>由<code>--test_strategy</code>命令行选项选择的以请求的方式运行测试的选项。</p><p>测试是根据精心设计的协议运行的，该协议使用环境变量来告诉测试对它们的期望。有关 Bazel 对测试的期望以及对 Bazel 的期望的详细描述，请参见 <a href=https://docs.bazel.build/versions/main/test-encyclopedia.html target=_blank>此处</a>。在最简单的情况下，退出代码 0 表示成功，其他任何值都表示失败。</p><p>除了缓存状态文件之外，每个测试进程都会发出许多其他文件。它们被放在“测试日志目录”中，这是<code>testlogs</code>目标配置的输出目录的子目录 ：</p><ul><li><code>test.xml</code>，一个 JUnit 样式的 XML 文件，详细说明了测试分片中的各个测试用例</li><li><code>test.log</code>，测试的控制台输出。 stdout 和 stderr 没有分开。</li><li><code>test.outputs</code>，“未声明的输出目录”；除了打印到终端的内容之外，它还被想要输出文件的测试使用。</li></ul><p>在构建常规目标期间，测试执行期间可能会发生两件事：独占测试执行和输出流。</p><p>有些测试需要以独占模式执行，即不与其他测试并行执行。这可以通过添加<code>tags=["exclusive"]</code>到测试规则或使用<code>--test_strategy=exclusive</code>. 每个独占测试由单独的 Skyframe 调用运行，请求在“主”构建之后执行测试。这是在 <code>SkyframeExecutor.runExclusiveTest()</code>.</p><p>与常规操作不同，后者的终端输出在操作完成时被转储，用户可以请求流式传输测试的输出，以便他们了解长时间运行的测试的进度。这是由<code>--test_output=streamed</code>命令行选项指定的， 并且意味着独占测试执行，因此不同测试的输出不会散布。</p><p>这是在恰当命名的<code>StreamedTestOutput</code>类中实现的，通过轮询<code>test.log</code>对相关测试文件的更改并将新字节转储到 Bazel 规则的终端来工作。</p><p>通过观察各种事件（例如<code>TestAttempt</code>，<code>TestResult</code>或<code>TestingCompleteEvent</code>），可以在事件总线上获得已执行测试的结果。它们被转储到构建事件协议，并由<code>AggregatingTestListener</code>.</p><h3 class="relative group">覆盖收集<div id=%E8%A6%86%E7%9B%96%E6%94%B6%E9%9B%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%A6%86%E7%9B%96%E6%94%B6%E9%9B%86 aria-label=锚点>#</a></span></h3><p>覆盖率由文件中的 LCOV 格式的测试报告 <code>bazel-testlogs/$PACKAGE/$TARGET/coverage.dat</code>。</p><p>为了收集覆盖率，每个测试执行都包含在一个名为 <code>collect_coverage.sh</code>.</p><p>此脚本设置测试环境以启用覆盖率收集并确定覆盖率运行时将覆盖率文件写入何处。然后它运行测试。一个测试本身可以运行多个子进程，并且由用多种不同编程语言编写的部分组成（具有单独的覆盖收集运行时）。包装脚本负责在必要时将生成的文件转换为 LCOV 格式，并将它们合并到一个文件中。</p><p>的插入<code>collect_coverage.sh</code>是由测试策略完成的，并且需要<code>collect_coverage.sh</code>在测试的输入上。这是通过<code>:coverage_support</code>解析为配置标志的值的隐式属性来完成的<code>--coverage_support</code>（请参阅 参考资料 <code>TestConfiguration.TestOptions.coverageSupport</code>）</p><p>一些语言进行离线检测，这意味着在编译时添加覆盖检测（例如 C++），而其他语言进行在线检测，这意味着在执行时添加覆盖检测。</p><p>另一个核心概念是<em>基线覆盖率</em>。这是库、二进制文件或测试的覆盖范围（如果其中没有运行代码）。它解决的问题是，如果您想计算二进制文件的测试覆盖率，仅合并所有测试的覆盖率是不够的，因为二进制文件中可能存在未链接到任何测试的代码。因此，我们要做的是为每个二进制文件发出一个覆盖文件，该文件只包含我们收集覆盖的文件，没有覆盖的行。目标的基线覆盖率文件位于 <code>bazel-testlogs/$PACKAGE/$TARGET/baseline_coverage.dat</code>. 如果您将<code>--nobuild_tests_only</code>标志传递给 Bazel ，除了测试之外，它还会为二进制文件和库生成 。</p><p>基线覆盖范围目前已被打破。</p><p>我们为每个规则跟踪两组文件以进行覆盖收集：检测文件集和检测元数据文件集。</p><p>检测文件集就是这样，一组要检测的文件。对于在线覆盖运行时，可以在运行时使用它来决定要检测哪些文件。它还用于实现基线覆盖。</p><p>仪表元数据文件集是测试需要从中生成 LCOV 文件所需的额外文件集。实际上，这由特定于运行时的文件组成；例如，gcc 在编译期间发出 .gcno 文件。如果启用了覆盖模式，这些将添加到测试操作的输入集中。</p><p>是否正在收集覆盖率存储在 <code>BuildConfiguration</code>. 这很方便，因为它是一种根据该位更改测试动作和动作图的简单方法，但这也意味着如果翻转该位，则需要重新分析所有目标（某些语言，例如 C++ 需要不同的编译器选项来发出可以收集覆盖率的代码，这在一定程度上缓解了这个问题，因为无论如何都需要重新分析）。</p><p>覆盖支持文件通过隐式依赖中的标签依赖，以便它们可以被调用策略覆盖，这允许它们在不同版本的 Bazel 之间有所不同。理想情况下，这些差异将被消除，我们将其中之一标准化。</p><p>我们还生成一个“覆盖率报告”，它合并了在 Bazel 调用中为每个测试收集的覆盖率。这由 处理 <code>CoverageReportActionFactory</code>并从 调用<code>BuildView.createResult()</code>。它通过查看<code>:coverage_report_generator</code> 执行的第一个测试的属性来访问所需的工具。</p><h2 class="relative group">查询引擎<div id=%E6%9F%A5%E8%AF%A2%E5%BC%95%E6%93%8E class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%9F%A5%E8%AF%A2%E5%BC%95%E6%93%8E aria-label=锚点>#</a></span></h2><p>该文档的原版，参考https://docs.bazel.build/versions/main/query-how-to.html</p><p>对于具体语言的细节和&ndash;output选项的的细节，看：</p><ul><li><a href=https://docs.bazel.build/versions/main/query.html target=_blank>https://docs.bazel.build/versions/main/query.html</a>，命令的帮助调用bazel help query</li><li><a href=https://docs.bazel.build/versions/main/cquery.html target=_blank>https://docs.bazel.build/versions/main/cquery.html</a>，bazel help cquery</li></ul><p>在执行的时候可能遇到各种错误，比方说targets不存在，如果想忽略，加上 <code>--keep_going</code> flag.</p><h3 class="relative group">查找依赖<div id=%E6%9F%A5%E6%89%BE%E4%BE%9D%E8%B5%96 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%9F%A5%E6%89%BE%E4%BE%9D%E8%B5%96 aria-label=锚点>#</a></span></h3><p>用bazel query &ldquo;deps(xxx)&ldquo;来查找依赖，这个命令会显示target所有的依赖，甚至会显示具体的文件。我一般查从文件触发的时候会这么查询</p><pre tabindex=0><code>$ bazel query &#34;deps(//foo)&#34;
//foo:foo
//foo:foo-dep
...
</code></pre><h3 class="relative group">查找两个target怎么建立的依赖<div id=%E6%9F%A5%E6%89%BE%E4%B8%A4%E4%B8%AAtarget%E6%80%8E%E4%B9%88%E5%BB%BA%E7%AB%8B%E7%9A%84%E4%BE%9D%E8%B5%96 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%9F%A5%E6%89%BE%E4%B8%A4%E4%B8%AAtarget%E6%80%8E%E4%B9%88%E5%BB%BA%E7%AB%8B%E7%9A%84%E4%BE%9D%E8%B5%96 aria-label=锚点>#</a></span></h3><p>target <code>//third_party/zlib:zlibonly</code> 没有直接写到 <code>//foo</code>的BUILD文件里，所以它是个间接依赖, 如何查询依赖的路径呢?</p><ul><li><p><code>allpaths</code> ，会检索出来所有的依赖路径，这个结果是一个压扁的list</p><pre tabindex=0><code>$ bazel query &#34;allpaths(//foo, third_party/...)&#34;
  ...many errors detected in BUILD files...
//foo:foo
//translations/tools:translator
//translations/tools:aggregator
//translations/base:base
//tools/pkg:pex
//tools/pkg:pex_phase_one
//tools/pkg:pex_lib
//third_party/python:python_lib
//translations/tools:messages
//third_party/py/xml:xml
//third_party/py/xml:utils/boolean.so
//third_party/py/xml:parsers/sgmlop.so
//third_party/py/xml:parsers/pyexpat.so
//third_party/py/MySQL:MySQL
//third_party/py/MySQL:_MySQL.so
//third_party/mysql:mysql
//third_party/openssl:openssl
//third_party/zlib:zlibonly
//third_party/zlib:zlibonly_v1_2_3
//third_party/python:headers
//third_party/openssl:crypto
</code></pre><p>使用dot来转换依赖链为svg图片，这样子好看一些</p><pre tabindex=0><code>$ bazel query &#34;allpaths(//foo, third_party/...)&#34; --notool_deps --output graph | dot -Tsvg &gt; /tmp/deps.svg
</code></pre></li><li><p><code>somepath</code>，会检索出来一条路径</p><pre tabindex=0><code>$ bazel query &#34;somepath(//foo:foo, third_party/zlib:zlibonly)&#34;
//foo:foo
//translations/tools:translator
//translations/base:base
//third_party/py/MySQL:MySQL
//third_party/py/MySQL:_MySQL.so
//third_party/mysql:mysql
//third_party/zlib:zlibonly
</code></pre></li><li><p><code>--notool_deps</code>可能也有</p></li></ul><h3 class="relative group">Aside: implicit dependencies<div id=aside-implicit-dependencies class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#aside-implicit-dependencies aria-label=锚点>#</a></span></h3><p><code>//foo</code> 的BUILD文件从来没引用 <code>//translations/tools:aggregator</code>. 直接的依赖链是什么呢？</p><p>有时候一部分的编译需要引入很多隐式的依赖，比方说编译proto文件的时候需要先编译protocol compiler，因此引入了很多的不必要的依赖，使用<code>--noimplicit_deps</code>移除这些依赖</p><h3 class="relative group">查找反向的依赖<div id=%E6%9F%A5%E6%89%BE%E5%8F%8D%E5%90%91%E7%9A%84%E4%BE%9D%E8%B5%96 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%9F%A5%E6%89%BE%E5%8F%8D%E5%90%91%E7%9A%84%E4%BE%9D%E8%B5%96 aria-label=锚点>#</a></span></h3><p>有时候希望查找哪些targets依赖了具体的目标，比方说你改动了部分的文件，你想知道你的代码改动会影响到哪些target，可以使用 <code>rdeps(u, x)</code> 来执行反向查找， <code>x</code> 是 <code>u</code>的闭包，Bazel&rsquo;s <a href=https://docs.bazel.build/versions/main/query.html#sky-query target=_blank>Sky Query</a> 支持 <code>allrdeps</code> 函数, 可以方便的自定检索方式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bazel query <span class=s1>&#39;rdeps(//offboard/dashboard:sim_server, //offboard/dashboard/services/health:health)&#39;</span> <span class=c1>#查找反向依赖链,查找health到sim_server</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bazel query <span class=s1>&#39;rdeps(//..., //offboard/dashboard/services/health:health)&#39;</span> --keep_going <span class=c1>#这个命令检索所有的依赖health的target</span>
</span></span></code></pre></div><h4 class="relative group">What packages exist beneath <code>foo</code>?<div id=what-packages-exist-beneath-foo class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-packages-exist-beneath-foo aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;foo/...&#39; --output package
</code></pre><h4 class="relative group">What rules are defined in the <code>foo</code> package?<div id=what-rules-are-defined-in-the-foo-package class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-rules-are-defined-in-the-foo-package aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;kind(rule, foo:*)&#39; --output label_kind
</code></pre><h4 class="relative group">What files are generated by rules in the <code>foo</code> package?<div id=what-files-are-generated-by-rules-in-the-foo-package class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-files-are-generated-by-rules-in-the-foo-package aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;kind(&#34;generated file&#34;, //foo:*)&#39;
</code></pre><h4 class="relative group">What targets are generated by starlark macro <code>foo</code>?<div id=what-targets-are-generated-by-starlark-macro-foo class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-targets-are-generated-by-starlark-macro-foo aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;attr(generator_function, foo, //path/to/search/...)&#39;
</code></pre><h4 class="relative group">What&rsquo;s the set of BUILD files needed to build <code>//foo</code>?<div id=whats-the-set-of-build-files-needed-to-build-foo class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#whats-the-set-of-build-files-needed-to-build-foo aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;buildfiles(deps(//foo))&#39; | cut -f1 -d:
</code></pre><h4 class="relative group">What are the individual tests that a <code>test_suite</code> expands to?<div id=what-are-the-individual-tests-that-a-test_suite-expands-to class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-are-the-individual-tests-that-a-test_suite-expands-to aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;tests(//foo:smoke_tests)&#39;
</code></pre><h4 class="relative group">Which of those are C++ tests?<div id=which-of-those-are-c-tests class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#which-of-those-are-c-tests aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;kind(cc_.*, tests(//foo:smoke_tests))&#39;
</code></pre><h4 class="relative group">Which of those are small? Medium? Large?<div id=which-of-those-are-small-medium-large class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#which-of-those-are-small-medium-large aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;attr(size, small, tests(//foo:smoke_tests))&#39;

bazel query &#39;attr(size, medium, tests(//foo:smoke_tests))&#39;

bazel query &#39;attr(size, large, tests(//foo:smoke_tests))&#39;
</code></pre><h4 class="relative group">What are the tests beneath <code>foo</code> that match a pattern?<div id=what-are-the-tests-beneath-foo-that-match-a-pattern class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-are-the-tests-beneath-foo-that-match-a-pattern aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;filter(&#34;pa?t&#34;, kind(&#34;.*_test rule&#34;, //foo/...))&#39;
</code></pre><p>The pattern is a regex and is applied to the full name of the rule. It&rsquo;s similar to doing</p><pre tabindex=0><code>bazel query &#39;kind(&#34;.*_test rule&#34;, //foo/...)&#39; | grep -E &#39;pa?t&#39;
</code></pre><h4 class="relative group">What package contains file <code>path/to/file/bar.java</code>?<div id=what-package-contains-file-pathtofilebarjava class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-package-contains-file-pathtofilebarjava aria-label=锚点>#</a></span></h4><pre tabindex=0><code> bazel query path/to/file/bar.java --output=package
</code></pre><h4 class="relative group">What is the build label for <code>path/to/file/bar.java?</code><div id=what-is-the-build-label-for-pathtofilebarjava class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-is-the-build-label-for-pathtofilebarjava aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query path/to/file/bar.java
</code></pre><h4 class="relative group">What rule target(s) contain file <code>path/to/file/bar.java</code> as a source?<div id=what-rule-targets-contain-file-pathtofilebarjava-as-a-source class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-rule-targets-contain-file-pathtofilebarjava-as-a-source aria-label=锚点>#</a></span></h4><pre tabindex=0><code>fullname=$(bazel query path/to/file/bar.java)
bazel query &#34;attr(&#39;srcs&#39;, $fullname, ${fullname//:*/}:*)&#34;
</code></pre><h3 class="relative group">What package dependencies exist &mldr;<div id=what-package-dependencies-exist- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-package-dependencies-exist- aria-label=锚点>#</a></span></h3><h4 class="relative group">What packages does <code>foo</code> depend on? (What do I need to check out to build <code>foo</code>)<div id=what-packages-does-foo-depend-on-what-do-i-need-to-check-out-to-build-foo class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-packages-does-foo-depend-on-what-do-i-need-to-check-out-to-build-foo aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;buildfiles(deps(//foo:foo))&#39; --output package
</code></pre><p>Note, <code>buildfiles</code> is required in order to correctly obtain all files referenced by <code>subinclude</code>; see the reference manual for details.</p><h4 class="relative group">What packages does the <code>foo</code> tree depend on, excluding <code>foo/contrib</code>?<div id=what-packages-does-the-foo-tree-depend-on-excluding-foocontrib class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-packages-does-the-foo-tree-depend-on-excluding-foocontrib aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;deps(foo/... except foo/contrib/...)&#39; --output package
</code></pre><h3 class="relative group">What rule dependencies exist &mldr;<div id=what-rule-dependencies-exist- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-rule-dependencies-exist- aria-label=锚点>#</a></span></h3><h4 class="relative group">What genproto rules does bar depend upon?<div id=what-genproto-rules-does-bar-depend-upon class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-genproto-rules-does-bar-depend-upon aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;kind(genproto, deps(bar/...))&#39;
</code></pre><h4 class="relative group">Find the definition of some JNI (C++) library that is transitively depended upon by a Java binary rule in the servlet tree.<div id=find-the-definition-of-some-jni-c-library-that-is-transitively-depended-upon-by-a-java-binary-rule-in-the-servlet-tree class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#find-the-definition-of-some-jni-c-library-that-is-transitively-depended-upon-by-a-java-binary-rule-in-the-servlet-tree aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;some(kind(cc_.*library, deps(kind(java_binary, //java/com/example/frontend/...))))&#39; --output location
</code></pre><h5 class="relative group">&mldr;Now find the definitions of all the Java binaries that depend on them<div id=now-find-the-definitions-of-all-the-java-binaries-that-depend-on-them class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#now-find-the-definitions-of-all-the-java-binaries-that-depend-on-them aria-label=锚点>#</a></span></h5><pre tabindex=0><code>bazel query &#39;let jbs = kind(java_binary, //java/com/example/frontend/...) in
  let cls = kind(cc_.*library, deps($jbs)) in
    $jbs intersect allpaths($jbs, $cls)&#39;
</code></pre><h3 class="relative group">What file dependencies exist &mldr;<div id=what-file-dependencies-exist- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-file-dependencies-exist- aria-label=锚点>#</a></span></h3><h4 class="relative group">What&rsquo;s the complete set of Java source files required to build foo?<div id=whats-the-complete-set-of-java-source-files-required-to-build-foo class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#whats-the-complete-set-of-java-source-files-required-to-build-foo aria-label=锚点>#</a></span></h4><p>Source files:</p><pre tabindex=0><code>bazel query &#39;kind(&#34;source file&#34;, deps(//path/to/target/foo/...))&#39; | grep java$
</code></pre><p>Generated files:</p><pre tabindex=0><code>bazel query &#39;kind(&#34;generated file&#34;, deps(//path/to/target/foo/...))&#39; | grep java$
</code></pre><h4 class="relative group">What is the complete set of Java source files required to build QUX&rsquo;s tests?<div id=what-is-the-complete-set-of-java-source-files-required-to-build-quxs-tests class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-is-the-complete-set-of-java-source-files-required-to-build-quxs-tests aria-label=锚点>#</a></span></h4><p>Source files:</p><pre tabindex=0><code>bazel query &#39;kind(&#34;source file&#34;, deps(kind(&#34;.*_test rule&#34;, javatests/com/example/qux/...)))&#39; | grep java$
</code></pre><p>Generated files:</p><pre tabindex=0><code>bazel query &#39;kind(&#34;generated file&#34;, deps(kind(&#34;.*_test rule&#34;, javatests/com/example/qux/...)))&#39; | grep java$
</code></pre><h3 class="relative group">What differences in dependencies between X and Y exist &mldr;<div id=what-differences-in-dependencies-between-x-and-y-exist- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-differences-in-dependencies-between-x-and-y-exist- aria-label=锚点>#</a></span></h3><h4 class="relative group">What targets does <code>//foo</code> depend on that <code>//foo:foolib</code> does not?<div id=what-targets-does-foo-depend-on-that-foofoolib-does-not class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-targets-does-foo-depend-on-that-foofoolib-does-not aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;deps(//foo) except deps(//foo:foolib)&#39;
</code></pre><h4 class="relative group">What C++ libraries do the <code>foo</code> tests depend on that the <code>//foo</code> production binary does <em>not</em> depend on?<div id=what-c-libraries-do-the-foo-tests-depend-on-that-the-foo-production-binary-does-not-depend-on class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-c-libraries-do-the-foo-tests-depend-on-that-the-foo-production-binary-does-not-depend-on aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;kind(&#34;cc_library&#34;, deps(kind(&#34;.*test rule&#34;, foo/...)) except deps(//foo))&#39;
</code></pre><h3 class="relative group">Why does this dependency exist &mldr;<div id=why-does-this-dependency-exist- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#why-does-this-dependency-exist- aria-label=锚点>#</a></span></h3><h4 class="relative group">Why does <code>bar</code> depend on <code>groups2</code>?<div id=why-does-bar-depend-on-groups2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#why-does-bar-depend-on-groups2 aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;somepath(bar/...,groups2/...:*)&#39;
</code></pre><p>Once you have the results of this query, you will often find that a single target stands out as being an unexpected or egregious and undesirable dependency of <code>bar</code>. The query can then be further refined to:</p><h4 class="relative group">Show me a path from <code>docker/updater:updater_systest</code> (a <code>py_test</code>) to some <code>cc_library</code> that it depends upon:<div id=show-me-a-path-from-dockerupdaterupdater_systest-a-py_test-to-some-cc_library-that-it-depends-upon class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#show-me-a-path-from-dockerupdaterupdater_systest-a-py_test-to-some-cc_library-that-it-depends-upon aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;let cc = kind(cc_library, deps(docker/updater:updater_systest)) in
  somepath(docker/updater:updater_systest, $cc)&#39;
</code></pre><h4 class="relative group">Why does library <code>//photos/frontend:lib</code> depend on two variants of the same library <code>//third_party/jpeglib</code> and <code>//third_party/jpeg</code>?<div id=why-does-library-photosfrontendlib-depend-on-two-variants-of-the-same-library-third_partyjpeglib-and-third_partyjpeg class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#why-does-library-photosfrontendlib-depend-on-two-variants-of-the-same-library-third_partyjpeglib-and-third_partyjpeg aria-label=锚点>#</a></span></h4><p>This query boils down to: &ldquo;show me the subgraph of <code>//photos/frontend:lib</code> that depends on both libraries&rdquo;. When shown in topological order, the last element of the result is the most likely culprit.</p><pre tabindex=0><code>bazel query &#39;allpaths(//photos/frontend:lib, //third_party/jpeglib)
                intersect
               allpaths(//photos/frontend:lib, //third_party/jpeg)&#39;
//photos/frontend:lib
//photos/frontend:lib_impl
//photos/frontend:lib_dispatcher
//photos/frontend:icons
//photos/frontend/modules/gadgets:gadget_icon
//photos/thumbnailer:thumbnail_lib
//third_party/jpeg/img:renderer
</code></pre><h3 class="relative group">What depends on &mldr;<div id=what-depends-on- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-depends-on- aria-label=锚点>#</a></span></h3><h4 class="relative group">What rules under bar depend on Y?<div id=what-rules-under-bar-depend-on-y class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-rules-under-bar-depend-on-y aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;bar/... intersect allpaths(bar/..., Y)&#39;
</code></pre><p>Note: <code>X intersect allpaths(X, Y)</code> is the general idiom for the query &ldquo;which X depend on Y?&rdquo; If expression X is non-trivial, it may be convenient to bind a name to it using <code>let</code> to avoid duplication.</p><h4 class="relative group">What targets directly depend on T, in T&rsquo;s package?<div id=what-targets-directly-depend-on-t-in-ts-package class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-targets-directly-depend-on-t-in-ts-package aria-label=锚点>#</a></span></h4><pre tabindex=0><code>bazel query &#39;same_pkg_direct_rdeps(T)&#39;
</code></pre><h3 class="relative group">How do I break a dependency &mldr;<div id=how-do-i-break-a-dependency- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#how-do-i-break-a-dependency- aria-label=锚点>#</a></span></h3><h4 class="relative group">What dependency paths do I have to break to make <code>bar</code> no longer depend on X?<div id=what-dependency-paths-do-i-have-to-break-to-make-bar-no-longer-depend-on-x class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-dependency-paths-do-i-have-to-break-to-make-bar-no-longer-depend-on-x aria-label=锚点>#</a></span></h4><p>To output the graph to a <code>svg</code> file:</p><pre tabindex=0><code>bazel query &#39;allpaths(bar/...,X)&#39; --output graph | dot -Tsvg &gt; /tmp/dep.svg
</code></pre><h3 class="relative group">Misc &mldr;<div id=misc- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#misc- aria-label=锚点>#</a></span></h3><h4 class="relative group">How many sequential steps are there in the <code>//foo-tests</code> build?<div id=how-many-sequential-steps-are-there-in-the-foo-tests-build class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#how-many-sequential-steps-are-there-in-the-foo-tests-build aria-label=锚点>#</a></span></h4><p>Unfortunately, the query language can&rsquo;t currently give you the longest path from x to y, but it can find the (or rather <em>a</em>) most distant node from the starting point, or show you the <em>lengths</em> of the longest path from x to every y that it depends on. Use <code>maxrank</code>:</p><pre tabindex=0><code>bazel query &#39;deps(//foo-tests)&#39; --output maxrank | tail -1
85 //third_party/zlib:zutil.c
</code></pre><p>The result indicates that there exist paths of length 85 that must occur in order in this build.</p><h3 class="relative group">性能评估<div id=%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0 aria-label=锚点>#</a></span></h3><h2 class="relative group">模块系统<div id=%E6%A8%A1%E5%9D%97%E7%B3%BB%E7%BB%9F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%A8%A1%E5%9D%97%E7%B3%BB%E7%BB%9F aria-label=锚点>#</a></span></h2><p>Bazel 可以通过添加模块来扩展。每个模块都必须子类化 <code>BlazeModule</code>（该名称是 Bazel 过去称为 Blaze 的历史遗物）并在命令执行期间获取有关各种事件的信息。</p><p>它们主要用于实现只有某些版本的 Bazel（例如我们在 Google 使用的那个）需要的各种“非核心”功能：</p><ul><li>远程执行系统的接口</li><li>新命令</li></ul><p><code>BlazeModule</code>提供的扩展点集有些随意。不要将其用作良好设计原则的示例。</p><h2 class="relative group">活动巴士<div id=%E6%B4%BB%E5%8A%A8%E5%B7%B4%E5%A3%AB class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%B4%BB%E5%8A%A8%E5%B7%B4%E5%A3%AB aria-label=锚点>#</a></span></h2><p>BlazeModules与巴泽尔的其余部分通信的主要方式是通过事件总线（<code>EventBus</code>）：每构建创建一个新的实例，巴泽尔的各个部分可以发布事件，它和模块可以注册他们感兴趣的事件侦听器。例如，以下事物表示为事件：</p><ul><li>已确定要构建的构建目标列表 ( <code>TargetParsingCompleteEvent</code>)</li><li>顶层配置已确定 ( <code>BuildConfigurationEvent</code>)</li><li>目标是否已构建成功与否 ( <code>TargetCompleteEvent</code>)</li><li>运行测试 ( <code>TestAttempt</code>, <code>TestSummary</code>)</li></ul><p>其中一些事件在<a href=https://docs.bazel.build/versions/main/build-event-protocol.html target=_blank>构建事件协议中</a>的 Bazel 之外表示 （它们是<code>BuildEvent</code>s）。这不仅允许<code>BlazeModule</code>s，而且还允许Bazel 进程之外的事物来观察构建。它们可以作为包含协议消息的文件进行访问，或者 Bazel 可以连接到服务器（称为构建事件服务）以流式传输事件。</p><p>这是在<code>build.lib.buildeventservice</code>和 <code>build.lib.buildeventstream</code>Java 包中实现的。</p><h2 class="relative group">外部存储库<div id=%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8%E5%BA%93 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8%E5%BA%93 aria-label=锚点>#</a></span></h2><p>Bazel 最初设计用于 monorepo（包含构建所需的所有内容的单一源代码树），但 Bazel 生活在一个不一定正确的世界中。“外部存储库”是用于连接这两个世界的抽象：它们表示构建所需但不在主源代码树中的代码。</p><h3 class="relative group">工作空间文件<div id=%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4%E6%96%87%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4%E6%96%87%E4%BB%B6 aria-label=锚点>#</a></span></h3><p>外部存储库的集合是通过解析 WORKSPACE 文件来确定的。例如，这样的声明：</p><pre tabindex=0><code>    local_repository(name=&#34;foo&#34;, path=&#34;/foo/bar&#34;)
</code></pre><p>存储库中的结果称为<code>@foo</code>可用。这变得复杂的地方在于，可以在 Starlark 文件中定义新的存储库规则，然后可以使用这些文件加载新的 Starlark 代码，可以用来定义新的存储库规则等等……</p><p>为了处理这种情况，WORKSPACE 文件的解析（in <code>WorkspaceFileFunction</code>）被分成由<code>load()</code> 语句描述的块。块索引由指示<code>WorkspaceFileKey.getIndex()</code>和计算<code>WorkspaceFileFunction</code>直到索引 X 意味着评估它直到第 X 条<code>load()</code>语句。</p><h3 class="relative group">获取存储库<div id=%E8%8E%B7%E5%8F%96%E5%AD%98%E5%82%A8%E5%BA%93 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%8E%B7%E5%8F%96%E5%AD%98%E5%82%A8%E5%BA%93 aria-label=锚点>#</a></span></h3><p>在 Bazel 可以使用存储库的代码之前，需要 <em>fetch</em>。这导致 Bazel 在 <code>$OUTPUT_BASE/external/&lt;repository name></code>.</p><p>获取存储库的步骤如下：</p><ol><li><code>PackageLookupFunction</code>意识到它需要一个存储库并创建 a <code>RepositoryName</code>as a <code>SkyKey</code>，它调用<code>RepositoryLoaderFunction</code></li><li><code>RepositoryLoaderFunction</code>将请求转发给 <code>RepositoryDelegatorFunction</code>不明原因（代码说这是为了避免在 Skyframe 重新启动的情况下重新下载东西，但这不是一个非常可靠的推理）</li><li><code>RepositoryDelegatorFunction</code> 通过遍历 WORKSPACE 文件的块，直到找到请求的存储库，找出它被要求获取的存储库规则</li><li><code>RepositoryFunction</code>找到合适的实现repository fetching；它可以是存储库的 Starlark 实现，也可以是用 Java 实现的存储库的硬编码映射。</li></ol><p>由于获取存储库可能非常昂贵，因此存在各种缓存层：</p><ol><li>下载的文件有一个缓存，由它们的校验和 ( <code>RepositoryCache</code>)键控。这要求校验和在 WORKSPACE 文件中可用，但无论如何这对密封性都有好处。这是由同一工作站上的每个 Bazel 服务器实例共享的，无论它们在哪个工作区或输出库中运行。</li><li>为每个存储库编写一个“标记文件” <code>$OUTPUT_BASE/external</code> ，其中包含用于获取它的规则的校验和。如果 Bazel 服务器重新启动但校验和没有更改，则不会重新获取它。这是在<code>RepositoryDelegatorFunction.DigestWriter</code>.</li><li>该<code>--distdir</code>命令行选项指定要下载用来查找文物另外一个缓存。这在 Bazel 不应从 Internet 获取随机内容的企业环境中很有用。这是由<code>DownloadManager</code>.</li></ol><p>下载存储库后，其中的工件将被视为源工件。这带来了一个问题，因为 Bazel 通常通过调用 stat() 检查源工件的最新性，并且当它们所在的存储库的定义发生更改时，这些工件也会失效。因此， <code>FileStateValue</code>外部存储库中工件的 s 需要依赖于它们的外部存储库。这是由<code>ExternalFilesHelper</code>.</p><h3 class="relative group">托管目录<div id=%E6%89%98%E7%AE%A1%E7%9B%AE%E5%BD%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%89%98%E7%AE%A1%E7%9B%AE%E5%BD%95 aria-label=锚点>#</a></span></h3><p>有时，外部存储库需要修改工作空间根目录下的文件（例如，将下载的包存放在源代码树的子目录中的包管理器）。这与 Bazel 假设源文件仅由用户而不是自己修改并允许包引用工作区根目录下的每个目录的假设不一致。为了使这种外部存储库工作，Bazel 做了两件事：</p><ol><li>允许用户指定 Bazel 不允许进入的工作区的子目录。它们列在一个名为的文件中<code>.bazelignore</code>，功能在<code>BlacklistedPackagePrefixesFunction</code>.</li><li>我们对从工作空间的子目录到外部存储库的映射进行编码，<code>ManagedDirectoriesKnowledge</code>并 <code>FileStateValue</code>以与常规外部存储库相同的方式引用它们。</li></ol><h3 class="relative group">存储库映射<div id=%E5%AD%98%E5%82%A8%E5%BA%93%E6%98%A0%E5%B0%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%AD%98%E5%82%A8%E5%BA%93%E6%98%A0%E5%B0%84 aria-label=锚点>#</a></span></h3><p>可能会发生多个存储库想要依赖于同一个存储库，但版本不同（这是“钻石依赖问题”的一个实例）。例如，如果构建中不同存储库中的两个二进制文件想要依赖 Guava，它们可能都会引用带有标签的 Guava，<code>@guava//</code>并期望这意味着它的不同版本。</p><p>因此，Bazel 允许重新映射外部存储库标签，以便字符串<code>@guava//</code>可以引用<code>@guava1//</code>一个二进制存储库中的一个 Guava 存储库（例如<code>@guava2//</code>）和另一个 Guava 存储库（例如）另一个的存储库。</p><p>或者，这也可用于<strong>连接</strong>钻石。如果一个存储库依赖于<code>@guava1//</code>，而另一个依赖于<code>@guava2//</code>，存储库映射允许重新映射两个存储库以使用规范<code>@guava//</code>存储库。</p><p>该映射在 WORKSPACE 文件中指定<code>repo_mapping</code>为各个存储库定义的属性。然后，它作为 的成员出现在 Skyframe 中 <code>WorkspaceFileValue</code>，并连接到：</p><ul><li><code>Package.Builder.repositoryMapping</code> 它用于通过以下方式转换包中规则的标签值属性 <code>RuleClass.populateRuleAttributeValues()</code></li><li><code>Package.repositoryMapping</code>在分析阶段使用（用于解决<code>$(location)</code>加载阶段未解析的问题）</li><li><code>BzlLoadFunction</code> 用于解析 load() 语句中的标签</li></ul><h1 class="relative group">BUILDFARM<div id=buildfarm class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#buildfarm aria-label=锚点>#</a></span></h1><p>CI的BUILDFARM相关的路线图</p><ul><li>Buildfarm<ul><li>升级<ul><li>1.12 => 1.15</li><li>1.15 => 2.0.0</li><li>2.0.0 => 2.3.1</li></ul></li><li>监控<ul><li>export execute_slot_usage</li><li>export pre queue</li><li>export build slow issue</li></ul></li><li>故障分析<ul><li>filesystem XFS升级解决hard link问题</li><li>write-cancell问题分析</li></ul></li><li>性能优化<ul><li>nginx负载均衡</li><li>bowb启用</li></ul></li></ul></li></ul><p>用户使用场景</p><ul><li>用户希望远程执行命令<ul><li>用户首先上传相应的Command，Action到ContentAddressableStorage。这里面意味着用户需要首先上传文件。</li><li>用户调用Execute执行任务，服务端会执行Action。客户可以调用WaitExecution来等待任务完成，收到一串的stream反馈结果</li><li>Action在执行完毕之后可以直接缓存ActionResult到Server端</li></ul></li><li>ActionCache或者相关服务CAS<ul><li>调用GetActionResult检索ActionCache</li><li>上传CAS Action需要上传CAS文件，如果（which may occur in the middle of a single upload if another client uploads
the same blob concurrently）有其它用户已经上传完了CAS文件</li><li>用户需要确定CAS文件是否存在FindMissingBlobs</li><li>BatchUpdateBlobs， BatchReadBlobs，用户上传文件的时候会同时上传Digest和byte内容，其中bytes就是文件的原始内容对于BatchUpdateBlobsRequest，它的BatchUpdateBlobsResponse实际上是一样的结构。</li><li>GetTreeRequest</li></ul></li></ul><p>buildfarm架构：</p><p>简单理解，可以将buildfarm分为三块：server，worker，backplane（redis）。其中backplane是分布式同步信息的唯一方法，这里的信息包括state of the Instance，可以简单理解为server/worker的 状态。ActionCache, Operations,和ContentAddressableStorage流等信息。简单来说公用的状态同步板。server和worker都不断的通过backplane，阻塞式地（不断重试）检索任务。</p><p>如果worker在执行任务的时候发现某个action缺失，或者找不到对应的文件，这时候有两种方法，一种是请求用户上传，另一种是</p><p>客户端实际上远程执行也是不断轮训任务是不是完成了。</p><ul><li>server，我们只看核心<ul><li>ActionCacheService<ul><li>核心函数 getActionResult。Essentially the &ldquo;get&rdquo; method, which is responsible for finding an ActionResult and retrieving it.</li></ul></li><li>ContentAddressableStorageService</li><li>ExecutionService executionservice提供面向用户的远程执行服务，本质对应admin\main\src\main\resources\proto\remote_execution.proto文件。ExecutionService的内容会更新ActionCacheService
+</li><li></li></ul></li><li>worker<ul><li>worker提供</li></ul></li></ul><p>buildfarm从2.0开始做了大规模的简化工作，只需要指定一两个配置选项就可以，不需要再写冗长的配置</p><pre tabindex=0><code>backplane:
  redisUri: &#34;xxx&#34;
  queues:
    - name: &#34;cpu&#34;
      properties:
        - name: &#34;min-cores&#34;
          value: &#34;*&#34;
        - name: &#34;max-cores&#34;
          value: &#34;*&#34;
digestFunction: SHA256
server:
  name: &#34;shard&#34;
  recordBesEvents: true
  maxEntrySizeBytes: 214748364800 # 200 * 1024 * 1024 * 1024
</code></pre><pre tabindex=0><code>backplane:
  redisUri: &#34;xxx&#34;
  queues:
    - name: &#34;cpu&#34;
      properties:
        - name: &#34;min-cores&#34;
          value: &#34;*&#34;
        - name: &#34;max-cores&#34;
          value: &#34;*&#34;
digestFunction: SHA256        
worker:
  port: 8982
  publicName: &#34;localhost:8982&#34;
  inputFetchStageWidth: 8
  realInputDirectories:
    - &#34;external&#34;
  cas:
    type: FILESYSTEM
    maxSizeBytes: 536870912000 # 500 * 1024 * 1024 * 1024
    maxEntrySizeBytes: 214748364800 # 200 * 1024 * 1024 * 1024
</code></pre><p>前提条件，需要对java的并发编程 & google的Guava有一定的了解，需要了解：</p><ul><li>ListenableFuture， 使用<code>addListener(Runnable, Executor)</code>来添加由executor执行的回调函数Runnable，也可以用Futures.addCallback(ListenableFuture<v>, FutureCallback<v>, Executor)，添加回调函数。具体参考：https://github.com/google/guava/wiki/ListenableFutureExplained & <a href=https://guava.dev/releases/29.0-jre/api/docs/com/google/common/util/concurrent/ListenableFuture.html target=_blank>https://guava.dev/releases/29.0-jre/api/docs/com/google/common/util/concurrent/ListenableFuture.html</a></li><li>SettableFuture，A <a href=https://guava.dev/releases/23.0/api/docs/com/google/common/util/concurrent/ListenableFuture.html target=_blank><code>ListenableFuture</code></a> whose result can be set by a <a href=https://guava.dev/releases/23.0/api/docs/com/google/common/util/concurrent/SettableFuture.html#set-V- target=_blank><code>set(Object)</code></a>, <a href=https://guava.dev/releases/23.0/api/docs/com/google/common/util/concurrent/SettableFuture.html#setException-java.lang.Throwable- target=_blank><code>setException(Throwable)</code></a> or <a href=https://guava.dev/releases/23.0/api/docs/com/google/common/util/concurrent/SettableFuture.html#setFuture-com.google.common.util.concurrent.ListenableFuture- target=_blank><code>setFuture(ListenableFuture)</code></a> call. 具体参考：https://guava.dev/releases/23.0/api/docs/com/google/common/util/concurrent/SettableFuture.html & <a href=https://zhuanlan.zhihu.com/p/356808315 target=_blank>https://zhuanlan.zhihu.com/p/356808315</a></li><li>Cache，参考：https://segmentfault.com/a/1190000011105644 & <a href=https://www.baeldung.com/guava-cache target=_blank>https://www.baeldung.com/guava-cache</a></li></ul><p>基础知识：</p><p>远程执行主要参考admin/main/src/main/resources/proto/remote_execution.proto文件，</p><ul><li><p>执行前，用户检查是不是已经缓存了对应的action，调用ActionCache api相关的查询函数，获取或者更新等操作。</p></li><li><p>客户端上传所有的输入，要运行的命令（command），要存入CAS的Action，然后调用Execute命令并传入参数action_digest来执行。</p></li><li><p>用户需要上传执行命令需要的bolb，这个时候就需要ContentAddressableStorage服务，这个服务负责上传/下载编译出来的binary，每个content都是通过计算hash得出。</p><ul><li>对于小文件，bazle使用BatchUpdateBlobs上传</li><li>对于大文件，需要使用Write method来执行写操作，实际上我们目前观测到的worker stuck，好几次都是由于write method引起的。下载资源的时候，需要使用Read method。成功后返回commitsize</li><li>FindMissingBlobs，用这个函数来查询blob是不是已经存在</li><li>这里面实际上有个问题，我上传了文件到worker，可是怎么保证执行execute的时候，worker就一定找到我想要的文件呢？</li></ul></li><li><p>Action，关于执行所有的信息都通过action来hold，action执行的command存储在ContentAddressableStorage里面，input_root_digest就是输入的文件啥的也需要缓存好，换存在ContentAddressableStorage</p></li><li><p>Command</p></li><li><p>Directory，代表文件树里面的一个目录节点，包含文件nodes，目录nodes，软连接node等子节点</p></li><li></li></ul><p>重点需要关注</p><ul><li>instance:<ul><li>operationQueuer</li><li>DispatchedMonitor：The DispatchedMonitor exists to requeue operations that go missing. For example, if a worker leaves the cluster in the middle of executing an action. 会尝试一直往一个queueentry压executiveteentry进去</li><li></li></ul></li><li>worker</li><li>backplane</li><li>Operations</li></ul><p>架构：</p><ul><li><p>A backplane is a communication medium for all of the members of a shard instance. All distributed communication and shared truth flows through or is retained by it.Buildfarm sees the backplane as an Interface (i.e. Java) that it can use to retrieve and broadcast information about the state of the Instance. Messages about the ActionCache, Operations, and ContentAddressableStorage flow in and out of it.</p></li><li><p>Both Schedulers and Workers have an instance of a Backplane implementation (i.e. concrete class object) upon which they invoke methods. &lsquo;Long polling&rsquo; for dequeues (Operation Arrivals and Ready-to-Run) occurs within the backplane implementation, and the usage is as a blocking dequeue. Similar long-polling occurs on clients waiting for Operation completion, but with an active monitor for each waiting method invocation. Schedulers insist that they are updated frequently, or can positively determine the current known position, for each Operation that is being waited for.</p></li><li><p>stock redis cluster, and even a single stock non-clustered redis node now, will suffice to be a backplane target. And yes, it is one example, and the main/only one provided for now.</p><p>The workers are actively waiting on the backplane at all times that they are idle, yes. The <a href=https://github.com/bazelbuild/bazel-buildfarm/blob/master/src/main/java/build/buildfarm/common/redis/BalancedRedisQueue.java target=_blank>BalancedRedisQueue</a> implementation actually goes through several states while waiting for work, polling a queue on each shard of a redis cluster initially unblocking (with rpoplpush), then blocking (with brpoplpush) with an exponential timeout in sequence. Any work response resets this procedure. This distributes the queue load amongst redis cluster members equally.</p><p>The Scheduler is listening for OperationChange messages, implemented as subscriptions via redis pub/sub, on behalf of the client, to respond to it with updates. This is an event-driven interface, not a polling one, so the responses are as immediate as the pub/sub communication channel is at any moment. Per &lsquo;jobs that depend on those ones&rsquo;: the Remote Execution API does not currently allow for the presentation of inter-Operation dependencies. Each Operation is considered its own isolated activity (except with relative priority), and any dependent enqueueing is undertaken by the client in response to the Operation updates.</p><p>It is important as you&rsquo;ve indicated to reduce overhead here. For reference, we have a moderately sized and scaling cluster of hosts supporting 100s of concurrently executing builds, each with 10k to 100k remote actions. We&rsquo;ve benchmarked arrival rates through multiple schedulers and workers at up to 10k/s without queueing (negating action-dependent transform and execute times). Operation round trips have been seen as low as 10ms, but this varies dramatically as Schedulers and Workers need to fetch and retain information throughout the cluster to transform, validate, store, check cache, and retrieve inputs and inject outputs over its lifecycle, to say nothing of execution time.</p><p>We find it easiest to monitor these transition costs systemically as opposed to cumulatively, dealing with each phase transition cost as an individual stage, and assume that the average cost of a stage is transferrable to all operations: i.e. &ldquo;Operation input fetch is slow today&rdquo;</p></li></ul><h2 class="relative group">ShardInstance Server相关代码阅读<div id=shardinstance-server%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#shardinstance-server%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB aria-label=锚点>#</a></span></h2><p>java的future相关的看这个文档：https://www.baeldung.com/guava-futures-listenablefuture</p><p>中文的listenablefuture看这个https://zhuanlan.zhihu.com/p/349038746</p><p>schedulor和backplane交互，用redis的backplane，最后还是和redis通信。不过这样子也好，让redis管理包括任务有序啥的东西了，做消息队列了。</p><p>简单说：</p><p>shardinstance</p><ul><li>创建一个包含24个线程的actionCacheFetchService，用来获取actioncache；之后创建相应的actioncache</li><li>创建remoteInputStreamFactory</li><li>创建dispatchedMonitor，一个线程</li><li>创建operationQueuer</li><li>创建prometheusMetricsThread，单线程</li></ul><p>key功能：</p><ul><li><p>函数start</p><ul><li>启动backplane</li><li>启动dispatchedMonitor</li><li>启动operationQueuer</li><li>启动prometheusMetricsThread</li></ul></li><li><p>函数stop：这个不细说了，我们基本没主动停机过</p></li><li><p>函数findMissingBlobs：查找missingblob的位置的关键函数</p><ul><li>先遍历一遍找到非空的blobdigest</li><li>然后获取worker，丢到一个双端队列中。这里面有个问题啊，某些blob可能只存储在特定的worker上，随便找一个worker可能找不到啊？明白了，这个只是查找，获取到底在哪个worker上？</li><li>调用findMissingBlobsOnWorker，创意的requestid是个UUID.randomUUID().toString()</li><li>最后返回<code>ListenableFuture&lt;Iterable&lt;Digest>></code></li></ul></li><li><p>类别FindMissingResponseEntry</p><ul><li>就一个构造函数，指定worker，metric，exception啥的</li></ul></li><li><p>findMissingBlobsOnWorker</p><ul><li><p>调用 <code>workers.removeFirst()</code>来获得双端队列的第一个worker</p></li><li><p>调用workerstub去查找丢失的blob，实际上是创建listenablefuture：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ListenableFuture</span><span class=o>&lt;</span><span class=n>Iterable</span><span class=o>&lt;</span><span class=n>Digest</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>workerMissingBlobsFuture</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>workerStub</span><span class=p>(</span><span class=n>worker</span><span class=p>).</span><span class=na>findMissingBlobs</span><span class=p>(</span><span class=n>blobDigests</span><span class=p>,</span><span class=w> </span><span class=n>requestMetadata</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div></li><li><p>给listenablefuture加个回调函数</p><ul><li><p>成功：worker会返回一个missingDigests，这个应该指代可以找到的digests？继续调用findMissingBlobsOnWorker去查找。这个实际上</p></li><li><p>失败：</p><ul><li>如果是response没实现或者不可用（Code.UNAVAILABLE；Code.UNIMPLEMENTED），就removeMalfunctioningWorker。实际上这个可以解决我们最近经常遇到的某个worker stuck in settable future的问题。当然，我们目前还没明白为什么会stuck</li><li>如果是超时了</li><li>如果是被cancell了，那么什么也不做</li><li>其它的类型再把worker加到worker的末尾</li></ul><p>除非已经找到了，否则继续</p></li></ul></li></ul></li><li><p>fetchBlobFromWorker</p><ul><li>还是先deque一个worker</li><li>调用getblob去获取blob</li></ul></li><li><p>getBlob</p></li><li><p>execute：执行的关键逻辑</p><ul><li>检查backplane.canPrequeue，是否可以prequeue</li></ul></li></ul><p>shardinstace启动流程几个函数的创建</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl> public class ShardInstance extends AbstractServerInstance...
</span></span><span class=line><span class=cl> public ShardInstance<span class=o>(</span>
</span></span><span class=line><span class=cl>      String name,
</span></span><span class=line><span class=cl>      String identifier,
</span></span><span class=line><span class=cl>      DigestUtil digestUtil,
</span></span><span class=line><span class=cl>      ShardInstanceConfig config,
</span></span><span class=line><span class=cl>      Runnable onStop<span class=o>)</span> <span class=o>{</span>...
</span></span><span class=line><span class=cl>      	//step <span class=m>1</span> 在这里创建出来shardbackplane，也就是说每个server instance都会有自己的backplane。
</span></span><span class=line><span class=cl>        //backplane创建出来了，但是具体的更进一步的操作还没发生，shardinstance自己这么做的？backplane又是这么决定把哪个operation发到那里呢？
</span></span><span class=line><span class=cl>      	<span class=nv>内部调用</span> <span class=o>===</span>&gt; RedisShardBackplane,而RedisShardBackplane有RedisShardSubscriber,这里有订阅的逻辑在里面
</span></span><span class=line><span class=cl>      	
</span></span><span class=line><span class=cl>      	//step <span class=m>2</span> 创建actionCacheFetchService，或者叫做ListeningExecutorService，这里实际上就是给listeningfuture创建线程池呗
</span></span><span class=line><span class=cl>      	/* <span class=nv>actionCacheFetchService</span><span class=o>=</span>*/ listeningDecorator<span class=o>(</span>newFixedThreadPool<span class=o>(</span>24<span class=o>)))</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>         <span class=o>====</span>&gt;
</span></span><span class=line><span class=cl>             private ShardInstance<span class=o>(</span>
</span></span><span class=line><span class=cl>                String name,
</span></span><span class=line><span class=cl>                DigestUtil digestUtil,
</span></span><span class=line><span class=cl>                Backplane backplane,
</span></span><span class=line><span class=cl>                ShardInstanceConfig config,
</span></span><span class=line><span class=cl>                Runnable onStop,
</span></span><span class=line><span class=cl>                ListeningExecutorService actionCacheFetchService<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                	// step 1，创建新的ShardActionCache
</span></span><span class=line><span class=cl>                	new ShardActionCache<span class=o>(</span>DEFAULT_MAX_LOCAL_ACTION_CACHE_SIZE, backplane, actionCacheFetchService<span class=o>)</span>
</span></span><span class=line><span class=cl>                	// step 2,创建workerstub,workersub用来做什么？
</span></span><span class=line><span class=cl>                	WorkerStubs.create<span class=o>(</span>digestUtil, config.getGrpcTimeout<span class=o>())</span>,
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>===</span>&gt; 
</span></span><span class=line><span class=cl>                         public ShardInstance<span class=o>(</span>
</span></span><span class=line><span class=cl>                            String name,
</span></span><span class=line><span class=cl>                            DigestUtil digestUtil,
</span></span><span class=line><span class=cl>                            Backplane backplane,
</span></span><span class=line><span class=cl>                            ReadThroughActionCache readThroughActionCache,
</span></span><span class=line><span class=cl>                            boolean runDispatchedMonitor,
</span></span><span class=line><span class=cl>                            int dispatchedMonitorIntervalSeconds,
</span></span><span class=line><span class=cl>                            boolean runOperationQueuer,
</span></span><span class=line><span class=cl>                            long maxEntrySizeBytes,
</span></span><span class=line><span class=cl>                            int maxCpu,
</span></span><span class=line><span class=cl>                            int maxRequeueAttempts,
</span></span><span class=line><span class=cl>                            Duration maxActionTimeout,
</span></span><span class=line><span class=cl>                            boolean useDenyList,
</span></span><span class=line><span class=cl>                            Runnable onStop,
</span></span><span class=line><span class=cl>                            LoadingCache&lt;String, Instance&gt; workerStubs,
</span></span><span class=line><span class=cl>                            ListeningExecutorService actionCacheFetchService,
</span></span><span class=line><span class=cl>                            boolean ensureOutputsPresent<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            	//所有的核心逻辑都在这里，换言之这里就把每个需要用到的东西都创建出来
</span></span><span class=line><span class=cl>                            	//core step <span class=m>0</span> 起DispatchedMonitor之前，我们看一下这个requeueOperation的函数逻辑
</span></span><span class=line><span class=cl>                            	public ListenableFuture&lt;Void&gt; requeueOperation<span class=o>(</span>QueueEntry queueEntry, Duration timeout<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            		// step <span class=m>1</span> 获取executeEntry <span class=p>&amp;</span> Operation，executeEntry在buildfarm.proto内部定义，包含operation_name
</span></span><span class=line><span class=cl>                            		// execution_policy，request_metadata等信息
</span></span><span class=line><span class=cl>                            		// step <span class=m>2</span> 检查能不能requeue,
</span></span><span class=line><span class=cl>                            		// step <span class=m>3</span> validate <span class=p>&amp;</span> requeue
</span></span><span class=line><span class=cl>                            		private ListenableFuture&lt;Void&gt; validateAndRequeueOperation <span class=o>{</span>
</span></span><span class=line><span class=cl>                            			//这里的重点就是四个future
</span></span><span class=line><span class=cl>                            			ListenableFuture&lt;QueuedOperation&gt; fetchQueuedOperationFuture；
</span></span><span class=line><span class=cl>                            			ListenableFuture&lt;QueuedOperation&gt; queuedOperationFuture；
</span></span><span class=line><span class=cl>                            			ListenableFuture&lt;QueuedOperation&gt; validatedFuture；
</span></span><span class=line><span class=cl>                            			ListenableFuture&lt;QueuedOperationResult&gt; uploadedFuture；
</span></span><span class=line><span class=cl>                            			SettableFuture&lt;Void&gt; <span class=nv>requeuedFuture</span> <span class=o>=</span> SettableFuture.create<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            				<span class=o>==</span>&gt; QueuedOperationResult <span class=p>&amp;</span> <span class=nv>uploadQueuedOperation</span>
</span></span><span class=line><span class=cl>                            					<span class=o>==</span>&gt; backplane.queue核心是queue
</span></span><span class=line><span class=cl>                            		<span class=o>}</span>
</span></span><span class=line><span class=cl>                            	<span class=o>}</span>
</span></span><span class=line><span class=cl>                            	//core step <span class=m>1</span> 起一个线程来做DispatchedMonitor
</span></span><span class=line><span class=cl>                            	<span class=nv>dispatchedMonitor</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                                new Thread<span class=o>(</span>
</span></span><span class=line><span class=cl>                                    new DispatchedMonitor<span class=o>(</span>
</span></span><span class=line><span class=cl>                                        backplane, this::requeueOperation, dispatchedMonitorIntervalSeconds<span class=o>))</span><span class=p>;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                        	//dispatchedMonitor负责把已经dispatched的operation（action）重新压入，是固定的压倒一个queue吗？或者说是稳定的worker去dequeue这个queentry吗？
</span></span><span class=line><span class=cl>                                        	//重点关注这个requeue函数，
</span></span><span class=line><span class=cl>                                        	private ListenableFuture&lt;Void&gt; requeueDispatchedOperation<span class=o>(</span>DispatchedOperation o, long now<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                        		// step <span class=m>1</span> 内部调用private void logOverdueOperation<span class=o>(</span>DispatchedOperation o, long now<span class=o>)</span> 记录下
</span></span><span class=line><span class=cl>                                        		logOverdueOperation<span class=o>(</span>o, now<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                        		// step <span class=m>2</span> requeue，这里就要关注requeued的逻辑是什么了,
</span></span><span class=line><span class=cl>                                        		ListenableFuture&lt;Void&gt; <span class=nv>requeuedFuture</span> <span class=o>=</span> requeuer.apply<span class=o>(</span>queueEntry, Durations.fromSeconds<span class=o>(</span>60<span class=o>))</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                                        	<span class=o>}</span>
</span></span><span class=line><span class=cl>                                        	
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                                        
</span></span><span class=line><span class=cl>                                        
</span></span><span class=line><span class=cl>                              //core step <span class=m>2</span> 起一个线程做operationQueuer，这个Runnable在不断的往队列里面丢东西，
</span></span><span class=line><span class=cl>                                ListenableFuture&lt;Void&gt; iterate<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                	//拿一个prequeueoperation，
</span></span><span class=line><span class=cl>                                	backplane.deprequeueOperation<span class=o>()</span>
</span></span><span class=line><span class=cl>                                	//为了能够理解poller，我们看看poller干了些什么，poller起了一个线程ActivePoller监视，第一个参数是BooleanSupplier，实际上就是看是不是出异常的时候是不是终止了shardinstance
</span></span><span class=line><span class=cl>                                	//然后poller resume，先把结果poll出来，再调用ListenableFuture把结果再查到对立里，但是查队列的时候这么找到客户段的？就是buildfarm-worker的？
</span></span><span class=line><span class=cl>                                	poller.resume
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                              
</span></span><span class=line><span class=cl>                              //core step <span class=m>3</span> 起promethues metric 线程，具体的代码就不贴了，没啥意思
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                     
</span></span></code></pre></div><pre tabindex=0><code>@Override
  public ListenableFuture&lt;Void&gt; execute(
      Digest actionDigest,
      boolean skipCacheLookup,
      ExecutionPolicy executionPolicy,
      ResultsCachePolicy resultsCachePolicy,
      RequestMetadata requestMetadata,
      Watcher watcher) {
    try {
      if (!backplane.canPrequeue()) {
        return immediateFailedFuture(
            Status.RESOURCE_EXHAUSTED.withDescription(&#34;Too many jobs pending&#34;).asException());
      }

      String operationName = createOperationName(UUID.randomUUID().toString());

      executionSuccess.inc();
      log.log(
          Level.FINE,
          new StringBuilder()
              .append(&#34;ExecutionSuccess: &#34;)
              .append(requestMetadata.getToolInvocationId())
              .append(&#34; -&gt; &#34;)
              .append(operationName)
              .append(&#34;: &#34;)
              .append(DigestUtil.toString(actionDigest))
              .toString());

      actionCache.invalidate(DigestUtil.asActionKey(actionDigest));
      if (!skipCacheLookup &amp;&amp; recentCacheServedExecutions.getIfPresent(requestMetadata) != null) {
        log.log(
            Level.FINE,
            format(&#34;Operation %s will have skip_cache_lookup = true due to retry&#34;, operationName));
        skipCacheLookup = true;
      }

      String stdoutStreamName = operationName + &#34;/streams/stdout&#34;;
      String stderrStreamName = operationName + &#34;/streams/stderr&#34;;
      ExecuteEntry executeEntry =
          ExecuteEntry.newBuilder()
              .setOperationName(operationName)
              .setActionDigest(actionDigest)
              .setExecutionPolicy(executionPolicy)
              .setResultsCachePolicy(resultsCachePolicy)
              .setSkipCacheLookup(skipCacheLookup)
              .setRequestMetadata(requestMetadata)
              .setStdoutStreamName(stdoutStreamName)
              .setStderrStreamName(stderrStreamName)
              .setQueuedTimestamp(Timestamps.fromMillis(System.currentTimeMillis()))
              .build();
      ExecuteOperationMetadata metadata =
          ExecuteOperationMetadata.newBuilder()
              .setActionDigest(actionDigest)
              .setStdoutStreamName(stdoutStreamName)
              .setStderrStreamName(stderrStreamName)
              .build();
      Operation operation =
          Operation.newBuilder().setName(operationName).setMetadata(Any.pack(metadata)).build();
      try {
        watcher.observe(operation);
      } catch (Exception e) {
        return immediateFailedFuture(e);
      }

      if (inDenyList(requestMetadata)) {
        watcher.observe(
            operation
                .toBuilder()
                .setDone(true)
                .setResponse(Any.pack(denyActionResponse(actionDigest, BLOCK_LIST_ERROR)))
                .build());
        return immediateFuture(null);
      }
      backplane.prequeue(executeEntry, operation);
      return watchOperation(
          operation,
          newActionResultWatcher(DigestUtil.asActionKey(actionDigest), watcher),
          /* initial=*/ false);
    } catch (IOException e) {
      return immediateFailedFuture(e);
    }
  }
</code></pre><h2 class="relative group">BackPlane相关<div id=backplane%E7%9B%B8%E5%85%B3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#backplane%E7%9B%B8%E5%85%B3 aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>queue</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>JedisCluster</span><span class=w> </span><span class=n>jedis</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>operationName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Platform</span><span class=p>.</span><span class=na>Property</span><span class=o>&gt;</span><span class=w> </span><span class=n>provisions</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>queueEntryJson</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>priority</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=na>dispatchedOperations</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>jedis</span><span class=p>,</span><span class=w> </span><span class=n>operationName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>logger</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>Level</span><span class=p>.</span><span class=na>WARNING</span><span class=p>,</span><span class=w> </span><span class=n>format</span><span class=p>(</span><span class=s>&#34;removed dispatched operation %s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>operationName</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>state</span><span class=p>.</span><span class=na>operationQueue</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>jedis</span><span class=p>,</span><span class=w> </span><span class=n>provisions</span><span class=p>,</span><span class=w> </span><span class=n>queueEntryJson</span><span class=p>,</span><span class=w> </span><span class=n>priority</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;ConstantConditions&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>queue</span><span class=p>(</span><span class=n>QueueEntry</span><span class=w> </span><span class=n>queueEntry</span><span class=p>,</span><span class=w> </span><span class=n>Operation</span><span class=w> </span><span class=n>operation</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>operationName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operation</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>operationJson</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operationPrinter</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>operation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>queueEntryJson</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JsonFormat</span><span class=p>.</span><span class=na>printer</span><span class=p>().</span><span class=na>print</span><span class=p>(</span><span class=n>queueEntry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Operation</span><span class=w> </span><span class=n>publishOperation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>onPublish</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>operation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>priority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queueEntry</span><span class=p>.</span><span class=na>getExecuteEntry</span><span class=p>().</span><span class=na>getExecutionPolicy</span><span class=p>().</span><span class=na>getPriority</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>client</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jedis</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>jedis</span><span class=p>.</span><span class=na>setex</span><span class=p>(</span><span class=n>operationKey</span><span class=p>(</span><span class=n>operationName</span><span class=p>),</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>getOperationExpire</span><span class=p>(),</span><span class=w> </span><span class=n>operationJson</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>queue</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>jedis</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>operation</span><span class=p>.</span><span class=na>getName</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>queueEntry</span><span class=p>.</span><span class=na>getPlatform</span><span class=p>().</span><span class=na>getPropertiesList</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>queueEntryJson</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>priority</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>publishReset</span><span class=p>(</span><span class=n>jedis</span><span class=p>,</span><span class=w> </span><span class=n>publishOperation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 class="relative group">ShardInstance Worker相关代码阅读<div id=shardinstance-worker%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#shardinstance-worker%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB aria-label=锚点>#</a></span></h2><p>我们先大致理解下worker，以shardworker为例，到底是个怎么的架构。</p><p>什么是operationContext包含operation，action，command，queuentry，poller等信息。operation或者说com.google.longrunning.Operation，即为This resource represents a long-running operation that is the result of a network API call，这实际上可以认为是个凭证，客户端可以一直轮训这个来获取结果。action，command。poller，内部包含一个继承自Runnable的ActivePoller，puller的构造函数每次都会指定到点时间，poller有两个函数，一个是resume：构造一个activePoller然后起个线程去执行它，pause：停止activePoller，然后置空。这里注意，activePoller会不断检查是不是超时了，执行操作，如果stop了，那么函数会调用notify去通知，通知谁？</p><p>Worker首先会配置好一个worker context，然后创建每个service：</p><ol><li><p>ContentAddressableStorageService，这个服务是查询数据/缓存数据的核心操作。</p></li><li><p>ByteStreamService，写文件实际上的服务发生在这里发生在这里。这里面有个java的streamobserver的基础知识，看这里https://grpc.io/docs/languages/java/basics/ 和 <a href=https://blog.csdn.net/u010900754/article/details/106203724 target=_blank>https://blog.csdn.net/u010900754/article/details/106203724</a></p><ol><li><p>客户端(这个客户端）会调用函数StreamObserver<writerequest> write(StreamObserver<writeresponse> responseObserver)，服务端（也就是我们的worker）搞一个双向的流式传输，返回给客户端一个WriteStreamObserver，从而每当客户端发来一些数据就会做一些操作。这里的WriteStreamObserver.onNext()就是针对客户端的一些操作的回调：我们在根据客户端的操作做一系列的行为</p><p>下面的栈显示了，WriteStreamObserver发过来一个Request的时候，我们就触发了个一个操作，根据具体write的类型决定是getOperationStreamWrite还是getUploadBlobWrite，先加一个回调函数，然后开始handleRequest这个请求。这时候实际上就是等待获取写入的commitsize的过程，这个closedfuture实际上就是真正的写入。</p><pre tabindex=0><code>SettableFuture is waiting for executor?
&#34;grpc-default-executor-7&#34; #418 daemon prio=5 os_prio=0 cpu=8.65ms elapsed=182086.43s allocated=1427K defined_classes=0 tid=0x00007f662c04f800 nid=0x257 waiting on condition  [0x00007f61a70f3000]
   java.lang.Thread.State: WAITING (parking)
  at jdk.internal.misc.Unsafe.park(java.base@11.0.15/Native Method)
  - parking to wait for  &lt;0x000000010598b288&gt; (a com.google.common.util.concurrent.SettableFuture)
  at java.util.concurrent.locks.LockSupport.park(java.base@11.0.15/LockSupport.java:194)
  at com.google.common.util.concurrent.AbstractFuture.get(AbstractFuture.java:537)
  at com.google.common.util.concurrent.AbstractFuture$TrustedFuture.get(AbstractFuture.java:104)
  at build.buildfarm.cas.cfc.CASFileCache$3.getOutput(CASFileCache.java:855)
  - locked &lt;0x00000001059897b8&gt; (a build.buildfarm.cas.cfc.CASFileCache$3)
  at build.buildfarm.server.WriteStreamObserver.getOutput(WriteStreamObserver.java:414)
  at build.buildfarm.server.WriteStreamObserver.getCommittedSizeForWrite(WriteStreamObserver.java:288)
  at build.buildfarm.server.WriteStreamObserver.handleWrite(WriteStreamObserver.java:297)
  at build.buildfarm.server.WriteStreamObserver.handleRequest(WriteStreamObserver.java:282)
  at build.buildfarm.server.WriteStreamObserver.initialize(WriteStreamObserver.java:228)
  at build.buildfarm.server.WriteStreamObserver.onUncommittedNext(WriteStreamObserver.java:115)
  at build.buildfarm.server.WriteStreamObserver.onNext(WriteStreamObserver.java:95)
  - locked &lt;0x0000000091795828&gt; (a build.buildfarm.server.WriteStreamObserver)
  at build.buildfarm.server.WriteStreamObserver.onNext(WriteStreamObserver.java:53)
...
</code></pre></li></ol></li></ol><p>然后创建一个pipeline，包含多个stage，执行任务。</p><ol><li><p>MatchStage继承PipelineStage，显式调用iterate函数来执行ShardWorkerContext.match函数，调用redis的阻塞方式读取operation，这里有个小点，provisionqueue没有注册在backplane里面，是在取的时候显式的从本地配置读取的，栈如下。所以如果没有什么match的，那么实际上是阻塞在标记处</p><pre tabindex=0><code>	at build.buildfarm.common.redis.ProvisionedRedisQueue.isEligible(ProvisionedRedisQueue.java:182)
	at build.buildfarm.instance.shard.OperationQueue.chooseEligibleQueue(OperationQueue.java:271)
	at build.buildfarm.instance.shard.OperationQueue.dequeue(OperationQueue.java:189) &lt;== stuck
	at build.buildfarm.instance.shard.RedisShardBackplane.dispatchOperation(RedisShardBackplane.java:1153)
	at build.buildfarm.instance.shard.RedisShardBackplane.lambda$dispatchOperation$27(RedisShardBackplane.java:1210)
	at build.buildfarm.common.redis.RedisClient.lambda$blockingCall$1(RedisClient.java:99)
	at build.buildfarm.common.redis.RedisClient.call(RedisClient.java:117)
	at build.buildfarm.common.redis.RedisClient.blockingCall(RedisClient.java:96)
	at build.buildfarm.instance.shard.RedisShardBackplane.dispatchOperation(RedisShardBackplane.java:1210)
	at build.buildfarm.worker.shard.ShardWorkerContext.matchInterruptible(ShardWorkerContext.java:279)
	at build.buildfarm.worker.shard.ShardWorkerContext.match(ShardWorkerContext.java:361)
	at build.buildfarm.worker.MatchStage.iterate(MatchStage.java:143)
	at build.buildfarm.worker.PipelineStage.runInterruptible(PipelineStage.java:44)
	at build.buildfarm.worker.PipelineStage.run(PipelineStage.java:51)
	at java.base/java.lang.Thread.run(Thread.java:829)
	bazel build -c opt --config=cpu offboard/playback:playback_client
</code></pre></li><li><p>InputFetchStage继承SuperscalarPipelineStage，创建新线程InputFetcher，去获取相关的信息</p><ul><li><p>InputFetcher拿到要使用的文件，下载到本地。该过程在workercontext.createExecDir调用execFileSystem的同名函数，会批量创建fetchedFutures拿取文件，这里要理解fetchInputs阶段如何创建fetchedFutures</p></li><li><p>fetchInputs遍历每个目录里面的文件并且下载到本地，这里要注意，运行到的东西实际上是已经存储到了CAS中。其调用Directory(见admin/main/src/main/resources/proto/remote_execution.proto)里面的FileNode files field字段，然后对每个FileNode使用src/main/java/build/buildfarm/worker/shard/CFCExecFileSystem.java里面的put函数，简单来说就是调用fileCache来获取文件，真正的执行者是（src/main/java/build/buildfarm/server/services/FetchService.java）FetchService</p></li></ul></li><li><p>PutOperationStage包含InterruptingConsumer<operation> onPut结构，InterruptingConsumer是一个范型。每次往这个stage放OperationContext，就是往onPut里面放operation。</p></li><li><p>ReportResultStage继承自PipelineStage，它包含一个BlockingQueue，这个queue里面放的是OperationContext。这个stage只有一个workerContext，这个stage的tick函数里，workerContext会resumePoller，然后会尝试调用reportPolled。reportPolled函数，先构造一个resultBuilder，然后调用唯一的workerContext.uploadOutputs，并且保存执行完的action，然后构造一个completedOperation，//待确定，执行完后会调用after函数去摧毁execdir，因此实际上大量hardlink重复到一个node上的情况理论上不会特别高的概率出现。</p></li><li><p>ExecuteActionStage继承SuperscalarPipelineStage，它的iterate函数，覆盖了默认的iterate函数，对每个context，新建一个executor和executorThread，每个thread都会加到保存的executors里面。然后启动每个线程，开始执行。所以实际上启动的线程数量是无限的吗？这里肯定有什么我漏了的</p><ul><li>executor是个runnable，它的核心是runInterruptible:获取operation的metadata，更新为处于正在执行的stage。然后尝试更新operation，更新成功以后调用workerContext.resumePoller，然后调用executePolled<ul><li><p>workerContext.resumePoller，因为我们的buildfarm是shardinstace，所以关注ShardWorkerContext：传进来的poller.resume调用operationPoller.poll，就是backplane::pollOperation.poll；简单来说，就是传进来的poller.resume会然后创建新的ActivePoller，在超时的时候调用operationPoller.poll，就是backplane::pollOperation.poll。这时候还没有开始执行呢，只是把东西都启动了拿回来</p><ul><li>ActivePoller，超时后调用onExpiration.</li></ul></li><li><p>executePolled，真正关心的东西，执行command，remote execute就是在这里做的操作，换言之build/test都是在这里做的。先把io资源相关的东西搞出来，然后调用executeCommand</p><ul><li>executeCommand函数</li></ul></li></ul></li></ul></li><li><hr></li><li></li></ol><p>这几个说完了，说点其他的，我们看inputfetch stage似乎只是获取operation，没有拿到具体的data，那么数据从哪里来呢？</p><pre tabindex=0><code></code></pre><p>BuildFarm Worker负责执行执行test，保存本地的cache，插入blob，我们先看构造函数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>build</span><span class=o>/</span><span class=n>buildfarm</span><span class=o>/</span><span class=n>worker</span><span class=o>/</span><span class=n>shard</span><span class=o>/</span><span class=n>Worker</span><span class=p>.</span><span class=na>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>Worker</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>session</span><span class=p>,</span><span class=w> </span><span class=n>ServerBuilder</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>serverBuilder</span><span class=p>,</span><span class=w> </span><span class=n>ShardWorkerConfig</span><span class=w> </span><span class=n>config</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>throws</span><span class=w> </span><span class=n>ConfigurationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//step 1 先设置一些基本配置，获取些cas容量和remote executive的设置，然后指定worker的名字,启动backplane，创建workerstub，用来通信,代码省略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//step 2 创建removeDirectoryService，accessRecorder,remoteInputStreamFactory,cas和execfs。这里有一点要注意，就是</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>removeDirectoryService</span><span class=w> </span><span class=o>=</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>accessRecorder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newSingleThreadExecutor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>InputStreamFactory</span><span class=w> </span><span class=n>remoteInputStreamFactory</span><span class=w> </span><span class=o>=</span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//removeDirectoryService参与到了ContentAddressableStorage &amp; execFileSystem的创建，或者说实际上就是具体执行操作的线程池</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//让我们具体到上面几个什么ContentAddressableStorage/execFileSystem看看这个removeDirectoryService都干了些什么操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ContentAddressableStorage</span><span class=w> </span><span class=n>storage</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      	</span><span class=n>createStorages</span><span class=p>(</span><span class=n>remoteInputStreamFactory</span><span class=p>,</span><span class=w> </span><span class=n>removeDirectoryService</span><span class=p>,</span><span class=w> </span><span class=n>accessRecorder</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>getCasList</span><span class=p>());</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//我们是filesystem类型的cas，经过两轮调用,创建casfilecache。removeDirectoryService对应代码里面的expireService，用来做删除的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      			</span><span class=n>ShardCASFileCache</span><span class=p>(....,</span><span class=n>removeDirectoryService</span><span class=p>,</span><span class=n>accessRecorder</span><span class=p>...);</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//shardcasfilecache是casfilecache内部的代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//情况1 实际就是本地文件没有，要重新生成，这个时候发现路径或者entry重复了，就需要删除文件会用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>newTransparentInput</span><span class=o>/</span><span class=n>newInput</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=n>newLocalInput</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=n>dischargeEntry</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span><span class=w> </span><span class=n>expireService</span><span class=p>);</span><span class=w>           
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//情况2 有新的输出文件或内容产生，要放到本地就会被调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              		</span><span class=n>putImpl</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>putOrReference</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=n>putOrReferenceGuarded</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>charge</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=c1>//内部调用expireService，或者说就是我们的removeDirectoryService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>execFileSystem</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>createExecFileSystem</span><span class=p>(</span><span class=n>remoteInputStreamFactory</span><span class=p>,</span><span class=w> </span><span class=n>removeDirectoryService</span><span class=p>,</span><span class=w> </span><span class=n>accessRecorder</span><span class=p>,</span><span class=w> </span><span class=n>storage</span><span class=p>);{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=c1>//因为是casfilecache，所以创建对应的execfilesystem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      			</span><span class=n>createCFCExecFileSystem</span><span class=p>(</span><span class=n>removeDirectoryService</span><span class=p>,</span><span class=w> </span><span class=n>accessRecorder</span><span class=p>,</span><span class=w> </span><span class=n>cfc</span><span class=p>,</span><span class=w> </span><span class=n>owner</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>CFCExecFileSystem</span><span class=p>(...,</span><span class=w> </span><span class=n>removeDirectoryService</span><span class=p>,</span><span class=w> </span><span class=n>accessRecorder</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=c1>//继续看哪里用了removeDirectoryService，将removeDirectoryService作为参数传递到filecache，就是上面的storage里面</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=n>ImmutableList</span><span class=p>.</span><span class=na>Builder</span><span class=o>&lt;</span><span class=n>Digest</span><span class=o>&gt;</span><span class=w> </span><span class=n>blobDigests</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ImmutableList</span><span class=p>.</span><span class=na>builder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=n>fileCache</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>digest</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>blobDigests</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                              </span><span class=n>blobDigests</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>digest</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>removeDirectoryService</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>skipLoad</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>instance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ShardWorkerInstance</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>getPublicName</span><span class=p>(),</span><span class=w> </span><span class=n>digestUtil</span><span class=p>,</span><span class=w> </span><span class=n>backplane</span><span class=p>,</span><span class=w> </span><span class=n>storage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// step 3 Create the appropriate writer for the context，并创建对应的pipeline，就是说我们的worker需要能执行操作，所以需要buildfarm worker提供</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CasWriter</span><span class=w> </span><span class=n>writer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ShardWorkerContext</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=p>...;</span><span class=w> </span><span class=c1>//ShardWorkerContext是执行，汇报，获取中的核心</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Pipeline</span><span class=p>();</span><span class=w> </span><span class=c1>//pipeline有四个pipeline stage：matchStage；inputFetchStage；executeActionStage；reportResultStage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//step 4， 最终创建server，开始提供服务。本身buildfarm worker实际上也是个服务器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createServer</span><span class=p>(</span><span class=n>serverBuilder</span><span class=p>,</span><span class=w> </span><span class=n>storage</span><span class=p>,</span><span class=w> </span><span class=n>instance</span><span class=p>,</span><span class=w> </span><span class=n>pipeline</span><span class=p>,</span><span class=w> </span><span class=n>context</span><span class=p>);</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>PipelineStage</span><span class=w> </span><span class=n>completeStage</span><span class=w> </span><span class=o>===&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PipelineStage</span><span class=w> </span><span class=n>errorStage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PipelineStage</span><span class=w> </span><span class=n>reportResultStage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PipelineStage</span><span class=w> </span><span class=n>executeActionStage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//pipelinestage实际上是可执行的程序，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>==&gt;</span><span class=w> </span><span class=n>startWorker</span><span class=p>(</span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>worker</span><span class=p>.</span><span class=na>start</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            		      </span><span class=n>backplane</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>getPublicName</span><span class=p>());</span><span class=w> </span><span class=c1>//启动backplane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            		      </span><span class=n>execFileSystem</span><span class=p>.</span><span class=na>start</span><span class=p>((</span><span class=n>digests</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>addBlobsLocation</span><span class=p>(</span><span class=n>digests</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>getPublicName</span><span class=p>()),</span><span class=w> </span><span class=n>skipLoad</span><span class=p>);</span><span class=w> </span><span class=c1>//execfs启动</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      	    </span><span class=n>worker</span><span class=p>.</span><span class=na>blockUntilShutdown</span><span class=p>();</span><span class=w> </span><span class=c1>//和worker.start同级</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><pre tabindex=0><code>pipelinestage
</code></pre><p>部分结构的伪代码，主要关注核心</p><p>PipelineStage</p><pre tabindex=0><code>runInterruptible {
	while(活着) {
		iterate {
			take operationContext;
			tick(operationContext) 来获取结果
		}
	}
}
</code></pre><p>SuperscalarPipelineStage 继承PipelineStage，结构没有大的不一样。但是它会自己创建PipelineStage error，用来处理出错的operationContext。唯一不同点是它的take是takeOrDrain，没10ms就take一次，不为空返回。但是如果interrupted，那么就会丢exception来终止自己</p><pre tabindex=0><code>&#34;ForkJoinPool-1-worker-141&#34; #663238 daemon prio=5 os_prio=0 cpu=102165.90ms elapsed=33159.90s tid=0x00007f6fe4003800 nid=0x1be14a runnable  [0x00007f73652d8000]
   java.lang.Thread.State: RUNNABLE
        at sun.nio.fs.UnixNativeDispatcher.link0(java.base@11.0.15/Native Method)
        at sun.nio.fs.UnixNativeDispatcher.link(java.base@11.0.15/UnixNativeDispatcher.java:141)
        at sun.nio.fs.UnixFileSystemProvider.createLink(java.base@11.0.15/UnixFileSystemProvider.java:479)
        at java.nio.file.Files.createLink(java.base@11.0.15/Files.java:1102)
        at build.buildfarm.worker.shard.CFCExecFileSystem.lambda$put$3(CFCExecFileSystem.java:202)
        at build.buildfarm.worker.shard.CFCExecFileSystem$$Lambda$298/0x00000008403c3840.apply(Unknown Source)
        at com.google.common.util.concurrent.AbstractTransformFuture$AsyncTransformFuture.doTransform(AbstractTransformFuture.java:213)
        at com.google.common.util.concurrent.AbstractTransformFuture$AsyncTransformFuture.doTransform(AbstractTransformFuture.java:202)
        at com.google.common.util.concurrent.AbstractTransformFuture.run(AbstractTransformFuture.java:118)
        at java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec(java.base@11.0.15/ForkJoinTask.java:1426)
        at java.util.concurrent.ForkJoinTask.doExec(java.base@11.0.15/ForkJoinTask.java:290)
        at java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(java.base@11.0.15/ForkJoinPool.java:1020)
        at java.util.concurrent.ForkJoinPool.scan(java.base@11.0.15/ForkJoinPool.java:1656)
        at java.util.concurrent.ForkJoinPool.runWorker(java.base@11.0.15/ForkJoinPool.java:1594)
        at java.util.concurrent.ForkJoinWorkerThread.run(java.base@11.0.15/ForkJoinWorkerThread.java:183)
</code></pre><p>另外一个fetchinputstage的栈</p><pre tabindex=0><code>&#34;Thread-687829&#34; #698760 prio=5 os_prio=0 cpu=7.20ms elapsed=0.02s tid=0x00007f75e86b2800 nid=0x1d2adf runnable  [0x00007f718b2f0000]
   java.lang.Thread.State: RUNNABLE
        at com.google.protobuf.Utf8.decodeUtf8(Utf8.java:340)
        at com.google.protobuf.CodedInputStream$StreamDecoder.readStringRequireUtf8(CodedInputStream.java:2299)
        at build.bazel.remote.execution.v2.Digest.&lt;init&gt;(Digest.java:82)
        at build.bazel.remote.execution.v2.Digest.&lt;init&gt;(Digest.java:38)
        at build.bazel.remote.execution.v2.Digest$1.parsePartialFrom(Digest.java:712)
        at build.bazel.remote.execution.v2.Digest$1.parsePartialFrom(Digest.java:706)
        at com.google.protobuf.CodedInputStream$StreamDecoder.readMessage(CodedInputStream.java:2367)
        at build.bazel.remote.execution.v2.FileNode.&lt;init&gt;(FileNode.java:67)
        at build.bazel.remote.execution.v2.FileNode.&lt;init&gt;(FileNode.java:13)
        at build.bazel.remote.execution.v2.FileNode$1.parsePartialFrom(FileNode.java:1079)
        at build.bazel.remote.execution.v2.FileNode$1.parsePartialFrom(FileNode.java:1073)
        at com.google.protobuf.CodedInputStream$StreamDecoder.readMessage(CodedInputStream.java:2367)
        at build.bazel.remote.execution.v2.Directory.&lt;init&gt;(Directory.java:134)
        at build.bazel.remote.execution.v2.Directory.&lt;init&gt;(Directory.java:82)
        at build.bazel.remote.execution.v2.Directory$1.parsePartialFrom(Directory.java:2057)
        at build.bazel.remote.execution.v2.Directory$1.parsePartialFrom(Directory.java:2051)
        at build.bazel.remote.execution.v2.Directory$Builder.mergeFrom(Directory.java:957)
        at build.bazel.remote.execution.v2.Directory$Builder.mergeFrom(Directory.java:690)
        at com.google.protobuf.CodedInputStream$StreamDecoder.readMessage(CodedInputStream.java:2351)
        at com.google.protobuf.MapEntryLite.parseField(MapEntryLite.java:128)
        at com.google.protobuf.MapEntryLite.parseEntry(MapEntryLite.java:184)
        at com.google.protobuf.MapEntry.&lt;init&gt;(MapEntry.java:107)
        at com.google.protobuf.MapEntry.&lt;init&gt;(MapEntry.java:50)
        at com.google.protobuf.MapEntry$Metadata$1.parsePartialFrom(MapEntry.java:71)
        at com.google.protobuf.MapEntry$Metadata$1.parsePartialFrom(MapEntry.java:65)
        at com.google.protobuf.CodedInputStream$StreamDecoder.readMessage(CodedInputStream.java:2367)
        at build.buildfarm.v1test.Tree.&lt;init&gt;(Tree.java:79)
        at build.buildfarm.v1test.Tree.&lt;init&gt;(Tree.java:16)
        at build.buildfarm.v1test.Tree$1.parsePartialFrom(Tree.java:936)
        at build.buildfarm.v1test.Tree$1.parsePartialFrom(Tree.java:930)
        at com.google.protobuf.CodedInputStream$StreamDecoder.readMessage(CodedInputStream.java:2367)
        at build.buildfarm.v1test.QueuedOperation.&lt;init&gt;(QueuedOperation.java:95)
        at build.buildfarm.v1test.QueuedOperation.&lt;init&gt;(QueuedOperation.java:9)
        at build.buildfarm.v1test.QueuedOperation$1.parsePartialFrom(QueuedOperation.java:1152)
        at build.buildfarm.v1test.QueuedOperation$1.parsePartialFrom(QueuedOperation.java:1146)
        at com.google.protobuf.AbstractParser.parsePartialFrom(AbstractParser.java:100)
        at com.google.protobuf.AbstractParser.parseFrom(AbstractParser.java:120)
        at com.google.protobuf.AbstractParser.parseFrom(AbstractParser.java:125)
        at com.google.protobuf.AbstractParser.parseFrom(AbstractParser.java:48)
        at build.buildfarm.v1test.QueuedOperation.parseFrom(QueuedOperation.java:371)
        at build.buildfarm.common.ProtoUtils.parseQueuedOperation(ProtoUtils.java:47)
        at build.buildfarm.worker.shard.ShardWorkerContext.getQueuedOperation(ShardWorkerContext.java:272)
        at build.buildfarm.worker.InputFetcher.fetchPolled(InputFetcher.java:178)
        at build.buildfarm.worker.InputFetcher.runInterruptibly(InputFetcher.java:101)
        at build.buildfarm.worker.InputFetcher.run(InputFetcher.java:288)
        at java.lang.Thread.run(java.base@11.0.15/Thread.java:829)
</code></pre><p>关于</p><h2 class="relative group">BUILDFARM的奇怪问题<div id=buildfarm%E7%9A%84%E5%A5%87%E6%80%AA%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#buildfarm%E7%9A%84%E5%A5%87%E6%80%AA%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h2><h3 class="relative group">1 BUILDFARM上传模型失败<div id=1-buildfarm%E4%B8%8A%E4%BC%A0%E6%A8%A1%E5%9E%8B%E5%A4%B1%E8%B4%A5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-buildfarm%E4%B8%8A%E4%BC%A0%E6%A8%A1%E5%9E%8B%E5%A4%B1%E8%B4%A5 aria-label=锚点>#</a></span></h3><p>这个问题实际上困扰我们已经很久了，我们的buildfarm worker有时候离线了，需要重新触发blob上传就会报这个错误。只不过一直没找到稳定复现的机会，因为buildfarm-worker也不是一直出问题。。。这两天上传有仿真同事一直说bazel test出错，开始正式追踪，错误信息贴在了下面</p><pre tabindex=0><code>(06:17:44) [13,512 / 13,544] 337 / 3997 tests; Testing //onboard/planner/speed:speed_optimizer_test; 37s remote ... (30 actions, 0 running)
(06:18:14) [13,512 / 13,544] 337 / 3997 tests; Testing //onboard/planner/speed:speed_optimizer_test; 67s remote ... (30 actions, 0 running)
(06:18:25) ERROR: /builds/MSfUsJda/15/root/qcraft/onboard/planner/initializer/geometry/BUILD:158:8: Testing //onboard/planner/initializer/geometry:geometry_form_builder_test failed: (Exit 34): Error while uploading artifact with digest &#39;c7a5774bd97a9bee99d19dcfa8a7f5d6216dbe7ec842c1719d1ec9121ea732b3/684019619&#39;
com.google.devtools.build.lib.remote.BulkTransferException: Error while uploading artifact with digest &#39;c7a5774bd97a9bee99d19dcfa8a7f5d6216dbe7ec842c1719d1ec9121ea732b3/684019619&#39;
		...
		at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123)
		... 3 more
	Caused by: io.grpc.StatusRuntimeException: UNKNOWN: HTTP status code 413
invalid content-type: text/html
headers: Metadata(:status=413,date=Wed, 01 Jun 2022 06:18:25 GMT,content-type=text/html,content-length=176,strict-transport-security=max-age=15724800; includeSubDomains,access-control-allow-origin=*,access-control-allow-credentials=true)
DATA-----------------------------
&lt;html&gt;
&lt;head&gt;&lt;title&gt;413 Request Entity Too Large&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;413 Request Entity Too Large&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
		at io.grpc.Status.asRuntimeException(Status.java:524)
		at com.google.devtools.build.lib.remote.ByteStreamUploader$AsyncUpload$1.onClose(ByteStreamUploader.java:551)
		... 13 more
</code></pre><p>我们的架构是一个ack-ingress在前面整个代理。后面是buildfarm-server& buildfarm-worker。我开始介入debug，然后发现很奇怪的现象是buildfarm-server端没出错的信息，也没有什么日志记录这个bolb，然后开始怀疑是不是中间的ack-ingress的问题。然后去查ingress的日志看到这种日志</p><pre tabindex=0><code>2022/06/01 13:40:49 [error] 18994#18994: *1457627908 client intended to send too large chunked body: 20972665 bytes while sending request to upstream, client: 172.20.1.18, server: buildfarm-all.qcraftai.com, request: &#34;POST /google.bytestream.ByteStream/Write HTTP/2.0&#34;, upstream: &#34;grpc://10.150.1.56:8980&#34;, host: &#34;buildfarm-all.qcraftai.com:443&#34;
</code></pre><p>感觉不对劲，查配置发现对应ingress里面的proxy-body-size这个有点不对，才8m。而我们用户的模型动不动就600多m，改成了1024重试，成功了。。。</p><h3 class="relative group">2 BUILDFARM WORKER STUCK<div id=2-buildfarm-worker-stuck class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-buildfarm-worker-stuck aria-label=锚点>#</a></span></h3><p>相比较第一个问题，第二个问题更令人无奈一些。我们的buildfarm worker有的时候会卡住，使用jstack观察打印出来的栈。会发现所有的remove-directory-pool的线程都会卡在<code>parking to wait for &lt;0x00000000934039d0> (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</code>，其它的forkjonpool也会卡住：<code>parking to wait for &lt;0x00000000957aed30> (a java.util.concurrent.ForkJoinPool)</code>，然后buildfarm会启动一大堆其它的thread，然后每个都在等，最后buildfarm的线程数量会超过1000个，而且这个worker就会进入无法相应的状态，也就是说，server会不断往这个worker发任务，但是一直无法完成，最终block到用户的编译任务。</p><pre tabindex=0><code>SettableFuture is waiting for executor?
&#34;grpc-default-executor-7&#34; #418 daemon prio=5 os_prio=0 cpu=8.65ms elapsed=182086.43s allocated=1427K defined_classes=0 tid=0x00007f662c04f800 nid=0x257 waiting on condition  [0x00007f61a70f3000]
   java.lang.Thread.State: WAITING (parking)
  at jdk.internal.misc.Unsafe.park(java.base@11.0.15/Native Method)
  - parking to wait for  &lt;0x000000010598b288&gt; (a com.google.common.util.concurrent.SettableFuture)
  at java.util.concurrent.locks.LockSupport.park(java.base@11.0.15/LockSupport.java:194)
  at com.google.common.util.concurrent.AbstractFuture.get(AbstractFuture.java:537)
  at com.google.common.util.concurrent.AbstractFuture$TrustedFuture.get(AbstractFuture.java:104)
  at build.buildfarm.cas.cfc.CASFileCache$3.getOutput(CASFileCache.java:855)
  - locked &lt;0x00000001059897b8&gt; (a build.buildfarm.cas.cfc.CASFileCache$3)
  at build.buildfarm.server.WriteStreamObserver.getOutput(WriteStreamObserver.java:414)
  at build.buildfarm.server.WriteStreamObserver.getCommittedSizeForWrite(WriteStreamObserver.java:288)
  at build.buildfarm.server.WriteStreamObserver.handleWrite(WriteStreamObserver.java:297)
  at build.buildfarm.server.WriteStreamObserver.handleRequest(WriteStreamObserver.java:282)
  at build.buildfarm.server.WriteStreamObserver.initialize(WriteStreamObserver.java:228)
  at build.buildfarm.server.WriteStreamObserver.onUncommittedNext(WriteStreamObserver.java:115)
  at build.buildfarm.server.WriteStreamObserver.onNext(WriteStreamObserver.java:95)
  - locked &lt;0x0000000091795828&gt; (a build.buildfarm.server.WriteStreamObserver)
  at build.buildfarm.server.WriteStreamObserver.onNext(WriteStreamObserver.java:53)
  at io.grpc.stub.ServerCalls$StreamingServerCallHandler$StreamingServerCallListener.onMessage(ServerCalls.java:255)
  at io.grpc.internal.ServerCallImpl$ServerStreamListenerImpl.messagesAvailableInternal(ServerCallImpl.java:309)
  at io.grpc.internal.ServerCallImpl$ServerStreamListenerImpl.messagesAvailable(ServerCallImpl.java:292)
  at io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener$1MessagesAvailable.runInContext(ServerImpl.java:765)
  at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37)
  at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123)
  at java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@11.0.15/ThreadPoolExecutor.java:1128)
  at java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@11.0.15/ThreadPoolExecutor.java:628)
  at java.lang.Thread.run(java.base@11.0.15/Thread.java:829)
</code></pre><p>目前发现的部分现象，上面实际上针对worker的分析已经有了部分分析，我们清楚：</p><ol><li>handleWrite执行写入cas的操作，然而这个时候还没真的执行写入，只是调用getCommittedSizeForWrite获取commitsize，执行的代码是WriteStreamObserver.getOutput，它实际上是在等一个write.getOutput()，一个阻塞的操作。</li><li>而write.ouput函数实际上是拿到FeedbackOutputStream，顾名思义，有回馈的outputstream，调用write.getOutput来获取FeedbackOutputStream，这个地方可能有个小坑，这个write的实现在src/main/java/build/buildfarm/cas/cfc/CASFileCache.java里面，Write newWrite(BlobWriteKey key, ListenableFuture<long> future)这个函数。</li><li>这个时候虽然没有执行真正的写入，但是必然已经调用过getOutput，否则closedFuture == null，因此已经调用commitOpenState初始化了closedfuture，（第一次调用的时候使用createUniqueWriteOutput创建uniqueOut）这一步还只是</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=nd>@GuardedBy</span><span class=p>(</span><span class=s>&#34;this&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initialize</span><span class=p>(</span><span class=n>WriteRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>resourceName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getResourceName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resourceName</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>errorResponse</span><span class=p>(</span><span class=n>INVALID_ARGUMENT</span><span class=p>.</span><span class=na>withDescription</span><span class=p>(</span><span class=s>&#34;resource_name is empty&#34;</span><span class=p>).</span><span class=na>asException</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resourceName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>write</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getWrite</span><span class=p>(</span><span class=n>resourceName</span><span class=p>);</span><span class=w> </span><span class=c1>// &lt;===== we need to check this out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>logger</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Level</span><span class=p>.</span><span class=na>FINER</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>format</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;registering callback for %s: committed_size = %d (transient), complete = %s&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resourceName</span><span class=p>,</span><span class=w> </span><span class=n>write</span><span class=p>.</span><span class=na>getCommittedSize</span><span class=p>(),</span><span class=w> </span><span class=n>write</span><span class=p>.</span><span class=na>isComplete</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Futures</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>write</span><span class=p>.</span><span class=na>getFuture</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>FutureCallback</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onSuccess</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>committedSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>commit</span><span class=p>(</span><span class=n>committedSize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;NullableProblems&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onFailure</span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>errorResponse</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>withCancellation</span><span class=p>.</span><span class=na>fixedContextExecutor</span><span class=p>(</span><span class=n>directExecutor</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>write</span><span class=p>.</span><span class=na>isComplete</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>initialized</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>handleRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>EntryLimitException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>errorResponse</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>errorResponse</span><span class=p>(</span><span class=n>Status</span><span class=p>.</span><span class=na>fromThrowable</span><span class=p>(</span><span class=n>e</span><span class=p>).</span><span class=na>asException</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>logWriteRequest</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>下面的代码是伪代码，我删去了一些无用的东西。所以实际上最后Write就是blobWrites.get(key, () -> newWrite(key))，Cache的get方法有两个参数，第一个参数是要从Cache中获取记录的key，第二个记录是一个Callable对象。当缓存中已经存在key对应的记录时，get方法直接返回key对应的记录。如果缓存中不包含key对应的记录，Guava会启动一个线程执行Callable对象中的call方法，call方法的返回值会作为key对应的值被存储到缓存中，并且被get方法返回。所以这里会先造一个Write出来。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>Write</span><span class=w> </span><span class=nf>getWrite</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>resourceName</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>detectResourceOperation</span><span class=p>(</span><span class=n>resourceName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>UploadBlob</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ByteStreamService</span><span class=p>.</span><span class=na>getUploadBlobWrite</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span><span class=w> </span><span class=n>uploadBlobDigest</span><span class=p>,</span><span class=w> </span><span class=n>parseUploadBlobUUID</span><span class=p>(</span><span class=n>resourceName</span><span class=p>));</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>instance</span><span class=p>.</span><span class=na>getBlobWrite</span><span class=w> </span><span class=p>{</span><span class=w>  </span><span class=c1>//我们是shardinstance，所以得找shardinstace对应的代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>writes</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>digest</span><span class=p>,</span><span class=w> </span><span class=n>uuid</span><span class=p>,</span><span class=w> </span><span class=n>requestMetadata</span><span class=p>);</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>blobWrites</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>newWrite</span><span class=p>(</span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>//blobWrites是Cache&lt;BlobWriteKey, Write&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Write</span><span class=w> </span><span class=nf>newWrite</span><span class=p>(</span><span class=n>BlobWriteKey</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>ListenableFuture</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=n>future</span><span class=p>)</span><span class=w> </span><span class=c1>//CASFileCache.java:761，所以调用的时候getoutput也是直接在casfilecache里面。这一圈实际上绕的有点晕。。。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>OperationStream</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ByteStreamService</span><span class=p>.</span><span class=na>getOperationStreamWrite</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span><span class=w> </span><span class=n>resourceName</span><span class=p>);</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>instance</span><span class=p>.</span><span class=na>getOperationStreamWrite</span><span class=p>(</span><span class=n>resourceName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>Blob</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=n>INVALID_ARGUMENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>withDescription</span><span class=p>(</span><span class=s>&#34;unknown resource operation for &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>resourceName</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>asRuntimeException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">3 BUILD 任务很慢<div id=3-build-%E4%BB%BB%E5%8A%A1%E5%BE%88%E6%85%A2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-build-%E4%BB%BB%E5%8A%A1%E5%BE%88%E6%85%A2 aria-label=锚点>#</a></span></h3><p>这两天日常CI维护，我在盯CI任务的时候，发现有些用户的编译任务比较慢，开始排查怎么回事。参考文档https://bazel.build/rules/performance#performance-profiling</p><p>随便找了两个profile的文件，然后用chrome://tracing打开，第一张是编译很快，第二章是编译比较慢。能够非常明显的看出来有大量的queue操作，查看buildfarm的execute_slot_usage会发现60c用满了，可能是负载的问题，ok，用analysis-profile来分析下</p><p><figure><img class="my-0 rounded-md" loading=lazy src=imgs/fastbuild.png alt=image-20220721205716976></figure></p><p><figure><img class="my-0 rounded-md" loading=lazy src=imgs/slow-build.png alt=image-20220721212913294></figure></p><p>相比较而言，execution phase time的时间明显增长，符合我们观察到的信息，那么大概率是buildfarm的负载太重了，那么有没有可能是io，cpu，文件系统遇到了瓶颈呢？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>qcraft@qcraft-dev-qcraft:/hosthome/Downloads<span class=o>]</span> $ bazel analyze-profile fast-build-213465-6957259.profile.gz 
</span></span><span class=line><span class=cl>WARNING: Invoking Bazel in batch mode since it is not invoked from within a workspace <span class=o>(</span>below a directory having a WORKSPACE file<span class=o>)</span>.
</span></span><span class=line><span class=cl>WARNING: This information is intended <span class=k>for</span> consumption by Bazel developers only, and may change at any time. Script against it at your own risk
</span></span><span class=line><span class=cl>INFO: Profile created on Thu Jul <span class=m>21</span> 11:46:06 UTC 2022, build ID: d37327ed-2404-4c26-b9d8-a065086d3a24, output base: /home/qcrafter/.cache/bazel/_bazel_qcrafter/de91dfe5bfd7ed036386d41fdb745489
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>===</span> PHASE SUMMARY <span class=nv>INFORMATION</span> <span class=o>===</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Total launch phase <span class=nb>time</span>         3.499 s    1.57%
</span></span><span class=line><span class=cl>Total init phase <span class=nb>time</span>           7.940 s    3.57%
</span></span><span class=line><span class=cl>Total target pattern evaluation phase <span class=nb>time</span>    2.357 s    1.06%
</span></span><span class=line><span class=cl>Total interleaved loading-and-analysis phase <span class=nb>time</span>   62.404 s   28.08%
</span></span><span class=line><span class=cl>Total preparation phase <span class=nb>time</span>    0.092 s    0.04%
</span></span><span class=line><span class=cl>Total execution phase <span class=nb>time</span>    145.721 s   65.57%
</span></span><span class=line><span class=cl>Total finish phase <span class=nb>time</span>         0.237 s    0.11%
</span></span><span class=line><span class=cl>------------------------------------------------
</span></span><span class=line><span class=cl>Total run <span class=nb>time</span>                222.252 s  100.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>qcraft@qcraft-dev-qcraft:/hosthome/Downloads<span class=o>]</span> $ bazel analyze-profile slow-build-213242-6943808.profile.gz 
</span></span><span class=line><span class=cl>WARNING: Invoking Bazel in batch mode since it is not invoked from within a workspace <span class=o>(</span>below a directory having a WORKSPACE file<span class=o>)</span>.
</span></span><span class=line><span class=cl>WARNING: This information is intended <span class=k>for</span> consumption by Bazel developers only, and may change at any time. Script against it at your own risk
</span></span><span class=line><span class=cl>INFO: Profile created on Thu Jul <span class=m>21</span> 08:20:06 UTC 2022, build ID: 1733eb6e-f3e0-42d9-a52c-5087c5dd93e0, output base: /home/qcrafter/.cache/bazel/_bazel_qcrafter/4cc6af9c7ea2a1930fc83c0b6578c460
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>===</span> PHASE SUMMARY <span class=nv>INFORMATION</span> <span class=o>===</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Total launch phase <span class=nb>time</span>         2.158 s    0.03%
</span></span><span class=line><span class=cl>Total init phase <span class=nb>time</span>           6.007 s    0.09%
</span></span><span class=line><span class=cl>Total target pattern evaluation phase <span class=nb>time</span>    2.456 s    0.04%
</span></span><span class=line><span class=cl>Total interleaved loading-and-analysis phase <span class=nb>time</span>   62.822 s    0.95%
</span></span><span class=line><span class=cl>Total preparation phase <span class=nb>time</span>    0.127 s    0.00%
</span></span><span class=line><span class=cl>Total execution phase <span class=nb>time</span>   6532.905 s   98.88%
</span></span><span class=line><span class=cl>Total finish phase <span class=nb>time</span>         0.332 s    0.01%
</span></span><span class=line><span class=cl>------------------------------------------------
</span></span><span class=line><span class=cl>Total run <span class=nb>time</span>               6606.809 s  100.00%
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h3 class="relative group">4 BUILDFARM USE TWO SERVICE AT SAME TIME<div id=4-buildfarm-use-two-service-at-same-time class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-buildfarm-use-two-service-at-same-time aria-label=锚点>#</a></span></h3><p>我们有两套buildfarm服务，每个都是三个server，六个worker，最近通过看metric:execulte_slog_usage发现buildfarm1的负载很重，需要启用两套环境，看了ingress和service都不太成，所以只能启用nginx来做负载均衡，然后发现nginx的ip_hash不起效果，我们内网环境，ip的前三个字段都是一致的，和这个链接https://stackoverflow.com/questions/69481839/nginx-ip-hash-balancing-method-not-working-as-expected 写的一样，就改成了。然后才生效</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>upstream</span> <span class=s>xxxxx</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>server</span> <span class=s>A</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server</span> <span class=s>B</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>hash</span> <span class=nv>$remote_addr</span><span class=p>;</span> <span class=c1>#需要使用这种方法，而不是第二种方法，为什么呢
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># hash $remote_addr consistent;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>然后发现了另外一个问题，我们起了一个nginxpod做ingress的反向代理，然后发现大量的buildfarm 任务都过它的时候，任务依然非常慢，也就是说即使bf2将文件和具体的operation(action)已经cache住了，依然很慢。然后我修改nginx的副本数量，调整到两位数，编译的时间再次回到了10min以内，编译时间才恢复正常。至于为什么还在排查中，现在暂时没确定原因。</p><p>下面是改完了的效果，去除了启动失败的runner错误打断编译的情况，计算平均时间参考了</p><table><thead><tr><th>total duration (s) / counts / 60</th><th>不启用nginx,2022-07-21 14:30:00-18:00:00</th><th>启用nginx,2022-07-27 14:30:00-18:00:00</th></tr></thead><tbody><tr><td>g-build-presubmit-edge</td><td>106577.64329499999 / 65 / 60 = 27.3</td><td>108007.82199799998 / 84 / 60= 21.4</td></tr><tr><td>k8s-gpu-build-presubmit-edge</td><td>102611.17144700004 / 58 / 60 = 29.5</td><td>117250.97695900007 / 78 / 60 = 25</td></tr><tr><td>bazel-build-postsubmit:</td><td>41239.953479 / 16 / 60 = 43</td><td>30597.056951000002 / 19 / 60 = 26.9</td></tr><tr><td>gpu-bazel-build-postsubmit</td><td>48058.69408200001 / 17 / 60 = 47</td><td>31474.201981000002 / 19 / 60 = 27.6</td></tr></tbody></table><h3 class="relative group">5 BAZEL的内存占用<div id=5-bazel%E7%9A%84%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5-bazel%E7%9A%84%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8 aria-label=锚点>#</a></span></h3><p>这两天在统计CI/CD的JOB占用的资源的情况，以更好地提升资源利用率，然后发现了一个很蛋疼的事情，就是我们启用了buildfarm之后的bazel cpu & gpu build任务吃掉了40～50G内存，导致了机器OOM，经过排查发现有两个地方可能是吃内存的大户：</p><ul><li>BAZEL的真实工作者JAVA进程，JVM吃掉了太多的内存，在&ndash;jobs为30的情况下，明显的观察到吃掉了20多G的内存</li><li>pod内部的buff/cache吃掉了大量的内存，这并不奇怪，本来buff/cache在有读写文件的时候就会消耗很多内存</li></ul><p>所以开始针对性地进行优化，尝试了多种手段：</p><ul><li>首先按照bazel的官方文档，启用<code>--discard_analysis_cache, --notrack_incremental_state & --nokeep_state_after_build</code>这三个编译选项，毕竟在CI上是不需要增量编译的。经过测试节省内存0～4GB，符合官方文档的"thus freeing up additional memory (around 10%) &ldquo;，但是还是有点少，毕竟远程执行又不需要你本地做什么事情。</li><li>官方方法不好用，开始考虑JVM相关的优化，启用JVM参数：<code>--host_jvm_args="-XX:-TieredCompilation" --host_jvm_args=-Xmx2g --host_jvm_args="-XX:+UseParallelGC", </code>，内存有效削减10～20GB，通过让JAVA频繁触发GC，砍掉了一半的内存消耗</li><li>限制并发的&ndash;jobs数量，从30减到20，又砍掉了3个GB。这并不奇怪，毕竟每个线程都要维护环境和一些符号，杯水车薪也不错</li><li>定时性的触发<code>"echo 3 > /proc/sys/vm/drop_caches"</code>来释放buff/cache的内存消耗，从而减少kernel的内存，这个砍掉了差不多10GB的内存</li></ul><p>全用的话，pod稳定在8G，和同事讨论以后被教育第四个过于hack，job数量限制又可能导致运行过久，最后用了第一个和第二个，砍掉了0～25G</p><h3 class="relative group">6 BUILDFARM的代理优化<div id=6-buildfarm%E7%9A%84%E4%BB%A3%E7%90%86%E4%BC%98%E5%8C%96 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#6-buildfarm%E7%9A%84%E4%BB%A3%E7%90%86%E4%BC%98%E5%8C%96 aria-label=锚点>#</a></span></h3><p>4 BUILDFARM USE TWO SERVICE AT SAME TIME里面说到了启用了nginx作为我们buildfarm的前面代理，当时提到了启用多个nginx才能使编译的速度加快，一个nginx pod作为代理，编译速度还是拖慢了，因此开始尝试nginx调节参数，加了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=c1># 自动调优
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>worker_processes</span>  <span class=s>auto</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>worker_cpu_affinity</span> <span class=s>auto</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>events</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>worker_connections</span>  <span class=mi>4000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>use</span> <span class=s>epoll</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># If multi_accept is disabled, a worker process will accept one new connection at a time. Otherwise, a worker process will accept all new connections at a time
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>multi_accept</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># When buffering is enabled, nginx receives a response from the proxied server as soon as possible, saving it into the buffers set by the proxy_buffer_size and proxy_buffers directives. If the whole response does not fit into memory, a part of it can be saved to a temporary file on the disk. Writing to temporary files is controlled by the proxy_max_temp_file_size and proxy_temp_file_write_size directives.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># proxy_buffering off; 这个实际上没启用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>http</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kn>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 调整server的backlog为65535，启用reuse port
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>listen</span>       <span class=mi>80</span> <span class=s>reuseport</span> <span class=s>backlog=65535</span>
</span></span><span class=line><span class=cl>  <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span></code></pre></div><p>multi_accept这个选项令人怀疑nginx的关键点是因为我们的客户端和nginx就是多条连接，参考这个问题https://serverfault.com/questions/763597/why-is-multi-accept-off-as-default-in-nginx，怀疑可能是一个减慢了速度的点</p><p>proxy_buffering关闭，是认为行为cache结果没必要，不如直接利用buildfarm本身cache的结果。</p><p>server 的backlog调大，每个pod的默认值为128，认为确实有点小，看nginx的ingress controller的/proc/sys/net/core/somaxconn默认是65535，那么给这些pod也调整成这么大试试。参考了这篇文章使用了如下的几条命令来使内核的somaxconn也调大</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sysctl -w net.core.somaxconn<span class=o>=</span><span class=m>65535</span>
</span></span><span class=line><span class=cl>sysctl -w net.ipv4.ip_local_port_range<span class=o>=</span><span class=s2>&#34;1024 65535&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 实际上是busybox的优化用initcontainer</span>
</span></span><span class=line><span class=cl>      initContainers:
</span></span><span class=line><span class=cl>        - command:
</span></span><span class=line><span class=cl>            - /bin/sh
</span></span><span class=line><span class=cl>            - <span class=s1>&#39;-c&#39;</span>
</span></span><span class=line><span class=cl>            - <span class=p>|</span>
</span></span><span class=line><span class=cl>              mount -o remount rw /proc/sys
</span></span><span class=line><span class=cl>              sysctl -w net.core.somaxconn<span class=o>=</span><span class=m>65535</span>
</span></span><span class=line><span class=cl>              sysctl -w net.ipv4.ip_local_port_range<span class=o>=</span><span class=s2>&#34;1024 65535&#34;</span>
</span></span><span class=line><span class=cl>              sysctl -w kernel.core_uses_pid<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>          image: <span class=s1>&#39;registry-vpc.cn-zhangjiakou.aliyuncs.com/acs/busybox:v1.29.2&#39;</span>
</span></span><span class=line><span class=cl>          imagePullPolicy: IfNotPresent
</span></span><span class=line><span class=cl>          name: init-sysctl
</span></span><span class=line><span class=cl>          resources: <span class=o>{}</span>
</span></span><span class=line><span class=cl>          securityContext:
</span></span><span class=line><span class=cl>            capabilities:
</span></span><span class=line><span class=cl>              add:
</span></span><span class=line><span class=cl>                - SYS_ADMIN
</span></span><span class=line><span class=cl>              drop:
</span></span><span class=line><span class=cl>                - ALL
</span></span><span class=line><span class=cl>          terminationMessagePath: /dev/termination-log
</span></span><span class=line><span class=cl>          terminationMessagePolicy: File
</span></span></code></pre></div><p>重新启用后，一个cache住的bazel job耗时从12min压缩2min，嘿嘿</p><h3 class="relative group">7 SANDBOX的选择<div id=7-sandbox%E7%9A%84%E9%80%89%E6%8B%A9 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#7-sandbox%E7%9A%84%E9%80%89%E6%8B%A9 aria-label=锚点>#</a></span></h3><p>这个问题是一个比较早的问题，今天在做一个编译的时候忽然需要在程序当中调用bazel，然后我们都清楚默认bazel是在sandbox里面跑命令，然后我有很多的外部文件/配置希望直接同步到沙盒内，而不是使用</p><p>参考这个链接：https://github.com/bazelbuild/bazel/issues/14734</p><pre tabindex=0><code>The local strategy does not do any kind of sandboxing. It simply executes the action&#39;s command line with the working directory set to the execroot of your workspace.

processwrapper-sandbox is a sandboxing strategy that does not require any &#34;advanced&#34; features - it should work on any POSIX system out of the box. It builds a sandbox directory consisting of symlinks that point to the original source files, executes the action&#39;s command line with the working directory set to this directory instead of the execroot, then moves the known output artifacts out of the sandbox into the execroot and deletes the sandbox. This prevents the action from accidentally using any input files that are not declared and from littering the execroot with unknown output files.

linux-sandbox goes one step further and builds on top of the processwrapper-sandbox. Similar to what Docker does under the hood, it uses Linux Namespaces (User, Mount, PID, Network and IPC namespaces) to isolate the action from the host: It makes the entire filesystem read-only except for the sandbox directory, so the action cannot accidentally modify anything on the host filesystem (imagine a buggy test accidentally rm -rf&#39;ing your $HOME directory...). It optionally prevents the action from accessing the network. It uses PID namespaces to prevent the action from seeing any other processes and to reliably kill all processes (even daemons spawned by the action) at the end.

darwin-sandbox is similar, but for macOS. It uses Apple&#39;s sandbox-exec tool to achieve roughly the same as the Linux sandbox.

Both the linux-sandbox and the darwin-sandbox do not work in a &#34;nested&#34; scenario due to restrictions in the mechanisms provided by the operating systems: Because Docker also uses Linux namespaces for its container magic, you cannot easily run linux-sandbox inside a Docker container. (Only if you use docker run --privileged.) On macOS, you cannot run sandbox-exec inside a process that&#39;s already being sandboxed. Thus, in these cases, Bazel automatically falls back to using processwrapper-sandbox.

You can prevent this, if you would rather get a build error (e.g. to not accidentally build with a less strict execution strategy) by modifying the list of execution strategies explicitly that Bazel tries to use e.g. bazel build --spawn_strategy=worker,linux-sandbox.
</code></pre><h3 class="relative group">8 BUILDFARM STUCK 2.0<div id=8-buildfarm-stuck-20 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#8-buildfarm-stuck-20 aria-label=锚点>#</a></span></h3><p>表现的现象为所有的worker都处于stuck状态，每一个worker实际上都堆积了大量的任务，但是每一个实际上都没在跑，反而是卡着等一个操作。</p><h3 class="relative group">9 BUILDFARM ENTRY SIZE<div id=9-buildfarm-entry-size class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#9-buildfarm-entry-size aria-label=锚点>#</a></span></h3><p>这几天测试新版本buildfarm在不断报错下面的内容，简单看了一下，实际上增大maxSizeBytes & maxEntrySizeBytes即可</p><pre tabindex=0><code>[qcraft@qcraft-dev-qcraft:/qcraft(vgdog/ci_update_buildfarm) ] $ bazel build -c opt --remote_executor=grpc://172.20.4.22:80 --remote_cache= -- //... -release/...
INFO: Invocation ID: 30d10363-0edd-4a9a-a635-cbe790e20ddf
INFO: Analyzed 15398 targets (0 packages loaded, 0 targets configured).
INFO: Found 15398 targets...
ERROR: /qcraft/cyber_modules/control/proto/BUILD:85:17: ProtocInvocation cyber_modules/control/proto/input_debug_pb2.py failed: (Exit 34): Remote Execution Failure:
Failed Precondition: Action 85b4743e429e556bb6bfd4a88a07fb51e6473f8043723585cb6994648e3eec71/144 is invalid: A requested input (or the `Action` or its `Command`) was not found in the CAS.; A requested input (or the `Action` or its `Command`) was not found in the CAS.; A requested input (or the `Action` or its `Command`) was not found in the CAS. ...
  Precondition Failure:
    (MISSING) blobs/75f2f6295961d267b8eda1c5b5c99886b095ef225583df5f24a8d9051d024a9c/4156240: A requested input (or the `Action` or its `Command`) was not found in the CAS.
    (MISSING) blobs/38ecdb1c94e269e483acd31ee39aefe37f465015ddcdb7f53af2031fb99767d9/2121: A requested input (or the `Action` or its `Command`) was not found in the CAS.
    (MISSING) blobs/a6b3ad56297d3e759b63516a51d6057f2a7eb6fe8b72cbce3e0e587b62792cf0/878: A requested input (or the `Action` or its `Command`) was not found in the CAS.
    (MISSING) blobs/a837495ba065847bf3be22a07f9b8a43d31388a690df3766dce6fa76b8b36655/428: A requested input (or the `Action` or its `Command`) was not found in the CAS.
</code></pre><h3 class="relative group">10 BAZEL ANALYSIS 阶段大量时间消耗<div id=10-bazel-analysis-%E9%98%B6%E6%AE%B5%E5%A4%A7%E9%87%8F%E6%97%B6%E9%97%B4%E6%B6%88%E8%80%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#10-bazel-analysis-%E9%98%B6%E6%AE%B5%E5%A4%A7%E9%87%8F%E6%97%B6%E9%97%B4%E6%B6%88%E8%80%97 aria-label=锚点>#</a></span></h3><p>从profile来看主要是alibaba cloud sdk很慢，</p><p><figure><img class="my-0 rounded-md" loading=lazy src=imgs/profile.jpeg alt=img></figure></p><p>其中_go_repository_impl花费大量时间。</p><p>利用背景知识，参考：</p><ul><li><a href=https://sluongng.hashnode.dev/bazel-caching-explained-pt-3-repository-cache target=_blank>https://sluongng.hashnode.dev/bazel-caching-explained-pt-3-repository-cache</a></li><li><a href=https://bazel.build/docs/external#offline-builds target=_blank>https://bazel.build/docs/external#offline-builds</a></li><li><a href=https://cs.opensource.google/bazel/bazel/+/refs/tags/5.2.0:src/main/java/com/google/devtools/build/lib/bazel/repository/downloader/DownloadManager.java target=_blank>https://cs.opensource.google/bazel/bazel/+/refs/tags/5.2.0:src/main/java/com/google/devtools/build/lib/bazel/repository/downloader/DownloadManager.java</a> java的downloadmanager代码</li><li><a href=https://github.com/bazelbuild/bazel-gazelle/blob/master/internal/go_repository.bzl:112 target=_blank>https://github.com/bazelbuild/bazel-gazelle/blob/master/internal/go_repository.bzl:112</a> go_repo的代码，</li></ul><p>可知，第三方的cache，只有采用了 <code>ctx.download</code> or <code>ctx.download_and_extract</code> 才会往distdir/repo cache里面去找cache的结果，</p><p>仔细检查go_repository的代码，实际上也能发现使用的是vcs方式管理的代码，因此往output base里面放这个external的cloud go sdk，花费大量时间，走的是go mod download。因此最简单的解决方法实际上就是修改为urls。</p><p>解决了go_repo的问题之后，又有新的问题出现，即http_archive的对象每次都在fetching，花费大量时间，这个本身应该是cache到repo cache里面的，有一种加速的方法是存储到distdir里面，但是bazle没有提供直接存取到distdir的方法，有一种间接获取的方法：</p><pre tabindex=0><code>bazel sync --experimental_repository_resolved_file=resolved.bzl
</code></pre><p>会把下面结构的属性，拽出来</p><pre tabindex=0><code>&#34;repositories&#34;: [
    {
        &#34;rule_class&#34;: &#34;@bazel_tools//tools/build_defs/repo:http.bzl%http_archive&#34;,
        &#34;attributes&#34;: {
            &#34;url&#34;: &#34;&#34;,
            &#34;urls&#34;: [
                &#34;https://github.com/embree/embree/archive/v2.16.5.zip&#34;
            ],
            &#34;sha256&#34;: &#34;9c4c0c385a7725946648578c1b58e887caa8b4a675a9356e76b9501d9e2e9e42&#34;,
            &#34;netrc&#34;: &#34;&#34;,
            &#34;auth_patterns&#34;: {},
            &#34;canonical_id&#34;: &#34;&#34;,
            &#34;strip_prefix&#34;: &#34;embree-2.16.5&#34;,
            &#34;type&#34;: &#34;&#34;,
            &#34;patches&#34;: [],
            &#34;patch_tool&#34;: &#34;&#34;,
            &#34;patch_args&#34;: [
                &#34;-p0&#34;
            ],
            &#34;patch_cmds&#34;: [],
            &#34;patch_cmds_win&#34;: [],
            &#34;build_file&#34;: &#34;//ThirdParty:embree.BUILD&#34;,
            &#34;build_file_content&#34;: &#34;&#34;,
            &#34;workspace_file_content&#34;: &#34;&#34;,
            &#34;name&#34;: &#34;embree&#34;
        },
        &#34;output_tree_hash&#34;: &#34;b96d3a8db2ddd4bbc7ccde297a1d12e8be48c768bddde1ade53a4987861a1fe7&#34;
    }
]
</code></pre><h3 class="relative group">11 buildfarm的shm<div id=11-buildfarm%E7%9A%84shm class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#11-buildfarm%E7%9A%84shm aria-label=锚点>#</a></span></h3><p>我们的buildfarm运行在k8s的pod里面，这辆遇到一个问题，buildfarm是远程执行，因此任何本地</p><h3 class="relative group">12 buildfarm的cache瓶颈<div id=12-buildfarm%E7%9A%84cache%E7%93%B6%E9%A2%88 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#12-buildfarm%E7%9A%84cache%E7%93%B6%E9%A2%88 aria-label=锚点>#</a></span></h3><p>这个问题严格来讲也不是buildfarm的问题，我们的ci除了启动buildfarm来做远程执行之外，还使用了一些固定的cache目录来加速编译，金丹来说就是用了一块nas来做distdir和repository_cache，这几天分析profile文件，发现bazel的analysis stage依然花费了大量的时间去load external package，一开始我怀疑是distdir目录里面http_archive外部库没生效，我修改http_archive的urls为错误的url，然后打开distdir，发现能够编译成功，证明distdir确实是生效的，然后问题就变成了，为什么有了cache还是这么慢。。。</p><p>查了下我们作为cache的nas，发现吞吐带宽吃满了。。。。</p><h3 class="relative group">Devsecops bazel<div id=devsecops-bazel class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#devsecops-bazel aria-label=锚点>#</a></span></h3><p>两个方面，一方面是在开发阶段另一个是在运维阶段，开发阶段可以使用sast来进行分析，除了sast静态代码扫描，也可以使用动态污点分析。另一方面对于常见的漏洞要有分析的手段。</p><h4 class="relative group">DTA PARTS<div id=dta-parts class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#dta-parts aria-label=锚点>#</a></span></h4><p>三个步骤：</p><ul><li>定义污点源，taint source，污点源是指选择追踪的数据所在的程序的位置，系统调用，函数入口或者单挑指令都可作为污点源</li><li>定义污点槽，taint sink，污点槽是指进行检查的程序位置，以确定这些位置是否会收到污点数据的影响</li><li>追踪污点传播，taint propagation，插桩所有的处理数据的指令来追踪程序中的污点数据流</li></ul><p>程序内存布局，指的是从上到下的东西</p><p>函数后面加const的作用</p><p>static</p><p>常量指针和指针常量</p><p>集成派生的作用</p><p><figure><img class="my-0 rounded-md" loading=lazy src=https://i.loli.net/2020/08/27/BFHNyfpx3EsIDUG.jpg alt=狗头的赞赏码.jpg></figure></p></div></div><script>var oid="views_posts\\2021-11-20-bazel学习实例\\index.md",oid_likes="likes_posts\\2021-11-20-bazel学习实例\\index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/2021-11-09-%E4%B8%80%E4%BA%9B%E7%BD%91%E9%A1%B5%E5%86%85%E5%AE%B9%E7%9A%84%E6%91%98%E6%8A%84/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">一些网页内容的摘抄</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-11-09T00:00:00+00:00>2021 年 11 月 9 日</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/2022-01-13-%E4%B8%80%E4%B8%AAinfra%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E6%80%9D%E8%80%83/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">一个INFRA工程师的思考</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2022-01-13T00:00:00+00:00>2022 年 1 月 13 日</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">© 2025 - 2025 菜狗 All Rights Reserved.</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a> 强力驱动</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://hxndg.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>