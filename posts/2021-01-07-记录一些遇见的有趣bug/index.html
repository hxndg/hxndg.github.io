<!doctype html><html lang=cn dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>记录一些遇见的有趣BUG &#183; 菜狗的blog</title>
<meta name=title content="记录一些遇见的有趣BUG &#183; 菜狗的blog"><meta name=description content="菜狗's website"><meta name=keywords content="debug,fun,"><link rel=canonical href=https://hxndg.github.io/posts/2021-01-07-%E8%AE%B0%E5%BD%95%E4%B8%80%E4%BA%9B%E9%81%87%E8%A7%81%E7%9A%84%E6%9C%89%E8%B6%A3bug/><link type=text/css rel=stylesheet href=/css/main.bundle.min.ba3775bebd52a2b4837f8da64e32ee36e5c52bf284a0ce2262562782398b701543947527ad1498487717b1b96fe2a4e48d365a02e0b5d00e224893052e99d83c.css integrity><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.764eb2fe8d6a6b086c7c58f87d12c64fa79a7585117fc27eb53f688f80c287a6eff16277f9d186cd223a39ff700e294d64482834faece5e07ee0498fa042d056.js integrity="sha512-dk6y/o1qawhsfFj4fRLGT6eadYURf8J+tT9oj4DCh6bv8WJ3+dGGzSI6Of9wDilNZEgoNPrs5eB+4EmPoELQVg==" data-copy data-copied></script><script src=/lib/zoom/zoom.min.3530c2657381259433194af312ec3d322a97a2ad85661810299757fe793b24c3b8e07ab97fa8e5cf96cff1208f271e75394b6eaa56c2e39e7e2c3ca49fb1921c.js integrity="sha512-NTDCZXOBJZQzGUrzEuw9MiqXoq2FZhgQKZdX/nk7JMO44Hq5f6jlz5bP8SCPJx51OUtuqlbC455+LDykn7GSHA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://hxndg.github.io/posts/2021-01-07-%E8%AE%B0%E5%BD%95%E4%B8%80%E4%BA%9B%E9%81%87%E8%A7%81%E7%9A%84%E6%9C%89%E8%B6%A3bug/"><meta property="og:site_name" content="菜狗的blog"><meta property="og:title" content="记录一些遇见的有趣BUG"><meta property="og:description" content="菜狗's website"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-07T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-07T00:00:00+00:00"><meta property="article:tag" content="Debug"><meta property="article:tag" content="Fun"><meta name=twitter:card content="summary"><meta name=twitter:title content="记录一些遇见的有趣BUG"><meta name=twitter:description content="菜狗's website"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"记录一些遇见的有趣BUG","headline":"记录一些遇见的有趣BUG","inLanguage":"zh-cn","url":"https:\/\/hxndg.github.io\/posts\/2021-01-07-%E8%AE%B0%E5%BD%95%E4%B8%80%E4%BA%9B%E9%81%87%E8%A7%81%E7%9A%84%E6%9C%89%E8%B6%A3bug\/","author":{"@type":"Person","name":"菜狗"},"copyrightYear":"2021","dateCreated":"2021-01-07T00:00:00\u002b00:00","datePublished":"2021-01-07T00:00:00\u002b00:00","dateModified":"2021-01-07T00:00:00\u002b00:00","keywords":["debug","fun"],"mainEntityOfPage":"true","wordCount":"22669"}]</script><meta name=author content="菜狗"><script src=/lib/jquery/jquery.slim.min.03cb160e3cfdb2667a2e2c80d283bebcf63ff8bbc4b629c9ab2babf6fae1d0c07ad470edae783efa4fabda2ac01c58d60e63b98b3c336be8208460f08f4354f5.js integrity="sha512-A8sWDjz9smZ6LiyA0oO+vPY/+LvEtinJqyur9vrh0MB61HDtrng++k+r2irAHFjWDmO5izwza+gghGDwj0NU9Q=="></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>跳过正文</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">菜狗的blog</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Home</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Posts</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Tags</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Home</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Posts</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Tags</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">记录一些遇见的有趣BUG</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2021-01-07T00:00:00+00:00>2021 年 1 月 7 日</time><span class="px-2 text-primary-500">&#183;</span><span>22669 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>46 分钟</span></div></div><div class="flex author"><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">菜狗</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Focus</div><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#bug列表>BUG列表</a><ul><li><a href=#1-因为引用库和数据结构对不上触发的coredump>1 因为引用库和数据结构对不上触发的COREDUMP</a><ul><li><a href=#11-bug-100606---ft-2000atcp-coredump-at-raise--when-repeat-bug98307>1.1 Bug 100606 - [FT 2000]Atcp coredump at raise () when repeat bug98307.</a></li></ul></li><li><a href=#2-cache_line_size不同导致的coredump>2 CACHE_LINE_SIZE不同导致的COREDUMP</a><ul><li><a href=#21-bug-98768---ft-2000there-is-backend-coredump-when-use-command-debug-trace-tcp-all-to-capture-packages>2.1 Bug 98768 - [FT 2000]There is backend coredump when use command “debug trace tcp all” to capture packages</a></li></ul></li><li><a href=#3-因为openssl用的nid和国密不一致导致的失败>3 因为OPENSSL用的NID和国密不一致导致的失败</a><ul><li><a href=#31-bug-94844---20206cli-cannot-import-cfca-sm2-encryption-digital-envelope>3.1 Bug 94844 - [2020.6]CLI Cannot Import CFCA SM2 Encryption Digital Envelope.</a></li></ul></li><li><a href=#4-兆芯cpu的bug>4 兆芯CPU的BUG</a><ul><li><a href=#41-bug-103720httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103720---1850_zxthe-ecc-key-cant-import--bug-103313httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103313---1850_zxauto-ssl-does-not-work--bug-103951httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103951---the-cert-process-coredump-when-apv-starts-on-u5580-zx-c-platform-->4.1 <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=103720"><strong>Bug 103720</strong></a> <strong>-</strong> <strong>[1850_ZX]The ECC key can&rsquo;t import</strong> & <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=103313"><strong>Bug 103313</strong></a> <strong>-</strong> <strong>[1850_ZX][auto] ssl does not work.</strong> & <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=103951"><strong>Bug 103951</strong></a> <strong>-</strong> <strong>The cert process coredump when APV starts on U5580-ZX-C platform</strong> & &mldr;</a></li><li><a href=#42-bug-102140httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid102140---atcp-coredump-and-can-not-find-interface-when-performance-test-softsslecdhe-ecdsa-aes128-sha256>4.2 <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=102140"><strong>Bug 102140</strong></a> <strong>-</strong> <strong>Atcp coredump and can not find interface when performance test SoftSSl(ECDHE-ECDSA-AES128-SHA256)</strong></a></li></ul></li><li><a href=#5-不同gcc编译器编译代码混用导致的问题>5 不同gcc编译器编译代码混用导致的问题</a><ul><li><a href=#51-gcc-48-unordered_map-coredump-in-gcc-50>5.1 gcc 4.8 unordered_map coredump in gcc 5.0</a></li></ul></li><li><a href=#6-签名数据变长导致的coreump>6 签名数据变长导致的COREUMP</a></li><li><a href=#7-openssl-base64的bug>7 openssl base64的bug</a></li><li><a href=#8-log4cplus的奇怪问题>8 log4cplus的奇怪问题</a></li><li><a href=#9-openssl和boringssl混用的bug>9 openssl和boringssl混用的bug</a></li><li><a href=#10-grpc调用的问题>10 GRPC调用的问题</a></li><li><a href=#11-rebase错误>11 REbase错误</a></li><li><a href=#12-double-nan的问题>12 DOUBLE NAN的问题</a></li><li><a href=#13-多线程下follythreadlocal问题>13 多线程下folly:：threadlocal问题</a></li><li><a href=#14-因为升级glog导致的问题>14 因为升级glog导致的问题</a></li><li><a href=#15奇怪的调度>15奇怪的调度</a></li><li><a href=#16-错误的ssh-key>16 错误的ssh key</a></li><li><a href=#17-not-support-negative-lookaround>17 not support negative lookaround</a></li><li><a href=#18-git-push-ref-missing-head>18 git push ref missing head</a></li><li><a href=#19-奇怪的时间>19 奇怪的时间</a></li><li><a href=#20-奇怪的卡顿>20 奇怪的卡顿</a></li><li><a href=#21-低性能的unix-domain-socket>21 低性能的Unix Domain Socket</a></li><li><a href=#22-优雅地退出libevent>22 优雅地退出Libevent</a></li><li><a href=#23-suricata初始化>23 Suricata初始化</a></li><li><a href=#24-protobuf糟糕的protobuf_namespace_open>24 Protobuf糟糕的PROTOBUF_NAMESPACE_OPEN</a></li><li><a href=#25-nginx的性能为啥加了我们代码就变差了>25 Nginx的性能为啥加了我们代码就变差了</a></li></ul></li><li><a href=#结尾>结尾</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#bug列表>BUG列表</a><ul><li><a href=#1-因为引用库和数据结构对不上触发的coredump>1 因为引用库和数据结构对不上触发的COREDUMP</a><ul><li><a href=#11-bug-100606---ft-2000atcp-coredump-at-raise--when-repeat-bug98307>1.1 Bug 100606 - [FT 2000]Atcp coredump at raise () when repeat bug98307.</a></li></ul></li><li><a href=#2-cache_line_size不同导致的coredump>2 CACHE_LINE_SIZE不同导致的COREDUMP</a><ul><li><a href=#21-bug-98768---ft-2000there-is-backend-coredump-when-use-command-debug-trace-tcp-all-to-capture-packages>2.1 Bug 98768 - [FT 2000]There is backend coredump when use command “debug trace tcp all” to capture packages</a></li></ul></li><li><a href=#3-因为openssl用的nid和国密不一致导致的失败>3 因为OPENSSL用的NID和国密不一致导致的失败</a><ul><li><a href=#31-bug-94844---20206cli-cannot-import-cfca-sm2-encryption-digital-envelope>3.1 Bug 94844 - [2020.6]CLI Cannot Import CFCA SM2 Encryption Digital Envelope.</a></li></ul></li><li><a href=#4-兆芯cpu的bug>4 兆芯CPU的BUG</a><ul><li><a href=#41-bug-103720httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103720---1850_zxthe-ecc-key-cant-import--bug-103313httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103313---1850_zxauto-ssl-does-not-work--bug-103951httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103951---the-cert-process-coredump-when-apv-starts-on-u5580-zx-c-platform-->4.1 <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=103720"><strong>Bug 103720</strong></a> <strong>-</strong> <strong>[1850_ZX]The ECC key can&rsquo;t import</strong> & <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=103313"><strong>Bug 103313</strong></a> <strong>-</strong> <strong>[1850_ZX][auto] ssl does not work.</strong> & <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=103951"><strong>Bug 103951</strong></a> <strong>-</strong> <strong>The cert process coredump when APV starts on U5580-ZX-C platform</strong> & &mldr;</a></li><li><a href=#42-bug-102140httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid102140---atcp-coredump-and-can-not-find-interface-when-performance-test-softsslecdhe-ecdsa-aes128-sha256>4.2 <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=102140"><strong>Bug 102140</strong></a> <strong>-</strong> <strong>Atcp coredump and can not find interface when performance test SoftSSl(ECDHE-ECDSA-AES128-SHA256)</strong></a></li></ul></li><li><a href=#5-不同gcc编译器编译代码混用导致的问题>5 不同gcc编译器编译代码混用导致的问题</a><ul><li><a href=#51-gcc-48-unordered_map-coredump-in-gcc-50>5.1 gcc 4.8 unordered_map coredump in gcc 5.0</a></li></ul></li><li><a href=#6-签名数据变长导致的coreump>6 签名数据变长导致的COREUMP</a></li><li><a href=#7-openssl-base64的bug>7 openssl base64的bug</a></li><li><a href=#8-log4cplus的奇怪问题>8 log4cplus的奇怪问题</a></li><li><a href=#9-openssl和boringssl混用的bug>9 openssl和boringssl混用的bug</a></li><li><a href=#10-grpc调用的问题>10 GRPC调用的问题</a></li><li><a href=#11-rebase错误>11 REbase错误</a></li><li><a href=#12-double-nan的问题>12 DOUBLE NAN的问题</a></li><li><a href=#13-多线程下follythreadlocal问题>13 多线程下folly:：threadlocal问题</a></li><li><a href=#14-因为升级glog导致的问题>14 因为升级glog导致的问题</a></li><li><a href=#15奇怪的调度>15奇怪的调度</a></li><li><a href=#16-错误的ssh-key>16 错误的ssh key</a></li><li><a href=#17-not-support-negative-lookaround>17 not support negative lookaround</a></li><li><a href=#18-git-push-ref-missing-head>18 git push ref missing head</a></li><li><a href=#19-奇怪的时间>19 奇怪的时间</a></li><li><a href=#20-奇怪的卡顿>20 奇怪的卡顿</a></li><li><a href=#21-低性能的unix-domain-socket>21 低性能的Unix Domain Socket</a></li><li><a href=#22-优雅地退出libevent>22 优雅地退出Libevent</a></li><li><a href=#23-suricata初始化>23 Suricata初始化</a></li><li><a href=#24-protobuf糟糕的protobuf_namespace_open>24 Protobuf糟糕的PROTOBUF_NAMESPACE_OPEN</a></li><li><a href=#25-nginx的性能为啥加了我们代码就变差了>25 Nginx的性能为啥加了我们代码就变差了</a></li></ul></li><li><a href=#结尾>结尾</a></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h1 class="relative group">记录一些遇见的有趣BUG<div id=%E8%AE%B0%E5%BD%95%E4%B8%80%E4%BA%9B%E9%81%87%E8%A7%81%E7%9A%84%E6%9C%89%E8%B6%A3bug class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%AE%B0%E5%BD%95%E4%B8%80%E4%BA%9B%E9%81%87%E8%A7%81%E7%9A%84%E6%9C%89%E8%B6%A3bug aria-label=锚点>#</a></span></h1><h2 class="relative group">前言<div id=%E5%89%8D%E8%A8%80 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%89%8D%E8%A8%80 aria-label=锚点>#</a></span></h2><p>这篇博客的目的是记录下遇见过的有趣BUG</p><p>今天想想忽然觉得比较搞笑，几个公司做的东西不一样就会遇到各种不同的问题：在huayao涉及到的都是操作系统/内核/内存很多本身的问题，因为代码很老，做的东西又很底层，直接DPDK在用户态开搞；在mt公司涉及到的都是不规范的代码/不规范的环境/不规范的C/C++开发流程；在轻舟涉及到的就是各种新工具比方说buildfarm/bazel，但是面临的问题很多都是仿真测试，业务环境，k8s的问题。。。</p><h2 class="relative group">BUG列表<div id=bug%E5%88%97%E8%A1%A8 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bug%E5%88%97%E8%A1%A8 aria-label=锚点>#</a></span></h2><h3 class="relative group">1 因为引用库和数据结构对不上触发的COREDUMP<div id=1-%E5%9B%A0%E4%B8%BA%E5%BC%95%E7%94%A8%E5%BA%93%E5%92%8C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AF%B9%E4%B8%8D%E4%B8%8A%E8%A7%A6%E5%8F%91%E7%9A%84coredump class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-%E5%9B%A0%E4%B8%BA%E5%BC%95%E7%94%A8%E5%BA%93%E5%92%8C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AF%B9%E4%B8%8D%E4%B8%8A%E8%A7%A6%E5%8F%91%E7%9A%84coredump aria-label=锚点>#</a></span></h3><h4 class="relative group">1.1 Bug 100606 - [FT 2000]Atcp coredump at raise () when repeat bug98307.<div id=11-bug-100606---ft-2000atcp-coredump-at-raise--when-repeat-bug98307 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#11-bug-100606---ft-2000atcp-coredump-at-raise--when-repeat-bug98307 aria-label=锚点>#</a></span></h4><p>ARM平台上，对一个消息做softssl hash，会触发COREDUMP</p><p>这个BUG本质上是个金丝雀(canary)保护的例子，出现的原因是栈溢出。
出现的原因是两方面的叠加：
1 openssl自己保护的<code>SHA512_CTX</code>结构和我们自己的不一致，openssl的末尾多两个unsigned int。
2 引用的库操作是OPENSSL的库，OPENSSL会对OPENSSL结构下的<code>SHA512_CTX</code>末尾两个数字进行操作。
这里面存在两个问题
1 两个不同文件的同名数据结构，编译器为什么不认为出错就过去了？
2 为什么X86下不会认为出错，不会产生访问异常？</p><p>第一个问题比较好解答，编译和链接是不同过程，链接是不可能知道这还有两个数据区别。
第二个问题需要仔细检查，隐藏着几个小问题：X86架构上有没有canary保护？缺页中断保护的究竟是什么？是数据，还是异常内存访问？为什么ARM架构下就触发了canary保护？ 在USTACK原本的X86架构上，编译选项没有加上fstack-protect，导致编译器不会有fstack-protect-all标记，因此X86不会编入金丝雀保护。而ARM平台下，</p><h3 class="relative group">2 CACHE_LINE_SIZE不同导致的COREDUMP<div id=2-cache_line_size%E4%B8%8D%E5%90%8C%E5%AF%BC%E8%87%B4%E7%9A%84coredump class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-cache_line_size%E4%B8%8D%E5%90%8C%E5%AF%BC%E8%87%B4%E7%9A%84coredump aria-label=锚点>#</a></span></h3><h4 class="relative group">2.1 Bug 98768 - [FT 2000]There is backend coredump when use command “debug trace tcp all” to capture packages<div id=21-bug-98768---ft-2000there-is-backend-coredump-when-use-command-debug-trace-tcp-all-to-capture-packages class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#21-bug-98768---ft-2000there-is-backend-coredump-when-use-command-debug-trace-tcp-all-to-capture-packages aria-label=锚点>#</a></span></h4><p>ATCP enqueue数据，BACKEND进程DEQUEUE会触发COREDUMP。</p><p>一开始怀疑点是代码乱序，因为代码确实存在乱序可能性。没有任何内存屏障保护等等。
但是看到br->br_cons_mask和br->br_prod_mask不同开始怀疑，毕竟这个变量对消费者生产者都一样，也不会更改，怎么可能不同？</p><p>最后在ATCP和BACKEND里面使用命令<code>#define offset_of(type, memb) ((unsigned long)(&((type *)0)->memb))</code>检查发现两个进程的CACHE_LINE_SIZE不同，因而读取失败。最终修复除了引用相同头文件修复CACHE_LINE_SIZE还更新了RTE_RING代码。</p><h3 class="relative group">3 因为OPENSSL用的NID和国密不一致导致的失败<div id=3-%E5%9B%A0%E4%B8%BAopenssl%E7%94%A8%E7%9A%84nid%E5%92%8C%E5%9B%BD%E5%AF%86%E4%B8%8D%E4%B8%80%E8%87%B4%E5%AF%BC%E8%87%B4%E7%9A%84%E5%A4%B1%E8%B4%A5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-%E5%9B%A0%E4%B8%BAopenssl%E7%94%A8%E7%9A%84nid%E5%92%8C%E5%9B%BD%E5%AF%86%E4%B8%8D%E4%B8%80%E8%87%B4%E5%AF%BC%E8%87%B4%E7%9A%84%E5%A4%B1%E8%B4%A5 aria-label=锚点>#</a></span></h3><h4 class="relative group">3.1 Bug 94844 - [2020.6]CLI Cannot Import CFCA SM2 Encryption Digital Envelope.<div id=31-bug-94844---20206cli-cannot-import-cfca-sm2-encryption-digital-envelope class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#31-bug-94844---20206cli-cannot-import-cfca-sm2-encryption-digital-envelope aria-label=锚点>#</a></span></h4><p>这个BUG的排查比较花时间，因为出问题的点一开始没想到。毕竟头疼医头脚疼医脚是最直接的反应。</p><p>起因是QA拿着CFCA的申请请求去找CA了，发现签回来的信封导入不进去。</p><p>我一开始以为是10.4代码因为OPENSSL我们大改(OPENSSL1.1.1d的代码PATCH了国密，健康检查很多东西)，所以验签失败。检查OPENSSL验签的代码，后来发现似乎没什么逻辑错误，产生了怀疑。将熟悉信封导入到10.3.1的系统也失败产生了怀疑。</p><p>拿asn1 dump检查CSR申请请求的时候发现问题所在了，CSR里面的公钥为0x000&mldr;.相当于CA每次都在给错误的公钥做签名。出现问题的根本原因是因为OPENSSL看国密的NID是NID_X9_62_id_ecPublicKey(408)，但国内把国密的NID改成了NID_sm2(1172)。OPENSSL取公钥的时候发现NID不匹配就直接返回NULL了，但是CSR会成功生成。所以这个BUG是OPENSSL PATCH国密错+CA错导致的，两个地方都没报才会没发现。实际上这块因为NID不一致的问题很多，修改了好几个这种BUG。不过触发条件很奇葩。</p><h3 class="relative group">4 兆芯CPU的BUG<div id=4-%E5%85%86%E8%8A%AFcpu%E7%9A%84bug class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-%E5%85%86%E8%8A%AFcpu%E7%9A%84bug aria-label=锚点>#</a></span></h3><h4 class="relative group">4.1 <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=103720" target=_blank><strong>Bug 103720</strong></a> <strong>-</strong> <strong>[1850_ZX]The ECC key can&rsquo;t import</strong> & <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=103313" target=_blank><strong>Bug 103313</strong></a> <strong>-</strong> <strong>[1850_ZX][auto] ssl does not work.</strong> & <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=103951" target=_blank><strong>Bug 103951</strong></a> <strong>-</strong> <strong>The cert process coredump when APV starts on U5580-ZX-C platform</strong> & &mldr;<div id=41-bug-103720httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103720---1850_zxthe-ecc-key-cant-import--bug-103313httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103313---1850_zxauto-ssl-does-not-work--bug-103951httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103951---the-cert-process-coredump-when-apv-starts-on-u5580-zx-c-platform-- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#41-bug-103720httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103720---1850_zxthe-ecc-key-cant-import--bug-103313httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103313---1850_zxauto-ssl-does-not-work--bug-103951httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid103951---the-cert-process-coredump-when-apv-starts-on-u5580-zx-c-platform-- aria-label=锚点>#</a></span></h4><p>103720直接现象是不能导入一个secp384r1对应的EC 私钥，103313直接现象是不能正确生成2048的私钥/公钥，其它的一些BUG也有这个问题，大部分都是触发了断言，<code>assert((*wnumtop)==0</code>，很多都是div引起的。问题平台为ZX-5580CPU，其它的X86_64平台都没问题。这个BUG的排查特别花时间，虽然我早就猜到了应该是汇编级别的错误，但是汇编的错误藏得太深了，而且103313大师没有找到ROOT-CAUSE而是打PATCH绕开了问题，导致ROOT-CAUSE很难查。</p><p>首先导入私钥的时候，报错报的的是</p><pre tabindex=0><code>140737347789312:error:1012606B:elliptic curve routines:EC_POINT_set_affine_coordinates:point is not on
curve:crypto/ec/ec_lib.c:812:
</code></pre><p>也就是说验证点不在椭圆曲线上，这个函数<code>EC_POINT_is_on_curve</code>嵌套地特别深，但是查了很久发现问题并不在私钥的坐标上（椭圆曲线私钥是个点），反而是椭圆曲线的GROUP对应的公钥信息不对。追查为什么椭圆曲线的公钥信息不对，汇编级别的指令特别难插，关键点的条件基本找不到。废了九牛二虎之力最后发现问题所在竟然是ZX CPU的问题：</p><p>经过追究发现，根本原因出在div 上：ZX 5580 CPU对于特定输入会算错，稳定复现
无论正常机器还是错误机器，div %rcx汇编指令/机器码都相同，且进行运算的值相同。
div是无符号整数除法，高64位置于rdx，低64置于rax。触发运算结束，除数放于rax，余数放于rdx里。</p><p>正常机器的div前后的寄存器值分别为：</p><p>正常机器 div前</p><pre tabindex=0><code>rax            0x0	0
rcx            0xffffffffffffffff	-1
rdx            0xffffffff00000001	-4294967295
</code></pre><p>正常机器 div后</p><pre tabindex=0><code>rax            0xffffffff00000001	-4294967295
rcx            0xffffffffffffffff	-1
rdx            0xffffffff00000001	-4294967295
</code></pre><p>错误机器的div前后的寄存器值分别为：
错误机器 div前</p><pre tabindex=0><code>(gdb) info reg
rax            0x0                 0
rcx            0xffffffffffffffff  -1
rdx            0xffffffff00000001  -4294967295
</code></pre><p>错误机器 div后</p><pre tabindex=0><code>rax            0x1                 1
rcx            0xffffffffffffffff  -1
rdx            0x1                 1
</code></pre><p>为了验证div在正常机器上运算正常，所以我用python做了以下验证</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=mi>340282366841710300967557013911933812736</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;0x</span><span class=si>%x</span><span class=s1>&#39;</span><span class=o>%</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=mh>0xffffffff000000010000000000000000</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=mi>18446744073709551615</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;0x</span><span class=si>%x</span><span class=s1>&#39;</span><span class=o>%</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=mh>0xffffffffffffffff</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=o>/</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=mi>18446744069414584321</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;0x</span><span class=si>%x</span><span class=s1>&#39;</span><span class=o>%</span><span class=p>(</span><span class=n>a</span><span class=o>/</span><span class=n>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=mh>0xffffffff00000001</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=o>-</span><span class=n>b</span><span class=o>*</span><span class=p>(</span><span class=n>a</span><span class=o>/</span><span class=n>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=mi>18446744069414584321</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;0x</span><span class=si>%x</span><span class=s1>&#39;</span><span class=o>%</span><span class=p>(</span><span class=n>a</span><span class=o>-</span><span class=n>b</span><span class=o>*</span><span class=p>(</span><span class=n>a</span><span class=o>/</span><span class=n>b</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=mh>0xffffffff00000001</span>
</span></span></code></pre></div><p>为了验证是不是还有别的机器有这种问题，我写了一个test.c可以用来验证别的ZX CPU是不是也有这个问题。结果输出为1的都有这问题，结果输出位-4294967295的都是正常机器。经过测试，发现只有ZHAOXIN KaiXian <a href=mailto:KX-U5580@1.8GHz>KX-U5580@1.8GHz</a>有这个问题，ZHAOXIN KaiSheng <a href=mailto:KH-37800D@2.7GHz>KH-37800D@2.7GHz</a>没有这个问题，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define BN_ULONG unsigned long long *
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>n0</span> <span class=o>=</span> <span class=mi>18446744069414584321</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>n1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>d0</span> <span class=o>=</span> <span class=mi>18446744073709551615</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>q</span> <span class=o>=</span> <span class=mi>4294967295</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if 0</span><span class=c>
</span></span></span><span class=line><span class=cl><span class=c>BN_ULONG bn_div_words(BN_ULONG h, BN_ULONG l, BN_ULONG d)                               \
</span></span></span><span class=line><span class=cl><span class=c>{ __asm__ (
</span></span></span><span class=line><span class=cl><span class=c>        &#34;pushq %rbp\n\t&#34;
</span></span></span><span class=line><span class=cl><span class=c>        &#34;movq (%rsp), %rbp\n\t&#34;
</span></span></span><span class=line><span class=cl><span class=c>        &#34;movabsq $0xcef9f3930, %rax\n\t&#34;
</span></span></span><span class=line><span class=cl><span class=c>        &#34;pushq %rax\n\t&#34;
</span></span></span><span class=line><span class=cl><span class=c>        &#34;movq (%rsp), %rbp\n\t&#34;
</span></span></span><span class=line><span class=cl><span class=c>        &#34;leaq 0x30(%rsp), %rsp\n\t&#34;
</span></span></span><span class=line><span class=cl><span class=c>        );
</span></span></span><span class=line><span class=cl><span class=c>}
</span></span></span><span class=line><span class=cl><span class=c></span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>BN_ULONG</span> <span class=nf>bn_div_words</span><span class=p>(</span><span class=n>BN_ULONG</span> <span class=n>h</span><span class=p>,</span> <span class=n>BN_ULONG</span> <span class=n>l</span><span class=p>,</span> <span class=n>BN_ULONG</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BN_ULONG</span> <span class=n>ret</span><span class=p>,</span> <span class=n>waste</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>asm</span><span class=p>(</span><span class=s>&#34;divq      %4&#34;</span><span class=o>:</span><span class=s>&#34;=a&#34;</span><span class=p>(</span><span class=n>ret</span><span class=p>),</span> <span class=s>&#34;=d&#34;</span><span class=p>(</span><span class=n>waste</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=o>:</span>     <span class=s>&#34;a&#34;</span><span class=p>(</span><span class=n>l</span><span class=p>),</span> <span class=s>&#34;d&#34;</span><span class=p>(</span><span class=n>h</span><span class=p>),</span> <span class=s>&#34;r&#34;</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=o>:</span>     <span class=s>&#34;cc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span> <span class=o>=</span> <span class=nf>bn_div_words</span><span class=p>(</span><span class=n>n0</span><span class=p>,</span> <span class=n>n1</span><span class=p>,</span> <span class=n>d0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;q is %lld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>q</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">4.2 <a href="http://bugzilla.arraynetworks.com.cn/bugzilla/show_bug.cgi?id=102140" target=_blank><strong>Bug 102140</strong></a> <strong>-</strong> <strong>Atcp coredump and can not find interface when performance test SoftSSl(ECDHE-ECDSA-AES128-SHA256)</strong><div id=42-bug-102140httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid102140---atcp-coredump-and-can-not-find-interface-when-performance-test-softsslecdhe-ecdsa-aes128-sha256 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#42-bug-102140httpbugzillaarraynetworkscomcnbugzillashow_bugcgiid102140---atcp-coredump-and-can-not-find-interface-when-performance-test-softsslecdhe-ecdsa-aes128-sha256 aria-label=锚点>#</a></span></h4><p>坦白讲上面这个BUG和4.1的CPU型号不同，这个是 C-QuadCore <a href=mailto:C4600@2.0GHz>C4600@2.0GHz</a>。目前看起来，在 C-QuadCore <a href=mailto:C4600@2.0GHz>C4600@2.0GHz</a>上，每次MOVQ RBP都会触发的COREDUMP，而ZX-5580U没有这个问题，具体原因还没找到。等要到设备再研究。</p><h3 class="relative group">5 不同gcc编译器编译代码混用导致的问题<div id=5-%E4%B8%8D%E5%90%8Cgcc%E7%BC%96%E8%AF%91%E5%99%A8%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81%E6%B7%B7%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5-%E4%B8%8D%E5%90%8Cgcc%E7%BC%96%E8%AF%91%E5%99%A8%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81%E6%B7%B7%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h3><h4 class="relative group">5.1 gcc 4.8 unordered_map coredump in gcc 5.0<div id=51-gcc-48-unordered_map-coredump-in-gcc-50 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#51-gcc-48-unordered_map-coredump-in-gcc-50 aria-label=锚点>#</a></span></h4><p>今天遇到一个很有意思的BUG，一个4.8.5编出来的so库给gcc5.3.1用，一find就会coredump。查找的的时候使用的结构和函数为为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>class</span> <span class=nc>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>,</span> <span class=n>T</span><span class=o>*&gt;</span> <span class=n>T</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>pthread_rwlock_t</span> <span class=n>rwlock</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=n>T</span> <span class=o>*</span><span class=n>instance</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>static</span> <span class=n>T</span> <span class=n>inst</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>&amp;</span><span class=n>inst</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>pthread_rwlock_rdlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rwlock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>it</span> <span class=o>=</span> <span class=n>T_map</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>ns_key_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>it</span> <span class=o>!=</span> <span class=n>T_map</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>pthread_rwlock_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rwlock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>这个问题可以说是非常蛋疼了，最后惊奇的发现，在gcc5.0的库里面，T结构上锁的时候参数rdi明明应该是rwlock，却修改了T_map的<code>_M_buckets</code>结构，仔细查看发现gcc4.8里面的unordered_map是48字节，所以锁的位置是unordered_map+48。而gcc5里面unordered_map是56字节，理论上应该上锁的位置是unordered_map+56，但是.so里面代码还是对+48位置上锁导致错误修改<code>_T_buckets</code>从而coredump。</p><h3 class="relative group">6 签名数据变长导致的COREUMP<div id=6-%E7%AD%BE%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8F%98%E9%95%BF%E5%AF%BC%E8%87%B4%E7%9A%84coreump class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#6-%E7%AD%BE%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8F%98%E9%95%BF%E5%AF%BC%E8%87%B4%E7%9A%84coreump aria-label=锚点>#</a></span></h3><p>今天可以说是一个特别蛋疼的问题，一开始一直没想到。在做ECDSA/RSA签名的优化。然后想当然的认为，消息摘要缓冲区长度不需要超过64字节，那么签名结果缓冲区不需要超过64字节。然后出了一连串莫名其妙的问题：ecdsa签名/研签的时候没出错，rsa签名完了，ret之后，一打印signature的内容就疯狂coredump。然后lldb/gdb报告coredump的点是string的assign即赋值函数，我一开始没明白单线程赋值为啥会core。后来反应过来内存访问越界了。。。好坑！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl>				<span class=cm>/* 签名的最后结果并不一定小于64，对ECDSA而言256bit可以达到72字节。所以signature_buf长度最好保存1024，直接防备rsa 4096的密钥 */</span>
</span></span><span class=line><span class=cl>        <span class=k>static</span> <span class=kt>bool</span> <span class=nf>ecdsa_sha256_sign_openssl</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=o>&amp;</span><span class=n>message</span><span class=p>,</span> <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=o>&amp;</span><span class=n>pem_private_key</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=o>&amp;</span><span class=n>signature</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint32_t</span> <span class=n>digest_len</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint32_t</span> <span class=n>signature_len</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>digest</span><span class=p>[</span><span class=n>EVP_MAX_MD_SIZE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=kt>char</span> <span class=n>signature_buf</span><span class=p>[</span><span class=n>EVP_MAX_MD_SIZE</span><span class=p>];</span>					<span class=c1>//这个地方错了，长度64不能够存储足够的签名信息。对rsa4096/ecdsa等都会超过64字节。最后修改所有的signature_buf为1024字节就好了
</span></span></span><span class=line><span class=cl><span class=c1></span>        
</span></span><span class=line><span class=cl>            <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>key</span> <span class=o>=</span> <span class=s>&#34;-----BEGIN PRIVATE KEY-----</span><span class=se>\n</span><span class=s>&#34;</span> <span class=o>+</span> <span class=n>pem_private_key</span> <span class=o>+</span> <span class=s>&#34;</span><span class=se>\n</span><span class=s>-----END PRIVATE KEY-----&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>BIO</span> <span class=o>*</span><span class=n>bio</span> <span class=o>=</span> <span class=n>BIO_new</span><span class=p>(</span><span class=n>BIO_s_mem</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>bio</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>BIO_puts</span><span class=p>(</span><span class=n>bio</span><span class=p>,</span> <span class=n>key</span><span class=p>.</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>EC_KEY</span> <span class=o>*</span><span class=n>ec_key</span> <span class=o>=</span> <span class=n>PEM_read_bio_ECPrivateKey</span><span class=p>(</span><span class=n>bio</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>ec_key</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>BIO_free</span><span class=p>(</span><span class=n>bio</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>EVP_MD_CTX</span> <span class=o>*</span><span class=n>md_ctx</span> <span class=o>=</span> <span class=n>EVP_MD_CTX_create</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>md_ctx</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>BIO_free</span><span class=p>(</span><span class=n>bio</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>EC_KEY_free</span><span class=p>(</span><span class=n>ec_key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>bool</span> <span class=n>ret</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>bzero</span><span class=p>(</span><span class=n>digest</span><span class=p>,</span> <span class=n>EVP_MAX_MD_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>EVP_DigestInit</span><span class=p>(</span><span class=n>md_ctx</span><span class=p>,</span> <span class=n>EVP_sha256</span><span class=p>())</span> <span class=o>&lt;=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=o>||</span><span class=n>EVP_DigestUpdate</span><span class=p>(</span><span class=n>md_ctx</span><span class=p>,</span> <span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>message</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span> <span class=n>message</span><span class=p>.</span><span class=n>length</span><span class=p>())</span> <span class=o>&lt;=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                    <span class=o>||</span><span class=n>EVP_DigestFinal</span><span class=p>(</span><span class=n>md_ctx</span><span class=p>,</span> <span class=n>digest</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>digest_len</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                        <span class=o>||</span><span class=n>ECDSA_sign</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>digest</span><span class=p>,</span> <span class=n>digest_len</span><span class=p>,</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>signature_buf</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>signature_len</span><span class=p>,</span> <span class=n>ec_key</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ret</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>final_sig</span><span class=p>(</span><span class=n>signature_buf</span><span class=p>,</span> <span class=n>signature_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>signature</span> <span class=o>=</span> <span class=n>final_sig</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>BIO_free</span><span class=p>(</span><span class=n>bio</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>EC_KEY_free</span><span class=p>(</span><span class=n>ec_key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>EVP_MD_CTX_destroy</span><span class=p>(</span><span class=n>md_ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span></code></pre></div><h3 class="relative group">7 openssl base64的bug<div id=7-openssl-base64%E7%9A%84bug class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#7-openssl-base64%E7%9A%84bug aria-label=锚点>#</a></span></h3><p>今天做代码测试的时候发现的一个问题，openssl自己实现的openssl有bug，经常会出现本来应该解码错误的情况解码成功。然后无论是1.1.1k还是1.0.2k都是错误的。然后我看了boringssl的实现，发现boringssl是对的。太坑了！</p><h3 class="relative group">8 log4cplus的奇怪问题<div id=8-log4cplus%E7%9A%84%E5%A5%87%E6%80%AA%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#8-log4cplus%E7%9A%84%E5%A5%87%E6%80%AA%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h3><p>这个问题实际上没找到解决问题，简单描述下问题怎么回事。我打了一个动态库，依赖1.1.3的log4cplus，boost169，然后我使用的环境是gcc 4.8.5(这个对c11的支持不完全)。然后客户用gcc8.3.1使用这个库的时候用了另一个日志库，另一个日志库包含了1.2.2的log4cplus库，然而这引发了一个非常奇怪的问题。</p><p>每次load配置文件的时候，会检查存储配置的map里面是不是存在字符串layout的，触发一个从char*到string的隐式转换，但是每次转换都会在malloc里面的_int_malloc触发core。当然如果使用gcc4.8.5也会触发这个问题。我检查了从string的构造到malloc与Properties的各种属性和参数，都正常，但是每次都会稳定core，就非常奇怪。本身也看不到具体的malloc的代码，就很蛋疼。</p><p>发现实际上问题并不是直接处在char*的转换上，而是上一次分配664字节的RollingFileAppender的时候的mutex加锁的位置会破坏malloc的结果，mutex的位置竟然超出了RollingFileAppender的范围，多写了8个字节。</p><p>具体的现象表现为</p><p><code>g++ main.cpp /usr/lib64/libclogV2.a ./auth_centos7_4cpp.so -std=c++11 -o -g statica.out</code>，使用静态库编译出来的<code>log4cplus::RollingFileAppender::RollingFileAppender</code>分配出来的RollingFileAppender是664字节，锁的位置在RollingFileAppender之内，mutex的位置和我自己include的头文件结构位置匹配。</p><p>但是使用<code>g++ main.cpp /usr/lib64/libclogV2.so ./auth_centos7_4cpp.so -std=c++11 -o -g statica.out</code>时rollingFileAppender的大小还是664字节，但是mutex的偏移不在664之内，在664之外会写坏内存，mutex的位置和clogV2包含的头文件结构位置匹配。</p><p>查看实现单独使用clogV2动/静态库链接的时候，发现RollingFileAppender的大小是680字节，原来clogV2用的log4cplus是基于1.2.2的，而我们用的log4cplus是1.1.3的版本，这两个版本的头文件不一致，导致数据结构RollingFileAppender大小不同，因为我们包入了头文件，每次真正malloc的时候实际上都是分配664字节，也就是说并没有分配680字节。这种行为就属于标准的UB，才会出现这种问题。</p><p>下面是具体查询的流程。</p><p>我个人在centos7，gcc4.8.5尝试复现这个问题，环境参数如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>gcc 8.3.1 调用编译出来的库和clogV2.so的命令为
</span></span></span><span class=line><span class=cl><span class=cm>g++ main.cpp ./auth_centos7_4cpp.so /usr/lib64/libclogV2.so
</span></span></span><span class=line><span class=cl><span class=cm>执行的时候触发core
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>gdb</span><span class=p>)</span> <span class=n>bt</span>
</span></span><span class=line><span class=cl><span class=cp>#0  0x0000000000000000 in ?? ()
</span></span></span><span class=line><span class=cl><span class=cp>#1  0x00007ffff79d7d18 in log4cplus::spi::ObjectRegistryBase::putVal (this=0x604270, name=..., object=&lt;optimized out&gt;)
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=n>at</span> <span class=n>objectregistry</span><span class=p>.</span><span class=nl>cxx</span><span class=p>:</span><span class=mi>87</span>
</span></span><span class=line><span class=cl><span class=cp>#2  0x00007ffff79e3ab8 in log4cplus::spi::FactoryRegistry&lt;log4cplus::spi::LayoutFactory&gt;::put (object=..., this=0x604270)
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=n>at</span> <span class=p>..</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>log4cplus</span><span class=o>/</span><span class=n>spi</span><span class=o>/</span><span class=n>factory</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>163</span>
</span></span><span class=line><span class=cl><span class=cp>#3  log4cplus::initializeFactoryRegistry () at factory.cxx:169
</span></span></span><span class=line><span class=cl><span class=cp>#4  0x00007ffff79cd47b in log4cplus::initializeLog4cplus () at global-init.cxx:374
</span></span></span><span class=line><span class=cl><span class=cp>#5  0x00007ffff79cd4ed in (anonymous namespace)::_static_log4cplus_initializer::_static_log4cplus_initializer (
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>this</span><span class=o>=</span><span class=mh>0x7ffff7dda74a</span> <span class=o>&lt;</span><span class=p>(</span><span class=n>anonymous</span> <span class=k>namespace</span><span class=p>)</span><span class=o>::</span><span class=n>initializer</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>at</span> <span class=n>global</span><span class=o>-</span><span class=n>init</span><span class=p>.</span><span class=nl>cxx</span><span class=p>:</span><span class=mi>557</span>
</span></span><span class=line><span class=cl><span class=cp>#6  __static_initialization_and_destruction_0 (__priority=&lt;optimized out&gt;, __initialize_p=1) at global-init.cxx:569
</span></span></span><span class=line><span class=cl><span class=cp>#7  0x00007ffff7dea9c3 in _dl_init_internal () from /lib64/ld-linux-x86-64.so.2
</span></span></span><span class=line><span class=cl><span class=cp>#8  0x00007ffff7ddc17a in _dl_start_user () from /lib64/ld-linux-x86-64.so.2
</span></span></span><span class=line><span class=cl><span class=cp>#9  0x0000000000000001 in ?? ()
</span></span></span><span class=line><span class=cl><span class=cp>#10 0x00007fffffffe3a1 in ?? ()
</span></span></span><span class=line><span class=cl><span class=cp>#11 0x0000000000000000 in ?? ()
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>(</span><span class=n>gdb</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl><span class=cm>/* 如果先使用clogV2的动态库，再调用auth动态库，命令为g++ main.cpp /usr/lib64/libclogV2.so ./auth_centos7_4cpp.so，同样core。最奇怪的事情是如果使用libclogV2的静态库不会core*/</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>gdb</span><span class=p>)</span> <span class=n>bt</span>
</span></span><span class=line><span class=cl><span class=cp>#0  0x00007ffff63cb3d7 in raise () from /lib64/libc.so.6
</span></span></span><span class=line><span class=cl><span class=cp>#1  0x00007ffff63ccac8 in abort () from /lib64/libc.so.6
</span></span></span><span class=line><span class=cl><span class=cp>#2  0x00007ffff640df67 in __libc_message () from /lib64/libc.so.6
</span></span></span><span class=line><span class=cl><span class=cp>#3  0x00007ffff6417b36 in _int_malloc () from /lib64/libc.so.6
</span></span></span><span class=line><span class=cl><span class=cp>#4  0x00007ffff641a78c in malloc () from /lib64/libc.so.6
</span></span></span><span class=line><span class=cl><span class=cp>#5  0x00007ffff6cda18d in operator new(unsigned long) () from /lib64/libstdc++.so.6
</span></span></span><span class=line><span class=cl><span class=cp>#6  0x00007ffff6d38cd9 in std::string::_Rep::_S_create(unsigned long, unsigned long, std::allocator&lt;char&gt; const&amp;) ()
</span></span></span><span class=line><span class=cl><span class=cp></span>   <span class=n>from</span> <span class=o>/</span><span class=n>lib64</span><span class=o>/</span><span class=n>libstdc</span><span class=o>++</span><span class=p>.</span><span class=n>so</span><span class=mf>.6</span>
</span></span><span class=line><span class=cl><span class=cp>#7  0x00007ffff6d3a561 in char* std::string::_S_construct&lt;char const*&gt;(char const*, char const*, std::allocator&lt;char&gt; const&amp;, std::forward_iterator_tag) () from /lib64/libstdc++.so.6
</span></span></span><span class=line><span class=cl><span class=cp>#8  0x00007ffff6d3a998 in std::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;::basic_string(char const*, std::allocator&lt;char&gt; const&amp;) () from /lib64/libstdc++.so.6
</span></span></span><span class=line><span class=cl><span class=cp>#9  0x00007ffff7b9815b in log4cplus::helpers::Properties::exists(char const*) const () from /lib64/libclogV2.so
</span></span></span><span class=line><span class=cl><span class=cp>#10 0x00007ffff7b4b895 in log4cplus::Appender::Appender(log4cplus::helpers::Properties const&amp;) () from /lib64/libclogV2.so
</span></span></span><span class=line><span class=cl><span class=cp>#11 0x00007ffff7b6714f in log4cplus::FileAppenderBase::FileAppenderBase(log4cplus::helpers::Properties const&amp;, std::_Ios_Openmode) ()
</span></span></span><span class=line><span class=cl><span class=cp></span>   <span class=n>from</span> <span class=o>/</span><span class=n>lib64</span><span class=o>/</span><span class=n>libclogV2</span><span class=p>.</span><span class=n>so</span>
</span></span><span class=line><span class=cl><span class=cp>#12 0x00007ffff7b71646 in log4cplus::FileAppender::FileAppender(log4cplus::helpers::Properties const&amp;, std::_Ios_Openmode) ()
</span></span></span><span class=line><span class=cl><span class=cp></span>   <span class=n>from</span> <span class=o>/</span><span class=n>lib64</span><span class=o>/</span><span class=n>libclogV2</span><span class=p>.</span><span class=n>so</span>  <span class=c1>//已经出错了
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#13 0x00007ffff7b71959 in log4cplus::RollingFileAppender::RollingFileAppender(log4cplus::helpers::Properties const&amp;) ()
</span></span></span><span class=line><span class=cl><span class=cp></span>   <span class=n>from</span> <span class=o>/</span><span class=n>lib64</span><span class=o>/</span><span class=n>libclogV2</span><span class=p>.</span><span class=n>so</span>
</span></span><span class=line><span class=cl><span class=cp>#14 0x00007ffff77009f1 in log4cplus::spi::FactoryTempl&lt;log4cplus::RollingFileAppender, log4cplus::spi::AppenderFactory&gt;::createObject (
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>this</span><span class=o>=&lt;</span><span class=n>optimized</span> <span class=n>out</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>props</span><span class=o>=</span><span class=p>...)</span> <span class=n>at</span> <span class=p>..</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>log4cplus</span><span class=o>/</span><span class=n>spi</span><span class=o>/</span><span class=n>factory</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>242</span>
</span></span><span class=line><span class=cl><span class=cp>#15 0x00007ffff7b50bb9 in log4cplus::PropertyConfigurator::configureAppenders() () from /lib64/libclogV2.so
</span></span></span><span class=line><span class=cl><span class=cp>#16 0x00007ffff7b53d2e in log4cplus::PropertyConfigurator::configure() () from /lib64/libclogV2.so
</span></span></span><span class=line><span class=cl><span class=cp>#17 0x00007ffff7b53f24 in log4cplus::PropertyConfigurator::doConfigure(std::string const&amp;, log4cplus::Hierarchy&amp;, unsigned int) ()
</span></span></span><span class=line><span class=cl><span class=cp></span>   <span class=n>from</span> <span class=o>/</span><span class=n>lib64</span><span class=o>/</span><span class=n>libclogV2</span><span class=p>.</span><span class=n>so</span>
</span></span><span class=line><span class=cl><span class=cp>#18 0x00007ffff744ed07 in AuthService::Init (this=this@entry=0x6089c0)
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=n>at</span> <span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>vgdog</span><span class=o>/</span><span class=n>code</span><span class=o>/</span><span class=n>sts</span><span class=o>/</span><span class=n>auth_sdk_cpp</span><span class=o>/</span><span class=n>source</span><span class=o>/</span><span class=n>auth_service_real</span><span class=p>.</span><span class=nl>cpp</span><span class=p>:</span><span class=mi>9</span>
</span></span><span class=line><span class=cl><span class=cp>#19 0x00007ffff744c6ac in kms::Singleton&lt;AuthService&gt;::instance ()
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=n>at</span> <span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>vgdog</span><span class=o>/</span><span class=n>code</span><span class=o>/</span><span class=n>sts</span><span class=o>/</span><span class=n>auth_sdk_cpp</span><span class=o>/</span><span class=n>source</span><span class=o>/</span><span class=p>.</span><span class=o>/</span><span class=n>utils</span><span class=o>/</span><span class=n>Singleton</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>54</span>
</span></span><span class=line><span class=cl><span class=cp>#20 inf::auth::AuthServiceSignInit (param=...) at /home/vgdog/code/sts/auth_sdk_cpp/source/auth_service.cpp:8
</span></span></span><span class=line><span class=cl><span class=cp>#21 0x0000000000400dee in main ()
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 查询发现log4cplus::Properties是没有问题的*/</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=cm>/* 所以拜托SRE把glibc的源代码装上，开始查，在进入log4cplus::helpers::Properties::exists(char const*)前，这块内存就已经被破坏了 ，内存地址在watch *(struct malloc_chunk *) 0x60eed0上，开始检测这块地址，可以发现实际上是在创建一个智能指针，具体的类型为helpers::SharedObjectPtr&lt;Appender&gt; SharedAppenderPtr*/</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=cm>/* 所以实际上是分配内存，然后构造相应的mutex的流程时破坏了malloc的内存结构，ok，问题找到了分配出来的地址返回之后修改mutex的时候会直接修改内存块的size，具体看这里*/</span>
</span></span><span class=line><span class=cl><span class=cm>/* 初始化mutex的时候的参数和调用栈*/</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>gdb</span><span class=p>)</span> <span class=n>info</span> <span class=n>reg</span>
</span></span><span class=line><span class=cl><span class=n>rax</span>            <span class=mh>0x7ffff7dd5bb0</span>	<span class=mi>140737351867312</span>
</span></span><span class=line><span class=cl><span class=n>rbx</span>            <span class=mh>0x60ec40</span>	<span class=mi>6351936</span>
</span></span><span class=line><span class=cl><span class=n>rcx</span>            <span class=mh>0x60ec30</span>	<span class=mi>6351920</span>
</span></span><span class=line><span class=cl><span class=n>rdx</span>            <span class=mh>0x60ec40</span>	<span class=mi>6351936</span>
</span></span><span class=line><span class=cl><span class=n>rsi</span>            <span class=mh>0x1</span>	<span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>rdi</span>            <span class=mh>0x60eed8</span>	<span class=mi>6352600</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>gdb</span><span class=p>)</span> <span class=n>bt</span>
</span></span><span class=line><span class=cl><span class=cp>#0  0x00007ffff7ba4510 in log4cplus::thread::Mutex::Mutex(log4cplus::thread::Mutex::Type) () from /lib64/libclogV2.so
</span></span></span><span class=line><span class=cl><span class=cp>#1  0x00007ffff7b71934 in log4cplus::RollingFileAppender::RollingFileAppender(log4cplus::helpers::Properties const&amp;) ()
</span></span></span><span class=line><span class=cl><span class=cp></span>   <span class=n>from</span> <span class=o>/</span><span class=n>lib64</span><span class=o>/</span><span class=n>libclogV2</span><span class=p>.</span><span class=n>so</span>
</span></span><span class=line><span class=cl><span class=cp>#2  0x00007ffff77009f1 in log4cplus::spi::FactoryTempl&lt;log4cplus::RollingFileAppender, log4cplus::spi::AppenderFactory&gt;::createObject (
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>this</span><span class=o>=&lt;</span><span class=n>optimized</span> <span class=n>out</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>props</span><span class=o>=</span><span class=p>...)</span> <span class=n>at</span> <span class=p>..</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>log4cplus</span><span class=o>/</span><span class=n>spi</span><span class=o>/</span><span class=n>factory</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>242</span>
</span></span><span class=line><span class=cl><span class=cp>#3  0x00007ffff7b50bb9 in log4cplus::PropertyConfigurator::configureAppenders() () from /lib64/libclogV2.so
</span></span></span><span class=line><span class=cl><span class=cp>#4  0x00007ffff7b53d2e in log4cplus::PropertyConfigurator::configure() () from /lib64/libclogV2.so
</span></span></span><span class=line><span class=cl><span class=cp>#5  0x00007ffff7b53f24 in log4cplus::PropertyConfigurator::doConfigure(std::string const&amp;, log4cplus::Hierarchy&amp;, unsigned int) ()
</span></span></span><span class=line><span class=cl><span class=cp></span>   <span class=n>from</span> <span class=o>/</span><span class=n>lib64</span><span class=o>/</span><span class=n>libclogV2</span><span class=p>.</span><span class=n>so</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>gdb</span><span class=p>)</span> <span class=n>p</span> <span class=p>(</span><span class=o>&amp;</span><span class=p>((</span><span class=k>struct</span> <span class=nc>malloc_chunk</span> <span class=o>*</span><span class=p>)</span> <span class=mh>0x60eed0</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=err>$</span><span class=mi>103</span> <span class=o>=</span> <span class=p>(</span><span class=n>size_t</span> <span class=o>*</span><span class=p>)</span> <span class=mh>0x60eed8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* 链接clogV2的静态库的话malloc的参数是664字节，也就是sizeof(log4cplus::RollingFileAppender)，地址为0x60cfd0，堆的地址是从低到高增长的，所以size在0x60cfd0+664的地方为实际的大小，是1025。所以我们能看到具体构造mutex的时候mutex的地址为0x60d258，log4cplus::thread::Mutex::Mutex (this=0x60d258, t=log4cplus::thread::Mutex::RECURSIVE)。这个地址减去log4cplus::RollingFileAppender的起始地址为648的偏移，也就是说还在分配出来的内存量里面*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*而链接clogV2动态库的话malloc的参数是664字节，返回地址为(void *) 0x60ec40，实际大小为0x60ec40+664的地址也就是1025。而构造mutex时mutex的地址为0x60eed8，但是操作的偏移量为664字节，换言之mutex写的已经超了，那么为什么会出现这种问题呢？ */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* 现在实际上是初始化SharedObejct部分的mutex*/</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-assembly data-lang=assembly>Dump of assembler code for function log4cplus::RollingFileAppender::RollingFileAppender(log4cplus::helpers::Properties const&amp;):
=&gt; 0x00007ffff79e94d0 &lt;+0&gt;:	mov    %rbx,-0x30(%rsp)
   0x00007ffff79e94d5 &lt;+5&gt;:	mov    %rbp,-0x28(%rsp)
   0x00007ffff79e94da &lt;+10&gt;:	mov    %rdi,%rbx
   0x00007ffff79e94dd &lt;+13&gt;:	mov    %r14,-0x10(%rsp)
   0x00007ffff79e94e2 &lt;+18&gt;:	mov    %r12,-0x20(%rsp)
   0x00007ffff79e94e7 &lt;+23&gt;:	lea    0x280(%rdi),%r14    /* 静态库的偏移量时0x280，也就是说在库的内部，是正确的*/
   0x00007ffff79e94ee &lt;+30&gt;:	mov    %r13,-0x18(%rsp)
   0x00007ffff79e94f3 &lt;+35&gt;:	mov    %r15,-0x8(%rsp)
   0x00007ffff79e94f8 &lt;+40&gt;:	sub    $0x58,%rsp
   0x00007ffff79e94fc &lt;+44&gt;:	mov    0x3d0fa5(%rip),%rax        # 0x7ffff7dba4a8
   0x00007ffff79e9503 &lt;+51&gt;:	mov    %rsi,%rbp
   0x00007ffff79e9506 &lt;+54&gt;:	mov    $0x1,%esi
   0x00007ffff79e950b &lt;+59&gt;:	add    $0x10,%rax
   0x00007ffff79e950f &lt;+63&gt;:	mov    %rax,0x280(%rdi)
   0x00007ffff79e9516 &lt;+70&gt;:	lea    0x288(%rdi),%rdi
   0x00007ffff79e951d &lt;+77&gt;:	callq  0x7ffff76e6f40 &lt;_ZN9log4cplus6thread5MutexC1ENS1_4TypeE@plt&gt;
   
   (gdb) info reg
rax            0x60cfd0	6344656
rbx            0x60cfd0	6344656
rcx            0x60cfc0	6344640
rdx            0x60cfd0	6344656
rsi            0x7fffffffdf60	140737488346976
rdi            0x60cfd0	6344656
rbp            0x7fffffffe050	0x7fffffffe050
rsp            0x7fffffffdec8	0x7fffffffdec8
r8             0x400	1024
r9             0x298	664
r10            0x7fffffffd2a0	140737488343712
r11            0x7ffff79e94d0	140737347753168
r12            0x7fffffffdf60	140737488346976
r13            0x7ffff72663e0	140737339876320
r14            0x7fffffffe060	140737488347232
r15            0x7fffffffdf60	140737488346976
rip            0x7ffff79e94d0	0x7ffff79e94d0 &lt;log4cplus::RollingFileAppender::RollingFileAppender(log4cplus::helpers::Properties const&amp;)&gt;
eflags         0x202	[ IF ]
cs             0x33	51
ss             0x2b	43
ds             0x0	0
es             0x0	0
fs             0x0	0
gs             0x0	0
   
   
Dump of assembler code for function _ZN9log4cplus19RollingFileAppenderC1ERKNS_7helpers10PropertiesE:
=&gt; 0x00007ffff7b71900 &lt;+0&gt;:	push   %r15
   0x00007ffff7b71902 &lt;+2&gt;:	push   %r14
   0x00007ffff7b71904 &lt;+4&gt;:	push   %r13
   0x00007ffff7b71906 &lt;+6&gt;:	push   %r12
   0x00007ffff7b71908 &lt;+8&gt;:	mov    %rsi,%r12
   0x00007ffff7b7190b &lt;+11&gt;:	push   %rbp
   0x00007ffff7b7190c &lt;+12&gt;:	push   %rbx
   0x00007ffff7b7190d &lt;+13&gt;:	mov    %rdi,%rbx
   0x00007ffff7b71910 &lt;+16&gt;:	lea    0x298(%rdi),%rdi    /* rdi是rollingfileAppender的值，直接加了0x298，直接就偏移过多了啊，就超过了sizeof(rollingFileAppender）了，赋值完了rdi就是(gdb) p/x 0x60ec40+0x298 $14 = 0x60eed8，直接就越界了*/
   0x00007ffff7b71917 &lt;+23&gt;:	mov    $0x1,%esi
   0x00007ffff7b7191c &lt;+28&gt;:	sub    $0x38,%rsp
   0x00007ffff7b71920 &lt;+32&gt;:	mov    0x266139(%rip),%rax        # 0x7ffff7dd7a60
   0x00007ffff7b71927 &lt;+39&gt;:	add    $0x10,%rax
   0x00007ffff7b7192b &lt;+43&gt;:	mov    %rax,-0x8(%rdi)
   0x00007ffff7b7192f &lt;+47&gt;:	callq  0x7ffff7b3fbb0 &lt;_ZN9log4cplus6thread5MutexC1ENS1_4TypeE@plt&gt;
   
   
rax            0x60ec40	6351936
rbx            0x60ec40	6351936
rcx            0x60ec30	6351920
rdx            0x60ec40	6351936
rsi            0x7fffffffe090	140737488347280
rdi            0x60ec40	6351936
rbp            0x7fffffffdff0	0x7fffffffdff0
rsp            0x7fffffffdf38	0x7fffffffdf38
r8             0x400	1024
r9             0x298	664
r10            0x7fffffffd320	140737488343840
r11            0x7ffff7b71900	140737349359872
r12            0x7fffffffe090	140737488347280
r13            0x7fffffffe198	140737488347544
r14            0x7fffffffdfe0	140737488347104
r15            0x0	0
rip            0x7ffff7b71900	0x7ffff7b71900 &lt;log4cplus::RollingFileAppender::RollingFileAppender(log4cplus::helpers::Properties const&amp;)&gt;
eflags         0x202	[ IF ]
cs             0x33	51
ss             0x2b	43
ds             0x0	0
es             0x0	0
fs             0x0	0
gs             0x0	0
</code></pre><h3 class="relative group">9 openssl和boringssl混用的bug<div id=9-openssl%E5%92%8Cboringssl%E6%B7%B7%E7%94%A8%E7%9A%84bug class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#9-openssl%E5%92%8Cboringssl%E6%B7%B7%E7%94%A8%E7%9A%84bug aria-label=锚点>#</a></span></h3><h3 class="relative group">10 GRPC调用的问题<div id=10-grpc%E8%B0%83%E7%94%A8%E7%9A%84%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#10-grpc%E8%B0%83%E7%94%A8%E7%9A%84%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h3><p>今天在写grpc的UT的时候，忽然爆了一个错误：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>liboffboard_Sdashboard_Sproto_Slibscenarios_Ucc_Ugrpc.so: undefined symbol: _ZN4grpc24g_core_codegen_interfaceE
</span></span></code></pre></div><p>先拿c++filt看下</p><pre tabindex=0><code>c++filt _ZN4grpc24g_core_codegen_interfaceE
grpc::g_core_codegen_interface
</code></pre><p>看起来是grpc的代码，在bazel的BUILD里面加上了一句搞完了</p><pre tabindex=0><code>&#34;@com_github_grpc_grpc//:grpc++&#34;,
</code></pre><h3 class="relative group">11 REbase错误<div id=11-rebase%E9%94%99%E8%AF%AF class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#11-rebase%E9%94%99%E8%AF%AF aria-label=锚点>#</a></span></h3><p>今天写代码的时候发现CI出错了，然后发现postsubmit bazel build出错。感觉revert，revert完了当事人把原始代码贴了下发现依赖是加了的，后来看了下发现，rebase代码的时候前面有一个修改间接rebase的MR，一开始以为是间接依赖被删除导致的，但是我还是感觉有点迷惑，原始的commit
是加的直接依赖那个头文件的trajectory_developer啊， 他加的trajectory_developer依赖的是两个地方，cyclist_behavior_predictor & vehicle_intention_predictor。怎么rebase完了加依赖的地方就成了 cyclist_behavior_predictor & vehicle_behavior_predictor。</p><p>我感觉这属于rebase的错误了</p><h3 class="relative group">12 DOUBLE NAN的问题<div id=12-double-nan%E7%9A%84%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#12-double-nan%E7%9A%84%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h3><p>这几天postsubmit的pipeline出现了问题，出现了一个非常奇怪的问题，问题代码为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PlannerState</span> <span class=n>other_state</span> <span class=o>=</span> <span class=n>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//EXPECT_EQ(state, state);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>EXPECT_EQ</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>other_state</span><span class=p>);</span> <span class=o>&lt;======</span><span class=err>问题出在这句上，但是即使上一句也会报这个错误</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>//一般也不会出错，得用下面的语句
</span></span><span class=line><span class=cl>bazel <span class=nb>test</span> -c opt --cache_test_results<span class=o>=</span>no //onboard/planner:planner_state_test --spawn_strategy<span class=o>=</span><span class=nb>local</span>
</span></span></code></pre></div><p>百思不得其解，最后问了川，发现是double的默认值为nan了，PlannerState结构体里面有一个double的结构体，默认初始化是nan，而nan和自己比较为false，换言之下面的代码的靠下的部分是true的，从而会报错。我最后改了代码加了C++11的isnan判断，发现确实打印了错误。那么问题来了，为什么同样的在local模式会出现这个错误？<a href="https://zh.wikipedia.org/w/index.php?title=IEEE_754-1985&amp;action=edit&amp;redlink=1" target=_blank>IEEE 754-1985</a>中，用指数部分全为1、小数部分非零表示NaN。也就是说<a href="https://zh.wikipedia.org/w/index.php?title=IEEE_754-1985&amp;action=edit&amp;redlink=1" target=_blank>IEEE 754-1985</a>中，用指数部分全为1、小数部分非零表示NaN。以32位IEEE单精度浮点数的NaN为例，按位表示即：S111 1111 1AXX XXXX XXXX XXXX XXXX XXXX，S为符号位，符号位S的取值无关紧要；A是小数部分的最高位（the most significant bit of the significand），其取值表示了NaN的类型：小数部分不能全为0，小数部分除了A之外的部分被称为NaN的payload；[<a href=https://zh.wikipedia.org/wiki/NaN#cite_note-1 target=_blank>注 1]</a></p><p>64位IEEE单精度浮点数的NAN也是这样子，也是一开始是11111&mldr;，然后小数部分为全为0</p><p>而这个int的值为1111111111111111111111111111111111111111101000000000000000000000，十进制为18446744073703259376，十六进制为ffffffffffa00000，去跑isnan发现还是为nan</p><p>然后最有趣的事情来了，这个数字即使是做运算也就是nan-nan，结果也还是nan而不是零，也就是说减法不能用，等于不能用，符号运算全不能用。所以这个问题的最彻底解决方法还是显示初始化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>struct</span> <span class=nc>PlannerState</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>      <span class=kt>double</span> <span class=n>current_route_s</span><span class=p>;</span> <span class=o>&lt;===</span> <span class=err>问题出在这一行</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=n>PlannerState</span><span class=o>::</span><span class=k>operator</span><span class=o>==</span><span class=p>(</span><span class=k>const</span> <span class=n>PlannerState</span><span class=o>&amp;</span> <span class=n>other</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=n>current_route_s</span> <span class=o>!=</span> <span class=n>current_route_s</span> <span class=c1>//这个语句是true的，
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>isnan</span><span class=p>(</span><span class=n>current_route_s</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>LOG</span><span class=p>(</span><span class=n>INFO</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;what is nan default?&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>看了一下拷贝出错的地方的汇编代码是下面的代码中间的地方，也非常直接，那么直接对这个赋值的地方呢？</p><pre tabindex=0><code class=language-assembly data-lang=assembly>    0x55555557283e &lt;+798&gt;:  callq  0x55555558c010            ; symbol stub for: qcraft::planner::SpacetimePlannerTrajectories::SpacetimePlannerTrajectories(qcraft::planner::SpacetimePlannerTrajectories const&amp;)
    0x555555572843 &lt;+803&gt;:  vmovsd 0x5e0(%r15), %xmm0        ; xmm0 = mem[0],zero 
    0x55555557284c &lt;+812&gt;:  vmovsd %xmm0, 0x5e0(%r13)        //0x5e0的偏移为double current_route_s所在的地方，
    0x555555572855 &lt;+821&gt;:  leaq   0x5e8(%r13), %rdi 
    0x55555557285c &lt;+828&gt;:  leaq   0x5e8(%r15), %rsi         //0x6a0的偏移为MissionStageProto的所在地方
    0x555555572863 &lt;+835&gt;:  callq  0x555555576a00            ; ::LanePath() at lane_path.h:26
</code></pre><pre tabindex=0><code class=language-assembly data-lang=assembly>    0x555555571fd8 &lt;+536&gt;:  callq  0x55555558bed0            ; symbol stub for: qcraft::planner::SpacetimePlannerTrajectories::SpacetimePlannerTrajectories(google::protobuf::Arena*, bool)
-&gt;  0x555555571fdd &lt;+541&gt;:  vxorps %xmm0, %xmm0, %xmm0
    0x555555571fe1 &lt;+545&gt;:  vmovups %ymm0, 0x608(%r15)
    0x555555571fea &lt;+554&gt;:  vmovups %ymm0, 0x5e8(%r15)       //可以看到实际上对double的操作就没做，最多就是一个0x5e8地址的写操作，那得看有没有相应的初始化了，找一下初始化的代码,也就是说malloc的代码
    0x555555571ff3 &lt;+563&gt;:  movq   $0x0, 0x628(%r15)
    0x555555571ffe &lt;+574&gt;:  movb   $0x1, 0x630(%r15)
    0x555555572006 &lt;+582&gt;:  vxorps %xmm1, %xmm1, %xmm1
    0x55555557200a &lt;+586&gt;:  vmovups %xmm1, 0x648(%r15)
    0x555555572013 &lt;+595&gt;:  movq   $0x0, 0x658(%r15)
    0x55555557201e &lt;+606&gt;:  movq   $0x0, 0x668(%r15)
    0x555555572029 &lt;+617&gt;:  movq   %r13, 0x670(%r15)
    0x555555572030 &lt;+624&gt;:  leaq   0x678(%r15), %rbx
    0x555555572037 &lt;+631&gt;:  vmovups %ymm0, 0x678(%r15)
    0x555555572040 &lt;+640&gt;:  movabsq $0x7fefffffffffffff, %rax ; imm = 0x7FEFFFFFFFFFFFFF 
    0x55555557204a &lt;+650&gt;:  movq   %rax, 0x698(%r15)   //这个砍掉8字节
    0x555555572051 &lt;+657&gt;:  leaq   0x6a0(%r15), %rdi   //0x6a0是要传递给MissionStageProto的this指针或者说首地址
    0x555555572058 &lt;+664&gt;:  xorl   %esi, %esi
    0x55555557205a &lt;+666&gt;:  xorl   %edx, %edx
    0x55555557205c &lt;+668&gt;:  vzeroupper 
    0x55555557205f &lt;+671&gt;:  callq  0x55555558bee0            ; symbol stub for: qcraft::MissionStageProto::MissionStageProto(google::protobuf::Arena*, bool)
</code></pre><h3 class="relative group">13 多线程下folly:：threadlocal问题<div id=13-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8Bfollythreadlocal%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#13-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8Bfollythreadlocal%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h3><p>这几天维护代码库的时候报了一个错误，报错如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>----------<span class=o>]</span> Global <span class=nb>test</span> environment tear-down
</span></span><span class=line><span class=cl><span class=o>[==========]</span> <span class=m>1</span> <span class=nb>test</span> from <span class=m>1</span> <span class=nb>test</span> suite ran. <span class=o>(</span><span class=m>7</span> ms total<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  PASSED  <span class=o>]</span> <span class=m>1</span> test.
</span></span><span class=line><span class=cl>terminate called after throwing an instance of <span class=s1>&#39;std::system_error&#39;</span>
</span></span><span class=line><span class=cl>  what<span class=o>()</span>:  pthread_setspecific failed: Invalid argument
</span></span></code></pre></div><p>然后追了一下，下面是完整的调用栈，看了一下为什么。主线程退出的时候，调用pthread_key_delete删除了5这个pkey，但是之后又使用pthread_setspecific来操作这个pkey了。所以在操作的时候报错</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>qcraft@qcraft-dev-qcraft:/qcraft<span class=o>(</span>master<span class=o>)</span> <span class=o>]</span> $ 
</span></span><span class=line><span class=cl><span class=o>[</span>qcraft@qcraft-dev-qcraft:/qcraft<span class=o>(</span>master<span class=o>)</span> <span class=o>]</span> $ lldb bazel-bin/onboard/prediction/container/objects_history_test
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> target create <span class=s2>&#34;bazel-bin/onboard/prediction/container/objects_history_test&#34;</span>
</span></span><span class=line><span class=cl>Current executable <span class=nb>set</span> to <span class=s1>&#39;/qcraft/bazel-bin/onboard/prediction/container/objects_history_test&#39;</span> <span class=o>(</span>x86_64<span class=o>)</span>.
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> b pthread_setspecific
</span></span><span class=line><span class=cl>Breakpoint 1: no locations <span class=o>(</span>pending<span class=o>)</span>.
</span></span><span class=line><span class=cl>WARNING:  Unable to resolve breakpoint to any actual locations.
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> b pthread_key_create
</span></span><span class=line><span class=cl>Breakpoint 2: no locations <span class=o>(</span>pending<span class=o>)</span>.
</span></span><span class=line><span class=cl>WARNING:  Unable to resolve breakpoint to any actual locations.
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> b pthread_key_delete
</span></span><span class=line><span class=cl>Breakpoint 3: no locations <span class=o>(</span>pending<span class=o>)</span>.
</span></span><span class=line><span class=cl>WARNING:  Unable to resolve breakpoint to any actual locations.
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> r
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Process <span class=m>6522</span> resuming
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ，</span>
</span></span><span class=line><span class=cl>Process <span class=m>6522</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;objects_history&#39;, stop reason = breakpoint 3.1</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x00007ffff0c9a0d0 libpthread.so.0`pthread_key_delete</span>
</span></span><span class=line><span class=cl>libpthread.so.0<span class=sb>`</span>pthread_key_delete:
</span></span><span class=line><span class=cl>-&gt;  0x7ffff0c9a0d0 &lt;+0&gt;:  cmpl   <span class=nv>$0</span>x3ff, %edi              <span class=p>;</span> <span class=nv>imm</span> <span class=o>=</span> 0x3FF 
</span></span><span class=line><span class=cl>    0x7ffff0c9a0d6 &lt;+6&gt;:  ja     0x7ffff0c9a100            <span class=p>;</span> &lt;+48&gt;
</span></span><span class=line><span class=cl>    0x7ffff0c9a0d8 &lt;+8&gt;:  movl   %edi, %edi
</span></span><span class=line><span class=cl>    0x7ffff0c9a0da &lt;+10&gt;: leaq   0x20b23f<span class=o>(</span>%rip<span class=o>)</span>, %rax      <span class=p>;</span> __GI___pthread_keys
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> register <span class=nb>read</span>
</span></span><span class=line><span class=cl>General Purpose Registers:
</span></span><span class=line><span class=cl>       <span class=nv>rax</span> <span class=o>=</span> 0x00005555556519e0  objects_history_test<span class=sb>`</span>folly::threadlocal_detail::PthreadKeyUnregister::instance_
</span></span><span class=line><span class=cl>       <span class=nv>rbx</span> <span class=o>=</span> 0x0000000000000001
</span></span><span class=line><span class=cl>       <span class=nv>rcx</span> <span class=o>=</span> 0x0000000000000001
</span></span><span class=line><span class=cl>       <span class=nv>rdx</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>       <span class=nv>rdi</span> <span class=o>=</span> 0x0000000000000005
</span></span><span class=line><span class=cl>       <span class=nv>rsi</span> <span class=o>=</span> 0x000000000000ffff
</span></span><span class=line><span class=cl>       <span class=nv>rbp</span> <span class=o>=</span> 0x00007fffffffd760
</span></span><span class=line><span class=cl>       <span class=nv>rsp</span> <span class=o>=</span> 0x00007fffffffd738
</span></span><span class=line><span class=cl>        <span class=nv>r8</span> <span class=o>=</span> 0x00005555556519e0  objects_history_test<span class=sb>`</span>folly::threadlocal_detail::PthreadKeyUnregister::instance_
</span></span><span class=line><span class=cl>        <span class=nv>r9</span> <span class=o>=</span> 0x00007fffef6eea00
</span></span><span class=line><span class=cl>       <span class=nv>r10</span> <span class=o>=</span> 0x00000000fffffffa
</span></span><span class=line><span class=cl>       <span class=nv>r11</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>       <span class=nv>r12</span> <span class=o>=</span> 0x00007fffefcff718
</span></span><span class=line><span class=cl>       <span class=nv>r13</span> <span class=o>=</span> 0x00000000000005f0
</span></span><span class=line><span class=cl>       <span class=nv>r14</span> <span class=o>=</span> 0x00007fffefd04708
</span></span><span class=line><span class=cl>       <span class=nv>r15</span> <span class=o>=</span> 0x0000555555716b60
</span></span><span class=line><span class=cl>       <span class=nv>rip</span> <span class=o>=</span> 0x00007ffff0c9a0d0  libpthread.so.0<span class=sb>`</span>pthread_key_delete
</span></span><span class=line><span class=cl>    <span class=nv>rflags</span> <span class=o>=</span> 0x0000000000000257
</span></span><span class=line><span class=cl>        <span class=nv>cs</span> <span class=o>=</span> 0x0000000000000033
</span></span><span class=line><span class=cl>        <span class=nv>fs</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>        <span class=nv>gs</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>        <span class=nv>ss</span> <span class=o>=</span> 0x000000000000002b
</span></span><span class=line><span class=cl>        <span class=nv>ds</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>        <span class=nv>es</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> bt
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;objects_history&#39;, stop reason = breakpoint 3.1</span>
</span></span><span class=line><span class=cl>  * frame <span class=c1>#0: 0x00007ffff0c9a0d0 libpthread.so.0`pthread_key_delete</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#1: 0x0000555555643f92 objects_history_test`folly::threadlocal_detail::PthreadKeyUnregister::~PthreadKeyUnregister(this=0x00005555556519e0) at ThreadLocalDetail.h:266:7</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#2: 0x00007fffef957161 libc.so.6`___lldb_unnamed_symbol109$$libc.so.6 + 369</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#3: 0x00007fffef95725a libc.so.6`exit + 26</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#4: 0x00007fffef935bfe libc.so.6`__libc_start_main + 238</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#5: 0x00005555555e6b5a objects_history_test`_start + 42</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> c
</span></span><span class=line><span class=cl>Process <span class=m>6522</span> resuming
</span></span><span class=line><span class=cl>Process <span class=m>6522</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#2, name = &#39;objects_history&#39;, stop reason = breakpoint 1.1</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x00007ffff0c9a1a0 libpthread.so.0`__pthread_setspecific</span>
</span></span><span class=line><span class=cl>libpthread.so.0<span class=sb>`</span>__pthread_setspecific:
</span></span><span class=line><span class=cl>-&gt;  0x7ffff0c9a1a0 &lt;+0&gt;: pushq  %r13
</span></span><span class=line><span class=cl>    0x7ffff0c9a1a2 &lt;+2&gt;: pushq  %r12
</span></span><span class=line><span class=cl>    0x7ffff0c9a1a4 &lt;+4&gt;: pushq  %rbp
</span></span><span class=line><span class=cl>    0x7ffff0c9a1a5 &lt;+5&gt;: pushq  %rbx
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> register <span class=nb>read</span>
</span></span><span class=line><span class=cl>General Purpose Registers:
</span></span><span class=line><span class=cl>       <span class=nv>rax</span> <span class=o>=</span> 0x00007fffeeceb560
</span></span><span class=line><span class=cl>       <span class=nv>rbx</span> <span class=o>=</span> 0x00005555556ef4f8
</span></span><span class=line><span class=cl>       <span class=nv>rcx</span> <span class=o>=</span> 0x00005555557151b0
</span></span><span class=line><span class=cl>       <span class=nv>rdx</span> <span class=o>=</span> 0x00005555556fe5c0
</span></span><span class=line><span class=cl>       <span class=nv>rdi</span> <span class=o>=</span> 0x0000000000000005
</span></span><span class=line><span class=cl>       <span class=nv>rsi</span> <span class=o>=</span> 0x00007fffeeceb560
</span></span><span class=line><span class=cl>       <span class=nv>rbp</span> <span class=o>=</span> 0x00007fffeeaea050
</span></span><span class=line><span class=cl>       <span class=nv>rsp</span> <span class=o>=</span> 0x00007fffeeaea018
</span></span><span class=line><span class=cl>        <span class=nv>r8</span> <span class=o>=</span> 0x00000000620e53ab
</span></span><span class=line><span class=cl>        <span class=nv>r9</span> <span class=o>=</span> 0x00007fffeeae9d88
</span></span><span class=line><span class=cl>       <span class=nv>r10</span> <span class=o>=</span> 0x00007fffeeae9d40
</span></span><span class=line><span class=cl>       <span class=nv>r11</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>       <span class=nv>r12</span> <span class=o>=</span> 0x00007fffeeaea880
</span></span><span class=line><span class=cl>       <span class=nv>r13</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>       <span class=nv>r14</span> <span class=o>=</span> 0x000055555571bc40
</span></span><span class=line><span class=cl>       <span class=nv>r15</span> <span class=o>=</span> 0x00007fffffffc6a0
</span></span><span class=line><span class=cl>       <span class=nv>rip</span> <span class=o>=</span> 0x00007ffff0c9a1a0  libpthread.so.0<span class=sb>`</span>__pthread_setspecific
</span></span><span class=line><span class=cl>    <span class=nv>rflags</span> <span class=o>=</span> 0x0000000000000202
</span></span><span class=line><span class=cl>        <span class=nv>cs</span> <span class=o>=</span> 0x0000000000000033
</span></span><span class=line><span class=cl>        <span class=nv>fs</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>        <span class=nv>gs</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>        <span class=nv>ss</span> <span class=o>=</span> 0x000000000000002b
</span></span><span class=line><span class=cl>        <span class=nv>ds</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>        <span class=nv>es</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> thread list
</span></span><span class=line><span class=cl>Process <span class=m>6522</span> stopped
</span></span><span class=line><span class=cl>  thread <span class=c1>#1: tid = 6522, 0x00007ffff7deaf2b, name = &#39;objects_history&#39;</span>
</span></span><span class=line><span class=cl>* thread <span class=c1>#2: tid = 7615, 0x00007ffff0c9a1a0 libpthread.so.0`__pthread_setspecific, name = &#39;objects_history&#39;, stop reason = breakpoint 1.1</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> c
</span></span><span class=line><span class=cl>Process <span class=m>6522</span> resuming
</span></span><span class=line><span class=cl>terminate called after throwing an instance of <span class=s1>&#39;std::system_error&#39;</span>
</span></span><span class=line><span class=cl>  what<span class=o>()</span>:  pthread_setspecific failed: Invalid argument
</span></span><span class=line><span class=cl>Process <span class=m>6522</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#2, name = &#39;objects_history&#39;, stop reason = signal SIGABRT</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x00007fffef952fb7 libc.so.6`raise + 199</span>
</span></span><span class=line><span class=cl>libc.so.6<span class=sb>`</span>raise:
</span></span><span class=line><span class=cl>-&gt;  0x7fffef952fb7 &lt;+199&gt;: movq   0x108<span class=o>(</span>%rsp<span class=o>)</span>, %rcx
</span></span><span class=line><span class=cl>    0x7fffef952fbf &lt;+207&gt;: xorq   %fs:0x28, %rcx
</span></span><span class=line><span class=cl>    0x7fffef952fc8 &lt;+216&gt;: movl   %r8d, %eax
</span></span><span class=line><span class=cl>    0x7fffef952fcb &lt;+219&gt;: jne    0x7fffef952fec            <span class=p>;</span> &lt;+252&gt;
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> 
</span></span><span class=line><span class=cl>Process <span class=m>11199</span> resuming
</span></span><span class=line><span class=cl>Process <span class=m>11199</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;objects_history&#39;, stop reason = breakpoint 3.1</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x0000555555641c8b objects_history_test`folly::threadlocal_detail::PthreadKeyUnregister::registerKey(key=5) at ThreadLocalDetail.h:272:31</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> bt
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;objects_history&#39;, stop reason = breakpoint 3.1</span>
</span></span><span class=line><span class=cl>  * frame <span class=c1>#0: 0x0000555555641c8b objects_history_test`folly::threadlocal_detail::PthreadKeyUnregister::registerKey(key=5) at ThreadLocalDetail.h:272:31</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#1: 0x0000555555640d8d objects_history_test`folly::threadlocal_detail::StaticMetaBase::StaticMetaBase(this=0x00005555557151b0, threadEntry=(libonboard_Sglobal_Slibcounter.so`folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::getThreadEntrySlow() at ThreadLocalDetail.h:468), strict=false)(), bool) at ThreadLocalDetail.cpp:73:3</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#2: 0x00007ffff55a525b libonboard_Sglobal_Slibcounter.so`folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::StaticMeta(this=0x00005555557151b0) at ThreadLocalDetail.h:420:9</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#3: 0x00007ffff55a5138 libonboard_Sglobal_Slibcounter.so`void* folly::detail::StaticSingletonManagerWithRtti::make&lt;folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt; &gt;() at StaticSingletonManager.h:80:16</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#4: 0x000055555563e3a9 objects_history_test`folly::detail::(anonymous namespace)::StaticSingletonManagerWithRttiImpl::Entry::get(this=0x00005555556ea1c0, make=0x00007ffff55a5110)()) at StaticSingletonManager.cpp:46:33</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#5: 0x000055555563e121 objects_history_test`folly::detail::(anonymous namespace)::StaticSingletonManagerWithRttiImpl::create(this=0x0000555555728910, key=0x00007ffff55b6740, make=0x00007ffff55a5110, cache=0x00007ffff55b9f58)(), std::atomic&lt;void*&gt;&amp;) at StaticSingletonManager.cpp:34:33</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#6: 0x000055555563e098 objects_history_test`folly::detail::StaticSingletonManagerWithRtti::create_(arg=0x00007ffff55b9f58) at StaticSingletonManager.cpp:65:19</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#7: 0x00007ffff55a5053 libonboard_Sglobal_Slibcounter.so`folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::instance() [inlined] void* folly::detail::StaticSingletonManagerWithRtti::create_&lt;false&gt;(arg=0x00007ffff55b9f58) at StaticSingletonManager.h:85:12</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#8: 0x00007ffff55a504a libonboard_Sglobal_Slibcounter.so`folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::instance() [inlined] folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;&amp; folly::detail::StaticSingletonManagerWithRtti::create&lt;folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;, void&gt;() at StaticSingletonManager.h:64</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#9: 0x00007ffff55a5008 libonboard_Sglobal_Slibcounter.so`folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::instance() [inlined] folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;&amp; folly::detail::createGlobal&lt;folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;, void&gt;() at StaticSingletonManager.h:97</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#10: 0x00007ffff55a5008 libonboard_Sglobal_Slibcounter.so`folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::instance() at ThreadLocalDetail.h:433</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#11: 0x00007ffff55a4f4d libonboard_Sglobal_Slibcounter.so`folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::getSlowReserveAndCache(ent=0x00005555556fbe30, id=0x00007fffffffc894, threadEntry=0x00007fffef2ee850, capacity=0x00007fffef2ee858) at ThreadLocalDetail.h:458:18</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#12: 0x00007ffff55a4e2f libonboard_Sglobal_Slibcounter.so`folly::ThreadLocalPtr&lt;qcraft::CounterImpl::CounterPerThread, qcraft::CounterImpl::CounterTag, void&gt;::get() const [inlined] folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::get(ent=0x00005555556fbe30) at ThreadLocalDetail.h:448:7</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#13: 0x00007ffff55a4dc4 libonboard_Sglobal_Slibcounter.so`folly::ThreadLocalPtr&lt;qcraft::CounterImpl::CounterPerThread, qcraft::CounterImpl::CounterTag, void&gt;::get(this=0x00005555556fbe30) const at ThreadLocal.h:158</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#14: 0x00007ffff55941a1 libonboard_Sglobal_Slibcounter.so`folly::ThreadLocal&lt;qcraft::CounterImpl::CounterPerThread, qcraft::CounterImpl::CounterTag, void&gt;::operator-&gt;() const [inlined] folly::ThreadLocal&lt;qcraft::CounterImpl::CounterPerThread, qcraft::CounterImpl::CounterTag, void&gt;::get(this=0x00005555556fbe30) const at ThreadLocal.h:68:27</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#15: 0x00007ffff559419c libonboard_Sglobal_Slibcounter.so`folly::ThreadLocal&lt;qcraft::CounterImpl::CounterPerThread, qcraft::CounterImpl::CounterTag, void&gt;::operator-&gt;(this=0x00005555556fbe30) const at ThreadLocal.h:73</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#16: 0x00007ffff5588c39 libonboard_Sglobal_Slibcounter.so`qcraft::CounterImpl::AddCounterEvent(this=0x00005555556fbe30, name=&#34;schedulefuture_callback_size&#34;, val=1) at counter.cc:51:3</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#17: 0x00007ffff558a23d libonboard_Sglobal_Slibcounter.so`qcraft::Counter::AddCounterEventInternal(this=0x0000555555711cd0, name=&#34;schedulefuture_callback_size&#34;, val=1) at counter.cc:191:10</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#18: 0x00005555555f0745 objects_history_test`void qcraft::Counter::AddCounterEvent&lt;long&gt;(this=0x0000555555711cd0, name=&#34;schedulefuture_callback_size&#34;, val=1) at counter.h:70:5</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#19: 0x00005555555e9fa7 objects_history_test`qcraft::Future&lt;std::result_of&lt;boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt; (void qcraft::DestroyContainerAsync&lt;boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt; &gt;(qcraft::ThreadPool*, boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt;)::&#39;lambda&#39;()...)&gt;::type&gt; qcraft::ThreadPool::Schedule&lt;void qcraft::DestroyContainerAsync&lt;boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt; &gt;(this=0x000055555572ae70, f=0x00007fffffffcbb0)::&#39;lambda&#39;()&gt;(boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt;&amp;&amp;, void qcraft::DestroyContainerAsync&lt;boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt; &gt;(qcraft::ThreadPool*, boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt;)::&#39;lambda&#39;()&amp;&amp;...) at thread_pool.h:88:5</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#20: 0x00005555555e9951 objects_history_test`auto qcraft::ScheduleFuture&lt;void qcraft::DestroyContainerAsync&lt;boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt; &gt;(qcraft::ThreadPool*, boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt;)::&#39;lambda&#39;()&gt;(thread_pool=0x000055555572ae70, f=0x00007fffffffcbb0)::&#39;lambda&#39;()&amp;&amp;...) at async_util.h:24:23</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#21: 0x00005555555e9835 objects_history_test`void qcraft::DestroyContainerAsync&lt;boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt; &gt;(thread_pool=0x000055555572ae70, container=&lt;unavailable&gt;) at async_util.h:38:3</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#22: 0x00005555555e96fb objects_history_test`void qcraft::DestroyContainerAsync&lt;boost::circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt; &gt;(container=circular_buffer&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt;, std::allocator&lt;qcraft::elements_history::Node&lt;double, qcraft::prediction::PredictionObject&gt; &gt; &gt; @ 0x00007fffffffcc80) at async_util.h:47:3</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#23: 0x00005555555e9666 objects_history_test`qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;::~ElementHistory(this=0x000055555572ae30) at elements_history.h:103:23</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#24: 0x00005555555e950b objects_history_test`std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt;::operator(this=0x000055555570f6c8, __ptr=0x000055555572ae30)(qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;*) const at unique_ptr.h:81:2</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#25: 0x00005555555e9450 objects_history_test`std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt;::~unique_ptr(this=0x000055555570f6c8) at unique_ptr.h:292:4</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#26: 0x00005555555e93dd objects_history_test`std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt;::~pair(this=0x000055555570f6a8) at stl_iterator.h:1283:12</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#27: 0x00005555555e93b9 objects_history_test`void __gnu_cxx::new_allocator&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt;::destroy&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt;(this=0x00007fffffffd1b8, __p=0x000055555570f6a8) at new_allocator.h:152:10</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#28: 0x00005555555e938d objects_history_test`void std::allocator_traits&lt;std::allocator&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt; &gt;::destroy&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt;(__a=0x00007fffffffd1b8, __p=0x000055555570f6a8) at alloc_traits.h:496:8</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#29: 0x00005555555e935d objects_history_test`void absl::lts_20210324::container_internal::map_slot_policy&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt;::destroy&lt;std::allocator&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt; &gt;(alloc=0x00007fffffffd1b8, slot=0x000055555570f6a8) at container_memory.h:408:7</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#30: 0x00005555555e932d objects_history_test`void absl::lts_20210324::container_internal::FlatHashMapPolicy&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt;::destroy&lt;std::allocator&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt; &gt;(alloc=0x00007fffffffd1b8, slot=0x000055555570f6a8) at flat_hash_map.h:567:5</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#31: 0x00005555555e914d objects_history_test`void absl::lts_20210324::container_internal::hash_policy_traits&lt;absl::lts_20210324::container_internal::FlatHashMapPolicy&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt;, void&gt;::destroy&lt;std::allocator&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt; &gt;(alloc=0x00007fffffffd1b8, slot=0x000055555570f6a8) at hash_policy_traits.h:101:5</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#32: 0x00005555555e9040 objects_history_test`absl::lts_20210324::container_internal::raw_hash_set&lt;absl::lts_20210324::container_internal::FlatHashMapPolicy&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt;, absl::lts_20210324::container_internal::StringHash, absl::lts_20210324::container_internal::StringHashEq::Eq, std::allocator&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt; &gt;::destroy_slots(this=0x00007fffffffd198) at raw_hash_set.h:1565:9</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#33: 0x00005555555e8f79 objects_history_test`absl::lts_20210324::container_internal::raw_hash_set&lt;absl::lts_20210324::container_internal::FlatHashMapPolicy&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt;, absl::lts_20210324::container_internal::StringHash, absl::lts_20210324::container_internal::StringHashEq::Eq, std::allocator&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt; &gt;::~raw_hash_set(this=0x00007fffffffd198) at raw_hash_set.h:970:21</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#34: 0x00005555555e8f55 objects_history_test`absl::lts_20210324::container_internal::raw_hash_map&lt;absl::lts_20210324::container_internal::FlatHashMapPolicy&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt;, absl::lts_20210324::container_internal::StringHash, absl::lts_20210324::container_internal::StringHashEq::Eq, std::allocator&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt; &gt;::~raw_hash_map(this=0x00007fffffffd198) at raw_hash_map.h:31:7</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#35: 0x00005555555e8b05 objects_history_test`absl::lts_20210324::flat_hash_map&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt;, absl::lts_20210324::container_internal::StringHash, absl::lts_20210324::container_internal::StringHashEq::Eq, std::allocator&lt;std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const, std::unique_ptr&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt;, std::default_delete&lt;qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt; &gt; &gt; &gt; &gt;::~flat_hash_map(this=0x00007fffffffd198) at flat_hash_map.h:108:7</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#36: 0x00005555555f5f59 objects_history_test`qcraft::elements_history::ElementsHistory&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, double, qcraft::prediction::PredictionObject, qcraft::elements_history::ElementHistory&lt;double, qcraft::prediction::PredictionObject, qcraft::prediction::ObjectHistorySpan&gt; &gt;::~ElementsHistory(this=0x00007fffffffd190) at elements_history.h:152:7</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#37: 0x00005555555e81f5 objects_history_test`qcraft::prediction::ObjectsHistory::~ObjectsHistory(this=0x00007fffffffd190) at objects_history.h:11:7</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#38: 0x00005555555e73ae objects_history_test`qcraft::prediction::ObjectsHistoryTest_Test_ObjectHistory_Push_Test::TestBody(this=0x000055555572b5c0) at objects_history_test.cc:13:1</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#39: 0x00007ffff11d925b libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`void testing::internal::HandleSehExceptionsInMethodIfSupported&lt;testing::Test, void&gt;(object=0x000055555572b5c0, method=21 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00, location=&#34;the test body&#34;)(), char const*) at gtest.cc:2607:10</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#40: 0x00007ffff11c6cad libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`void testing::internal::HandleExceptionsInMethodIfSupported&lt;testing::Test, void&gt;(object=0x000055555572b5c0, method=21 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00, location=&#34;the test body&#34;)(), char const*) at gtest.cc:2643:14</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#41: 0x00007ffff11aafe3 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`testing::Test::Run(this=0x000055555572b5c0) at gtest.cc:2682:5</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#42: 0x00007ffff11abc19 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`testing::TestInfo::Run(this=0x0000555555711b10) at gtest.cc:2861:11</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#43: 0x00007ffff11ac474 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`testing::TestSuite::Run(this=0x00005555556fc500) at gtest.cc:3015:28</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#44: 0x00007ffff11be62b libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`testing::internal::UnitTestImpl::RunAllTests(this=0x00005555557183f0) at gtest.cc:5855:44</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#45: 0x00007ffff11dc0fb libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`bool testing::internal::HandleSehExceptionsInMethodIfSupported&lt;testing::internal::UnitTestImpl, bool&gt;(object=0x00005555557183f0, method=d0 e1 1b f1 ff 7f 00 00 00 00 00 00 00 00 00 00, location=&#34;auxiliary test code (environments or event listeners)&#34;)(), char const*) at gtest.cc:2607:10</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#46: 0x00007ffff11c9243 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`bool testing::internal::HandleExceptionsInMethodIfSupported&lt;testing::internal::UnitTestImpl, bool&gt;(object=0x00005555557183f0, method=d0 e1 1b f1 ff 7f 00 00 00 00 00 00 00 00 00 00, location=&#34;auxiliary test code (environments or event listeners)&#34;)(), char const*) at gtest.cc:2643:14</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#47: 0x00007ffff11be15e libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`testing::UnitTest::Run(this=0x00007ffff11f80f8) at gtest.cc:5438:10</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#48: 0x00007ffff11fcb01 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest_Umain.so`RUN_ALL_TESTS() at gtest.h:2490:46</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#49: 0x00007ffff11fca9b libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest_Umain.so`main(argc=1, argv=0x00007fffffffd8a8) at gmock_main.cc:70:10</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#50: 0x00007fffef935bf7 libc.so.6`__libc_start_main + 231</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#51: 0x00005555555e6b5a objects_history_test`_start + 42</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> thread list
</span></span><span class=line><span class=cl>Process <span class=m>11199</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1: tid = 11199, 0x0000555555641c8b objects_history_test`folly::threadlocal_detail::PthreadKeyUnregister::registerKey(key=5) at ThreadLocalDetail.h:272:31, name = &#39;objects_history&#39;, stop reason = breakpoint 3.1</span>
</span></span><span class=line><span class=cl>  thread <span class=c1>#2: tid = 11202, 0x00007ffff7ddd4ab, name = &#39;objects_history&#39;</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> <span class=nb>break</span> list
</span></span><span class=line><span class=cl>Current breakpoints:
</span></span><span class=line><span class=cl>1: <span class=nv>name</span> <span class=o>=</span> <span class=s1>&#39;pthread_create&#39;</span>, <span class=nv>locations</span> <span class=o>=</span> 1, <span class=nv>resolved</span> <span class=o>=</span> 1, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>  1.1: <span class=nv>where</span> <span class=o>=</span> libpthread.so.0<span class=sb>`</span>pthread_create@@GLIBC_2.2.5, <span class=nv>address</span> <span class=o>=</span> 0x00007ffff0c929b0, resolved, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>2</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2: <span class=nv>name</span> <span class=o>=</span> <span class=s1>&#39;pthread_setspecific&#39;</span>, <span class=nv>locations</span> <span class=o>=</span> 1, <span class=nv>resolved</span> <span class=o>=</span> 1, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>8</span>
</span></span><span class=line><span class=cl>  2.1: <span class=nv>where</span> <span class=o>=</span> libpthread.so.0<span class=sb>`</span>__pthread_setspecific, <span class=nv>address</span> <span class=o>=</span> 0x00007ffff0c9a1a0, resolved, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>8</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>3: <span class=nv>name</span> <span class=o>=</span> <span class=s1>&#39;folly::threadlocal_detail::PthreadKeyUnregister::registerKey&#39;</span>, <span class=nv>locations</span> <span class=o>=</span> 1, <span class=nv>resolved</span> <span class=o>=</span> 1, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  3.1: <span class=nv>where</span> <span class=o>=</span> objects_history_test<span class=sb>`</span>folly::threadlocal_detail::PthreadKeyUnregister::registerKey<span class=o>(</span>unsigned int<span class=o>)</span> + <span class=m>11</span> at ThreadLocalDetail.h:272:31, <span class=nv>address</span> <span class=o>=</span> 0x0000555555641c8b, resolved, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>3</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> br d <span class=m>2</span>
</span></span><span class=line><span class=cl>ambiguous <span class=nb>command</span> <span class=s1>&#39;breakpoint d&#39;</span>. Possible completions:
</span></span><span class=line><span class=cl>	delete
</span></span><span class=line><span class=cl>	disable
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> br de <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=m>1</span> breakpoints deleted<span class=p>;</span> <span class=m>0</span> breakpoint locations disabled.
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> 
</span></span></code></pre></div><p>写了一个段这个来测试删除pkey是不是会导致pthread_setsepcific返回22，符合了预期。主线程退出的时候destroy了pthread_pkey，导致的问题</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp>#include&lt;stdio.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp>#include&lt;pthread.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp>#include&lt;string.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pthread_key_t</span> <span class=n>p_key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>func1</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=o>*</span><span class=n>tmp</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>pthread_getspecific</span><span class=p>(</span><span class=n>p_key</span><span class=p>);</span><span class=c1>//同一线程内的各个函数间共享数据。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d is runing in %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=o>*</span><span class=n>tmp</span><span class=p>,</span><span class=n>__func__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>thread_func</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span>  <span class=n>pthread_setspecific</span><span class=p>(</span><span class=n>p_key</span><span class=p>,</span><span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;ret is %d </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=o>*</span><span class=n>tmp</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>pthread_getspecific</span><span class=p>(</span><span class=n>p_key</span><span class=p>);</span><span class=c1>//获得线程的私有空间
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d is runing in %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=o>*</span><span class=n>tmp</span><span class=p>,</span><span class=n>__func__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=n>tmp</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=n>tmp</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=p>;</span><span class=c1>//修改私有变量的值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>func1</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>pthread_t</span> <span class=n>pa</span><span class=p>,</span> <span class=n>pb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>a</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>b</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pthread_key_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p_key</span><span class=p>,</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pa</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span><span class=n>thread_func</span><span class=p>,</span><span class=o>&amp;</span><span class=n>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>pthread_key_delete</span><span class=p>(</span><span class=n>p_key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;pthread_key_delete ret is %d </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pb</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span><span class=n>thread_func</span><span class=p>,</span><span class=o>&amp;</span><span class=n>b</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pthread_join</span><span class=p>(</span><span class=n>pa</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pthread_join</span><span class=p>(</span><span class=n>pb</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><pre tabindex=0><code>qcraft@BJ-vgdog:~/code_test/pthread_key_delete_test$ ./a.out 
ret is 0 
1 is runing in thread_func
100 is runing in func1
pthread_key_delete ret is 0 
ret is 22 
Segmentation fault
</code></pre><p>2023/03/21再探该问题，今天又遇到这个问题，同样是pthread_setspecific提示invalid argument，q公司内部实际上有一个曾经的分析，但是当时我没追踪这个问题，另外分析的过程臆想的部分过多，所以从新过滤思路，走了一遍debug。最终的思路如下：</p><p>这个问题看起来似乎并不好调试，但是只需要确定是多线程的问题外加线程局部变量即可检查：因为主线程退出会导致静态变量析构，因此只需要在gtest结束之后调试主线程的时候断点断住pthread_key_delete和pthread_setspecific，令其他线程都暂停即set scheduler-locking on(这里注意，好几个thread local变量清理掉了)。之后打开其他线程继续调试即可。</p><p>这个过程当中可以发现问题的整个过程如下</p><p>gtest主线程调用一个planner的模块，该模块会启动线程2执行任务，执行任务的过程中会调用load地图的函数，注意这里面load地图的函数会传递一个析构函数到主线程。因此当planner的模块退出时，主线程调用析构函数。而该主线程在退出时调用的析构函数会再次创建一个新的线程去执行析构（DestroyContainerAsync，本质是ScheduleFuture一个对象到线程池）。换言之在主线程on_exit的时候，调用了ThreadPool::DisposalPool()去创建第三个线程，执行任务。</p><p>实际上这里如果能够保证第三个线程管理的内存对象都释放掉，那么问题并不严重，但是我们的代码里面调用了folly的threadlocal类型对象，即folly::ThreadLocal&lt;XXXPerThread, XXXTag> xxx_per_thread_;这个东西，它最终会进入下面的代码的pthread_setspecific从而抛出invalid argument，即key是invalid。那么问题就出现了pthread_getspecific没出错说明这个时候key是有效的，pthread_setspecific出错说明这个时候key无效，那么必然是key删除了，这个key为什么会删除，在哪里删除？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>FOLLY_EXPORT</span> <span class=n>FOLLY_NOINLINE</span> <span class=k>static</span> <span class=n>ThreadEntry</span><span class=o>*</span> <span class=nf>getThreadEntrySlow</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>meta</span> <span class=o>=</span> <span class=n>instance</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>key</span> <span class=o>=</span> <span class=n>meta</span><span class=p>.</span><span class=n>pthreadKey_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ThreadEntry</span><span class=o>*</span> <span class=n>threadEntry</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>static_cast</span><span class=o>&lt;</span><span class=n>ThreadEntry</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>pthread_getspecific</span><span class=p>(</span><span class=n>key</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>threadEntry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>ThreadEntryList</span><span class=o>*</span> <span class=n>threadEntryList</span> <span class=o>=</span> <span class=n>StaticMeta</span><span class=o>::</span><span class=n>getThreadEntryList</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>kUseThreadLocal</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>static</span> <span class=k>thread_local</span> <span class=n>ThreadEntry</span> <span class=n>threadEntrySingleton</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>threadEntry</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>threadEntrySingleton</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>threadEntry</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadEntry</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// if the ThreadEntry already exists
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// but pthread_getspecific returns NULL
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// do not add the same entry twice to the list
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// since this would create a loop in the list
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>list</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>list</span> <span class=o>=</span> <span class=n>threadEntryList</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>listNext</span> <span class=o>=</span> <span class=n>threadEntryList</span><span class=o>-&gt;</span><span class=n>head</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>threadEntryList</span><span class=o>-&gt;</span><span class=n>head</span> <span class=o>=</span> <span class=n>threadEntry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>tid</span><span class=p>()</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>tid_os</span> <span class=o>=</span> <span class=n>folly</span><span class=o>::</span><span class=n>getOSThreadID</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// if we&#39;re adding a thread entry
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// we need to increment the list count
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// even if the entry is reused
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>threadEntryList</span><span class=o>-&gt;</span><span class=n>count</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>meta</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>meta</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>pthread_setspecific</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>threadEntry</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>checkPosixError</span><span class=p>(</span><span class=n>ret</span><span class=p>,</span> <span class=s>&#34;pthread_setspecific failed&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>这里追踪就能发现folly::threadlocal_detail::PthreadKeyUnregister::~PthreadKeyUnregister()在析构的时候pthread_delete掉了pthread_key类型的变量，PthreadKeyUnregister是一个singleton，主线程退出会调用其析构删除pthread key对象，一旦在set之前析构掉了，那么就会报错pthread_setspecific invalid argument。参考这个实现就很清楚了（实际上注释也写的很清楚了，这个singleton是由析构顺序造成的问题的，其logic并不安全），PthreadKeyUnregister管理着全局的所有的pthread_key。每次新注册的pthread_local都会走这套去注册pthread_key到该类型中，而析构的时候并最终释放掉这些pthread keys。而另外一个新线程此时需要绑定一个局部tls到这个pthreadkey，从而导致这个问题。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PthreadKeyUnregister</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=k>constexpr</span> <span class=n>size_t</span> <span class=n>kMaxKeys</span> <span class=o>=</span> <span class=mi>1UL</span> <span class=o>&lt;&lt;</span> <span class=mi>16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>~</span><span class=n>PthreadKeyUnregister</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If static constructor priorities are not supported then
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ~PthreadKeyUnregister logic is not safe.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#if !defined(__APPLE__) &amp;&amp; !defined(_MSC_VER)
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=n>MSLGuard</span> <span class=nf>lg</span><span class=p>(</span><span class=n>lock_</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 最终考虑了下，once and for all还是直接注释掉下面三句话。。。。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=p>(</span><span class=n>size_</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=n>pthread_key_delete</span><span class=p>(</span><span class=n>keys_</span><span class=p>[</span><span class=o>--</span><span class=n>size_</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=kt>void</span> <span class=nf>registerKey</span><span class=p>(</span><span class=n>pthread_key_t</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span> <span class=n>instance_</span><span class=p>.</span><span class=n>registerKeyImpl</span><span class=p>(</span><span class=n>key</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Only one global instance should exist, hence this is private.
</span></span></span><span class=line><span class=cl><span class=cm>   * See also the important note at the top of this class about `constexpr`
</span></span></span><span class=line><span class=cl><span class=cm>   * usage.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>constexpr</span> <span class=n>PthreadKeyUnregister</span><span class=p>()</span> <span class=o>:</span> <span class=n>lock_</span><span class=p>(),</span> <span class=n>size_</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=n>keys_</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=k>friend</span> <span class=k>struct</span> <span class=nc>folly</span><span class=o>::</span><span class=n>threadlocal_detail</span><span class=o>::</span><span class=n>PthreadKeyUnregisterTester</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>registerKeyImpl</span><span class=p>(</span><span class=n>pthread_key_t</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>MSLGuard</span> <span class=n>lg</span><span class=p>(</span><span class=n>lock_</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>size_</span> <span class=o>==</span> <span class=n>kMaxKeys</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>throw_exception</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>logic_error</span><span class=o>&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;pthread_key limit has already been reached&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>keys_</span><span class=p>[</span><span class=n>size_</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>MicroSpinLock</span> <span class=n>lock_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>size_t</span> <span class=n>size_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>pthread_key_t</span> <span class=n>keys_</span><span class=p>[</span><span class=n>kMaxKeys</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=n>PthreadKeyUnregister</span> <span class=n>instance_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>这里我们最终回归一下，为什么说程序开始的时候调用DestroyContainerAsync(std::move(x x x)); 强制初始化好ThreadLocal变量，只是虚假的解决了这个问题，而不是真正地解决，还是回到下面的代码，是因为如果强行构造std::move来程序正常运行时绑定了tls到pthread_key，之后这里的pthread_getspecific获取就不会出现threadEntry为空的情况，从而就不会调用的pthread_setspecific，所以不会出现pthread_setspecific的问题。其实际上并没有保证内存是正常的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl>   <span class=n>FOLLY_NOINLINE</span> <span class=k>static</span> <span class=kt>void</span> <span class=nf>getSlowReserveAndCache</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>EntryID</span><span class=o>*</span> <span class=n>ent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>uint32_t</span><span class=o>&amp;</span> <span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>ThreadEntry</span><span class=o>*&amp;</span> <span class=n>threadEntry</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>size_t</span><span class=o>&amp;</span> <span class=n>capacity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>inst</span> <span class=o>=</span> <span class=n>instance</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>threadEntry</span> <span class=o>=</span> <span class=n>inst</span><span class=p>.</span><span class=n>threadEntry_</span><span class=p>();</span> <span class=o>&lt;===</span> <span class=n>run</span> <span class=n>here</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>UNLIKELY</span><span class=p>(</span><span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>getElementsCapacity</span><span class=p>()</span> <span class=o>&lt;=</span> <span class=n>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>inst</span><span class=p>.</span><span class=n>reserve</span><span class=p>(</span><span class=n>ent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>id</span> <span class=o>=</span> <span class=n>ent</span><span class=o>-&gt;</span><span class=n>getOrInvalid</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>capacity</span> <span class=o>=</span> <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>getElementsCapacity</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>assert</span><span class=p>(</span><span class=n>capacity</span> <span class=o>&gt;</span> <span class=n>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FOLLY_EXPORT</span> <span class=n>FOLLY_NOINLINE</span> <span class=k>static</span> <span class=n>ThreadEntry</span><span class=o>*</span> <span class=nf>getThreadEntrySlow</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 拿到对应的staticMeta
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>meta</span> <span class=o>=</span> <span class=n>instance</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 拿到对应的pthreadkey
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>auto</span> <span class=n>key</span> <span class=o>=</span> <span class=n>meta</span><span class=p>.</span><span class=n>pthreadKey_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取对当前线程拿到的ThreadEntry
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ThreadEntry</span><span class=o>*</span> <span class=n>threadEntry</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>static_cast</span><span class=o>&lt;</span><span class=n>ThreadEntry</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>pthread_getspecific</span><span class=p>(</span><span class=n>key</span><span class=p>));</span>  <span class=c1>// 就是这里实际上不会返回null了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>threadEntry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// threadEntry为空说明当前线程就没这个玩意，那么我们就得分配新的ThreadEntry开始用啦
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 这里注意ThreadEntryList是StaticMeta的东西
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>ThreadEntryList</span><span class=o>*</span> <span class=n>threadEntryList</span> <span class=o>=</span> <span class=n>StaticMeta</span><span class=o>::</span><span class=n>getThreadEntryList</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>kUseThreadLocal</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>static</span> <span class=k>thread_local</span> <span class=n>ThreadEntry</span> <span class=n>threadEntrySingleton</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>threadEntry</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>threadEntrySingleton</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>threadEntry</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadEntry</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// if the ThreadEntry already exists
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// but pthread_getspecific returns NULL
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// do not add the same entry twice to the list
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// since this would create a loop in the list
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 刚才的新造出来的，当前线程的存储的局部ThreadEntry放到threadEntryList里面
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>list</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>list</span> <span class=o>=</span> <span class=n>threadEntryList</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>listNext</span> <span class=o>=</span> <span class=n>threadEntryList</span><span class=o>-&gt;</span><span class=n>head</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>threadEntryList</span><span class=o>-&gt;</span><span class=n>head</span> <span class=o>=</span> <span class=n>threadEntry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 再存储下tid
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>tid</span><span class=p>()</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>tid_os</span> <span class=o>=</span> <span class=n>folly</span><span class=o>::</span><span class=n>getOSThreadID</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// if we&#39;re adding a thread entry
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// we need to increment the list count
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// even if the entry is reused
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>threadEntryList</span><span class=o>-&gt;</span><span class=n>count</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>threadEntry</span><span class=o>-&gt;</span><span class=n>meta</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>meta</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 上面都加好了，现在可以设置绑定到当前线程啦
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>pthread_setspecific</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>threadEntry</span><span class=p>);</span>   <span class=o>&lt;===</span> <span class=n>run</span> <span class=n>here</span>
</span></span><span class=line><span class=cl>      <span class=n>checkPosixError</span><span class=p>(</span><span class=n>ret</span><span class=p>,</span> <span class=s>&#34;pthread_setspecific failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//不为空直接返回了拿到的当前线程的ThreadEntry
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>threadEntry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></div><p>附上程序栈和部分代码的分析</p><pre tabindex=0><code>(gdb) bt
#0  0x00007fffe8de1d50 in __GI___pthread_setspecific (key=9, value=0x7fffde552518) at pthread_setspecific.c:26
# 这里就到了有趣的地方了，解释看上面的部分
#1  0x00007fffee3dd94c in folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::getThreadEntrySlow() () at external/folly/folly/detail/ThreadLocalDetail.h:497

# frame 2 getSlowReserveAndCache这个的代码就不贴了，这里实际上是拿到staticmeta&lt;Tag&gt;的instance
# 即只针对某一种类型的staticmeta的单例
#2  0x00007fffee3dd4ab in folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::getSlowReserveAndCache(folly::threadlocal_detail::StaticMetaBase::EntryID*, unsigned int&amp;, folly::threadlocal_detail::ThreadEntry*&amp;, unsigned long&amp;) (ent=0x5555556eaa80, id=@0x7fffde550c64: 1, threadEntry=@0x7fffde552508: 0x0, capacity=@0x7fffde552510: 0) at external/folly/folly/detail/ThreadLocalDetail.h:459

# frame 3的代码如下
#  FOLLY_EXPORT FOLLY_ALWAYS_INLINE static ElementWrapper&amp; get(EntryID* ent) {
#    // Eliminate as many branches and as much extra code as possible in the
#    // cached fast path, leaving only one branch here and one indirection below.
#    uint32_t id = ent-&gt;getOrInvalid();
##ifdef FOLLY_TLD_USE_FOLLY_TLS
#    static FOLLY_TLS ThreadEntry* threadEntry{};   &lt;== notice here， it&#39;s a per thread static thing as well
#    static FOLLY_TLS size_t capacity{};     &lt;== FOLLY_TLS is macro for _thread per thread as well
##else
#    ThreadEntry* threadEntry{};
#    size_t capacity{};
##endif
#    if (FOLLY_UNLIKELY(capacity &lt;= id)) {
#      getSlowReserveAndCache(ent, id, threadEntry, capacity);  &lt;== run here
#    }
#    return threadEntry-&gt;elements[id];
#  }
# 这次在做什么操作呢，实际上就是在给元素做cache缓存和分配。这里注意
# ThreadEntry* threadEntry{}是第一次分配的时候的事情，这时候这个东西实际上是空的指针！也就是说如果第一次过来会申请
# 但是如果已经走了一遍申请，因为静态变量不会多次初始化，所以只要它变了，它就是变了，
# 下次再来访问这里的时候,id和capcity都是确定的，如果是新的那么id就增加了,capacity就会
#
#
#
#
#3  0x00007fffee3dd37f in folly::threadlocal_detail::StaticMeta&lt;qcraft::CounterImpl::CounterTag, void&gt;::get(folly::threadlocal_detail::StaticMetaBase::EntryID*) (ent=0x5555556eaa80) at external/folly/folly/detail/ThreadLocalDetail.h:448

# frame 4的代码如下
#  T* get() const {
#    threadlocal_detail::ElementWrapper&amp; w = StaticMeta::get(&amp;id_); &lt;== run here
#    return static_cast&lt;T*&gt;(w.ptr);
#  }
# 所以可以清楚的看到，这个时候实际上是从StaticMeta当中通过id拿到真实元素的wrapper,StaticMeta是一个类型设定好了singleton
# 对于整个程序而言，一种类型对应一种StaticMeta，用folly自己的话
# We have one of these per &#34;Tag&#34;, by default one for the whole system，
# 在这里我们就能确定我们操作的是CounterTag的StaticMeta，但是这里的id_是什么？如果是默认构造函数，能够看到id_调用默认构造
# 由其他的ThreadLocalPtr那么就拿别人的id_
#4  0x00007fffee3dd37f in folly::ThreadLocalPtr&lt;qcraft::CounterImpl::CounterPerThread, qcraft::CounterImpl::CounterTag, void&gt;::get() const (this=0x5555556eaa80) at external/folly/folly/ThreadLocal.h:158

# frame 5 这里实际上就是获取对应的perthread的数据的过程,对应的代码如下
#  FOLLY_ERASE T* get() const {
#    auto const ptr = tlp_.get();  &lt;==运行到这里
#    return FOLLY_LIKELY(!!ptr) ? ptr : makeTlp();
# }
# 第一个问题就来了tlp_是个什么东西，其定义为mutable ThreadLocalPtr&lt;T, Tag, AccessMode&gt; tlp_
# 所以实际上就是一个ThreadLocalPtr类型，参考https://github.com/facebook/folly/blob/main/folly/docs/ThreadLocal.md
# 所以实际上folly::ThreadLocal就是一成folly::ThreadLocalPtr的包裹，哈哈哈，这个具体干啥可以直接查询到
#5  0x00007fffee3ca7d1 in folly::ThreadLocal&lt;qcraft::CounterImpl::CounterPerThread, qcraft::CounterImpl::CounterTag, void&gt;::get() const (this=0x5555556eaa80) at external/folly/folly/ThreadLocal.h:68

# frame 6 真正开始调用operator-&gt;()，因为其是一个threadlocal类型的变量，所以指针寻找的过程实际上重写了对应的过程
# 这里实际上就是把xxxx_per_thread_当成了一个指针
#6  0x00007fffee3ca7d1 in folly::ThreadLocal&lt;qcraft::CounterImpl::CounterPerThread, qcraft::CounterImpl::CounterTag, void&gt;::operator-&gt;() const (this=0x5555556eaa80) at external/folly/folly/ThreadLocal.h:73

# frame 7 的代码实际上是个xxxx_per_thread_-&gt;spin_lock.Lock(), 
# xxxx_per_thread_对应的类别是XXXPerThread，里面放了一个boost::circular_buffer和SpinLock
#7  0x00007fffee3b90a4 in qcraft::CounterImpl::AddCounterEvent(char const*, long) (this=0x5555556eaa80, name=0x7fffee41e698 &#34;AddTraceEvent&#34;, val=12096) at onboard/global/counter.cc:70
#8  0x00007fffee3baa3d in qcraft::Counter::AddCounterEventInternal(char const*, long) (this=0x555555744ca0, name=0x7fffee41e698 &#34;AddTraceEvent&#34;, val=12096) at onboard/global/counter.cc:208
#9  0x00007ffff76a1d25 in qcraft::Counter::AddCounterEvent&lt;long&gt;(char const*, long) (this=0x555555744ca0, name=0x7fffee41e698 &#34;AddTraceEvent&#34;, val=12096) at ./onboard/global/counter.h:40
#10 0x00007ffff7668d3b in qcraft::CounterEventWrapper::~CounterEventWrapper() (this=0x7fffde550f18) at ./onboard/global/counter.h:64
#11 0x00007fffee440325 in qcraft::TraceImpl::AddTraceEvent(qcraft::TraceEvent const&amp;) (this=0x7fffd901e0e0, trace_event=...) at onboard/global/trace.cc:75
#12 0x00007fffee42f675 in qcraft::Trace::AddTraceEvent(qcraft::TraceEvent const&amp;) (this=0x7fffd901a0f0, trace_event=...) at onboard/global/trace.cc:342
#13 0x00007ffff7bc2a96 in qcraft::ScopedTrace::ScopedTrace(char const*, bool) (this=0x7fffde5510d0, name=0x7ffff3d3ab2b &#34;DestroyContainerAsync&#34;, use_ftrace=true) at ./onboard/global/trace.h:150
#14 0x00007ffff3dbeb76 in void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1}::operator()() (this=0x555555728d78)
    at ./onboard/async/async_util.h:40
#15 0x00007ffff3dc275d in std::__invoke_impl&lt;void, void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1}&amp;&gt;(std::__invoke_other, void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1}&amp;) (__f=...)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/invoke.h:60
#16 0x00007ffff3dc272d in std::__invoke&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1}&amp;&gt;(void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1}&amp;, (std::__invoke_result&amp;&amp;)...) (__fn=...)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/invoke.h:95
#17 0x00007ffff3dc2709 in std::_Bind&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;::__call&lt;void&gt;(std::tuple&lt;&gt;&amp;&amp;, std::_Index_tuple&lt;&gt;) (this=0x555555728d78, __args=...) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/functional:400
#18 0x00007ffff3dc26e6 in std::_Bind&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;::operator()&lt;, void&gt;() (this=0x555555728d78) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/functional:482
#19 0x00007ffff3dc269d in std::__invoke_impl&lt;void, std::_Bind&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;&amp;&gt;(std::__invoke_other, std::_Bind&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;&amp;) (__f=...)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/invoke.h:60
#20 0x00007ffff3dc266d in std::__invoke&lt;std::_Bind&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;&amp;&gt;(std::_Bind&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;&amp;, (std::__invoke_result&amp;&amp;)...) (__fn=...)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/invoke.h:95
#21 0x00007ffff3dc263c in std::__future_base::_Task_state&lt;std::_Bind&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;, std::allocator&lt;int&gt;, void ()&gt;::_M_run()::{lambda()#1}::operator()() const (this=0x7fffde551660) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/future:1421
#22 0x00007ffff3dc251c in std::__future_base::_Task_setter&lt;std::unique_ptr&lt;std::__future_base::_Result&lt;void&gt;, std::__future_base::_Result_base::_Deleter&gt;, std::__future_base::_Task_state&lt;std::_Bind&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;, std::allocator&lt;int&gt;, void ()&gt;::_M_run()::{lambda()#1}, void&gt;::operator()() const (this=0x7fffde551640)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/future:1362
#23 0x00007ffff3dc23b0 in std::_Function_handler&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; (), std::__future_base::_Task_setter&lt;std::unique_ptr&lt;std::__future_base::_Result&lt;void&gt;, std::__future_base::_Result_base::_Deleter&gt;, std::__future_base::_Task_state&lt;std::_Bind&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;, std::allocator&lt;int&gt;, void ()&gt;::_M_run()::{lambda()#1}, void&gt; &gt;::_M_invoke(std::_Any_data const&amp;) (__functor=...) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/std_function.h:285
#24 0x00007ffff3dab658 in std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;::operator()() const (this=0x7fffde551640) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/std_function.h:688
#25 0x00007ffff3dab379 in std::__future_base::_State_baseV2::_M_do_set(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*) (this=0x555555728d50, __f=0x7fffde551640, __did_set=0x7fffde5515c6)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/future:561
#26 0x00007ffff3dab601 in std::__invoke_impl&lt;void, void (std::__future_base::_State_baseV2::*)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*&gt;(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&amp;&amp;)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*&amp;&amp;, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*&amp;&amp;, bool*&amp;&amp;) (__f=
    @0x7fffde5515b0: (void (std::__future_base::_State_baseV2::*)(std::__future_base::_State_baseV2 * const, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt; *, bool *)) 0x7ffff3dab350 &lt;std::__future_base::_State_baseV2::_M_do_set(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*)&gt;, __t=@0x7fffde5515a8: 0x555555728d50, __args=@0x7fffde5515a0: 0x7fffde551640, __args=@0x7fffde551598: 0x7fffde5515c6)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/invoke.h:73
#27 0x00007ffff3dab50c in std::__invoke&lt;void (std::__future_base::_State_baseV2::*)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*&gt;(void (std::__future_base::_State_baseV2::*&amp;&amp;)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*&amp;&amp;, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*&amp;&amp;, bool*&amp;&amp;) (__fn=
    @0x7fffde5515b0: (void (std::__future_base::_State_baseV2::*)(std::__future_base::_State_baseV2 * const, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt; *, bool *)) 0x7ffff3dab350 &lt;std::__future_base::_State_baseV2::_M_do_set(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*)&gt;, __args=@0x7fffde5515a8: 0x555555728d50, __args=@0x7fffde5515a0: 0x7fffde551640, __args=@0x7fffde551598: 0x7fffde5515c6)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/invoke.h:95
#28 0x00007ffff3dab49c in void std::call_once&lt;void (std::__future_base::_State_baseV2::*)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*&gt;(std::once_flag&amp;, void (std::__future_base::_State_baseV2::*&amp;&amp;)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*&amp;&amp;, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*&amp;&amp;, bool*&amp;&amp;)::{lambda()#1}::operator()() const (this=0x7fffde551518)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/mutex:671
#29 0x00007ffff3dab424 in void std::call_once&lt;void (std::__future_base::_State_baseV2::*)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*&gt;(std::once_flag&amp;, void (std::__future_base::_State_baseV2::*&amp;&amp;)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*&amp;&amp;, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*&amp;&amp;, bool*&amp;&amp;)::{lambda()#2}::operator()() const (this=0x7ffff7e57758)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/mutex:676
#30 0x00007ffff3dab3f9 in void std::call_once&lt;void (std::__future_base::_State_baseV2::*)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*&gt;(std::once_flag&amp;, void (std::__future_base::_State_baseV2::*&amp;&amp;)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*&amp;&amp;, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*&amp;&amp;, bool*&amp;&amp;)::{lambda()#2}::__invoke() () at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/mutex:676
#31 0x00007fffe8de24df in __pthread_once_slow (once_control=0x555555728d68, init_routine=0x7ffff7d51c20 &lt;__once_proxy&gt;) at pthread_once.c:116
#32 0x00007ffff3d938cb in __gthread_once(int*, void (*)()) (__once=0x555555728d68, __func=0x7ffff7d51c20 &lt;__once_proxy&gt;) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/x86_64-linux-gnu/c++/9/bits/gthr-default.h:700
#33 0x00007ffff3dab334 in std::call_once&lt;void (std::__future_base::_State_baseV2::*)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*&gt;(std::once_flag&amp;, void (std::__future_base::_State_baseV2::*&amp;&amp;)(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*), std::__future_base::_State_baseV2*&amp;&amp;, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*&amp;&amp;, bool*&amp;&amp;) (__once=..., __f=
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---
    @0x7fffde5515b0: (void (std::__future_base::_State_baseV2::*)(std::__future_base::_State_baseV2 * const, std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt; *, bool *)) 0x7ffff3dab350 &lt;std::__future_base::_State_baseV2::_M_do_set(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;*, bool*)&gt;, __args=@0x7fffde5515a8: 0x555555728d50, __args=@0x7fffde5515a0: 0x7fffde551640, __args=@0x7fffde551598: 0x7fffde5515c6)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/mutex:683
#34 0x00007ffff3daae2e in std::__future_base::_State_baseV2::_M_set_result(std::function&lt;std::unique_ptr&lt;std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter&gt; ()&gt;, bool) (this=0x555555728d50, __res=..., __ignore_failure=false)
    at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/future:401
#35 0x00007ffff3dc1f71 in std::__future_base::_Task_state&lt;std::_Bind&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;, std::allocator&lt;int&gt;, void ()&gt;::_M_run() (this=0x555555728d50) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/future:1423
#36 0x00007ffff3dc0a7b in std::packaged_task&lt;void ()&gt;::operator()() (this=0x5555558181b0) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/future:1551
#37 0x00007ffff3dc388d in qcraft::Future&lt;std::result_of&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;::type&gt; qcraft::ThreadPool::Schedule&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1}&gt;(void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1}&amp;&amp;, (std::result_of&amp;&amp;)...)::{lambda()#1}::operator()() const (this=0x5555557287e0)
    at ./onboard/async/thread_pool.h:118
#38 0x00007ffff3dc372d in std::_Function_handler&lt;void (), qcraft::Future&lt;std::result_of&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1} ()&gt;::type&gt; qcraft::ThreadPool::Schedule&lt;void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1}&gt;(void qcraft::DestroyContainerAsync&lt;qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt; &gt;(qcraft::ThreadPool*, qcraft::LockFileAndDelete&lt;qcraft::mapping::v2::SemanticMapManager&gt;)::{lambda()#1}&amp;&amp;, (std::result_of&amp;&amp;)...)::{lambda()#1}&gt;::_M_invoke(std::_Any_data const&amp;) (__functor=...) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/std_function.h:300
#39 0x00007ffff7668ad5 in std::function&lt;void ()&gt;::operator()() const (this=0x7fffde551748) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/std_function.h:688
#40 0x00007fffee4756bb in qcraft::ThreadPool::ThreadPool(int, std::function&lt;void (int)&gt; const&amp;)::$_0::operator()() const (this=0x555555727e88) at onboard/async/thread_pool.cc:74
#41 0x00007fffee47542d in _ZSt13__invoke_implIvZN6qcraft10ThreadPoolC1EiRKSt8functionIFviEEE3$_0JEET_St14__invoke_otherOT0_DpOT1_ (__f=...) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/invoke.h:60
#42 0x00007fffee4753bd in _ZSt8__invokeIZN6qcraft10ThreadPoolC1EiRKSt8functionIFviEEE3$_0JEENSt15__invoke_resultIT_JDpT0_EE4typeEOS9_DpOSA_ (__fn=...) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/bits/invoke.h:95
#43 0x00007fffee475395 in std::thread::_Invoker&lt;std::tuple&lt;qcraft::ThreadPool::ThreadPool(int, std::function&lt;void (int)&gt; const&amp;)::$_0&gt; &gt;::_M_invoke&lt;0ul&gt;(std::_Index_tuple&lt;0ul&gt;) (this=0x555555727e88) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/thread:244
#44 0x00007fffee475365 in std::thread::_Invoker&lt;std::tuple&lt;qcraft::ThreadPool::ThreadPool(int, std::function&lt;void (int)&gt; const&amp;)::$_0&gt; &gt;::operator()() (this=0x555555727e88) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/thread:251
#45 0x00007fffee475229 in std::thread::_State_impl&lt;std::thread::_Invoker&lt;std::tuple&lt;qcraft::ThreadPool::ThreadPool(int, std::function&lt;void (int)&gt; const&amp;)::$_0&gt; &gt; &gt;::_M_run() (this=0x555555727e80) at /usr/lib/gcc/x86_64-linux-gnu/9/../../../../include/c++/9/thread:195
#46 0x00007ffff7d52de4 in  () at /usr/lib/x86_64-linux-gnu/libstdc++.so.6
#47 0x00007fffe8dd9609 in start_thread (arg=&lt;optimized out&gt;) at pthread_create.c:477
#48 0x00007fffe858b133 in clone () at /lib/x86_64-linux-gnu/libc.so.6
</code></pre><p>到这里这个事情基本就结束了</p><h3 class="relative group">14 因为升级glog导致的问题<div id=14-%E5%9B%A0%E4%B8%BA%E5%8D%87%E7%BA%A7glog%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#14-%E5%9B%A0%E4%B8%BA%E5%8D%87%E7%BA%A7glog%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h3><p>这几天维护代码库遇到一个问题，我们有一个Async的Logtest忽然开始bangbangbang出错了，代码大致如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>TEST</span><span class=p>(</span><span class=n>AsyncLoggerTest</span><span class=p>,</span> <span class=n>SetLoggerToGlog</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>AsyncLogger</span> <span class=n>logger</span><span class=p>(</span><span class=n>google</span><span class=o>::</span><span class=n>base</span><span class=o>::</span><span class=n>GetLogger</span><span class=p>(</span><span class=n>google</span><span class=o>::</span><span class=n>INFO</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>google</span><span class=o>::</span><span class=n>base</span><span class=o>::</span><span class=n>SetLogger</span><span class=p>(</span><span class=n>FLAGS_minloglevel</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>logger</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>google</span><span class=o>::</span><span class=n>ShutdownGoogleLogging</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//gtest的报错信息
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>FAIL: //cyber/logger:async_logger_test ...
</span></span><span class=line><span class=cl>INFO: From Testing //cyber/logger:async_logger_test:
</span></span><span class=line><span class=cl><span class=o>====================</span> Test output <span class=k>for</span> //cyber/logger:async_logger_test:
</span></span><span class=line><span class=cl>Running main<span class=o>()</span> from gmock_main.cc
</span></span><span class=line><span class=cl><span class=o>[==========]</span> Running <span class=m>2</span> tests from <span class=m>1</span> <span class=nb>test</span> suite.
</span></span><span class=line><span class=cl><span class=o>[</span>----------<span class=o>]</span> Global <span class=nb>test</span> environment set-up.
</span></span><span class=line><span class=cl><span class=o>[</span>----------<span class=o>]</span> <span class=m>2</span> tests from AsyncLoggerTest
</span></span><span class=line><span class=cl><span class=o>[</span> RUN      <span class=o>]</span> AsyncLoggerTest.WriteAndFlush
</span></span><span class=line><span class=cl><span class=o>[</span>       OK <span class=o>]</span> AsyncLoggerTest.WriteAndFlush <span class=o>(</span><span class=m>3</span> ms<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span> RUN      <span class=o>]</span> AsyncLoggerTest.SetLoggerToGlog
</span></span><span class=line><span class=cl>E20220301 18:15:28.254946  <span class=m>8519</span> async_logger_test.cc:65<span class=o>]</span> <span class=o>[</span>AsyncLoggerTest2<span class=o>]</span><span class=nb>test</span> <span class=nb>set</span> async logger to glog
</span></span><span class=line><span class=cl>free<span class=o>()</span>: invalid <span class=nv>pointer</span>
</span></span><span class=line><span class=cl><span class=o>================================================================================</span>
</span></span><span class=line><span class=cl>Target //cyber/logger:async_logger_test up-to-date:
</span></span><span class=line><span class=cl>  bazel-bin/cyber/logger/async_logger_test
</span></span><span class=line><span class=cl>INFO: Elapsed time: 1.325s, Critical Path: 1.09s
</span></span><span class=line><span class=cl>INFO: <span class=m>2</span> processes: <span class=m>2</span> processwrapper-sandbox.
</span></span><span class=line><span class=cl>INFO: Build completed, <span class=m>1</span> <span class=nb>test</span> FAILED, <span class=m>2</span> total actions
</span></span><span class=line><span class=cl>Test cases: finished with <span class=m>0</span> passing and <span class=m>1</span> failing out of <span class=m>1</span> <span class=nb>test</span> cases
</span></span></code></pre></div><p>然后我开始介入，基本上free报invalid pointer都是传入的指针不对，看了下就是logger的地址被传递给了free的参数，一开始没反应过来，以为是函数写越界地址写错了，然后后来忽然感觉不对劲：logger是个局部变量，明明是栈上的怎么就在ShutdownGoogleLogging里面给free了，然后看了下free函数寄存器等东西发现确实是free的这个地址！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>rdx</span> <span class=o>=</span> 0x0000555555664010
</span></span><span class=line><span class=cl><span class=nv>rdi</span> <span class=o>=</span> 0x00007fffffffd208
</span></span><span class=line><span class=cl><span class=nv>rsi</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apollo::cyber::logger::AsyncLogger::AsyncLogger
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> register <span class=nb>read</span>
</span></span><span class=line><span class=cl>General Purpose Registers:
</span></span><span class=line><span class=cl>       <span class=nv>rax</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>       <span class=nv>rbx</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>       <span class=nv>rcx</span> <span class=o>=</span> 0x0000000000000002
</span></span><span class=line><span class=cl>       <span class=nv>rdx</span> <span class=o>=</span> 0x0000555555664010
</span></span><span class=line><span class=cl>       <span class=nv>rdi</span> <span class=o>=</span> 0x00007fffffffd208
</span></span><span class=line><span class=cl>       <span class=nv>rsi</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>       <span class=nv>rbp</span> <span class=o>=</span> 0x00007fffffffd0c0
</span></span><span class=line><span class=cl>       <span class=nv>rsp</span> <span class=o>=</span> 0x00007fffffffd0a8
</span></span><span class=line><span class=cl>        <span class=nv>r8</span> <span class=o>=</span> 0x000055555567dd60
</span></span><span class=line><span class=cl>        <span class=nv>r9</span> <span class=o>=</span> 0x00007fffffffcd10
</span></span><span class=line><span class=cl>       <span class=nv>r10</span> <span class=o>=</span> 0x00007fffffffcd10
</span></span><span class=line><span class=cl>       <span class=nv>r11</span> <span class=o>=</span> 0x0000000000000206
</span></span><span class=line><span class=cl>       <span class=nv>r12</span> <span class=o>=</span> 0x000055555558edd0  async_logger_test<span class=sb>`</span>_start
</span></span><span class=line><span class=cl>       <span class=nv>r13</span> <span class=o>=</span> 0x00007fffffffd8f0
</span></span><span class=line><span class=cl>       <span class=nv>r14</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>       <span class=nv>r15</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>       <span class=nv>rip</span> <span class=o>=</span> 0x00007fffed33ca30  libc.so.6<span class=sb>`</span>cfree
</span></span><span class=line><span class=cl>    <span class=nv>rflags</span> <span class=o>=</span> 0x0000000000000206
</span></span><span class=line><span class=cl>        <span class=nv>cs</span> <span class=o>=</span> 0x0000000000000033
</span></span><span class=line><span class=cl>        <span class=nv>fs</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>        <span class=nv>gs</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>        <span class=nv>ss</span> <span class=o>=</span> 0x000000000000002b
</span></span><span class=line><span class=cl>        <span class=nv>ds</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>        <span class=nv>es</span> <span class=o>=</span> 0x0000000000000000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> br list
</span></span><span class=line><span class=cl>Current breakpoints:
</span></span><span class=line><span class=cl>1: <span class=nv>name</span> <span class=o>=</span> <span class=s1>&#39;apollo::cyber::logger::AsyncLogger::~AsyncLogger&#39;</span>, <span class=nv>locations</span> <span class=o>=</span> 2, <span class=nv>resolved</span> <span class=o>=</span> 2, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>21</span>
</span></span><span class=line><span class=cl>  1.1: <span class=nv>where</span> <span class=o>=</span> libcyber_Slogger_Slibasync_Ulogger.so<span class=sb>`</span>apollo::cyber::logger::AsyncLogger::~AsyncLogger<span class=o>()</span> + <span class=m>20</span> at async_logger.cc:39:29, <span class=nv>address</span> <span class=o>=</span> 0x00007ffff7e5efd4, resolved, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>7</span> 
</span></span><span class=line><span class=cl>  1.2: <span class=nv>where</span> <span class=o>=</span> libcyber_Slogger_Slibasync_Ulogger.so<span class=sb>`</span>apollo::cyber::logger::AsyncLogger::~AsyncLogger<span class=o>()</span> + <span class=m>20</span> at async_logger.cc:39:29, <span class=nv>address</span> <span class=o>=</span> 0x00007ffff7e5eaf4, resolved, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>14</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>5: <span class=nv>name</span> <span class=o>=</span> <span class=s1>&#39;free&#39;</span>, <span class=nv>locations</span> <span class=o>=</span> 3, <span class=nv>resolved</span> <span class=o>=</span> 3, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>16</span>
</span></span><span class=line><span class=cl>  5.1: <span class=nv>where</span> <span class=o>=</span> ld-2.27.so<span class=sb>`</span>free, <span class=nv>address</span> <span class=o>=</span> 0x00007ffff7dee800, resolved, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>0</span> 
</span></span><span class=line><span class=cl>  5.2: <span class=nv>where</span> <span class=o>=</span> libexternal_Sboost_Slibasio.so<span class=sb>`</span>boost::asio::detail::object_pool&lt;boost::asio::detail::epoll_reactor::descriptor_state&gt;::free<span class=o>(</span>boost::asio::detail::epoll_reactor::descriptor_state*<span class=o>)</span> + <span class=m>24</span> at object_pool.hpp:128:9, <span class=nv>address</span> <span class=o>=</span> 0x00007ffff3317648, resolved, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>0</span> 
</span></span><span class=line><span class=cl>  5.3: <span class=nv>where</span> <span class=o>=</span> libc.so.6<span class=sb>`</span>cfree, <span class=nv>address</span> <span class=o>=</span> 0x00007fffed33ca30, resolved, hit <span class=nv>count</span> <span class=o>=</span> <span class=m>16</span> 
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>很有趣的一点，明明这个变量在栈上，为什么会送到free函数上？
</span></span><span class=line><span class=cl>看下分配的函数
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-&gt;  0x55555558f5f7 &lt;+87&gt;:  callq  0x5555555d9a80            <span class=p>;</span> symbol stub <span class=k>for</span>: google::base::GetLogger<span class=o>(</span>int<span class=o>)</span>
</span></span><span class=line><span class=cl>    0x55555558f5fc &lt;+92&gt;:  movq   %rax, %rsi
</span></span><span class=line><span class=cl>    0x55555558f5ff &lt;+95&gt;:  leaq   -0x78<span class=o>(</span>%rbp<span class=o>)</span>, %rdi
</span></span><span class=line><span class=cl>    0x55555558f603 &lt;+99&gt;:  movq   %rdi, -0xc0<span class=o>(</span>%rbp<span class=o>)</span>
</span></span><span class=line><span class=cl>    0x55555558f60a &lt;+106&gt;: callq  0x5555555d9a90            <span class=p>;</span> symbol stub <span class=k>for</span>: apollo::cyber::logger::AsyncLogger::AsyncLogger<span class=o>(</span>google::base::Logger*<span class=o>)</span>
</span></span><span class=line><span class=cl>    0x55555558f60f &lt;+111&gt;: movq   -0xc0<span class=o>(</span>%rbp<span class=o>)</span>, %rsi
</span></span><span class=line><span class=cl>    0x55555558f616 &lt;+118&gt;: movq   0x4eb33<span class=o>(</span>%rip<span class=o>)</span>, %rax
</span></span><span class=line><span class=cl>    0x55555558f61d &lt;+125&gt;: movl   <span class=o>(</span>%rax<span class=o>)</span>, %edi
</span></span><span class=line><span class=cl>    0x55555558f61f &lt;+127&gt;: callq  0x5555555d9bf0            <span class=p>;</span> symbol stub <span class=k>for</span>: google::base::SetLogger<span class=o>(</span>int, google::base::Logger*<span class=o>)</span>
</span></span><span class=line><span class=cl>    0x55555558f624 &lt;+132&gt;: jmp    0x55555558f629            <span class=p>;</span> &lt;+137&gt; at async_logger_test.cc
</span></span><span class=line><span class=cl>    0x55555558f629 &lt;+137&gt;: leaq   -0x78<span class=o>(</span>%rbp<span class=o>)</span>, %rdi
</span></span><span class=line><span class=cl>    0x55555558f62d &lt;+141&gt;: callq  0x5555555d9b60            <span class=p>;</span> symbol stub <span class=k>for</span>: apollo::cyber::logger::AsyncLogger::Start<span class=o>()</span>
</span></span><span class=line><span class=cl>    0x55555558f632 &lt;+146&gt;: jmp    0x55555558f637            <span class=p>;</span> &lt;+151&gt; at async_logger_test.cc:63:3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>非常清楚，调用apollo::cyber::logger::AsyncLogger::AsyncLogger的对象（实际上是rdi）是从栈上申请出来的地址，怎么最后就送到了free函数了呢？
</span></span></code></pre></div><p>开始翻修改记录，发现同事把代码从glog 0.4升级到了0.5的代码，然后打了下断点看了下调用栈</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Running main<span class=o>()</span> from gmock_main.cc
</span></span><span class=line><span class=cl><span class=o>[==========]</span> Running <span class=m>2</span> tests from <span class=m>1</span> <span class=nb>test</span> suite.
</span></span><span class=line><span class=cl><span class=o>[</span>----------<span class=o>]</span> Global <span class=nb>test</span> environment set-up.
</span></span><span class=line><span class=cl><span class=o>[</span>----------<span class=o>]</span> <span class=m>2</span> tests from AsyncLoggerTest
</span></span><span class=line><span class=cl><span class=o>[</span> RUN      <span class=o>]</span> AsyncLoggerTest.WriteAndFlush
</span></span><span class=line><span class=cl><span class=o>[</span>       OK <span class=o>]</span> AsyncLoggerTest.WriteAndFlush <span class=o>(</span><span class=m>3</span> ms<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span> RUN      <span class=o>]</span> AsyncLoggerTest.SetLoggerToGlog
</span></span><span class=line><span class=cl>E20220301 18:26:51.491030 <span class=m>15911</span> async_logger_test.cc:65<span class=o>]</span> <span class=o>[</span>AsyncLoggerTest2<span class=o>]</span><span class=nb>test</span> <span class=nb>set</span> async logger to glog
</span></span><span class=line><span class=cl>free<span class=o>()</span>: invalid pointer
</span></span><span class=line><span class=cl>Process <span class=m>15911</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;async_logger_te&#39;, stop reason = signal SIGABRT</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x00007fffed30dfb7 libc.so.6`raise + 199</span>
</span></span><span class=line><span class=cl>libc.so.6<span class=sb>`</span>raise:
</span></span><span class=line><span class=cl>-&gt;  0x7fffed30dfb7 &lt;+199&gt;: movq   0x108<span class=o>(</span>%rsp<span class=o>)</span>, %rcx
</span></span><span class=line><span class=cl>    0x7fffed30dfbf &lt;+207&gt;: xorq   %fs:0x28, %rcx
</span></span><span class=line><span class=cl>    0x7fffed30dfc8 &lt;+216&gt;: movl   %r8d, %eax
</span></span><span class=line><span class=cl>    0x7fffed30dfcb &lt;+219&gt;: jne    0x7fffed30dfec            <span class=p>;</span> &lt;+252&gt;
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> bt
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;async_logger_te&#39;, stop reason = signal SIGABRT</span>
</span></span><span class=line><span class=cl>  * frame <span class=c1>#0: 0x00007fffed30dfb7 libc.so.6`raise + 199</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#1: 0x00007fffed30f921 libc.so.6`abort + 321</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#2: 0x00007fffed358967 libc.so.6`___lldb_unnamed_symbol237$$libc.so.6 + 631</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#3: 0x00007fffed35f9da libc.so.6`___lldb_unnamed_symbol295$$libc.so.6 + 26</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#4: 0x00007fffed366f0c libc.so.6`cfree + 1244</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#5: 0x00007ffff7e5efe2 libcyber_Slogger_Slibasync_Ulogger.so`apollo::cyber::logger::AsyncLogger::~AsyncLogger(this=0x00007fffffffd218) at async_logger.cc:39:29</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#6: 0x00007fffef39da79 libexternal_Scom_Ugithub_Ugoogle_Uglog_Slibglog.so`google::LogDestination::~LogDestination(this=0x0000555555691c70) at logging.cc:638:5</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#7: 0x00007fffef39dbff libexternal_Scom_Ugithub_Ugoogle_Uglog_Slibglog.so`google::LogDestination::DeleteLogDestinations() at logging.cc:902:5</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#8: 0x00007fffef3a3282 libexternal_Scom_Ugithub_Ugoogle_Uglog_Slibglog.so`google::ShutdownGoogleLogging() at logging.cc:2573:3</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#9: 0x000055555558f838 async_logger_test`apollo::cyber::logger::AsyncLoggerTest_SetLoggerToGlog_Test::TestBody(this=0x00005555556b5180) at async_logger_test.cc:67:3</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#10: 0x00007fffeeb94d9b libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`void testing::internal::HandleSehExceptionsInMethodIfSupported&lt;testing::Test, void&gt;(object=0x00005555556b5180, method=21 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00, location=&#34;the test body&#34;)(), char const*) at gtest.cc:2607:10</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#11: 0x00007fffeeb82a0d libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`void testing::internal::HandleExceptionsInMethodIfSupported&lt;testing::Test, void&gt;(object=0x00005555556b5180, method=21 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00, location=&#34;the test body&#34;)(), char const*) at gtest.cc:2643:14</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#12: 0x00007fffeeb673e3 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`testing::Test::Run(this=0x00005555556b5180) at gtest.cc:2682:5</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#13: 0x00007fffeeb67fc9 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`testing::TestInfo::Run(this=0x00005555556c2080) at gtest.cc:2861:11</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#14: 0x00007fffeeb68814 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`testing::TestSuite::Run(this=0x000055555570f3b0) at gtest.cc:3015:28</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#15: 0x00007fffeeb7a5d8 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`testing::internal::UnitTestImpl::RunAllTests(this=0x0000555555707b20) at gtest.cc:5855:44</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#16: 0x00007fffeeb97c2b libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`bool testing::internal::HandleSehExceptionsInMethodIfSupported&lt;testing::internal::UnitTestImpl, bool&gt;(object=0x0000555555707b20, method=80 a1 b7 ee ff 7f 00 00 00 00 00 00 00 00 00 00, location=&#34;auxiliary test code (environments or event listeners)&#34;)(), char const*) at gtest.cc:2607:10</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#17: 0x00007fffeeb84f73 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`bool testing::internal::HandleExceptionsInMethodIfSupported&lt;testing::internal::UnitTestImpl, bool&gt;(object=0x0000555555707b20, method=80 a1 b7 ee ff 7f 00 00 00 00 00 00 00 00 00 00, location=&#34;auxiliary test code (environments or event listeners)&#34;)(), char const*) at gtest.cc:2643:14</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#18: 0x00007fffeeb7a118 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest.so`testing::UnitTest::Run(this=0x00007fffeebb3b60) at gtest.cc:5438:10</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#19: 0x00007fffeebb5a81 libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest_Umain.so`RUN_ALL_TESTS() at gtest.h:2490:46</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#20: 0x00007fffeebb5a1b libexternal_Scom_Ugoogle_Ugoogletest_Slibgtest_Umain.so`main(argc=1, argv=0x00007fffffffd908) at gmock_main.cc:70:10</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#21: 0x00007fffed2f0bf7 libc.so.6`__libc_start_main + 231</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#22: 0x000055555558edba async_logger_test`_start + 42</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> 
</span></span></code></pre></div><p>然后比较了一下glog 0.4和glog 0.5发现确实代码变了，还真是这个问题，然后查了一下glog的代码修改流程发现还真是这个事情，直接把整个logger的管理丢给了https://github.com/google/glog/commit/28321d8959574a8268de3ebe41d40cf65415fc9b</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>//glog 0.4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>~</span><span class=n>LogDestination</span><span class=p>()</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//glog 0.5
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>LogDestination</span><span class=o>::~</span><span class=n>LogDestination</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>logger_</span> <span class=o>&amp;&amp;</span> <span class=n>logger_</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>fileobject_</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Delete user-specified logger set via SetLogger().
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>delete</span> <span class=n>logger_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">15奇怪的调度<div id=15%E5%A5%87%E6%80%AA%E7%9A%84%E8%B0%83%E5%BA%A6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#15%E5%A5%87%E6%80%AA%E7%9A%84%E8%B0%83%E5%BA%A6 aria-label=锚点>#</a></span></h3><p>这个问题说起来并不难查，但是因为很久没做过性能方面的优化和分析，本身又对k8s不熟悉，所以漏了怯了。。。。回头写一个单独如何做性能分析的文章来总结下问题查询的方法。轻舟做CI，目前在迁移仿真从aws到阿里云集群（这个背景要注意），有的时候仿真的集群运行忽然就很慢，往往跑个pod发现要跑一个多小时，然后因为pod超时被kill，这个场景的测试又多次重试，从而又失败了。加了几条代码打日志看了下，代码如下：</p><pre tabindex=0><code>
std::vector&lt;std::vector&lt;cv::Mat&gt;&gt; PanoNet::ClassifyImagePixels(
    const std::vector&lt;cv::Mat&gt;&amp; images) {
  SCOPED_QTRACE_ARG1(&#34;PanoNet::ClassifyImagePixels&#34;, &#34;gpu_id&#34;,
                     GpuId_Name(net_param_.gpu_id()));
  absl::Time start = absl::Now();
  .....
  if (SimCacheActive() &amp;&amp; !use_gpu_) {
    ....
    auto sim_cache = GlobalSimCache::GetSimCache();
    if (!sim_cache-&gt;GetResult(cache_key, &amp;outputs)) {
      ....
    }
    int64_t into_check_latency_2 = absl::ToInt64Milliseconds(absl::Now() - start);
    LOG(INFO) &lt;&lt; &#34;2 classify image pixels into check takes &#34; &lt;&lt; into_check_latency_2 &lt;&lt; &#34;ms&#34; &lt;&lt; &#34;cache key is &#34; &lt;&lt; cache_key;
    tmp_cache_key = cache_key;
  } else {
    QCHECK(pano_net_-&gt;GetOutputs(images, batch_size, &amp;outputs));
  }
  int64_t into_check_latency_3 = absl::ToInt64Milliseconds(absl::Now() - start);
  LOG(INFO) &lt;&lt; &#34;3 classify image pixels into check takes &#34; &lt;&lt; into_check_latency_3 &lt;&lt; &#34;ms&#34; &lt;&lt;&#34; tmp cache key is &#34; &lt;&lt; tmp_cache_key;
....
}
</code></pre><p>发现在日志“2 classify image pixels xxx" 和 &ldquo;3 classify image pixels xxx"之间竟然有一个长达4-10s的gap，而代码本身之间没东西。查仿真进程发现进程调度oncpu时间和整体运行时间比例相差极大，一开始以为是调度问题，呼叫阿里云介入，阿里云反应是读写bps导致cpu被打断，我表示不能理解，你一个读取完数据的cpu搁这里因为整体读写磁盘负载高被打断？现在cpu的负载也不重，这个解释有点牵强，仿佛逗我笑，但是当时忘了查进程状态，所以就搁置了，运维同学介入说换个跑pod数量少的node机器，降低并发磁盘读写。</p><p>第二天换了机器问题还在，感觉不对劲，重新介入，查了下慢的simulator进程状态，是SLl也就是说等待事件，感觉不对，这不应该了。然后看了下主线程的pstack发现好几次都是在做sim-cache析构，然后往metric push消息。也就是说在阿里云的pod上往aws push metric，然后注释掉push metric的地方，重新触发仿真5分钟通过</p><pre tabindex=0><code>[root@sim-pipe241251spot ~]# ps -aux|grep 188359
root      188359  3.0  3.9 8693260 5077808 ?     SLl  12:10   0:19 offboard/simulation/simulator_main --variation=0 --qevents_dir=/tmp/9f07-e87d-f912-f353 --qevents_whitelist=* --logtostderr --enable_run_analysis=false --run_analysis_config_file= --run_analysis_server_address= --use_run_map=1 --sim_cache_dir=/media/s3/sim_cache --prom_push_gateway_url=a57985cd13e064fa7a332ec0870f38ea-559580627.cn-north-1.elb.amazonaws.com.cn:9091 --prom_aggregation_gateway_url=ae1be9e5057a74bcd909c63b8f134e95-1323279091.cn-north-1.elb.amazonaws.com.cn --sim_cache_monitor_keys=scenario_test_presubmit_cn --vehicle_param_dir=onboard/params/run_params/vehicles --scenario_path=/tmp/b99d-d2a3-11eb-9dda --output_file=/tmp/0a6d-cb37-11ca-0793 --enable_localizer_gpu=false --cpu_image_codec --fen_use_gpu=false --pcn_use_gpu=false --tcn_use_gpu=false --knet_use_gpu=false --panonet_use_gpu=false --mof_net_use_gpu=false --disable_vantage_forwarding_module --undefok=variation,qevents_dir,qevents_whitelist,logtostderr,enable_run_analysis,run_analysis_config_file,run_analysis_server_address,use_run_map,sim_cache_dir,prom_push_gateway_url,prom_aggregation_gateway_url,sim_cache_monitor_keys,vehicle_param_dir,scenario_path,output_file,enable_localizer_gpu,cpu_image_codec,fen_use_gpu,pcn_use_gpu,tcn_use_gpu,knet_use_gpu,panonet_use_gpu,mof_net_use_gpu,disable_vantage_forwarding_module --sim_msg_dir=/tmp/dc5e-c1ab-58aa-441c --replace_with_icc_agent=true
root      225817  0.0  0.0 112828  2344 pts/0    S+   12:21   0:00 grep --color=auto 188359
[root@sim-pipe241251spot ~]# pstack 188359
Thread 1 (process 188359):
#0  0x00007f562243c9cf in ?? ()
#1  0x0000000000000001 in ?? ()
#2  0x00007ffc30f1ccf0 in ?? ()
#3  0x0000000000000002 in ?? ()
#4  0x000003e800000000 in ?? ()
#5  0x0000000000000001 in ?? ()
#6  0x000055f858a6f0a5 in Curl_poll ()
#7  0x000055f858a62647 in Curl_multi_wait ()
#8  0x000055f858a628aa in curl_multi_poll ()
#9  0x000055f858a53f8f in curl_easy_perform ()
#10 0x000055f857b3e866 in curlpp::internal::CurlHandle::perform() ()
#11 0x000055f857b3c580 in qcraft::HttpClient::Post(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, std::__cxx11::list&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::allocator&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt; &gt; const&amp;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;*, int, int) ()
#12 0x000055f857b3b934 in qcraft::prometheus_gateway::PromGateWayClient::PushMetric(qcraft::prometheus_gateway::PromMetric const&amp;) ()
#13 0x000055f857b37fe4 in qcraft::SimCache::~SimCache() ()
#14 0x000055f857b39831 in qcraft::SimFileCache::~SimFileCache() ()
...
#20 0x00007f5623db247f in ?? ()
#21 0x00007f5623db24d0 in ?? ()
</code></pre><p>这次事件的反思是：</p><ul><li>代码里面if语句结束，不是直接就到下一句，if块里面的变量会析构，从而触发一些消耗，说实在的，这个虽然我大学的时候就知道，但是写C习惯了以后再看C++，我有的时候是真的想不起来。。。。一个variable的析构会触发一个curl，这说实在的也实在是神奇的代码。。。</li><li>应该在发现调度不上之后就确定进程的状态，通过ps -aux可以直接查看进程是不是处于SLl状态，即等待事件发生。这个单纯是那天太晚了，太困了，想不起来了。。。。</li><li>确定进程一直等待之后就可以调用pstack 188359查看进程的主线程的栈了，这个也是老方法了，当年查内存泄露用了好多次。。。</li></ul><h3 class="relative group">16 错误的ssh key<div id=16-%E9%94%99%E8%AF%AF%E7%9A%84ssh-key class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#16-%E9%94%99%E8%AF%AF%E7%9A%84ssh-key aria-label=锚点>#</a></span></h3><p>这个问题坦白讲一般不会遇到，我们有台云上机器，需要后处理一些敏感数据，需要拉取git仓库，配置了私钥格式如下，</p><pre tabindex=0><code>-----BEGIN OPENSSH PRIVATE KEY-----
~~~~~~~~~~~~~~~~~~~~~~~
-----END OPENSSH PRIVATE KEY-----
</code></pre><p>但是仍然一直报错</p><pre tabindex=0><code>Load key &#34;xxx/.ssh/id_ed25519&#34;: invalid format
yyyyy: Permission denied (publickey).
fatal: Could not read from remote repository.
Please make sure you have the correct access rights
and the repository exists.
</code></pre><p>最后发现是因为没有在私钥最后加一个newline。。。</p><p>改成多一个newline即可。。。</p><pre tabindex=0><code>-----BEGIN OPENSSH PRIVATE KEY-----
~~~~~~~~~~~~~~~~~~~~~~~
-----END OPENSSH PRIVATE KEY-----
&lt;=== notice here
</code></pre><h3 class="relative group">17 not support negative lookaround<div id=17-not-support-negative-lookaround class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#17-not-support-negative-lookaround aria-label=锚点>#</a></span></h3><p>这俩天写正则，遇到一个问题，我们有些用户创建分支都已origin打头，比方说建立了什么origin/master，origin/dbet什么的，然而gitlab使用re2引擎，因此它不支持negative lookaround。为了避免这个问题只能写原始匹配，因为origin太长了，写起来太费劲，所以写了匹配orig，最后的命令如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-reg data-lang=reg><span class=line><span class=cl><span class=err>^([^o].*$)|(o([^r].*$|$))|(or([^i].*$|$))|(ori([^g].*$|$))</span>
</span></span></code></pre></div><h3 class="relative group">18 git push ref missing head<div id=18-git-push-ref-missing-head class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#18-git-push-ref-missing-head aria-label=锚点>#</a></span></h3><p>这个问题，坦白讲我不知道root cause，也不知道解决原因为什么可以。简单来说我们有个巨大的git仓库放了很多的地图文件，每隔一段时间会遇到这种问题，即push代码会报错</p><pre tabindex=0><code>create mode 100644 zhuhai_1/semantic_map/4276747992/others.pb.bin
 create mode 100644 zhuhai_1/semantic_map/semantic_map_meta.pb.bin
Locking support detected on remote &#34;origin&#34;. Consider enabling it with:
  $ git config lfs.https://china-map.qcraftai.com/qcraft/qcraft-maps-china-v2.git/info/lfs.locksverify true
ref xxxxx:: missing object: 019e6b672af008e6873dcaec850c8c1fa5c63623
error: failed to push some refs to &#39;china-map.qcraftai.com:qcraft/qcraft-maps-china-v2.git&#39;
</code></pre><p>但是这个文件是实际上是lfs文件，而且文件也存在，而报错git missing，是不是意味着这个文件没有track在git的repo里面？而且后面操作</p><pre tabindex=0><code>qcrafter@runner-dghmx1qy-project-4-concurrent-09k7q5:/builds/DgHMx1qY/0/root/qcraft/qcraft-maps-china$ git cat-file -p 019e6b672af008e6873dcaec850c8c1fa5c63623
version https://git-lfs.github.com/spec/v1
oid sha256:5990808a372ce1ff02742a9557bc3312e6cddd7439e036f51acf019ea1ffb985
size 3003

qcrafter@runner-dghmx1qy-project-4-concurrent-09k7q5:/builds/DgHMx1qY/0/root/qcraft/qcraft-maps-china$ sha256sum beijing_yizhuang2nd/semantic_map/4283367543/sections.pb.bin
5990808a372ce1ff02742a9557bc3312e6cddd7439e036f51acf019ea1ffb985  beijing_yizhuang2nd/semantic_map/4283367543/sections.pb.bin
qcrafter@runner-dghmx1qy-project-4-concurrent-09k7q5:/builds/DgHMx1qY/0/root/qcraft/qcraft-maps-china$ git cat-file -p 019e6b672af008e6873dcaec850c8c1fa5c63623
version https://git-lfs.github.com/spec/v1
oid sha256:5990808a372ce1ff02742a9557bc3312e6cddd7439e036f51acf019ea1ffb985
size 3003
</code></pre><p>看到一个了类似的issue，https://stackoverflow.com/questions/52612880/lfs-upload-missing-object-but-the-file-is-there</p><p>还有一个现象很类似的issue，https://github.com/git-lfs/git-lfs/issues/3587</p><h3 class="relative group">19 奇怪的时间<div id=19-%E5%A5%87%E6%80%AA%E7%9A%84%E6%97%B6%E9%97%B4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#19-%E5%A5%87%E6%80%AA%E7%9A%84%E6%97%B6%E9%97%B4 aria-label=锚点>#</a></span></h3><p>写这个希望不会再有下一个倒霉蛋遇到这个事情了。。。。</p><p>这两天写golang的gorm一个简单的crud程序，遇到一个有趣的问题，我们有两个数据库（都是oceanbase，线上和测试环境），里面有个表是datetime类型，gorm的model里面用的类型是time.Time，插入数据的时候直接插入了time.Time{}，就是0000-00-00 00:00:00，在测试环境数据库读取时间没什么问题，在生产环境就稳定出现问题，读取出来的时间是-0001-11-30 00:00:00 +0000，因为是用同一个环境的同一套代码同一个elf程序跑的，所以一直没理解咋回事，今天仔细看了一下程序里面的流程，栈如下，连接测试数据库和生产数据库都一样</p><pre tabindex=0><code>(dlv) bt
 0  0x0000000001583232 in github.com/go-sql-driver/mysql.parseBinaryDateTime
    at /root/go/pkg/mod/github.com/go-sql-driver/mysql@v1.7.0/utils.go:230
 1  0x000000000157cff0 in github.com/go-sql-driver/mysql.(*binaryRows).readRow
    at /root/go/pkg/mod/github.com/go-sql-driver/mysql@v1.7.0/packets.go:1314
 2  0x000000000157ec37 in github.com/go-sql-driver/mysql.(*binaryRows).Next
    at /root/go/pkg/mod/github.com/go-sql-driver/mysql@v1.7.0/rows.go:198
 3  0x0000000001555d0a in database/sql.(*Rows).nextLocked
    at /usr/local/go/src/database/sql/sql.go:2974
 4  0x0000000001555ab4 in database/sql.(*Rows).Next.func1
    at /usr/local/go/src/database/sql/sql.go:2952
 5  0x0000000001559213 in database/sql.withLock
    at /usr/local/go/src/database/sql/sql.go:3405
 6  0x0000000001555a2b in database/sql.(*Rows).Next
    at /usr/local/go/src/database/sql/sql.go:2951
 7  0x00000000015fc622 in gorm.io/gorm.Scan
    at /root/go/pkg/mod/gorm.io/gorm@v1.25.2-0.20230530020048-26663ab9bf55/scan.go:327
 8  0x0000000001643377 in gorm.io/gorm/callbacks.Query
    at /root/go/pkg/mod/gorm.io/gorm@v1.25.2-0.20230530020048-26663ab9bf55/callbacks/query.go:28
 9  0x00000000015df4fe in gorm.io/gorm.(*processor).Execute
    at /root/go/pkg/mod/gorm.io/gorm@v1.25.2-0.20230530020048-26663ab9bf55/callbacks.go:130
10  0x00000000015e9708 in gorm.io/gorm.(*DB).First
    at /root/go/pkg/mod/gorm.io/gorm@v1.25.2-0.20230530020048-26663ab9bf55/finisher_api.go:129
11  0x000000000166505c in xxxxxxxx
    at xxxxxx
12  0x000000000167d2d4 in xxxxxxxxxx
    at xxxxx
13  0x000000000167ff56 in xxxxxxx
    at xxxxxx
14  0x0000000001681ff0 in main.main
    at ./cmd/datasource/main.go:105
15  0x00000000004affd3 in runtime.main
    at /usr/local/go/src/runtime/proc.go:250
16  0x00000000004e23a1 in runtime.goexit
    at /usr/local/go/src/runtime/asm_amd64.s:1598
</code></pre><p>然后打印了一下解析的内容，测试的环境回复的数据，日期部分（长度+内容）为[0&mldr;]，也就是说长度为0，生产环境回复的数据里面日期的部分为[&mldr;,11,0,0,0,0,0,0,0,0,0,0,0,&mldr;+7 more]，也就是说长度是11，然后内容都是0。接下来调用parsetime的逻辑就是下面的东西，测试环境长度是0，所以直接返回了默认时间。生产环境长度是11，默认的空时间戳，走11的逻辑，写了个小程序（下面），跑了一下，出来了-0001-11-30 00:00:00 +0000。</p><p>两个版本prod环境的oceanbase版本是3.2.3.1， test环境的oceanbase版本是 3.2.3.3</p><p>我去看了一下mysql里面的bianry encode的标准：https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_binary_resultset.html，和golang mysql的driver的代码也是匹配的，包括长度就是0，4，7，11。但是按照标准，全0的时间应该是只返回一个表示0长度的byte。所以我理解这应该是oceanbase 3.2.3.1的bug</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>parseBinaryDateTime</span><span class=p>(</span><span class=nx>num</span> <span class=kt>uint64</span><span class=p>,</span> <span class=nx>data</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>loc</span> <span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Location</span><span class=p>)</span> <span class=p>(</span><span class=nx>driver</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>num</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Date</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=nb>int</span><span class=p>(</span><span class=nx>binary</span><span class=p>.</span><span class=nx>LittleEndian</span><span class=p>.</span><span class=nf>Uint16</span><span class=p>(</span><span class=nx>data</span><span class=p>[:</span><span class=mi>2</span><span class=p>])),</span> <span class=c1>// year
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>time</span><span class=p>.</span><span class=nf>Month</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>2</span><span class=p>]),</span>                       <span class=c1>// month
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>3</span><span class=p>]),</span>                              <span class=c1>// day
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>loc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>7</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Date</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=nb>int</span><span class=p>(</span><span class=nx>binary</span><span class=p>.</span><span class=nx>LittleEndian</span><span class=p>.</span><span class=nf>Uint16</span><span class=p>(</span><span class=nx>data</span><span class=p>[:</span><span class=mi>2</span><span class=p>])),</span> <span class=c1>// year
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>time</span><span class=p>.</span><span class=nf>Month</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>2</span><span class=p>]),</span>                       <span class=c1>// month
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>3</span><span class=p>]),</span>                              <span class=c1>// day
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>4</span><span class=p>]),</span>                              <span class=c1>// hour
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>5</span><span class=p>]),</span>                              <span class=c1>// minutes
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>6</span><span class=p>]),</span>                              <span class=c1>// seconds
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>loc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>11</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Date</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=nb>int</span><span class=p>(</span><span class=nx>binary</span><span class=p>.</span><span class=nx>LittleEndian</span><span class=p>.</span><span class=nf>Uint16</span><span class=p>(</span><span class=nx>data</span><span class=p>[:</span><span class=mi>2</span><span class=p>])),</span> <span class=c1>// year
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>time</span><span class=p>.</span><span class=nf>Month</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>2</span><span class=p>]),</span>                       <span class=c1>// month
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>3</span><span class=p>]),</span>                              <span class=c1>// day
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>4</span><span class=p>]),</span>                              <span class=c1>// hour
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>5</span><span class=p>]),</span>                              <span class=c1>// minutes
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>6</span><span class=p>]),</span>                              <span class=c1>// seconds
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>int</span><span class=p>(</span><span class=nx>binary</span><span class=p>.</span><span class=nx>LittleEndian</span><span class=p>.</span><span class=nf>Uint32</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>7</span><span class=p>:</span><span class=mi>11</span><span class=p>]))</span><span class=o>*</span><span class=mi>1000</span><span class=p>,</span> <span class=c1>// nanoseconds
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>loc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid DATETIME packet length %d&#34;</span><span class=p>,</span> <span class=nx>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/binary&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>data</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>shot</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Date</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nb>int</span><span class=p>(</span><span class=nx>binary</span><span class=p>.</span><span class=nx>LittleEndian</span><span class=p>.</span><span class=nf>Uint16</span><span class=p>(</span><span class=nx>data</span><span class=p>[:</span><span class=mi>2</span><span class=p>])),</span> <span class=c1>// year
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>time</span><span class=p>.</span><span class=nf>Month</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>2</span><span class=p>]),</span>                       <span class=c1>// month
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>3</span><span class=p>]),</span>                              <span class=c1>// day
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>4</span><span class=p>]),</span>                              <span class=c1>// hour
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>5</span><span class=p>]),</span>                              <span class=c1>// minutes
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nb>int</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>6</span><span class=p>]),</span>                              <span class=c1>// seconds
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>time</span><span class=p>.</span><span class=nx>UTC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>invalidShot</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Date</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span> <span class=c1>// year
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=mi>0</span><span class=p>,</span> <span class=c1>// month
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=mi>0</span><span class=p>,</span> <span class=c1>// day
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=mi>0</span><span class=p>,</span> <span class=c1>// hour
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=mi>0</span><span class=p>,</span> <span class=c1>// minutes
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=mi>0</span><span class=p>,</span> <span class=c1>// seconds
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>time</span><span class=p>.</span><span class=nx>Local</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;time is %v\n&#34;</span><span class=p>,</span> <span class=nx>shot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;checked time is %v\n&#34;</span><span class=p>,</span> <span class=nx>invalidShot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;year is %v\n&#34;</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=nx>binary</span><span class=p>.</span><span class=nx>LittleEndian</span><span class=p>.</span><span class=nf>Uint16</span><span class=p>(</span><span class=nx>data</span><span class=p>[:</span><span class=mi>2</span><span class=p>])))</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;month is %v\n&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;day is %v\n&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;hour is %v\n&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>[</span><span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;minutes is %v\n&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>[</span><span class=mi>5</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;seconds is %v\n&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>[</span><span class=mi>6</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">20 奇怪的卡顿<div id=20-%E5%A5%87%E6%80%AA%E7%9A%84%E5%8D%A1%E9%A1%BF class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#20-%E5%A5%87%E6%80%AA%E7%9A%84%E5%8D%A1%E9%A1%BF aria-label=锚点>#</a></span></h3><p>这几天做一个grpc的性能测试，忽然遇到一个奇怪的问题，有个同步模式的grpc服务器，然后不断地启动新的grpc client连接它，且不断开旧的grpc，然后发现请求一段时间以后新的grpc就会卡住，不被响应/调度。我一开始以为是代码问题，后来忽然想起来，grpc本身服务器支持的连接数量是有限的，毕竟是文件描述符嘛，一般会报错：error reading server preface: EOF，这个时候可以看下文件描述符是不是打满了,</p><p>为了验证这一点，可以加上在服务端和client端执行的命令前面加上环境变量，如下所示</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl> <span class=nv>GRPC_GO_LOG_VERBOSITY_LEVEL</span><span class=o>=</span><span class=m>99</span> <span class=nv>GRPC_GO_LOG_SEVERITY_LEVEL</span><span class=o>=</span>info /usr/sbin/xxx --config /etc/xxxx/config.yml
</span></span></code></pre></div><p>client端执行后会看到下面的报错信息</p><pre tabindex=0><code>2023/12/20 17:20:11 INFO: [core] [Channel #149968 SubChannel #149969] Subchannel Connectivity change to IDLE, last error: connection error: desc = &#34;error reading server preface: EOF&#34;
2023/12/20 17:20:11 INFO: [core] pickfirstBalancer: UpdateSubConnState: 0xc1d0b88858, {IDLE connection error: desc = &#34;error reading server preface: EOF&#34;}
2023/12/20 17:20:11 INFO: [core] [Channel #149968] Channel Connectivity change to IDLE
2023/12/20 17:20:11 INFO: [core] [Channel #149968 SubChannel #149969] Subchannel Connectivity change to CONNECTING
2023/12/20 17:20:11 INFO: [core] [Channel #149968 SubChannel #149969] Subchannel picks a new address &#34;172.21.208.11:5444&#34; to connect
2023/12/20 17:20:11 INFO: [core] pickfirstBalancer: UpdateSubConnState: 0xc1d0b88858, {CONNECTING &lt;nil&gt;}
2023/12/20 17:20:11 INFO: [core] [Channel #149968] Channel Connectivity change to CONNECTING
2023/12/20 17:20:11 INFO: [transport] transport: closing: connection error: desc = &#34;error reading server preface: EOF&#34;
2023/12/20 17:20:11 INFO: [core] Creating new client transport to &#34;{\n  \&#34;Addr\&#34;: \&#34;172.21.208.11:5444\&#34;,\n  \&#34;ServerName\&#34;: \&#34;172.21.208.11:5444\&#34;,\n  \&#34;Attributes\&#34;: null,\n  \&#34;BalancerAttributes\&#34;: null,\n  \&#34;Type\&#34;: 0,\n  \&#34;Metadata\&#34;: null\n}&#34;: connection error: desc = &#34;error reading server preface: EOF&#34;
2023/12/20 17:20:11 WARNING: [core] [Channel #149968 SubChannel #149969] grpc: addrConn.createTransport failed to connect to {
  &#34;Addr&#34;: &#34;172.21.208.11:5444&#34;,
  &#34;ServerName&#34;: &#34;172.21.208.11:5444&#34;,
  &#34;Attributes&#34;: null,
  &#34;BalancerAttributes&#34;: null,
  &#34;Type&#34;: 0,
  &#34;Metadata&#34;: null
}. Err: connection error: desc = &#34;error reading server preface: EOF&#34;
2023/12/20 17:20:11 INFO: [core] [Channel #149968 SubChannel #149969] Subchannel Connectivity change to TRANSIENT_FAILURE, last error: connection error: desc = &#34;error reading server preface: EOF&#34;
2023/12/20 17:20:11 INFO: [transport] transport: loopyWriter exiting with error: transport closed by client
2023/12/20 17:20:11 INFO: [core] pickfirstBalancer: UpdateSubConnState: 0xc1d0b88858, {TRANSIENT_FAILURE connection error: desc = &#34;error reading server preface: EOF&#34;}
2023/12/20 17:20:11 INFO: [core] [Channel #149968] Channel Connectivity change to TRANSIENT_FAILURE
</code></pre><p>下面的代码是怎么对golang产生trace的代码，顺便做个附加了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl><span class=o>+</span>       <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl><span class=o>+</span>       <span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl><span class=o>+</span>       <span class=s>&#34;runtime/trace&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>+</span>				<span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=s>&#34;/tmp/trace.out&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>+</span>    		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>+</span>        		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>+</span>    		<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>+</span>    		<span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>+</span>
</span></span><span class=line><span class=cl><span class=o>+</span>    		<span class=c1>// 启动trace
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>+</span>    		<span class=nx>err</span> <span class=p>=</span> <span class=nx>trace</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>+</span>    		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>+</span>        		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>+</span>    		<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>+</span>    		<span class=k>defer</span> <span class=nx>trace</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>*</span><span class=nx>versionFlag</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;pomerium:&#34;</span><span class=p>,</span> <span class=nx>version</span><span class=p>.</span><span class=nf>FullVersion</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;envoy:&#34;</span><span class=p>,</span> <span class=nx>files</span><span class=p>.</span><span class=nf>FullVersion</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>-</span>       <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=p>!</span><span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Canceled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>-</span>               <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>-</span>       <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>-</span>       <span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;cmd/command: exiting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>+</span>       <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>+</span>               <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>+</span>               <span class=nf>run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>+</span>       <span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=o>+</span>
</span></span><span class=line><span class=cl><span class=o>+</span>    		<span class=nx>signalChan</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>+</span>    		<span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>signalChan</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Interrupt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>+</span>    		<span class=o>&lt;-</span><span class=nx>signalChan</span>
</span></span></code></pre></div><h3 class="relative group">21 低性能的Unix Domain Socket<div id=21-%E4%BD%8E%E6%80%A7%E8%83%BD%E7%9A%84unix-domain-socket class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#21-%E4%BD%8E%E6%80%A7%E8%83%BD%E7%9A%84unix-domain-socket aria-label=锚点>#</a></span></h3><p>这个问题出现有两个原因</p><ul><li>原因1（主要原因），k8s云环境配置的limit太小，线程数量很高导致都在互相抢占，上下文切换带来的性能问题很严重。这个最后看了统计里面的CPU throttling监控得到了验证。</li><li>原因2（次要原因），tokio的异步await轮询本身就是牺牲了时延的产物，因此会导致时延增高。请注意，尽管这是次要原因，但是如果使用了Tokio的容器k8s limit配置过低，它的线程触发了k8s的CPU throttling，无论服务端的处理速度有多快，那么它的异步线程调度会导致它那边看到的时延迅速增加！</li></ul><p>简单描述下上下文，同一个pod里面，两个不同k8s容器里面的程序通过UDS socket进行通信。服务端容器的k8s limit配置为1，是C语言，libevent+多线程痛处理UDS通信事件。另一个是客户端 Rust+Tokio发送数据，结果tokio经常提示UDS通信超时，超过了5ms。我自己在研发环境dev的时候平均时延并不高，显示处理UDS很快，也就几百us（我在dev进群没有配置k8s limit的限制，因此尽管CPU使用率最终显示为90%，但实际上程序还是并行的线程）。可能的原因</p><p>猜想1，资源不足，k8s limit为1导致的上下文切换代价比较高。这个验证也很简单，如果不做限制改成大一些的值，那么应该时延会迅速下降，超时的比例会很低。</p><p>猜想2，Rust客户端发送了，到了服务端进了backlog，最终超时了。在backlog里面待了一会，然后等待IO时间处理又等了一会，最终导致响应的很慢，也就是说超过了500us。这个并不可能，因为只要进入了backlog，不断溢出必然出错，但是并没有出错的日志。</p><p>猜想3，Rust客户端多次await，这个导致多次异步轮询耽误了时间。这个验证直接看下异步下的时间延迟即可，</p><p>关于猜想1的验证执行了两个操作</p><ul><li><p>查看k8s告警的CPU throttling监控，判断是否出现限流。从图片可以看出来确实有明显的限流。处于保密的原则，就不截图了。这个东西用户可以进入pod的container里面，通过<code>cat /sys/fs/cgroup/cpu,cpuacct/cpu.stat</code>来确定有没有触发限流。处于保密的缘故，我不能截图，但是我在我自己的dev环境做了复现，内容如下，可以看到有一半的周期都触发了CPU限流。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 配置k8s cpu limit 1时</span>
</span></span><span class=line><span class=cl>root@hxn-debug-zslgf:/suricata# cat /sys/fs/cgroup/cpu,cpuacct/cpu.stat
</span></span><span class=line><span class=cl>nr_periods <span class=m>6227</span>
</span></span><span class=line><span class=cl>nr_throttled <span class=m>3038</span>
</span></span><span class=line><span class=cl>throttled_time <span class=m>3271452651481</span>
</span></span><span class=line><span class=cl>nr_bursts <span class=m>0</span>
</span></span><span class=line><span class=cl>burst_time <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置k8s cpu limit 放到和线程数量相等甚至更大时</span>
</span></span><span class=line><span class=cl>root@hxn-debug-zslgf:/suricata# cat /sys/fs/cgroup/cpu,cpuacct/cpu.stat
</span></span><span class=line><span class=cl>nr_periods <span class=m>721708</span>
</span></span><span class=line><span class=cl>nr_throttled <span class=m>0</span>
</span></span><span class=line><span class=cl>throttled_time <span class=m>0</span>
</span></span></code></pre></div></li><li><p>修正limit为8，在压力测试下，看超时日志有没有减少。尽管后台的CPU throttling依然触发了限流，但是超时日志出现了明显的减少，从1w每分钟减少到了200每分钟（超时维持5ms，如果超时是1ms，那么超时会从1w每分钟降低到2k每分钟）</p></li></ul><p>关于猜想2直接放弃了验证，因为理论可能性太低。</p><p>关于猜想3，我在客户端和服务端分别记录了接受和发送的时刻，结果如下。证明了纯异步确实对时延有一定的影响，在我当时测试的情况下，影响确实不如第一个方面更大。</p><pre tabindex=0><code>
Rust程序
=================================
准备建立连接
时刻为 3982289 秒和 50986778 纳秒
尝试异步建连后，处理其它事情
=================================
																				C程序
																				=================================
																				处理建立连接
																				时刻为 3982289 s, 51285037 ns
																				连接握手接受，分配资源
																				时刻为 3982289 s, 51328058 ns
																				=================================																	

Rust程序
=================================
发现连接建立完成，准备发送数据
时刻为 3982289 秒和 52508772 纳秒
尝试异步发送，先处理其它事情
=================================

Rust程序
=================================
发现连接建立完成，准备发送数据
时刻为 3982289 秒和 52508772 纳秒
尝试异步发送，先处理其它事情
=================================


Rust程序
=================================
发现发送数据完成，再次flush数据
时刻为 在3982289 秒和 52774571 纳秒
异步fluash完成，先处理其它事情
=================================

																				C程序
																				====================================
																				处理IO数据，接受数据
																				时刻为 3982289 s, 52787736 ns
																				处理结束，发送处理的结果
																				时刻为 3982289 s, 52940983 ns
																				====================================


Rust程序
=================================
发现发送数据结束
时刻为 在3982289 秒和 52956091 纳秒
准备接受数据
=================================


...
</code></pre><h3 class="relative group">22 优雅地退出Libevent<div id=22-%E4%BC%98%E9%9B%85%E5%9C%B0%E9%80%80%E5%87%BAlibevent class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#22-%E4%BC%98%E9%9B%85%E5%9C%B0%E9%80%80%E5%87%BAlibevent aria-label=锚点>#</a></span></h3><p>最近在写一个Libevent服务器，主线程启动多个IO子线程，每个IO子线程都有自己的Loop（Event Base），主线程监听Socket连接，建立连接会注册事件到子线程。现在遇到一个问题是说，希望在不会导致任何IO事件被丢弃的前提下，IO子线程可以被替换。初步解决的方案是：</p><ul><li>每个子线程内部置一个状态位，用于标识当前子线程是不是应该终止了。建立一个更新子线程，专门用于创建新的IO子线程并替换。</li><li>IO子线程会调用 <code>event_base_loopexit(base, &amp;one_minute);</code>，然后调用<code>event_base_dispatch(base);</code>，如果没有注册IO事件就返回检查线程状态，如果状态为“准备终止”，就释放内存</li><li>更新子线程监听SIGHUP信号，每当收到SIGHUP信号，创建新的多子线程。锁住主线程的保护锁，替换主线程记录的子线程。</li><li>替换完成之后，更新子线程会把旧的IO子线程的状态置为“准备终止”，解析并等待旧的IO子线程的状态都被置为“终止完成”，到了终止完成之后。释放旧的IO线程的内存</li></ul><p>但这个方案会导致莫名其妙地丢数据，然后反应过来有个这个情况。</p><pre tabindex=0><code>极端情况
                                                  -------------------------------
                                                  IO线程正好没事情做，工作状态还在Working
                                                  从event_base_dispatched返回
                                                  -------------------------------
------------
主线程分配任务到
-------------
                 -----------------------------
                 更新线程执行替换操作
                 置IO线程状态为NeedTerminate
                 -----------------------------
                                                  -----------------------------------
                                                  IO线程开始加载状态，发现是NeedTerminate
                                                  释放内存，但实际上此时是有未处理的事件的
                                                  -----------------------------------
                                                  
</code></pre><p>所以最终的修复方式很简单，IOWorker的工作函数改成</p><pre tabindex=0><code>while (1) {

    struct timeval one_minute = {kDefaultSleepDuration, 0};
    int state = atomic_load(&amp;context-&gt;state_);
    if (state == kStateNeedTerminate) {
      // DCLP
      event_base_loopexit(base, &amp;one_minute);
      event_base_dispatch(base);
      cleanupSuricataContext(context);

      break;
    }
    event_base_loopexit(base, &amp;one_minute);
    event_base_dispatch(base);
  }
</code></pre><h3 class="relative group">23 Suricata初始化<div id=23-suricata%E5%88%9D%E5%A7%8B%E5%8C%96 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#23-suricata%E5%88%9D%E5%A7%8B%E5%8C%96 aria-label=锚点>#</a></span></h3><p>这两天该代码，会概率性出现报错</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Error: misc: pcre2_substring_copy_bynumber failed <span class=o>[</span>ParseSizeString:util-misc.c:101<span class=o>]</span>
</span></span><span class=line><span class=cl>Error: stream-tcp: Error parsing stream.memcap from conf file - 64mb.  Killing engine <span class=o>[</span>StreamTcpInitConfig:stream-tcp.c:400<span class=o>]</span>
</span></span></code></pre></div><h3 class="relative group">24 Protobuf糟糕的PROTOBUF_NAMESPACE_OPEN<div id=24-protobuf%E7%B3%9F%E7%B3%95%E7%9A%84protobuf_namespace_open class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#24-protobuf%E7%B3%9F%E7%B3%95%E7%9A%84protobuf_namespace_open aria-label=锚点>#</a></span></h3><p>这两天在帮同事写一点东西，遇到一些莫名其妙的东西，一直报错PROTOBUF_NAMESPACE_OPEN这个宏未定义，即使已经引入了Protobuf的src源代码里面的相关定义，最后是直接定义了下面的宏。</p><p>不过这里需要注意，最后的五个#define可能会和默认定义重合，出现报错，所以看情况注释掉</p><pre tabindex=0><code>#define PROTOBUF_NAMESPACE_OPEN \
  namespace google {            \
    namespace protobuf          \
    {
#define PROTOBUF_NAMESPACE_CLOSE \
  }                              \
  }
#define PROTOBUF_NAMESPACE_ID google::protobuf
#define PROTOBUF_CONSTEXPR
#define PROTOBUF_ATTRIBUTE_REINITIALIZES
#define PROTOBUF_NODISCARD [[nodiscard]]
#define PROTOBUF_ALWAYS_INLINE
</code></pre><h3 class="relative group">25 Nginx的性能为啥加了我们代码就变差了<div id=25-nginx%E7%9A%84%E6%80%A7%E8%83%BD%E4%B8%BA%E5%95%A5%E5%8A%A0%E4%BA%86%E6%88%91%E4%BB%AC%E4%BB%A3%E7%A0%81%E5%B0%B1%E5%8F%98%E5%B7%AE%E4%BA%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#25-nginx%E7%9A%84%E6%80%A7%E8%83%BD%E4%B8%BA%E5%95%A5%E5%8A%A0%E4%BA%86%E6%88%91%E4%BB%AC%E4%BB%A3%E7%A0%81%E5%B0%B1%E5%8F%98%E5%B7%AE%E4%BA%86 aria-label=锚点>#</a></span></h3><p>这两天在分析我们的代码为什么性能差，可以看性能分析那里提到MPMC的部分，但是有个很有趣的问题</p><p>Nginx不是性能非常好吗？加上我们的代码为啥会性能差呢？先看看Nginx本身的逻辑</p><p>linux部分用的epoll，初始化部分</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>ngx_event_module_t</span>  <span class=n>ngx_epoll_module_ctx</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;</span><span class=n>epoll_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>ngx_epoll_create_conf</span><span class=p>,</span>               <span class=cm>/* create configuration */</span>
</span></span><span class=line><span class=cl>    <span class=n>ngx_epoll_init_conf</span><span class=p>,</span>                 <span class=cm>/* init configuration */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ngx_epoll_add_event</span><span class=p>,</span>             <span class=cm>/* add an event */</span>
</span></span><span class=line><span class=cl>        <span class=n>ngx_epoll_del_event</span><span class=p>,</span>             <span class=cm>/* delete an event */</span>
</span></span><span class=line><span class=cl>        <span class=n>ngx_epoll_add_event</span><span class=p>,</span>             <span class=cm>/* enable an event */</span>
</span></span><span class=line><span class=cl>        <span class=n>ngx_epoll_del_event</span><span class=p>,</span>             <span class=cm>/* disable an event */</span>
</span></span><span class=line><span class=cl>        <span class=n>ngx_epoll_add_connection</span><span class=p>,</span>        <span class=cm>/* add an connection */</span>
</span></span><span class=line><span class=cl>        <span class=n>ngx_epoll_del_connection</span><span class=p>,</span>        <span class=cm>/* delete an connection */</span>
</span></span><span class=line><span class=cl><span class=cp>#if (NGX_HAVE_EVENTFD)
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=n>ngx_epoll_notify</span><span class=p>,</span>                <span class=cm>/* trigger a notify */</span>
</span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=nb>NULL</span><span class=p>,</span>                            <span class=cm>/* trigger a notify */</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=n>ngx_epoll_process_events</span><span class=p>,</span>        <span class=cm>/* process the events */</span>
</span></span><span class=line><span class=cl>        <span class=n>ngx_epoll_init</span><span class=p>,</span>                  <span class=cm>/* init the events */</span>
</span></span><span class=line><span class=cl>        <span class=n>ngx_epoll_done</span><span class=p>,</span>                  <span class=cm>/* done the events */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>处理部分</p><pre tabindex=0><code>ngx_epoll_process_events {

}
</code></pre><h2 class="relative group">结尾<div id=%E7%BB%93%E5%B0%BE class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%BB%93%E5%B0%BE aria-label=锚点>#</a></span></h2><p>唉，尴尬</p><p><figure><img class="my-0 rounded-md" loading=lazy src=https://i.loli.net/2020/08/27/BFHNyfpx3EsIDUG.jpg alt=狗头的赞赏码.jpg></figure></p></div></div><script>var oid="views_posts\\2021-01-07-记录一些遇见的有趣BUG\\index.md",oid_likes="likes_posts\\2021-01-07-记录一些遇见的有趣BUG\\index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/2021-01-03-%E4%BB%8E%E9%94%81%E5%92%8Crte-ring%E4%B8%8Ekfifo%E8%AF%B4%E8%B5%B7/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">从锁和RTE ring与KFIFO说起</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-01-03T00:00:00+00:00>2021 年 1 月 3 日</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/2021-01-17-ustack%E7%B3%BB%E7%BB%9F%E7%9A%84atcpzone%E8%AE%BE%E8%AE%A1/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">USTACK系统的ATCPZONE设计</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-01-07T00:00:00+00:00>2021 年 1 月 7 日</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">© 2025 - 2025 菜狗 All Rights Reserved.</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a> 强力驱动</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://hxndg.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>