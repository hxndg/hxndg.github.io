<!doctype html><html lang=cn dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>OPENSSL源码阅读 &#183; 菜狗的blog</title>
<meta name=title content="OPENSSL源码阅读 &#183; 菜狗的blog"><meta name=description content="菜狗's website"><meta name=keywords content="TLS,TLS1.3,OPENSSL,"><link rel=canonical href=https://hxndg.github.io/posts/2020-10-15-openssl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB9/><link type=text/css rel=stylesheet href=/css/main.bundle.min.ba3775bebd52a2b4837f8da64e32ee36e5c52bf284a0ce2262562782398b701543947527ad1498487717b1b96fe2a4e48d365a02e0b5d00e224893052e99d83c.css integrity="sha512-ujd1vr1SorSDf42mTjLuNuXFK/KEoM4iYlYngjmLcBVDlHUnrRSYSHcXsblv4qTkjTZaAuC10A4iSJMFLpnYPA=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.764eb2fe8d6a6b086c7c58f87d12c64fa79a7585117fc27eb53f688f80c287a6eff16277f9d186cd223a39ff700e294d64482834faece5e07ee0498fa042d056.js integrity="sha512-dk6y/o1qawhsfFj4fRLGT6eadYURf8J+tT9oj4DCh6bv8WJ3+dGGzSI6Of9wDilNZEgoNPrs5eB+4EmPoELQVg==" data-copy data-copied></script><script src=/lib/zoom/zoom.min.3530c2657381259433194af312ec3d322a97a2ad85661810299757fe793b24c3b8e07ab97fa8e5cf96cff1208f271e75394b6eaa56c2e39e7e2c3ca49fb1921c.js integrity="sha512-NTDCZXOBJZQzGUrzEuw9MiqXoq2FZhgQKZdX/nk7JMO44Hq5f6jlz5bP8SCPJx51OUtuqlbC455+LDykn7GSHA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://hxndg.github.io/posts/2020-10-15-openssl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB9/"><meta property="og:site_name" content="菜狗的blog"><meta property="og:title" content="OPENSSL源码阅读"><meta property="og:description" content="菜狗's website"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-15T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-15T00:00:00+00:00"><meta property="article:tag" content="TLS"><meta property="article:tag" content="TLS1.3"><meta property="article:tag" content="OPENSSL"><meta name=twitter:card content="summary"><meta name=twitter:title content="OPENSSL源码阅读"><meta name=twitter:description content="菜狗's website"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"OPENSSL源码阅读","headline":"OPENSSL源码阅读","inLanguage":"zh-cn","url":"https:\/\/hxndg.github.io\/posts\/2020-10-15-openssl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB9\/","author":{"@type":"Person","name":"菜狗"},"copyrightYear":"2020","dateCreated":"2020-10-15T00:00:00\u002b00:00","datePublished":"2020-10-15T00:00:00\u002b00:00","dateModified":"2020-10-15T00:00:00\u002b00:00","keywords":["TLS","TLS1.3","OPENSSL"],"mainEntityOfPage":"true","wordCount":"4476"}]</script><meta name=author content="菜狗"><script src=/lib/jquery/jquery.slim.min.03cb160e3cfdb2667a2e2c80d283bebcf63ff8bbc4b629c9ab2babf6fae1d0c07ad470edae783efa4fabda2ac01c58d60e63b98b3c336be8208460f08f4354f5.js integrity="sha512-A8sWDjz9smZ6LiyA0oO+vPY/+LvEtinJqyur9vrh0MB61HDtrng++k+r2irAHFjWDmO5izwza+gghGDwj0NU9Q=="></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>跳过正文</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">菜狗的blog</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Home</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Posts</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Tags</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Home</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Posts</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Tags</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">OPENSSL源码阅读</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2020-10-15T00:00:00+00:00>2020 年 10 月 15 日</time><span class="px-2 text-primary-500">&#183;</span><span>4476 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>9 分钟</span></div></div><div class="flex author"><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">菜狗</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Focus</div><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#前置知识>前置知识</a></li><li><a href=#heading></a></li><li><a href=#说说openssl的异步>说说OPENSSL的异步</a></li><li><a href=#从锁说起>从锁说起</a></li><li><a href=#结束>结束</a></li><li><a href=#结尾的闲言碎语>结尾的闲言碎语</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#前置知识>前置知识</a></li><li><a href=#heading></a></li><li><a href=#说说openssl的异步>说说OPENSSL的异步</a></li><li><a href=#从锁说起>从锁说起</a></li><li><a href=#结束>结束</a></li><li><a href=#结尾的闲言碎语>结尾的闲言碎语</a></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h1 class="relative group">OPENSSL源码阅读<div id=openssl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#openssl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB aria-label=锚点>#</a></span></h1><h2 class="relative group">前言<div id=%E5%89%8D%E8%A8%80 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%89%8D%E8%A8%80 aria-label=锚点>#</a></span></h2><p>原先写的几个都只是写了自动机，今天来看看多线程和异步。我们今天重点就是看看OPENSSL怎么做，这么做的好处与问题，锁的粒度等问题。实际上服务端s_server并不支持多线程，libcrypto支持多线程，所以对于S_SERVER我们重点看异步的做法，看libcrypto的多线程到底做了些什么。</p><h2 class="relative group">前置知识<div id=%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86 aria-label=锚点>#</a></span></h2><p>OPENSSL的ASYNC JOB就是使用协程+per thread局部变量的概念实现的，我们需要理解协程的基本概念，协程是个什么东西？</p><h2 class="relative group"><div id=heading class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#heading aria-label=锚点>#</a></span></h2><ul><li>多线程是怎么竞争的，竞争哪些内容？</li><li>异步是怎么做的？我们以S_SERVER为例，启动的选项为-nbio_test和-nbio。nbio的socket type为SOCK_STREAM</li><li>任务队列是怎么做的？(因为异步就是一个事情发现没法直接做完，那就先去做别的事情。这就是任务队列)</li></ul><p>OPENSSL大量使用per-thread内部局部变量，即调用函数<code>phread_key_create</code>创建<code>pthread_key_t</code>类型数值，每个线程再调用<code>pthread_setspcific()</code>和<code>pthread_getspecific()</code>去初始化线程内局部变量。OPENSSL调用<code>ossl_init_get_thread_local</code>函数去获取per线程局部变量，根据参数决定是不是分配。</p><p><code>ossl_init_thread_start</code>函数调用<code>ossl_init_get_thread_local</code>初始化per thread的数据，初始化成功返回1，</p><h2 class="relative group">说说OPENSSL的异步<div id=%E8%AF%B4%E8%AF%B4openssl%E7%9A%84%E5%BC%82%E6%AD%A5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%AF%B4%E8%AF%B4openssl%E7%9A%84%E5%BC%82%E6%AD%A5 aria-label=锚点>#</a></span></h2><p>OPENSSL的异步需要调用函数<code>ASYNC_start_job</code>，去注册一个函数做异步操作。这里的异步操作需要返回“per 线程局部变量”<code>ctxkey</code>，每个线程运行时都会有自己的任务(工作)，分配器和判阻塞。每个线程调用<code>async_fibre_swapcontext</code>去切换当前的任务到设置好的函数，使得函数继续。<code>ASYNC_start_job</code>的分析我们等会再说。</p><pre tabindex=0><code>	struct async_ctx_st {
    async_fibre dispatcher;
    ASYNC_JOB *currjob;
    unsigned int blocked;
};

struct async_job_st {
    async_fibre fibrectx;
    int (*func) (void *);
    void *funcargs;
    int ret;
    int status;
    ASYNC_WAIT_CTX *waitctx;
};

	async_ctx *async_get_ctx(void)
{
    return (async_ctx *)CRYPTO_THREAD_get_local(&amp;ctxkey);
}
</code></pre><p>函数<code>ASYNC_init_thread</code>分配POOL，并初始化线程的局部变量。</p><p>函数<code>ossl_init_thread_start</code>初始化并分配当前线程的per thread的本地状态<code>thread_local_inits_st</code>数据结构地址和空间。</p><p>函数<code>ASYNC_start_job</code>首先获取当前线程的<code>async_ctx</code>结构，如果SSL当前有JOB，那就初始化当前ctx的运行JOB为SSL的JOB，然后判断当前JOB的状态，结束<code>ASYNC_JOB_STOPPING</code>，正在暂停<code>ASYNC_JOB_PAUSING</code>还是已暂停<code>ASYNC_JOB_PAUSED</code>，为什么区分这三种状态？如果当前为已暂停，往往意味着刚才是因为等待网络IO/卡的计算，再次进来是因为网络IO/卡的计算结果有数据了，要继续向下运行了。如果当前为正在暂停，意味着是某个流程调用<code>ASYNC_pause_job</code>来暂停当前进行的函数，比方说送卡请求，等着结果了。而结束往往是指JOB已经结束了，没必要再维持了，已经拿到结果了。</p><p>好，继续说，判断完JOB的三种状态，就调用<code>async_fibre_swapcontext</code>去切换协议栈了，我们这里一般是切换到<code>async_start_func</code>函数，去调用我们在<code>ASYNC_start_job</code>传入的函数指针。这里注意啊<code>ctx->currjob->func = func;</code>传入的函数并不直接被调用，而是在函数<code>async_start_func</code>被交换回来。</p><pre tabindex=0><code>	int ASYNC_start_job(ASYNC_JOB **job, ASYNC_WAIT_CTX *wctx, int *ret,
                    int (*func)(void *), void *args, size_t size)
{
    async_ctx *ctx;

    if (!OPENSSL_init_crypto(OPENSSL_INIT_ASYNC, NULL))
        return ASYNC_ERR;

    ctx = async_get_ctx();
    if (ctx == NULL)
        ctx = async_ctx_new();
    if (ctx == NULL)
        return ASYNC_ERR;

    if (*job)
        ctx-&gt;currjob = *job;

    for (;;) {
        if (ctx-&gt;currjob != NULL) {
            if (ctx-&gt;currjob-&gt;status == ASYNC_JOB_STOPPING) {
                *ret = ctx-&gt;currjob-&gt;ret;
                ctx-&gt;currjob-&gt;waitctx = NULL;
                async_release_job(ctx-&gt;currjob);
                ctx-&gt;currjob = NULL;
                *job = NULL;
                return ASYNC_FINISH;
            }

            if (ctx-&gt;currjob-&gt;status == ASYNC_JOB_PAUSING) {
                *job = ctx-&gt;currjob;
                ctx-&gt;currjob-&gt;status = ASYNC_JOB_PAUSED;
                ctx-&gt;currjob = NULL;
                return ASYNC_PAUSE;
            }

            if (ctx-&gt;currjob-&gt;status == ASYNC_JOB_PAUSED) {
                ctx-&gt;currjob = *job;
                /* Resume previous job */
                if (!async_fibre_swapcontext(&amp;ctx-&gt;dispatcher,
                        &amp;ctx-&gt;currjob-&gt;fibrectx, 1)) {
                    ASYNCerr(ASYNC_F_ASYNC_START_JOB,
                             ASYNC_R_FAILED_TO_SWAP_CONTEXT);
                    goto err;
                }
                continue;
            }

            /* Should not happen */
            ASYNCerr(ASYNC_F_ASYNC_START_JOB, ERR_R_INTERNAL_ERROR);
            async_release_job(ctx-&gt;currjob);
            ctx-&gt;currjob = NULL;
            *job = NULL;
            return ASYNC_ERR;
        }

        /* Start a new job */
        if ((ctx-&gt;currjob = async_get_pool_job()) == NULL)
            return ASYNC_NO_JOBS;

        if (args != NULL) {
            ctx-&gt;currjob-&gt;funcargs = OPENSSL_malloc(size);
            if (ctx-&gt;currjob-&gt;funcargs == NULL) {
                ASYNCerr(ASYNC_F_ASYNC_START_JOB, ERR_R_MALLOC_FAILURE);
                async_release_job(ctx-&gt;currjob);
                ctx-&gt;currjob = NULL;
                return ASYNC_ERR;
            }
            memcpy(ctx-&gt;currjob-&gt;funcargs, args, size);
        } else {
            ctx-&gt;currjob-&gt;funcargs = NULL;
        }

        ctx-&gt;currjob-&gt;func = func;
        ctx-&gt;currjob-&gt;waitctx = wctx;
        if (!async_fibre_swapcontext(&amp;ctx-&gt;dispatcher,
                &amp;ctx-&gt;currjob-&gt;fibrectx, 1)) {
            ASYNCerr(ASYNC_F_ASYNC_START_JOB, ASYNC_R_FAILED_TO_SWAP_CONTEXT);
            goto err;
        }
    }

err:
    async_release_job(ctx-&gt;currjob);
    ctx-&gt;currjob = NULL;
    *job = NULL;
    return ASYNC_ERR;
}
</code></pre><p>函数<code>async_ctx_new</code>初始化并分配当前线程的per thread的本地状态，调用<code>ossl_init_thread_start</code>初始化<code>thread_local_inits_st</code>数据结构地址和空间。之后初始化per thread的<code>async_ctx_st</code>结构，每个ctx的结构。</p><p>函数<code>async_get_pool_job</code>从pool里获取一个job，获取本地pool，如果pool为空还要再分配per thread的工作pool。从pool中pop出最后进栈的job，如果没有job，就调用<code>async_job_new</code>分配一个新工作，然后调用<code>async_fibre_makecontext</code>初始化协程的调用栈，这里重点注意<code>async_fibre_makecontext</code>函数，该函数先分配一个堆栈出来，该堆栈长度为32768字节(小吧，省事省资源啊)，然后调用<code>makecontext</code>函数切换调用栈到函数<code>async_start_func</code>中，<code>async_start_func</code>的功能下面再说。</p><pre tabindex=0><code>	static ASYNC_JOB *async_get_pool_job(void) {
    ASYNC_JOB *job;
    async_pool *pool;

    pool = (async_pool *)CRYPTO_THREAD_get_local(&amp;poolkey);
    if (pool == NULL) {
        /*
         * Pool has not been initialised, so init with the defaults, i.e.
         * no max size and no pre-created jobs
         */
        if (ASYNC_init_thread(0, 0) == 0)
            return NULL;
        pool = (async_pool *)CRYPTO_THREAD_get_local(&amp;poolkey);
    }

    job = sk_ASYNC_JOB_pop(pool-&gt;jobs);
    if (job == NULL) {
        /* Pool is empty */
        if ((pool-&gt;max_size != 0) &amp;&amp; (pool-&gt;curr_size &gt;= pool-&gt;max_size))
            return NULL;

        job = async_job_new();
        if (job != NULL) {
            if (! async_fibre_makecontext(&amp;job-&gt;fibrectx)) {
                async_job_free(job);
                return NULL;
            }
            pool-&gt;curr_size++;
        }
    }
    return job;
}

int async_fibre_makecontext(async_fibre *fibre)
{
    fibre-&gt;env_init = 0;
    if (getcontext(&amp;fibre-&gt;fibre) == 0) {
        fibre-&gt;fibre.uc_stack.ss_sp = OPENSSL_malloc(STACKSIZE);
        if (fibre-&gt;fibre.uc_stack.ss_sp != NULL) {
            fibre-&gt;fibre.uc_stack.ss_size = STACKSIZE;
            fibre-&gt;fibre.uc_link = NULL;
            makecontext(&amp;fibre-&gt;fibre, async_start_func, 0);
            return 1;
        }
    } else {
        fibre-&gt;fibre.uc_stack.ss_sp = NULL;
    }
    return 0;
}
</code></pre><p>函数<code>async_start_func</code>该函数负责调用传入的JOB所指向的函数，函数终止以后调用<code>async_fibre_swapcontext</code>来交出控制栈并返回到<code>ctx->dispatcher</code>中</p><pre tabindex=0><code>	void async_start_func(void)
{
    ASYNC_JOB *job;
    async_ctx *ctx = async_get_ctx();

    while (1) {
        /* Run the job */
        job = ctx-&gt;currjob;
        job-&gt;ret = job-&gt;func(job-&gt;funcargs);

        /* Stop the job */
        job-&gt;status = ASYNC_JOB_STOPPING;
        if (!async_fibre_swapcontext(&amp;job-&gt;fibrectx,
                                     &amp;ctx-&gt;dispatcher, 1)) {
            /*
             * Should not happen. Getting here will close the thread...can&#39;t do
             * much about it
             */
            ASYNCerr(ASYNC_F_ASYNC_START_FUNC, ASYNC_R_FAILED_TO_SWAP_CONTEXT);
        }
    }
}
</code></pre><p>函数<code>SSL_get_all_async_fds</code>负责获取当前<code>SSL* s</code>的<code>wait_ctx</code>所关联的所有文件描述符，获取之后我们就可以对其调用epoll或者select函数来监控通信。对于每个<code>S->wait_ctx</code>，需要调用函数<code>ASYNC_WAIT_CTX_set_wait_fd</code>去给<code>S->wait_ctx</code>注册上这个描述符。一般来说只有异步的时候这个函数才会被调用，函数<code>wait_for_async</code>会调用它，而<code>sv_body</code>函数会调用<code>wait_for_async</code>等待网络异步IO事件。这里再赘述两局，OPENSSL的异步事件需要调用底层的ENGINE实现，底层的ENGINE有很多种，比方说AF_ALG，DUMMY，GM等等，这些ENGINE由我们实现并提供。</p><p>函数<code>async_fibre_swapcontext</code>切换线程栈，注意这里面的<code>o->env_init = 1</code>，第一次从o到n的时候调用<code>setcontext</code>函数，此时还没有调用过n，所以用<code>setcontext</code>函数。从n回到o的时候调用<code>_longjmp</code>。下次再从o到n的时候，就还是用_longjmp了。</p><pre tabindex=0><code>	static ossl_inline int async_fibre_swapcontext(async_fibre *o, async_fibre *n, int r)
{
    o-&gt;env_init = 1;

    if (!r || !_setjmp(o-&gt;env)) {
        if (n-&gt;env_init)
            _longjmp(n-&gt;env, 1);
        else
            setcontext(&amp;n-&gt;fibre);
    }

    return 1;
}
</code></pre><p>函数<code>dummy_pause_job</code>这个函数非常有趣，我们这里要注意这个<code>dummy_pause_job</code>只是个假的异步唤醒函数。该函数先对异步ctx<code>S->wait_ctx</code>注册了一个管道pipefd，并把writefd注册到了wait_ctx中，注册完了向管道写入一个字符"x"来表示唤醒，然后调用<code>ASYNC_pause_job</code>函数继续执行从而切换协程。然后自己再从管道当中把那个X读出来，相当于假装通知+假装唤醒。</p><pre tabindex=0><code>	static void dummy_pause_job(void) {
    ASYNC_JOB *job;
    ASYNC_WAIT_CTX *waitctx;
    OSSL_ASYNC_FD pipefds[2] = {0, 0};
    OSSL_ASYNC_FD *writefd;
#if defined(ASYNC_WIN)
    DWORD numwritten, numread;
    char buf = DUMMY_CHAR;
#elif defined(ASYNC_POSIX)
    char buf = DUMMY_CHAR;
#endif

    if ((job = ASYNC_get_current_job()) == NULL)
        return;

    waitctx = ASYNC_get_wait_ctx(job);

    if (ASYNC_WAIT_CTX_get_fd(waitctx, engine_dasync_id, &amp;pipefds[0],
                              (void **)&amp;writefd)) {
        pipefds[1] = *writefd;
    } else {
        writefd = OPENSSL_malloc(sizeof(*writefd));
        if (writefd == NULL)
            return;
#if defined(ASYNC_WIN)
        if (CreatePipe(&amp;pipefds[0], &amp;pipefds[1], NULL, 256) == 0) {
            OPENSSL_free(writefd);
            return;
        }
#elif defined(ASYNC_POSIX)
        if (pipe(pipefds) != 0) {
            OPENSSL_free(writefd);
            return;
        }
#endif
        *writefd = pipefds[1];

        if (!ASYNC_WAIT_CTX_set_wait_fd(waitctx, engine_dasync_id, pipefds[0],
                                        writefd, wait_cleanup)) {
            wait_cleanup(waitctx, engine_dasync_id, pipefds[0], writefd);
            return;
        }
    }
    /*
     * In the Dummy async engine we are cheating. We signal that the job
     * is complete by waking it before the call to ASYNC_pause_job(). A real
     * async engine would only wake when the job was actually complete
     */
#if defined(ASYNC_WIN)
    WriteFile(pipefds[1], &amp;buf, 1, &amp;numwritten, NULL);
#elif defined(ASYNC_POSIX)
    if (write(pipefds[1], &amp;buf, 1) &lt; 0)
        return;
#endif

    /* Ignore errors - we carry on anyway */
    ASYNC_pause_job();

    /* Clear the wake signal */
#if defined(ASYNC_WIN)
    ReadFile(pipefds[0], &amp;buf, 1, &amp;numread, NULL);
#elif defined(ASYNC_POSIX)
    if (read(pipefds[0], &amp;buf, 1) &lt; 0)
        return;
#endif
}
</code></pre><h2 class="relative group">从锁说起<div id=%E4%BB%8E%E9%94%81%E8%AF%B4%E8%B5%B7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BB%8E%E9%94%81%E8%AF%B4%E8%B5%B7 aria-label=锚点>#</a></span></h2><p>我们重点关注对openssl对linux系统下pthread的支持，具体的文件为threads_pthread.c，该文件位于crypto文件夹中，使用的锁为读写锁。初始化锁的函数为<code>CRYPTO_THREAD_lock_new</code>，实现非常简单，就是分配并初始化读写锁。我们重点是要看哪里使用了读写锁。异步的操作文件为async.c</p><pre tabindex=0><code>	CRYPTO_RWLOCK *CRYPTO_THREAD_lock_new(void)
{
# ifdef USE_RWLOCK
    CRYPTO_RWLOCK *lock;

    if ((lock = OPENSSL_zalloc(sizeof(pthread_rwlock_t))) == NULL) {
        /* Don&#39;t set error, to avoid recursion blowup. */
        return NULL;
    }

    if (pthread_rwlock_init(lock, NULL) != 0) {
        OPENSSL_free(lock);
        return NULL;
    }
...

    return lock;
}
</code></pre><ul><li>在函数BIO_new会调用<code>CRYPTO_THREAD_lock_new</code>，初始化bio->lock</li><li>函数<code>BN_BLINDING_new</code>中，生成一个<code>BN_BLINDING</code>，初始化其->lock</li><li>函数<code>context_init</code>中，会初始化<code>OPENSSL_CTX</code>的<code>lock</code>,<code>oncelock</code>和<code>ctx->index_locks[OPENSSL_CTX_MAX_INDEXES]</code></li><li>函数<code>dh_new_intern</code>中会初始化<code>DH* ret->lock</code></li><li>函数<code>evp_md_new</code></li><li>函数各种key，evp_cipher_new等等``</li><li>函数<code>CRYPTO_secure_malloc_init</code></li><li>函数<code>ssl_cert_new</code>和<code>ssl_cert_dup</code></li><li>函数<code>SSL_CTX_new_with_xxx</code>和<code>SSL_new</code>，查询session的时候，可以看到会对SSL_CTX加锁保护，查找session会进行检索。</li><li>函数<code>X509_STORE_new</code>和一些其他的函数</li></ul><p>我们可以看到对证书，BIO，SSL_CTX，SSL_st，DH/各种曲线/CIPHER都分配了锁结构。</p><p>我们重点关注下session是怎么存储的，OPENSSL查找session的函数为<code>ssl_get_prev_session</code>，核心的查找函数是<code>lookup_sess_in_cache</code>，该函数的几个查找函数直接看是看不到的，这几个函数都是通过宏定义<code>DEFINE_LHASH_OF</code>获得的。所以我们实际上是对每个<code>LHASH_OF(SSL_SESSION) s->session_ctx->sessions</code>进行查找，调用的核心函数实际上是<code>OPENSSL_LH_retrieve</code>。此时使用读锁来获取SSL_CTX，因为指向的SESSION CTX都是一个，这样子操作实际上比较糟糕。</p><pre tabindex=0><code>	void *OPENSSL_LH_retrieve(OPENSSL_LHASH *lh, const void *data)
{
    unsigned long hash;
    OPENSSL_LH_NODE **rn;
    void *ret;

    tsan_store((TSAN_QUALIFIER int *)&amp;lh-&gt;error, 0);

    rn = getrn(lh, data, &amp;hash);

    if (*rn == NULL) {
        tsan_counter(&amp;lh-&gt;num_retrieve_miss);
        return NULL;
    } else {
        ret = (*rn)-&gt;data;
        tsan_counter(&amp;lh-&gt;num_retrieve);
    }

    return ret;
}

static OPENSSL_LH_NODE **getrn(OPENSSL_LHASH *lh,
                               const void *data, unsigned long *rhash)
{
    OPENSSL_LH_NODE **ret, *n1;
    unsigned long hash, nn;
    OPENSSL_LH_COMPFUNC cf;

    hash = (*(lh-&gt;hash)) (data);
    tsan_counter(&amp;lh-&gt;num_hash_calls);
    *rhash = hash;

    nn = hash % lh-&gt;pmax;
    if (nn &lt; lh-&gt;p)
        nn = hash % lh-&gt;num_alloc_nodes;

    cf = lh-&gt;comp;
    ret = &amp;(lh-&gt;b[(int)nn]);
    for (n1 = *ret; n1 != NULL; n1 = n1-&gt;next) {
        tsan_counter(&amp;lh-&gt;num_hash_comps);
        if (n1-&gt;hash != hash) {
            ret = &amp;(n1-&gt;next);
            continue;
        }
        tsan_counter(&amp;lh-&gt;num_comp_calls);
        if (cf(n1-&gt;data, data) == 0)
            break;
        ret = &amp;(n1-&gt;next);
    }
    return ret;
}
</code></pre><h2 class="relative group">结束<div id=%E7%BB%93%E6%9D%9F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%BB%93%E6%9D%9F aria-label=锚点>#</a></span></h2><h2 class="relative group">结尾的闲言碎语<div id=%E7%BB%93%E5%B0%BE%E7%9A%84%E9%97%B2%E8%A8%80%E7%A2%8E%E8%AF%AD class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%BB%93%E5%B0%BE%E7%9A%84%E9%97%B2%E8%A8%80%E7%A2%8E%E8%AF%AD aria-label=锚点>#</a></span></h2><p>写到这里差不多就可以结束了。TLS这块还有啥不明白的直接告诉我就成了<figure><img class="my-0 rounded-md" loading=lazy src=https://i.loli.net/2020/08/27/BFHNyfpx3EsIDUG.jpg alt=狗头的赞赏码.jpg></figure></p></div></div><script>var oid="views_posts\\2020-10-15-OPENSSL源码阅读(9)\\index.md",oid_likes="likes_posts\\2020-10-15-OPENSSL源码阅读(9)\\index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/2020-10-13-tls%E8%87%AA%E5%8A%A8%E6%9C%BA%E5%AE%9E%E7%8E%B0%E6%97%B6%E4%B8%80%E4%BA%9B%E4%B8%8D%E9%94%99%E5%9C%B0%E6%96%B9/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">TLS自动机实现时一些不错地方</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2020-09-16T00:00:00+00:00>2020 年 9 月 16 日</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/2020-10-27-%E5%86%85%E5%AD%98%E5%AD%A6%E4%B9%A03--%E9%94%81%E4%BB%AC/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">内存学习(3)--锁(们)</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2020-10-27T00:00:00+00:00>2020 年 10 月 27 日</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">© 2025 - 2025 菜狗 All Rights Reserved.</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a> 强力驱动</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://hxndg.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>