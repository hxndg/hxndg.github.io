<!doctype html><html lang=cn dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>多处理编程的艺术第二版笔记 &#183; 菜狗的blog</title>
<meta name=title content="多处理编程的艺术第二版笔记 &#183; 菜狗的blog"><meta name=description content="菜狗's website"><meta name=keywords content="lock,架构,fun,"><link rel=canonical href=https://hxndg.github.io/posts/2021-01-26-%E5%A4%9A%E5%A4%84%E7%90%86%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF%E7%AC%AC%E4%BA%8C%E7%89%88%E7%AC%94%E8%AE%B0/><link type=text/css rel=stylesheet href=/css/main.bundle.min.ba3775bebd52a2b4837f8da64e32ee36e5c52bf284a0ce2262562782398b701543947527ad1498487717b1b96fe2a4e48d365a02e0b5d00e224893052e99d83c.css integrity="sha512-ujd1vr1SorSDf42mTjLuNuXFK/KEoM4iYlYngjmLcBVDlHUnrRSYSHcXsblv4qTkjTZaAuC10A4iSJMFLpnYPA=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.764eb2fe8d6a6b086c7c58f87d12c64fa79a7585117fc27eb53f688f80c287a6eff16277f9d186cd223a39ff700e294d64482834faece5e07ee0498fa042d056.js integrity="sha512-dk6y/o1qawhsfFj4fRLGT6eadYURf8J+tT9oj4DCh6bv8WJ3+dGGzSI6Of9wDilNZEgoNPrs5eB+4EmPoELQVg==" data-copy data-copied></script><script src=/lib/zoom/zoom.min.3530c2657381259433194af312ec3d322a97a2ad85661810299757fe793b24c3b8e07ab97fa8e5cf96cff1208f271e75394b6eaa56c2e39e7e2c3ca49fb1921c.js integrity="sha512-NTDCZXOBJZQzGUrzEuw9MiqXoq2FZhgQKZdX/nk7JMO44Hq5f6jlz5bP8SCPJx51OUtuqlbC455+LDykn7GSHA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://hxndg.github.io/posts/2021-01-26-%E5%A4%9A%E5%A4%84%E7%90%86%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF%E7%AC%AC%E4%BA%8C%E7%89%88%E7%AC%94%E8%AE%B0/"><meta property="og:site_name" content="菜狗的blog"><meta property="og:title" content="多处理编程的艺术第二版笔记"><meta property="og:description" content="菜狗's website"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-26T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-26T00:00:00+00:00"><meta property="article:tag" content="Lock"><meta property="article:tag" content="架构"><meta property="article:tag" content="Fun"><meta name=twitter:card content="summary"><meta name=twitter:title content="多处理编程的艺术第二版笔记"><meta name=twitter:description content="菜狗's website"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"多处理编程的艺术第二版笔记","headline":"多处理编程的艺术第二版笔记","inLanguage":"zh-cn","url":"https:\/\/hxndg.github.io\/posts\/2021-01-26-%E5%A4%9A%E5%A4%84%E7%90%86%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF%E7%AC%AC%E4%BA%8C%E7%89%88%E7%AC%94%E8%AE%B0\/","author":{"@type":"Person","name":"菜狗"},"copyrightYear":"2021","dateCreated":"2021-01-26T00:00:00\u002b00:00","datePublished":"2021-01-26T00:00:00\u002b00:00","dateModified":"2021-01-26T00:00:00\u002b00:00","keywords":["lock","架构","fun"],"mainEntityOfPage":"true","wordCount":"12295"}]</script><meta name=author content="菜狗"><script src=/lib/jquery/jquery.slim.min.03cb160e3cfdb2667a2e2c80d283bebcf63ff8bbc4b629c9ab2babf6fae1d0c07ad470edae783efa4fabda2ac01c58d60e63b98b3c336be8208460f08f4354f5.js integrity="sha512-A8sWDjz9smZ6LiyA0oO+vPY/+LvEtinJqyur9vrh0MB61HDtrng++k+r2irAHFjWDmO5izwza+gghGDwj0NU9Q=="></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>跳过正文</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">菜狗的blog</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Home</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Posts</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Tags</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Home</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Posts</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Tags</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">多处理编程的艺术第二版笔记</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2021-01-26T00:00:00+00:00>2021 年 1 月 26 日</time><span class="px-2 text-primary-500">&#183;</span><span>12295 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>25 分钟</span></div></div><div class="flex author"><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">菜狗</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Focus</div><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#锁同步常用检测思维>锁/同步常用检测思维：</a></li><li><a href=#锁同步设计常用思路>锁/同步设计常用思路：</a></li><li><a href=#第一章-introduction>第一章 introduction</a></li><li><a href=#第二章-互斥锁>第二章 互斥锁</a><ul><li><a href=#21-25-互斥锁的几个例子>2.1-2.5 互斥锁的几个例子</a></li><li><a href=#26-28-贝克算法和label有序性的理解>2.6-2.8 贝克算法和label有序性的理解</a></li><li><a href=#29-基于读写操作的锁的不足>2.9 基于读/写操作的锁的不足</a></li></ul></li><li><a href=#第三章-并发编程>第三章 并发编程</a><ul><li><a href=#30-33一个反直觉但正确的顺序一致性>3.0-3.3一个反直觉但正确的顺序一致性</a></li><li><a href=#34-35-线性一致性和静态一致性>3.4-3.5 线性一致性和静态一致性</a></li><li><a href=#36-线性一致性的正式定义>3.6 线性一致性的正式定义</a></li></ul></li><li><a href=#第七章-自旋锁和竞争>第七章 自旋锁和竞争</a><ul><li><a href=#71-74-几种不同的锁>7.1-7.4 几种不同的锁</a></li><li><a href=#75-基于队列的锁>7.5 基于队列的锁</a><ul><li><a href=#751-基于数组的锁>7.5.1 基于数组的锁</a></li><li><a href=#752-基于clh队列的锁>7.5.2 基于CLH队列的锁</a></li><li><a href=#753-mcs队列锁>7.5.3 MCS队列锁</a></li></ul></li><li><a href=#76-实现了超时功能的基于队列的锁>7.6 实现了超时功能的基于队列的锁</a></li><li><a href=#77-层次锁>7.7 层次锁</a></li><li><a href=#78-复合锁>7.8 复合锁</a></li><li><a href=#79-快速锁>7.9 快速锁？</a></li></ul></li><li><a href=#第八章-条件变量>第八章 条件变量</a><ul><li><a href=#83-读写锁>8.3 读写锁</a></li><li><a href=#84-可重入锁>8.4 可重入锁</a></li></ul></li><li><a href=#第九章-链表并发>第九章 链表并发</a><ul><li><a href=#91-93-一堆理念的废话>9.1-9.3 一堆理念的废话</a></li><li><a href=#94-95-各种粒度同步锁>9.4-9.5 各种粒度同步(锁)</a></li><li><a href=#96-乐观同步锁>9.6 乐观同步(锁)</a></li><li><a href=#97-懒同步锁>9.7 懒同步(锁)</a></li><li><a href=#98-无锁同步>9.8 无锁同步</a></li></ul></li><li><a href=#第十章队列内存管理和aba问题>第十章：队列，内存管理和ABA问题</a><ul><li><a href=#101-103有限同步队列的实现>10.1-10.3有限同步队列的实现</a></li><li><a href=#104-无限全部队列>10.4 无限全部队列</a></li><li><a href=#105-无锁无限队列>10.5 无锁无限队列</a></li><li><a href=#106-内存回收和aba问题>10.6 内存回收和ABA问题</a></li><li><a href=#107-双数数据结构>10.7 双数数据结构</a></li></ul></li><li><a href=#第11章-栈和释放>第11章 栈和释放(?)</a><ul><li><a href=#111-112-无锁栈>11.1-11.2 无锁栈</a></li><li><a href=#113-114-消除>11.3-11.4 消除（？）</a><ul><li><a href=#1141-交换类型的实现>11.4.1 交换类型的实现</a></li><li><a href=#1142-缓冲垫下的并发栈>11.4.2 缓冲垫下的并发栈</a></li></ul></li></ul></li><li><a href=#第十二章计数排序和分布式协作>第十二章：计数，排序和分布式协作</a><ul><li><a href=#123-软件合并>12.3 软件合并</a></li><li><a href=#125-计数网络>12.5 计数网络</a></li></ul></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#锁同步常用检测思维>锁/同步常用检测思维：</a></li><li><a href=#锁同步设计常用思路>锁/同步设计常用思路：</a></li><li><a href=#第一章-introduction>第一章 introduction</a></li><li><a href=#第二章-互斥锁>第二章 互斥锁</a><ul><li><a href=#21-25-互斥锁的几个例子>2.1-2.5 互斥锁的几个例子</a></li><li><a href=#26-28-贝克算法和label有序性的理解>2.6-2.8 贝克算法和label有序性的理解</a></li><li><a href=#29-基于读写操作的锁的不足>2.9 基于读/写操作的锁的不足</a></li></ul></li><li><a href=#第三章-并发编程>第三章 并发编程</a><ul><li><a href=#30-33一个反直觉但正确的顺序一致性>3.0-3.3一个反直觉但正确的顺序一致性</a></li><li><a href=#34-35-线性一致性和静态一致性>3.4-3.5 线性一致性和静态一致性</a></li><li><a href=#36-线性一致性的正式定义>3.6 线性一致性的正式定义</a></li></ul></li><li><a href=#第七章-自旋锁和竞争>第七章 自旋锁和竞争</a><ul><li><a href=#71-74-几种不同的锁>7.1-7.4 几种不同的锁</a></li><li><a href=#75-基于队列的锁>7.5 基于队列的锁</a><ul><li><a href=#751-基于数组的锁>7.5.1 基于数组的锁</a></li><li><a href=#752-基于clh队列的锁>7.5.2 基于CLH队列的锁</a></li><li><a href=#753-mcs队列锁>7.5.3 MCS队列锁</a></li></ul></li><li><a href=#76-实现了超时功能的基于队列的锁>7.6 实现了超时功能的基于队列的锁</a></li><li><a href=#77-层次锁>7.7 层次锁</a></li><li><a href=#78-复合锁>7.8 复合锁</a></li><li><a href=#79-快速锁>7.9 快速锁？</a></li></ul></li><li><a href=#第八章-条件变量>第八章 条件变量</a><ul><li><a href=#83-读写锁>8.3 读写锁</a></li><li><a href=#84-可重入锁>8.4 可重入锁</a></li></ul></li><li><a href=#第九章-链表并发>第九章 链表并发</a><ul><li><a href=#91-93-一堆理念的废话>9.1-9.3 一堆理念的废话</a></li><li><a href=#94-95-各种粒度同步锁>9.4-9.5 各种粒度同步(锁)</a></li><li><a href=#96-乐观同步锁>9.6 乐观同步(锁)</a></li><li><a href=#97-懒同步锁>9.7 懒同步(锁)</a></li><li><a href=#98-无锁同步>9.8 无锁同步</a></li></ul></li><li><a href=#第十章队列内存管理和aba问题>第十章：队列，内存管理和ABA问题</a><ul><li><a href=#101-103有限同步队列的实现>10.1-10.3有限同步队列的实现</a></li><li><a href=#104-无限全部队列>10.4 无限全部队列</a></li><li><a href=#105-无锁无限队列>10.5 无锁无限队列</a></li><li><a href=#106-内存回收和aba问题>10.6 内存回收和ABA问题</a></li><li><a href=#107-双数数据结构>10.7 双数数据结构</a></li></ul></li><li><a href=#第11章-栈和释放>第11章 栈和释放(?)</a><ul><li><a href=#111-112-无锁栈>11.1-11.2 无锁栈</a></li><li><a href=#113-114-消除>11.3-11.4 消除（？）</a><ul><li><a href=#1141-交换类型的实现>11.4.1 交换类型的实现</a></li><li><a href=#1142-缓冲垫下的并发栈>11.4.2 缓冲垫下的并发栈</a></li></ul></li></ul></li><li><a href=#第十二章计数排序和分布式协作>第十二章：计数，排序和分布式协作</a><ul><li><a href=#123-软件合并>12.3 软件合并</a></li><li><a href=#125-计数网络>12.5 计数网络</a></li></ul></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h1 class="relative group">多处理编程的艺术<div id=%E5%A4%9A%E5%A4%84%E7%90%86%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%A4%9A%E5%A4%84%E7%90%86%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF aria-label=锚点>#</a></span></h1><p>这本书我估计得看两遍，第一遍看算法/理论，第二遍看一遍证明。</p><h2 class="relative group">锁/同步常用检测思维：<div id=%E9%94%81%E5%90%8C%E6%AD%A5%E5%B8%B8%E7%94%A8%E6%A3%80%E6%B5%8B%E6%80%9D%E7%BB%B4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%94%81%E5%90%8C%E6%AD%A5%E5%B8%B8%E7%94%A8%E6%A3%80%E6%B5%8B%E6%80%9D%E7%BB%B4 aria-label=锚点>#</a></span></h2><ul><li>如何保证互斥？</li><li>如何保证公平性？简单来说，锁的先后顺序保证就是公平</li><li>如何保证不会饿死？</li><li>如何保证不会出现唤醒丢失/虚假唤醒？如果检测是否需要睡眠，和正式进入睡眠不是一步，一般就需要防备唤醒丢失。防备唤醒丢失的方法还是，使用锁来保证“同步”的线程不会出现同时执行交互的操作（同步的概念看第十章的开头）。虚假唤醒是指当醒过来的时候发现条件不满足(阅读第八章)，因此需要多次检测条件(条件变量)是否满足</li></ul><h2 class="relative group">锁/同步设计常用思路：<div id=%E9%94%81%E5%90%8C%E6%AD%A5%E8%AE%BE%E8%AE%A1%E5%B8%B8%E7%94%A8%E6%80%9D%E8%B7%AF class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%94%81%E5%90%8C%E6%AD%A5%E8%AE%BE%E8%AE%A1%E5%B8%B8%E7%94%A8%E6%80%9D%E8%B7%AF aria-label=锚点>#</a></span></h2><ul><li>对于相同(原子)变量的操作常常是导致性能消耗的关键，因此想办法将同样一个（原子）变量，拆分为属于不同部分的操作，见第十章对于有限同步队列最后 的点评与操作。除此之外，对同一事物的竞争是导致性能消耗的关键第十章的双数数据结构提供了一种保护操作。</li><li>除了对相同（原子）变量的操作导致性能消耗，另一方面，强行要求指令线性执行，而不是并发执行也会导致性能不高，对于这种问题：</li><li>具体见例子第十一章的11.3节：之所以无锁栈性能不好，不是因为top产生了竞争，而是因为强制要求线性并发，不能多个同时burst，这种加个缓冲垫的想法是非常常见且有效的。一个更具体的例子是：</li><li>这两条具体的理念看第十二章的12.2节，再看看合并树的操作。总而言之，尽量避免memory contention&mdash;多个线程同时访问相同的内存地址和尽量实现real parallelism，</li><li>无锁操作实现的关键往往是有每个前提保证的，就以第十章的无锁队列实现为例，每一步都要求保证当前操作的节点是最后的节点！设计无锁的数据结构建议看第十章无锁队列</li></ul><h2 class="relative group">第一章 introduction<div id=%E7%AC%AC%E4%B8%80%E7%AB%A0-introduction class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%AC%AC%E4%B8%80%E7%AB%A0-introduction aria-label=锚点>#</a></span></h2><h2 class="relative group">第二章 互斥锁<div id=%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E4%BA%92%E6%96%A5%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E4%BA%92%E6%96%A5%E9%94%81 aria-label=锚点>#</a></span></h2><h3 class="relative group">2.1-2.5 互斥锁的几个例子<div id=21-25-%E4%BA%92%E6%96%A5%E9%94%81%E7%9A%84%E5%87%A0%E4%B8%AA%E4%BE%8B%E5%AD%90 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#21-25-%E4%BA%92%E6%96%A5%E9%94%81%E7%9A%84%E5%87%A0%E4%B8%AA%E4%BE%8B%E5%AD%90 aria-label=锚点>#</a></span></h3><p>两种简单的锁，这两种锁各有各的缺点，但是相互补足了对面：一种锁的驱动机制会导致另一种锁卡住</p><p>pertson锁，结合了两种锁的优点</p><p>filter锁，适合多个线程，结合了多个线程的特点，有两个可以保证：</p><ul><li>总会有某个线程进入第<code>l</code>层成功。</li><li>倘若有多个线程想进入第<code>l</code>层，那么至少会有一个线程被阻塞。</li></ul><pre tabindex=0><code>1	class Filter implements Lock {
2 		int[] level;
3 		int[] victim;
4 		public Filter(int n) {
5 			level = new int[n];
6 			victim = new int[n]; // use 1..n-1
7 			for (int i = 0; i &lt; n; i++) {
8 				level[i] = 0;
9 			}
10 		}
11 		public void lock() {
12 			int me = ThreadID.get();
13 			for (int i = 1; i &lt; n; i++) { // attempt to enter level i
14 				level[me] = i;
15 				victim[i] = me;
16 				// spin while conflicts exist
17 				while ((∃k != me) (level[k] &gt;= i &amp;&amp; victim[i] == me)) {};
18 			}
19 		}
20 		public void unlock() {
21 			int me = ThreadID.get();
22 			level[me] = 0;
23 		}
24 	}
</code></pre><h3 class="relative group">2.6-2.8 贝克算法和label有序性的理解<div id=26-28-%E8%B4%9D%E5%85%8B%E7%AE%97%E6%B3%95%E5%92%8Clabel%E6%9C%89%E5%BA%8F%E6%80%A7%E7%9A%84%E7%90%86%E8%A7%A3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#26-28-%E8%B4%9D%E5%85%8B%E7%AE%97%E6%B3%95%E5%92%8Clabel%E6%9C%89%E5%BA%8F%E6%80%A7%E7%9A%84%E7%90%86%E8%A7%A3 aria-label=锚点>#</a></span></h3><p>公正性，将锁分成doorway section核waiting section。</p><p>兰博贝克算法，贝克算法要求后来的线程拿到的label必须是更大的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>class</span> <span class=nc>Bakery</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=kt>boolean</span><span class=o>[]</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=n>Label</span><span class=o>[]</span><span class=w> </span><span class=n>label</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>Bakery</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 			</span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>boolean</span><span class=o>[</span><span class=n>n</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=n>label</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Label</span><span class=o>[</span><span class=n>n</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 			</span><span class=nf>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 				</span><span class=n>flag</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=n>label</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w>			 </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 			</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadID</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 			</span><span class=n>flag</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 			</span><span class=n>label</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>max</span><span class=p>(</span><span class=n>label</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=p>...,</span><span class=n>label</span><span class=o>[</span><span class=n>n</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>((</span><span class=err>∃</span><span class=n>k</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>i</span><span class=p>)(</span><span class=n>flag</span><span class=o>[</span><span class=n>k</span><span class=o>]</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>label</span><span class=o>[</span><span class=n>k</span><span class=o>]</span><span class=p>,</span><span class=n>k</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=p>(</span><span class=n>label</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>,</span><span class=n>i</span><span class=p>)))</span><span class=w> </span><span class=p>{};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 			</span><span class=n>flag</span><span class=o>[</span><span class=n>ThreadID</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>实际上就是个单调的线性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=n>label</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=p>(</span><span class=n>label</span><span class=o>[</span><span class=n>j</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>j</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=n>only</span><span class=w> </span><span class=k>if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>label</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>label</span><span class=o>[</span><span class=n>j</span><span class=o>]</span><span class=w> </span><span class=n>or</span><span class=w> </span><span class=n>label</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>label</span><span class=o>[</span><span class=n>j</span><span class=o>]</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>j</span><span class=p>.</span><span class=w>
</span></span></span></code></pre></div><p>接下来提出了有向图的概念，a->b的意思是a晚于b发生。对于两个线程，我们只需要设置三个token的图，如图2.13s所示，既能保证他们是有序的。为了能够解决多线程的复杂情况，使用有向图来表示，提出下面的说法，实际上H也是图：</p><ul><li>We say that A dominates B in G if every node of A has edges directed to every node of B.</li><li>G ◦ H 就是graph multiplication ，Replace every node v of G by a copy of H (denoted Hv), and let Hv dominate Hu in G ◦ H if v dominates u in G. 这里所谓的图的替代，是指直接全替代代表一个节点？</li></ul><p>对于label算法的理解：理解n个线程的label算法的关键是token代表的节点从来都是有序构成一个环，而不会出现不知道label相互竞争的情况。对两个线程而言，之所以两个线程不会出现label的竞争是因为T2的最短路径里要求三个节点。这部分建议直接看中文第一版的《多处理器编程的艺术》。这部分没看的特别明白需要重看。</p><p>下面是一些要注意到的名词：</p><ul><li>Directed graph 有向图 Precedence graph 前趋图</li><li>irreflexive 自反关系：对自己是不成立的 antisymmetric 反对称关系 transitive 传递关系</li><li>trivial 容易得，不费力得</li><li>safety properties 不可进入非法状态 liveness properties运行状态中会达到的糟糕状态，只能找维基百科的说法 <strong>safety properties</strong> informally require that &ldquo;something bad will never happen&rdquo;</li></ul><h3 class="relative group">2.9 基于读/写操作的锁的不足<div id=29-%E5%9F%BA%E4%BA%8E%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C%E7%9A%84%E9%94%81%E7%9A%84%E4%B8%8D%E8%B6%B3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#29-%E5%9F%BA%E4%BA%8E%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C%E7%9A%84%E9%94%81%E7%9A%84%E4%B8%8D%E8%B6%B3 aria-label=锚点>#</a></span></h3><ul><li>Is there a clever Lock algorithm based on reading and writing memory that avoids this overhead? We now demonstrate that the answer is no. 为什么不能呢？因为如果多个线程同时读写，那么他们的结果可能在看到之前就被别的线程改写了。所以必须需要N个地方，换言之每个线程只能改自己的</li><li>A Lock object state s is inconsistent in any global state where some thread is in the critical section, but the lock state is compatible with a global state in which no thread is in the critical section or is trying to enter the critical section. 这里实际上实说，互斥的锁必然是状态一致的，不一致会导致互斥失败</li></ul><h2 class="relative group">第三章 并发编程<div id=%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B aria-label=锚点>#</a></span></h2><p>这一章是帮助理解什么是顺序一致性的，但是感觉读起来很蛋疼。这里面实际上有一个问题，怎么判断一个数据结构是不是满足线程安全呢？</p><h3 class="relative group">3.0-3.3一个反直觉但正确的顺序一致性<div id=30-33%E4%B8%80%E4%B8%AA%E5%8F%8D%E7%9B%B4%E8%A7%89%E4%BD%86%E6%AD%A3%E7%A1%AE%E7%9A%84%E9%A1%BA%E5%BA%8F%E4%B8%80%E8%87%B4%E6%80%A7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#30-33%E4%B8%80%E4%B8%AA%E5%8F%8D%E7%9B%B4%E8%A7%89%E4%BD%86%E6%AD%A3%E7%A1%AE%E7%9A%84%E9%A1%BA%E5%BA%8F%E4%B8%80%E8%87%B4%E6%80%A7 aria-label=锚点>#</a></span></h3><p>sequential consistency 顺序一致性，这个由下面两个定理定义。我们当然想要求real time order，但这里的sequential consistency并不保持real-time order，它并不要求要求不同线程之间存在的一种顺序，使得一个fifo的dequeue和enqueue是正确的。换言之，这种顺序一致性只是保证了一个线程内的程序调用顺序和代码顺序是一致的，这并不违背我们按照《A primer xxx》给出的顺序一致性。建议直接看这个问题：https://stackoverflow.com/questions/19209274/example-of-execution-which-is-sequentially-consistent-but-not-quiescently-consis</p><ul><li><p>Principle 3.3.1. Method calls should appear to happen in a one-at-a-time, sequential order. 这个只要求一个接一个.</p></li><li><p>Principle 3.3.2. Method calls should appear to take effect in program order. 程序的调用顺序应该和代码的执行顺序是一致的，而且应当符合我们的预期。</p></li><li><p>顺序一致性并不是阻塞的，这句话有点令人感觉蛋疼，和工业也不相符。</p></li><li><p>这里引入了一个复合的概念，每个个体满足p，如果全体也满足p那么就说p这个条件是复合的。但是对于SC则不满足这一点具体的例子见P57，这东西违背了顺序一致性，因为它自己构成了一个循环</p></li></ul><h3 class="relative group">3.4-3.5 线性一致性和静态一致性<div id=34-35-%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E9%9D%99%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#34-35-%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E9%9D%99%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7 aria-label=锚点>#</a></span></h3><p>这个东西就比刚才那个更符合人类的想法了。</p><ul><li>Principle 3.4.1. Each method call should appear to take effect instantaneously at some moment between its invocation and response. 就是可以将真正执行的时候，看成一个时刻，这个时刻在call发生和response返回之间。这就是线性一致性</li><li>Principle 3.5.1. Method calls separated by a period of quiescence should appear to take effect in their real-time order. 严格按照发生时刻的顺序执行，这个就是静态一致性</li></ul><h3 class="relative group">3.6 线性一致性的正式定义<div id=36-%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7%E7%9A%84%E6%AD%A3%E5%BC%8F%E5%AE%9A%E4%B9%89 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#36-%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7%E7%9A%84%E6%AD%A3%E5%BC%8F%E5%AE%9A%E4%B9%89 aria-label=锚点>#</a></span></h3><p>非常恶心，非常非常恶心，不说人话的典型，锁的理论表达，包括下面几章等以后再看吧。</p><h2 class="relative group">第七章 自旋锁和竞争<div id=%E7%AC%AC%E4%B8%83%E7%AB%A0-%E8%87%AA%E6%97%8B%E9%94%81%E5%92%8C%E7%AB%9E%E4%BA%89 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%AC%AC%E4%B8%83%E7%AB%A0-%E8%87%AA%E6%97%8B%E9%94%81%E5%92%8C%E7%AB%9E%E4%BA%89 aria-label=锚点>#</a></span></h2><p>这章实际上需要理解的就是锁的有序性，我们只要保证锁的获取是有序的，不会出现多个进入，那么就满足了互斥。然后只要不断将等待时间乘以二，那么就可以减少同时的争用。先进先出属于OPTIONAL的选项。</p><h3 class="relative group">7.1-7.4 几种不同的锁<div id=71-74-%E5%87%A0%E7%A7%8D%E4%B8%8D%E5%90%8C%E7%9A%84%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#71-74-%E5%87%A0%E7%A7%8D%E4%B8%8D%E5%90%8C%E7%9A%84%E9%94%81 aria-label=锚点>#</a></span></h3><p>TAS锁，TTAS锁，回退锁，为什么性能不一致？实际上是因为TAS锁竞争的时候对于缓存要求太高，经常要求使得其他的缓存无效，TTAS只要求GetS操作，不会强行同步总线和缓存。回退锁是减少了竞争的发生，实际上就是让出来临界区。实际上这东西提供了我们三个东西：</p><ul><li>代码层面我们认为逻辑一致性的东西，已经在一定程度上避免了问题的出现，但是这种层面只是问题设计的第一层面</li><li>因为代码是需要跑的，所以在实现的时候不但要考虑上层层面，还要考虑底层层面的实现，对锁而言就是缓存协议，同步等的代价</li><li>最后一个就是要养成一个从上向下，看到底层的习惯了。还得尝试提出，实现方面的抽象。</li></ul><p>TAS锁：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TASLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=n>AtomicBoolean</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicBoolean</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=na>getAndSet</span><span class=p>(</span><span class=kc>true</span><span class=p>))</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 			</span><span class=n>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>TTAS锁：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TTASLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=n>AtomicBoolean</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicBoolean</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 				</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=na>get</span><span class=p>())</span><span class=w> </span><span class=p>{};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 				</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>state</span><span class=p>.</span><span class=na>getAndSet</span><span class=p>(</span><span class=kc>true</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 					</span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 			</span><span class=n>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>回退锁：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Backoff</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>minDelay</span><span class=p>,</span><span class=w> </span><span class=n>maxDelay</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=kt>int</span><span class=w> </span><span class=n>limit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>Backoff</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>min</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>max</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 			</span><span class=n>minDelay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>min</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=n>maxDelay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>max</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 			</span><span class=n>limit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>minDelay</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>backoff</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 			</span><span class=kt>int</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadLocalRandom</span><span class=p>.</span><span class=na>current</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>limit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 			</span><span class=n>limit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>maxDelay</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>limit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 			</span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>delay</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>BackoffLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=kd>private</span><span class=w> </span><span class=n>AtomicBoolean</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicBoolean</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MIN_DELAY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MAX_DELAY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=n>Backoff</span><span class=w> </span><span class=n>backoff</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Backoff</span><span class=p>(</span><span class=n>MIN_DELAY</span><span class=p>,</span><span class=w> </span><span class=n>MAX_DELAY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 				</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=na>get</span><span class=p>())</span><span class=w> </span><span class=p>{};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 				</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>state</span><span class=p>.</span><span class=na>getAndSet</span><span class=p>(</span><span class=kc>true</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 					</span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 				</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 					</span><span class=n>backoff</span><span class=p>.</span><span class=na>backoff</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 			</span><span class=n>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">7.5 基于队列的锁<div id=75-%E5%9F%BA%E4%BA%8E%E9%98%9F%E5%88%97%E7%9A%84%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#75-%E5%9F%BA%E4%BA%8E%E9%98%9F%E5%88%97%E7%9A%84%E9%94%81 aria-label=锚点>#</a></span></h3><h4 class="relative group">7.5.1 基于数组的锁<div id=751-%E5%9F%BA%E4%BA%8E%E6%95%B0%E7%BB%84%E7%9A%84%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#751-%E5%9F%BA%E4%BA%8E%E6%95%B0%E7%BB%84%E7%9A%84%E9%94%81 aria-label=锚点>#</a></span></h4><p>基于数组的队列锁，tail是原子变量，保证每个线程都不会取到一样的值。每个flag[slot]为true代表锁可用，而flag[slot]为false代表不可用。因为使用了共享的一个数组，让多个线程不会在同一个地方产生竞争，因为可以提供竞争较少的服务。但是如果发生了高速缓存伪共享，(也就是说，不同内存块的内容被缓存到同一块缓存行上，不同的CPU对同一块缓存行的独写，注意这个不是同一个地址的独写，会导致高速缓存频繁的换入换出)同样会导致竞争激烈。因此如果把指针转动的幅度变大，就可以有效避免高速缓存伪共享的问题。</p><p>这东西我感觉像是一个表盘，转到谁就代表谁可以写数据，这个锁的传递是释放的时候传递的。但是有个问题如果最后又重新转到了头部，那么就会出现同时有两个线程获得锁了，这很糟糕。下面还是从三个层面来考虑：</p><ul><li>FIFO，是的，这个锁是FIFO的</li><li>会饿死吗？不会，只要能排上号的线程，最后都是会转到的</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ALock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>mySlotIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 			</span><span class=kd>protected</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>initialValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 				</span><span class=k>return</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 		</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 		</span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 		</span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=o>[]</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 		</span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>ALock</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 			</span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 			</span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 			</span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>boolean</span><span class=o>[</span><span class=n>capacity</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 			</span><span class=n>flag</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 			</span><span class=kt>int</span><span class=w> </span><span class=n>slot</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 			</span><span class=n>mySlotIndex</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>slot</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>flag</span><span class=o>[</span><span class=n>slot</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=p>{};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 			</span><span class=kt>int</span><span class=w> </span><span class=n>slot</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mySlotIndex</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 			</span><span class=n>flag</span><span class=o>[</span><span class=n>slot</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 			</span><span class=n>flag</span><span class=o>[</span><span class=p>(</span><span class=n>slot</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>size</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 class="relative group">7.5.2 基于CLH队列的锁<div id=752-%E5%9F%BA%E4%BA%8Eclh%E9%98%9F%E5%88%97%E7%9A%84%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#752-%E5%9F%BA%E4%BA%8Eclh%E9%98%9F%E5%88%97%E7%9A%84%E9%94%81 aria-label=锚点>#</a></span></h4><p>这个不如叫做链表锁吧，这个东西的有序是用链表的getAndSet保证的，因为要求锁的传递。这个东西对NUMA不友好，因为每个线程判断是不是可以上锁的时候都是要看前面的缓存块是不是锁住的。我们看看这个锁提供的特性</p><ul><li>饿死，不会饿死</li><li>FIFO，确实FIFO</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CLHLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=w> </span><span class=n>myPred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=w> </span><span class=n>myNode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>CLHLock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>QNode</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 			</span><span class=n>myNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 				</span><span class=kd>protected</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=nf>initialValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 					</span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>QNode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 			</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 			</span><span class=n>myPred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 			</span><span class=kd>protected</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=nf>initialValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 				</span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 		</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 		</span><span class=n>QNode</span><span class=w> </span><span class=n>qnode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myNode</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 		</span><span class=n>qnode</span><span class=p>.</span><span class=na>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 		</span><span class=n>QNode</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>.</span><span class=na>getAndSet</span><span class=p>(</span><span class=n>qnode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 		</span><span class=n>myPred</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>pred</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>pred</span><span class=p>.</span><span class=na>locked</span><span class=p>)</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 		</span><span class=n>QNode</span><span class=w> </span><span class=n>qnode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myNode</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 		</span><span class=n>qnode</span><span class=p>.</span><span class=na>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 		</span><span class=n>myNode</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>myPred</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> 	</span><span class=kd>class</span> <span class=nc>QNode</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 		</span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 class="relative group">7.5.3 MCS队列锁<div id=753-mcs%E9%98%9F%E5%88%97%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#753-mcs%E9%98%9F%E5%88%97%E9%94%81 aria-label=锚点>#</a></span></h4><p>这个锁不一样的地方是，每个线程看是否执行都是看自己控制的对象，所以每个对象都必须等待前面的对象释放掉自己。由于只有一个tail是可以原子CompareAndSet的，所以在unlokc的时候需要用tail这个fast path来等待slow path也就是后面的节点和前面节点挂起来的操作。这个锁和CLH锁相比，优点相同，但是因为检查的是本地的内存，所以对NUMA更友好。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MCSLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=w> </span><span class=n>myNode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>MCSLock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 			</span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=n>myNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 				</span><span class=kd>protected</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=nf>initialValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 					</span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>QNode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 			</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 			</span><span class=n>QNode</span><span class=w> </span><span class=n>qnode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myNode</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 			</span><span class=n>QNode</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>.</span><span class=na>getAndSet</span><span class=p>(</span><span class=n>qnode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 			</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>pred</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 				</span><span class=n>qnode</span><span class=p>.</span><span class=na>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 				</span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>qnode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 				</span><span class=c1>// wait until predecessor gives up the lock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 				</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>qnode</span><span class=p>.</span><span class=na>locked</span><span class=p>)</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 			</span><span class=n>QNode</span><span class=w> </span><span class=n>qnode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myNode</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 			</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>qnode</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 				</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>tail</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>qnode</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 					</span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 				</span><span class=c1>// wait until successor fills in its next field</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 				</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>qnode</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> 			</span><span class=n>qnode</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 			</span><span class=n>qnode</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 		</span><span class=kd>class</span> <span class=nc>QNode</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 			</span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 			</span><span class=kd>volatile</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>36</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>37</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">7.6 实现了超时功能的基于队列的锁<div id=76-%E5%AE%9E%E7%8E%B0%E4%BA%86%E8%B6%85%E6%97%B6%E5%8A%9F%E8%83%BD%E7%9A%84%E5%9F%BA%E4%BA%8E%E9%98%9F%E5%88%97%E7%9A%84%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#76-%E5%AE%9E%E7%8E%B0%E4%BA%86%E8%B6%85%E6%97%B6%E5%8A%9F%E8%83%BD%E7%9A%84%E5%9F%BA%E4%BA%8E%E9%98%9F%E5%88%97%E7%9A%84%E9%94%81 aria-label=锚点>#</a></span></h3><p>对于回退锁等简单锁，超时很简单，几步以后直接返回。而对于队列锁，返回则很难，不能直接把自己的锁标记为成功，因此采用一种lazy的做法，标记为abandoned，如果被抛弃的锁发现前面这货是被丢弃的，那么直接去检查之前的锁。下面的实现里，如果某个QNode的pred字段为NULL，那么要么是还没获取到锁，在等待获得锁，要么是还没获得锁，打释放掉锁。如果QNode的pred字段指向QNode AVAILABLE，那么这个QNode之前关联的线程已经释放，可以获取这个锁。如果pred字段指向其他节点，非NULL，也不是AVAILABLE，说明前面的QNode关联的线程放弃了锁请求，我们直接占有这个QNode去做检查。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TOLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=kd>static</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=n>AVAILABLE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QNode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=w> </span><span class=n>myNode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>TOLock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 			</span><span class=n>myNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 				</span><span class=kd>protected</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=nf>initialValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 					</span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>QNode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 			</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 		</span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>QNode</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 			</span><span class=kd>public</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryLock</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 		</span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 		</span><span class=kt>long</span><span class=w> </span><span class=n>patience</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>.</span><span class=na>convert</span><span class=p>(</span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 		</span><span class=n>QNode</span><span class=w> </span><span class=n>qnode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QNode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 		</span><span class=n>myNode</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>qnode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 		</span><span class=n>qnode</span><span class=p>.</span><span class=na>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 		</span><span class=n>QNode</span><span class=w> </span><span class=n>myPred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>.</span><span class=na>getAndSet</span><span class=p>(</span><span class=n>qnode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 		</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>myPred</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>myPred</span><span class=p>.</span><span class=na>pred</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>AVAILABLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 			</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>patience</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 			</span><span class=n>QNode</span><span class=w> </span><span class=n>predPred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myPred</span><span class=p>.</span><span class=na>pred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> 			</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>predPred</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>AVAILABLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 				</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 			</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>predPred</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 				</span><span class=n>myPred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>predPred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>36</span><span class=w> 		</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>tail</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>qnode</span><span class=p>,</span><span class=w> </span><span class=n>myPred</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>37</span><span class=w> 			</span><span class=n>qnode</span><span class=p>.</span><span class=na>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myPred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>38</span><span class=w> 		</span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>39</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>40</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>41</span><span class=w> 		</span><span class=n>QNode</span><span class=w> </span><span class=n>qnode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myNode</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>42</span><span class=w> 		</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>tail</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>qnode</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>43</span><span class=w> 			</span><span class=n>qnode</span><span class=p>.</span><span class=na>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AVAILABLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>44</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">7.7 层次锁<div id=77-%E5%B1%82%E6%AC%A1%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#77-%E5%B1%82%E6%AC%A1%E9%94%81 aria-label=锚点>#</a></span></h3><p>跨cluster锁的解决方式，不外乎锁队列。请求同类(cluster)队列的锁被称为队列锁。每个不同的cluster请求一个大的共享的锁，每次线程申请锁的时候，先锁cluster内部的锁，在请不同cluster共享的锁。释放的时候先检查本cluster内部有没有锁等着，有的话先释放自己cluster的锁，然后让自己cluster的锁跑着，等到确定没有了再释放大共享锁。</p><h3 class="relative group">7.8 复合锁<div id=78-%E5%A4%8D%E5%90%88%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#78-%E5%A4%8D%E5%90%88%E9%94%81 aria-label=锚点>#</a></span></h3><p>一种结合了好理解，而且要求常量空间的锁。实际上就是等待队列前面的锁该等就死等着把，等待队列后面的锁你们按照指数级别增长等待事件，嗯，既减少了竞争，又让前面的线程忙等。这种原地的写法实际上在我看来，糟糕透了，炫技意味浓厚。</p><ul><li><code>acquireQNode</code>就是尝试进入队列</li><li><code>spliceQNode</code>则尝试</li><li><code>waitForPredecessor</code>尝试获取锁，等待一段时间</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CompositeLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MIN_BACKOFF</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MAX_BACKOFF</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 		</span><span class=n>AtomicStampedReference</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 		</span><span class=n>QNode</span><span class=o>[]</span><span class=w> </span><span class=n>waiting</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 		</span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=w> </span><span class=n>myNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 			</span><span class=kd>protected</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=nf>initialValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 		</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>CompositeLock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 			</span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicStampedReference</span><span class=o>&lt;</span><span class=n>QNode</span><span class=o>&gt;</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 			</span><span class=n>waiting</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QNode</span><span class=o>[</span><span class=n>SIZE</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 			</span><span class=nf>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>waiting</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 				</span><span class=n>waiting</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QNode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 			</span><span class=n>QNode</span><span class=w> </span><span class=n>acqNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myNode</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w>			</span><span class=n>acqNode</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>State</span><span class=p>.</span><span class=na>RELEASED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 			</span><span class=n>myNode</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 		</span><span class=kd>enum</span><span class=w> </span><span class=n>State</span><span class=w> </span><span class=p>{</span><span class=n>FREE</span><span class=p>,</span><span class=w> </span><span class=n>WAITING</span><span class=p>,</span><span class=w> </span><span class=n>RELEASED</span><span class=p>,</span><span class=w> </span><span class=n>ABORTED</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 		</span><span class=kd>class</span> <span class=nc>QNode</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 			</span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>State</span><span class=o>&gt;</span><span class=w> </span><span class=n>state</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 			</span><span class=n>QNode</span><span class=w> </span><span class=n>pred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 			</span><span class=kd>public</span><span class=w> </span><span class=nf>QNode</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 				</span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>State</span><span class=o>&gt;</span><span class=p>(</span><span class=n>State</span><span class=p>.</span><span class=na>FREE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryLock</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 			</span><span class=kt>long</span><span class=w> </span><span class=n>patience</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>.</span><span class=na>convert</span><span class=p>(</span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 			</span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 			</span><span class=n>Backoff</span><span class=w> </span><span class=n>backoff</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Backoff</span><span class=p>(</span><span class=n>MIN_BACKOFF</span><span class=p>,</span><span class=w> </span><span class=n>MAX_BACKOFF</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>36</span><span class=w> 			</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>37</span><span class=w> 				</span><span class=n>QNode</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>acquireQNode</span><span class=p>(</span><span class=n>backoff</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=n>patience</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>38</span><span class=w> 				</span><span class=n>QNode</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>spliceQNode</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=n>patience</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>39</span><span class=w> 				</span><span class=nf>waitForPredecessor</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=n>patience</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>40</span><span class=w> 				</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>41</span><span class=w> 			</span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>TimeoutException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>42</span><span class=w> 				</span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>43</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>44</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>45</span><span class=w> 		</span><span class=kd>private</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=nf>acquireQNode</span><span class=p>(</span><span class=n>Backoff</span><span class=w> </span><span class=n>backoff</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>patience</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>46</span><span class=w> 			</span><span class=kd>throws</span><span class=w> </span><span class=n>TimeoutException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>47</span><span class=w> 				</span><span class=n>QNode</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>waiting</span><span class=o>[</span><span class=n>ThreadLocalRandom</span><span class=p>.</span><span class=na>current</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>SIZE</span><span class=p>)</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>48</span><span class=w> 				</span><span class=n>QNode</span><span class=w> </span><span class=n>currTail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>49</span><span class=w> 				</span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>currStamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>0</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>50</span><span class=w> 				</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>51</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>State</span><span class=p>.</span><span class=na>FREE</span><span class=p>,</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>WAITING</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>52</span><span class=w> 						</span><span class=k>return</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>53</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>54</span><span class=w> 					</span><span class=n>currTail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>currStamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>55</span><span class=w> 					</span><span class=n>State</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>56</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>ABORTED</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>RELEASED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>57</span><span class=w> 						</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>currTail</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>58</span><span class=w> 							</span><span class=n>QNode</span><span class=w> </span><span class=n>myPred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>59</span><span class=w> 							</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>ABORTED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>60</span><span class=w> 								</span><span class=n>myPred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>pred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>61</span><span class=w> 							</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>62</span><span class=w> 							</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>tail</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>currTail</span><span class=p>,</span><span class=w> </span><span class=n>myPred</span><span class=p>,</span><span class=w> </span><span class=n>currStamp</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>currStamp</span><span class=o>[</span><span class=n>0</span><span class=o>]+</span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>63</span><span class=w> 								</span><span class=n>node</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>State</span><span class=p>.</span><span class=na>WAITING</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>64</span><span class=w> 								</span><span class=k>return</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>65</span><span class=w> 							</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>66</span><span class=w> 						</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>67</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>68</span><span class=w> 					</span><span class=n>backoff</span><span class=p>.</span><span class=na>backoff</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>69</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>timeout</span><span class=p>(</span><span class=n>patience</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>70</span><span class=w> 						</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>TimeoutException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>71</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>72</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>73</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>74</span><span class=w> 		</span><span class=kd>private</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=nf>spliceQNode</span><span class=p>(</span><span class=n>QNode</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>patience</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>75</span><span class=w> 			</span><span class=kd>throws</span><span class=w> </span><span class=n>TimeoutException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>76</span><span class=w> 				</span><span class=n>QNode</span><span class=w> </span><span class=n>currTail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>77</span><span class=w> 				</span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>currStamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>0</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>78</span><span class=w> 				</span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>79</span><span class=w> 					</span><span class=n>currTail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>currStamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>80</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>timeout</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=n>patience</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>81</span><span class=w> 						</span><span class=n>node</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>State</span><span class=p>.</span><span class=na>FREE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>82</span><span class=w> 						</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>TimeoutException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>83</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>84</span><span class=w>				 </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>tail</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>currTail</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>currStamp</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>currStamp</span><span class=o>[</span><span class=n>0</span><span class=o>]+</span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>85</span><span class=w> 				</span><span class=k>return</span><span class=w> </span><span class=n>currTail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>86</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>87</span><span class=w> 		</span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>waitForPredecessor</span><span class=p>(</span><span class=n>QNode</span><span class=w> </span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>QNode</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>88</span><span class=w> 										</span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>patience</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>89</span><span class=w> 			</span><span class=kd>throws</span><span class=w> </span><span class=n>TimeoutException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>90</span><span class=w> 				</span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>0</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>91</span><span class=w> 				</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>pred</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>92</span><span class=w> 					</span><span class=n>myNode</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>93</span><span class=w> 					</span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>94</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>95</span><span class=w> 				</span><span class=n>State</span><span class=w> </span><span class=n>predState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>96</span><span class=w> 				</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>predState</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>RELEASED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>97</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>predState</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>ABORTED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>98</span><span class=w> 						</span><span class=n>QNode</span><span class=w> </span><span class=n>temp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>99</span><span class=w> 						</span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>pred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>100</span><span class=w> 					</span><span class=n>temp</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>State</span><span class=p>.</span><span class=na>FREE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>101</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>102</span><span class=w> 				</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>timeout</span><span class=p>(</span><span class=n>patience</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>103</span><span class=w> 					</span><span class=n>node</span><span class=p>.</span><span class=na>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>104</span><span class=w> 					</span><span class=n>node</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>State</span><span class=p>.</span><span class=na>ABORTED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>105</span><span class=w> 					</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>TimeoutException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>106</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>107</span><span class=w> 				</span><span class=n>predState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>108</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>109</span><span class=w> 			</span><span class=n>pred</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>State</span><span class=p>.</span><span class=na>FREE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>110</span><span class=w> 			</span><span class=n>myNode</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>111</span><span class=w> 			</span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>112</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">7.9 快速锁？<div id=79-%E5%BF%AB%E9%80%9F%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#79-%E5%BF%AB%E9%80%9F%E9%94%81 aria-label=锚点>#</a></span></h3><h2 class="relative group">第八章 条件变量<div id=%E7%AC%AC%E5%85%AB%E7%AB%A0-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%AC%AC%E5%85%AB%E7%AB%A0-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F aria-label=锚点>#</a></span></h2><p>因为我们能让线程自旋保持锁的争用，所以如果是自旋锁，我们可以保证总会有线程抢到锁。但是如果做的是睡眠操作而且没有条件变量，那就蛋疼了，如果做互斥唤醒的话我们必须得有条件变量来帮忙我们执行，否则我们没办法唤醒某个具体的线程。得看看C11的内置条件变量是怎么回事。</p><p>所有的语言都有无法唤醒(lost wake up)问题，有两种解决无法唤醒问题的方法：</p><ul><li>Always signal all processes waiting on a condition, not just one.</li><li>Specify a timeout when waiting</li></ul><p>这里面有几个地方需要注意，一个是虚假唤醒（spurious wakeup），另一个是惊群。C++11现在并没有解决虚假唤醒的问题。目前很多人把惊群也当作虚拟唤醒的一种。如果只看维基百科，惊群也是虚假唤醒的一种，但是在早期的版本，会出现没发信号就唤醒的情况：</p><ul><li>惊群：导致一个提前被唤醒的线程把资源给抢了，后面唤醒的线程发现条件不满足</li><li>spurious wakeup 如果有惊群效应导致一个提前被唤醒的线程把资源给抢了，后面唤醒的线程发现条件不满足，这个也叫做虚假唤醒。也有可能是根本就没有生产者线程发信号，wait就直接返回了，这也是虚假唤醒。不同的平台提供不同的保证，pthread说是不会出现第二个情况。具体虚假唤醒的定义看维基百科https://en.wikipedia.org/wiki/Spurious_wakeup</li></ul><h3 class="relative group">8.3 读写锁<div id=83-%E8%AF%BB%E5%86%99%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#83-%E8%AF%BB%E5%86%99%E9%94%81 aria-label=锚点>#</a></span></h3><p>读写锁两个特性，实际上书里给的两种读写锁都是用的可冲入锁，什么意思，可以多次进入一个锁：</p><ul><li>No thread can acquire the write lock while any thread holds either the write lock or the read lock.</li><li>No thread can acquire the read lock while any thread holds the write lock.</li></ul><p>光看这两个条件，有没有这种感觉，因为写锁获取之前必须所有的读锁/写锁都释放掉，所以和上面对应起来有种</p><ul><li><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>write</span><span class=p>.</span><span class=na>lock</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>while</span><span class=p>(</span><span class=n>还有读锁</span><span class=o>/</span><span class=n>写锁活着</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>condition</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>read</span><span class=p>.</span><span class=na>lock</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>while</span><span class=p>(</span><span class=n>写锁活着</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>condition</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li></ul><p>看看读写锁的代码实现，会发现可重入锁是关键，可重入锁保护的是谁？保护的实际上是write & readAcquires & redReleases对象，也就是锁内部的关键数据。但是我感觉这个实现没有避开多读者之间的竞争啊，还是有问题，当然也确实在一定程度上降低了读者的竞争。可重入锁的代码啥的看下面：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>23</span><span class=w> 	</span><span class=kd>private</span><span class=w> </span><span class=kd>class</span> <span class=nc>ReadLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 			</span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 			</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 				</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>writer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 				</span><span class=n>condition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 				</span><span class=n>readAcquires</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> 			</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 				</span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 			</span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>36</span><span class=w> 			</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>37</span><span class=w> 				</span><span class=n>readReleases</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>38</span><span class=w> 				</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>readAcquires</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>readReleases</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>39</span><span class=w> 					</span><span class=n>condition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>40</span><span class=w> 			</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>41</span><span class=w> 				</span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>42</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>43</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>44</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>45</span><span class=w> 	</span><span class=kd>private</span><span class=w> </span><span class=kd>class</span> <span class=nc>WriteLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>46</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>47</span><span class=w> 			</span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>48</span><span class=w> 		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>49</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>writer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>50</span><span class=w> 			</span><span class=n>condition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>51</span><span class=w> 			</span><span class=n>writer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>52</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>readAcquires</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>readReleases</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>53</span><span class=w> 				</span><span class=n>condition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>54</span><span class=w> 		</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>55</span><span class=w> 				</span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>56</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>57</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>58</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>59</span><span class=w> 		</span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>60</span><span class=w> 		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>61</span><span class=w> 			</span><span class=n>writer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>62</span><span class=w> 			</span><span class=n>condition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>63</span><span class=w> 		</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>64</span><span class=w> 			</span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>65</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>66</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>67</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">8.4 可重入锁<div id=84-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#84-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81 aria-label=锚点>#</a></span></h3><p>没想到吧JOJO，可重入锁才是本章节的关键啊，哈哈哈，实在是没话可说，这本书真的是不讲人话的典型啊。</p><h2 class="relative group">第九章 链表并发<div id=%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E9%93%BE%E8%A1%A8%E5%B9%B6%E5%8F%91 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E9%93%BE%E8%A1%A8%E5%B9%B6%E5%8F%91 aria-label=锚点>#</a></span></h2><p>这一章实际上是得意识到追求绝对的准确和减少竞争避免问题出现是很难一起实现的</p><h3 class="relative group">9.1-9.3 一堆理念的废话<div id=91-93-%E4%B8%80%E5%A0%86%E7%90%86%E5%BF%B5%E7%9A%84%E5%BA%9F%E8%AF%9D class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#91-93-%E4%B8%80%E5%A0%86%E7%90%86%E5%BF%B5%E7%9A%84%E5%BA%9F%E8%AF%9D aria-label=锚点>#</a></span></h3><p>9.3这节的重点并不是，所谓的线性/链表实现blablabla之类的东西，而是从不变式到抽象不变式，再到属性检查的部分是它的精髓，从某种意义来说也是最大的败笔，我在看实现方面的理念，你给我扯一堆没用的东西，然后说了一堆抽象的废话，就忽然结束了。</p><p>我们知道缓存的不变式(invariant)是SWMR和DATA-VALUE，对抽象数据结构而言，不变式是什么？嗯，我目前也不知道，不过不变式应该满足下面这两条。这些不变式也被叫做freedom from interference：</p><ul><li>the property holds when the object is created, and</li><li>once the property holds, no thread can take a step that makes it false.</li></ul><p>类比到我们这个例子里面，我们需要看每个同步时候的指令到底干了些啥，比方说insert(),remove()。在通过方法研究这些属性的时候，要能区分开他们代表的抽象和具体实际代码。抽象不变式只对对象抽象有效果，实现的不变式要跟着具体实现变化。下面的每节就是看各种不同级别的实现。</p><h3 class="relative group">9.4-9.5 各种粒度同步(锁)<div id=94-95-%E5%90%84%E7%A7%8D%E7%B2%92%E5%BA%A6%E5%90%8C%E6%AD%A5%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#94-95-%E5%90%84%E7%A7%8D%E7%B2%92%E5%BA%A6%E5%90%8C%E6%AD%A5%E9%94%81 aria-label=锚点>#</a></span></h3><p>细粒度锁为了能够保证先后的正确，因此必须，“手把手”的去获取锁。换言之：it acquires the lock for a node (except the head node) while holding (i.e., before releasing) the lock for its predecessor. 在获取某个节点锁之前要先获取它之前的锁。这个行为被称作lock coupling锁耦合(也叫做连接器)。这要求每个线程获取耦合锁的时候，具体获取耦合锁里面的一个锁的先后顺序要一致！</p><h3 class="relative group">9.6 乐观同步(锁)<div id=96-%E4%B9%90%E8%A7%82%E5%90%8C%E6%AD%A5%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#96-%E4%B9%90%E8%A7%82%E5%90%8C%E6%AD%A5%E9%94%81 aria-label=锚点>#</a></span></h3><p>嗯，那个出租车司机的笑话挺形象的。感觉除了这个之外没啥值得看额。。。也不完全是，对链表的插入和查询都不需要锁，或者说，拿个读锁去操作，写锁做别的事情。之所以这个能这么干，有个很大的原因就是删除操作并不是把单元的内存释放了，而是把关联的关系去掉了。但是，被删除的节点的->next属性依然指向下个节点。也就是说即使你拿到的是无效了的指针，它依然能找到下个元素。</p><p>那么这里面乐观了什么？这里实际上就是假设当我进行删除/查找/插入操作的时候，不会有其他的进程让我已经获得的节点失效。我这里面得意识到：</p><ul><li>先读的关系，后获取的锁，所以需要validate。</li><li>如果是先获取的锁，后读的关系，那就不需要validate了。这就是乐观同步和细粒度锁的区别。</li></ul><p>具体乐观锁的优化就是懒同步，下面是乐观同步的代码，主要有个问题是它的访问需要加锁，那么怎么解决呢？。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>   </span><span class=c1>//增加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=kt>int</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>item</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>curr</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 				</span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curr</span><span class=p>;</span><span class=w> </span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curr</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 			</span><span class=n>pred</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 			</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 				</span><span class=n>curr</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 				</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>validate</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>curr</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 						</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>curr</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 							</span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 						</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 							</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>item</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 							</span><span class=n>node</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 							</span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 							</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 						</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 				</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 					</span><span class=n>curr</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 			</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 				</span><span class=n>pred</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>remove</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=c1>//这个是删除操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 		</span><span class=kt>int</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>item</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>36</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>curr</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>37</span><span class=w> 				</span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curr</span><span class=p>;</span><span class=w> </span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curr</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>38</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>39</span><span class=w> 			</span><span class=n>pred</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>40</span><span class=w> 			</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>41</span><span class=w> 				</span><span class=n>curr</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>42</span><span class=w> 				</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>43</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>validate</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>curr</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>44</span><span class=w> 						</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>curr</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>45</span><span class=w> 							</span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curr</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>46</span><span class=w> 							</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>47</span><span class=w> 						</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>48</span><span class=w> 							</span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>49</span><span class=w> 						</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>50</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>51</span><span class=w> 				</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>52</span><span class=w> 					</span><span class=n>curr</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>53</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>54</span><span class=w> 			</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>55</span><span class=w> 				</span><span class=n>pred</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>56</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>57</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>58</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">9.7 懒同步(锁)<div id=97-%E6%87%92%E5%90%8C%E6%AD%A5%E9%94%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#97-%E6%87%92%E5%90%8C%E6%AD%A5%E9%94%81 aria-label=锚点>#</a></span></h3><p>懒同步实际上就是给每个节点加个标签，来表示它是不是有效的。这个东西实际上相当于一大堆读锁，每次发现某个数据没用了就直接CompareAndSet(Valid=false)。如果需要添加的节点的key已经存在，先改变值，再改变valid属性。每次发现数量太多了，不够用了再唤醒写锁。实际上你猜我想起来了什么，我想起来了mem_sem这个东西，这也是lasy_synchronization同步。</p><p>当着这个东西有个问题，就是会导致执行真正删除的时候很麻烦，为了能够detach节点，需要检查现在的detach的节点是不是有效的，相比于乐观同步，懒同步在移除节点的时候先标记无效，再移除关联关系。但是因为有可能找到无效的指针，所以检索找不到的可能性存在(具体见pdf的P218)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>33</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>contains</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 		</span><span class=kt>int</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>item</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 		</span><span class=n>Node</span><span class=w> </span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>36</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>curr</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>37</span><span class=w> 			</span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curr</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>38</span><span class=w> 		</span><span class=k>return</span><span class=w> </span><span class=n>curr</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>curr</span><span class=p>.</span><span class=na>marked</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>39</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">9.8 无锁同步<div id=98-%E6%97%A0%E9%94%81%E5%90%8C%E6%AD%A5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#98-%E6%97%A0%E9%94%81%E5%90%8C%E6%AD%A5 aria-label=锚点>#</a></span></h3><p>dada~到了最后就是重头戏了，无锁同步。本质就是同时看两个条件是不是满足，实质还是锁</p><p>建议看看这个C++11的例子，很有趣https://stackoverflow.com/questions/40247249/what-is-the-c-11-atomic-library-equivalent-of-javas-atomicmarkablereferencet和具体的atomic比较的例子https://www.cnblogs.com/haippy/p/3301408.html这部分还是建议直接看原理吧。</p><p>下面的代码里，window负责找到之前的节点和当前的节点</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>class</span> <span class=nc>Window</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>curr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=nf>Window</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>myPred</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>myCurr</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 			</span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myPred</span><span class=p>;</span><span class=w> </span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myCurr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 		</span><span class=n>Window</span><span class=w> </span><span class=nf>find</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>head</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>succ</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 			</span><span class=kt>boolean</span><span class=o>[]</span><span class=w> </span><span class=n>marked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=kc>false</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 			</span><span class=kt>boolean</span><span class=w> </span><span class=n>snip</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 			</span><span class=n>retry</span><span class=p>:</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 				</span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 				</span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>getReference</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 				</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 					</span><span class=n>succ</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curr</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>marked</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 					</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>marked</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 						</span><span class=n>snip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>curr</span><span class=p>,</span><span class=w> </span><span class=n>succ</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 						</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>snip</span><span class=p>)</span><span class=w> </span><span class=k>continue</span><span class=w> </span><span class=n>retry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 						</span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>succ</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 						</span><span class=n>succ</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curr</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>marked</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>curr</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 						</span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>Window</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>curr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 					</span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 					</span><span class=n>curr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>succ</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 class="relative group">第十章：队列，内存管理和ABA问题<div id=%E7%AC%AC%E5%8D%81%E7%AB%A0%E9%98%9F%E5%88%97%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%92%8Caba%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%AC%AC%E5%8D%81%E7%AB%A0%E9%98%9F%E5%88%97%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%92%8Caba%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h2><p>对pool（池）而言，操作分为部分和全部，部分是需要满足条件才能执行，如果条件不满足就阻塞的操作，全部是指立刻发生，或者返回错误码或者返回结果的操作。如果一个部分操作，需要另一个方法和它重叠才能发生，就说这个方法是同步的。</p><p>池提供了不同的公平性保证，如FIFO（队列），和LIFO（栈）。这章主要说队列。</p><h3 class="relative group">10.1-10.3有限同步队列的实现<div id=101-103%E6%9C%89%E9%99%90%E5%90%8C%E6%AD%A5%E9%98%9F%E5%88%97%E7%9A%84%E5%AE%9E%E7%8E%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#101-103%E6%9C%89%E9%99%90%E5%90%8C%E6%AD%A5%E9%98%9F%E5%88%97%E7%9A%84%E5%AE%9E%E7%8E%B0 aria-label=锚点>#</a></span></h3><p>两个条件变量，两个锁，下面的代码很巧妙的避免了“唤醒丢失”问题，这里要注意，为什么发现为空的时候要拿到deqLock呢？因为有唤醒丢失的问题，为什么会有唤醒丢失？因为：</p><ul><li>对于发布唤醒的线程而言(我们这里以enqueue为例)，虽然size是原子变量，但是从对size的判断再到<code>mustWakeDequeuers = true;</code>中间是有一个过程的，我们必须保证deq线程不能在<code>notEmptyCondition.signalAll();</code>之后进入睡眠，所以需要用deqLock进行保护。同理看deq算法</li><li>对于准备被唤醒的线程而言(我们这里以dequeue为例)，虽然size是原子变量，但是从对size的判断再到<code>notFullCondition </code>条件变量的等待是有个过程的，因此需要让enqueue线程获得enqLock来保证先后性。</li></ul><p>有限同步队列的问题是，每次都要操作两个锁deqLock和enqLock，同时enq和deq操作都要动size，因此将size拆分为enqSideSize 和deqSideSize 。队列的实际上都市enqSideSize+deqSideSize。enq操作检测enqSideSize大小，小于容量则继续。如果到达容量就锁住deqLock，把deqSideSize加到enqSideSize，然后重置deqSideSize为0</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>BoundedQueue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>enqLock</span><span class=p>,</span><span class=w> </span><span class=n>deqLock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=n>Condition</span><span class=w> </span><span class=n>notEmptyCondition</span><span class=p>,</span><span class=w> </span><span class=n>notFullCondition</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 		</span><span class=kd>volatile</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>head</span><span class=p>,</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 		</span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>BoundedQueue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>_capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 			</span><span class=n>capacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 			</span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 			</span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 			</span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 			</span><span class=n>enqLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 			</span><span class=n>notFullCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>enqLock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 			</span><span class=n>deqLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 			</span><span class=n>notEmptyCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>deqLock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 		</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 	</span><span class=kd>protected</span><span class=w> </span><span class=kd>class</span> <span class=nc>Node</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>Node</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 			</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 			</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>enq</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 		</span><span class=kt>boolean</span><span class=w> </span><span class=n>mustWakeDequeuers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 		</span><span class=n>Node</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> 		</span><span class=n>enqLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 				</span><span class=n>notFullCondition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 			</span><span class=n>tail</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 			</span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>36</span><span class=w> 			</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>37</span><span class=w> 				</span><span class=n>mustWakeDequeuers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>38</span><span class=w> 		</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>39</span><span class=w> 			</span><span class=n>enqLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>40</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>41</span><span class=w> 		</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>mustWakeDequeuers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>42</span><span class=w> 			</span><span class=n>deqLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>43</span><span class=w> 			</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>44</span><span class=w> 				</span><span class=n>notEmptyCondition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>45</span><span class=w> 			</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>46</span><span class=w> 				</span><span class=n>deqLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>47</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>48</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>49</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>50</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>deq</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>51</span><span class=w> 		</span><span class=n>T</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>52</span><span class=w> 		</span><span class=kt>boolean</span><span class=w> </span><span class=n>mustWakeEnqueuers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>53</span><span class=w> 		</span><span class=n>deqLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>54</span><span class=w> 		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>55</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>head</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>56</span><span class=w> 				</span><span class=n>notEmptyCondition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>57</span><span class=w> 			</span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>58</span><span class=w> 			</span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>59</span><span class=w> 			</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=p>.</span><span class=na>getAndDecrement</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>60</span><span class=w> 				</span><span class=n>mustWakeEnqueuers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>61</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>62</span><span class=w> 		</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>63</span><span class=w> 			</span><span class=n>deqLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>64</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>65</span><span class=w> 		</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>mustWakeEnqueuers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>66</span><span class=w> 			</span><span class=n>enqLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>67</span><span class=w> 			</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>68</span><span class=w> 				</span><span class=n>notFullCondition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>69</span><span class=w> 			</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>70</span><span class=w> 				</span><span class=n>enqLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>71</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>72</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>73</span><span class=w> 		</span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>74</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">10.4 无限全部队列<div id=104-%E6%97%A0%E9%99%90%E5%85%A8%E9%83%A8%E9%98%9F%E5%88%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#104-%E6%97%A0%E9%99%90%E5%85%A8%E9%83%A8%E9%98%9F%E5%88%97 aria-label=锚点>#</a></span></h3><p>无限同步队列不会产生死锁，enq必然成功，deq最多抛出个异常，实现非常简单。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>enq</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=n>Node</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=n>enqLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 			</span><span class=n>tail</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 		</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 			</span><span class=n>enqLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>deq</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>EmptyException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 		</span><span class=n>T</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 		</span><span class=n>deqLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 			</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>head</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 				</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>EmptyException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 			</span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 			</span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 		</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 			</span><span class=n>deqLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 		</span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">10.5 无锁无限队列<div id=105-%E6%97%A0%E9%94%81%E6%97%A0%E9%99%90%E9%98%9F%E5%88%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#105-%E6%97%A0%E9%94%81%E6%97%A0%E9%99%90%E9%98%9F%E5%88%97 aria-label=锚点>#</a></span></h3><p>先简单思考，对于无锁队列（以链表方式实现而言），问题在于：</p><ul><li>enq的时候，怎么确保添加到最后一个节点。换言之，我一开始看到的last和最后写入的last是一个吗？</li><li>tail->next的变化和tail的变化是同一步吗？怎么保证两个都成功？换言之，怎么保证添加新节点和挪动tail指针是原子的呢？我们必然得先添加新节点，再挪动tail指针。</li></ul><p>相对应的，我们针对这两个问题分析：</p><ul><li>enq的时候，如果last不是tail，说明最后节点失效。如果next不为NULL，说明最后节点有人添加，但是未必失效。所以在此CompareAndSet(tail)节点。我感觉没必要。。。。。实际上函数里面如果发现tail不是last节点，就重新获取last节点。</li><li>每次操作都是确保在当时last == tail的，然后尝试添加。如果发现next不是NULL，那么再次尝试重新获取tail。如果是NULL那么CompareAndSet，CAS成功了的话，更新tail，如果不成功说明有别的更新tail了，我们不用管。实际上还是通过CAS来保证添加新节点和挪动tail指针两步虽然是分割的，但是实际执行起来是原子的。每一步的检查都在确定当前的last节点是最后一个节点。</li></ul><p>现在分析一下，该队列。更新tail节点是lazy的，enq方法的29-31行实际上帮助了tail的挪动。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LockFreeQueue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;</span><span class=w> </span><span class=n>head</span><span class=p>,</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>LockFreeQueue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 			</span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 		</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Node</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>Node</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 			</span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 			</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>enq</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 		</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 			</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>last</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>tail</span><span class=p>.</span><span class=na>get</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 				</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>last</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>next</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 						</span><span class=n>tail</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>last</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 						</span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 				</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> 					</span><span class=n>tail</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>last</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>deq</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>EmptyException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>36</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>37</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>38</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>39</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>40</span><span class=w> 			</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>.</span><span class=na>get</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>41</span><span class=w> 				</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>last</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>42</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>43</span><span class=w> 						</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>EmptyException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>44</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>45</span><span class=w> 					</span><span class=n>tail</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>last</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>46</span><span class=w> 				</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>47</span><span class=w> 					</span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>48</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>head</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>first</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>49</span><span class=w> 					</span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>50</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>51</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>52</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>53</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">10.6 内存回收和ABA问题<div id=106-%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E5%92%8Caba%E9%97%AE%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#106-%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E5%92%8Caba%E9%97%AE%E9%A2%98 aria-label=锚点>#</a></span></h3><p>本节主要说的是内存回收</p><ul><li>每个线程维持自己的内存回收队列是最简单的实现，自己操作自己不会引起任何同步问题。</li></ul><h3 class="relative group">10.7 双数数据结构<div id=107-%E5%8F%8C%E6%95%B0%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#107-%E5%8F%8C%E6%95%B0%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84 aria-label=锚点>#</a></span></h3><p>这个实际上我没看，感觉用处不大。</p><h2 class="relative group">第11章 栈和释放(?)<div id=%E7%AC%AC11%E7%AB%A0-%E6%A0%88%E5%92%8C%E9%87%8A%E6%94%BE class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%AC%AC11%E7%AB%A0-%E6%A0%88%E5%92%8C%E9%87%8A%E6%94%BE aria-label=锚点>#</a></span></h2><h3 class="relative group">11.1-11.2 无锁栈<div id=111-112-%E6%97%A0%E9%94%81%E6%A0%88 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#111-112-%E6%97%A0%E9%94%81%E6%A0%88 aria-label=锚点>#</a></span></h3><p>CompareAndSet的实现，没啥问题</p><h3 class="relative group">11.3-11.4 消除（？）<div id=113-114-%E6%B6%88%E9%99%A4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#113-114-%E6%B6%88%E9%99%A4 aria-label=锚点>#</a></span></h3><p>之所以无锁栈性能不好，不是因为top产生了竞争，而是因为强制要求线性并发，不能多个同时burst。这里我们引入一个观察：一个push和一个pop会相互抵消，因此如果直接取消一对push和pop，就可以不对栈做操作。实际上这里是在数组里面添加了一个缓冲垫&mdash;一个缓冲数组。但是这个方法实际上并不再是后入后出了。而且只要对数组操作就有满不满吧？此外，我得说那个投票的笑话太牛逼了，一下子把出现的问题描述的非常清楚。</p><h4 class="relative group">11.4.1 交换类型的实现<div id=1141-%E4%BA%A4%E6%8D%A2%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AE%9E%E7%8E%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1141-%E4%BA%A4%E6%8D%A2%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AE%9E%E7%8E%B0 aria-label=锚点>#</a></span></h4><p>本质上是个缓冲垫，这个里面还有个问题就是，每个线程的随机数发生器必须不一样！否则都打到一个线程上了。缓冲垫不再随机，性能随之下降，相当于退化为原本的无锁栈了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LockFreeExchanger</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>EMPTY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...,</span><span class=w> </span><span class=n>WAITING</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...,</span><span class=w> </span><span class=n>BUSY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=n>AtomicStampedReference</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>slot</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicStampedReference</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>exchange</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>myItem</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 		</span><span class=kd>throws</span><span class=w> </span><span class=n>TimeoutException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=kt>long</span><span class=w> </span><span class=n>nanos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unit</span><span class=p>.</span><span class=na>toNanos</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 			</span><span class=kt>long</span><span class=w> </span><span class=n>timeBound</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>nanos</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 			</span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>stampHolder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>EMPTY</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 			</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 				</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>timeBound</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 				</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>TimeoutException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 				</span><span class=n>T</span><span class=w> </span><span class=n>yrItem</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>slot</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>stampHolder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 				</span><span class=kt>int</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stampHolder</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w>				 </span><span class=nf>switch</span><span class=p>(</span><span class=n>stamp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 					</span><span class=k>case</span><span class=w> </span><span class=n>EMPTY</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 						</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>slot</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>yrItem</span><span class=p>,</span><span class=w> </span><span class=n>myItem</span><span class=p>,</span><span class=w> </span><span class=n>EMPTY</span><span class=p>,</span><span class=w> </span><span class=n>WAITING</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 							</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>timeBound</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 								</span><span class=n>yrItem</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>slot</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>stampHolder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 								</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>stampHolder</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>BUSY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 									</span><span class=n>slot</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>EMPTY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 									</span><span class=k>return</span><span class=w> </span><span class=n>yrItem</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 								</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 							</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 							</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>slot</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>myItem</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>WAITING</span><span class=p>,</span><span class=w> </span><span class=n>EMPTY</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 								</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>TimeoutException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 							</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 								</span><span class=n>yrItem</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>slot</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>stampHolder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 								</span><span class=n>slot</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>EMPTY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 								</span><span class=k>return</span><span class=w> </span><span class=n>yrItem</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> 							</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 						</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 					</span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 					</span><span class=k>case</span><span class=w> </span><span class=n>WAITING</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 						</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>slot</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>yrItem</span><span class=p>,</span><span class=w> </span><span class=n>myItem</span><span class=p>,</span><span class=w> </span><span class=n>WAITING</span><span class=p>,</span><span class=w> </span><span class=n>BUSY</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 							</span><span class=k>return</span><span class=w> </span><span class=n>yrItem</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>36</span><span class=w> 					</span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>37</span><span class=w> 					</span><span class=k>case</span><span class=w> </span><span class=n>BUSY</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>38</span><span class=w> 					</span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>39</span><span class=w> 					</span><span class=k>default</span><span class=p>:</span><span class=w> </span><span class=c1>// impossible</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>40</span><span class=w> 					</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>41</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>42</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>43</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>44</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 class="relative group">11.4.2 缓冲垫下的并发栈<div id=1142-%E7%BC%93%E5%86%B2%E5%9E%AB%E4%B8%8B%E7%9A%84%E5%B9%B6%E5%8F%91%E6%A0%88 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1142-%E7%BC%93%E5%86%B2%E5%9E%AB%E4%B8%8B%E7%9A%84%E5%B9%B6%E5%8F%91%E6%A0%88 aria-label=锚点>#</a></span></h4><p>并发的缓冲垫，避免原子操作的失败。这里面rangePolicy.getRange()操作如果是小范围的，那么在线程数量不多的情况下就容易增加命中，如果范围很大，会降低线程的忙等。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>EliminationBackoffStack</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>LockFreeStack</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=n>EliminationArray</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>eliminationArray</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EliminationArray</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>capacity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=kd>static</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>RangePolicy</span><span class=o>&gt;</span><span class=w> </span><span class=n>policy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>RangePolicy</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 		</span><span class=kd>protected</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>RangePolicy</span><span class=w> </span><span class=nf>initialValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 			</span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>RangePolicy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>push</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 		</span><span class=n>RangePolicy</span><span class=w> </span><span class=n>rangePolicy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>policy</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 		</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 			</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>tryPush</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 				</span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 			</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 					</span><span class=n>T</span><span class=w> </span><span class=n>otherValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>eliminationArray</span><span class=p>.</span><span class=na>visit</span><span class=p>(</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>rangePolicy</span><span class=p>.</span><span class=na>getRange</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>otherValue</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 						</span><span class=n>rangePolicy</span><span class=p>.</span><span class=na>recordEliminationSuccess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 						</span><span class=k>return</span><span class=p>;</span><span class=w> </span><span class=c1>// exchanged with pop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 				</span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>TimeoutException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 					</span><span class=n>rangePolicy</span><span class=p>.</span><span class=na>recordEliminationTimeout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>pop</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>EmptyException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 		</span><span class=n>RangePolicy</span><span class=w> </span><span class=n>rangePolicy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>policy</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> 			</span><span class=n>Node</span><span class=w> </span><span class=n>returnNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tryPop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 			</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>returnNode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 				</span><span class=k>return</span><span class=w> </span><span class=n>returnNode</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 			</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 					</span><span class=n>T</span><span class=w> </span><span class=n>otherValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>eliminationArray</span><span class=p>.</span><span class=na>visit</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>rangePolicy</span><span class=p>.</span><span class=na>getRange</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 					</span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>otherValue</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>36</span><span class=w> 						</span><span class=n>rangePolicy</span><span class=p>.</span><span class=na>recordEliminationSuccess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>37</span><span class=w> 						</span><span class=k>return</span><span class=w> </span><span class=n>otherValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>38</span><span class=w> 					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>39</span><span class=w> 				</span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>TimeoutException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>40</span><span class=w> 					</span><span class=n>rangePolicy</span><span class=p>.</span><span class=na>recordEliminationTimeout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>41</span><span class=w> 				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>42</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>43</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 class="relative group">第十二章：计数，排序和分布式协作<div id=%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0%E8%AE%A1%E6%95%B0%E6%8E%92%E5%BA%8F%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E4%BD%9C class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0%E8%AE%A1%E6%95%B0%E6%8E%92%E5%BA%8F%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E4%BD%9C aria-label=锚点>#</a></span></h2><p>两种方式衡量并发，很神奇的是，对于分布式系统而言，这两个并不是互相矛盾的.：</p><ul><li>latency, the time it takes an individual method call to complete</li><li>throughput, the overall rate at which method calls complete</li></ul><h3 class="relative group">12.3 软件合并<div id=123-%E8%BD%AF%E4%BB%B6%E5%90%88%E5%B9%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#123-%E8%BD%AF%E4%BB%B6%E5%90%88%E5%B9%B6 aria-label=锚点>#</a></span></h3><p>合并树，本质是每次都让主动的进程去做操作。但是这个实现并不是那么简单，每个节点都要自旋一段时间，来保证两个线程可以碰上对方，因此给个节点要有自己的状态码。不过想一想合并树这个操作真的还挺骚，但是在最极端的情况下，这个算法并不怎么好使</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Node</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=kd>enum</span><span class=w> </span><span class=n>CStatus</span><span class=p>{</span><span class=n>IDLE</span><span class=p>,</span><span class=w> </span><span class=n>FIRST</span><span class=p>,</span><span class=w> </span><span class=n>SECOND</span><span class=p>,</span><span class=w> </span><span class=n>RESULT</span><span class=p>,</span><span class=w> </span><span class=n>ROOT</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=kt>boolean</span><span class=w> </span><span class=n>locked</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=n>CStatus</span><span class=w> </span><span class=n>cStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 		</span><span class=kt>int</span><span class=w> </span><span class=n>firstValue</span><span class=p>,</span><span class=w> </span><span class=n>secondValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 		</span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 		</span><span class=n>Node</span><span class=w> </span><span class=n>parent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>Node</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 			</span><span class=n>cStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CStatus</span><span class=p>.</span><span class=na>ROOT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 			</span><span class=n>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 		</span><span class=kd>public</span><span class=w> </span><span class=nf>Node</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>myParent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 			</span><span class=n>parent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myParent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 			</span><span class=n>cStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CStatus</span><span class=p>.</span><span class=na>IDLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 			</span><span class=n>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 	</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>合并树代码</p><p>合并树的preCombine方法需要保证原子吧，感觉有点问题啊。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>1</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=nf>CombiningTree</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2</span><span class=w> 		</span><span class=n>Node</span><span class=o>[]</span><span class=w> </span><span class=n>nodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>[</span><span class=n>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>3</span><span class=w> 		</span><span class=n>nodes</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>4</span><span class=w> 		</span><span class=nf>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>nodes</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>5</span><span class=w> 			</span><span class=n>nodes</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>nodes</span><span class=o>[</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=n>1</span><span class=p>)</span><span class=o>/</span><span class=n>2</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>6</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>7</span><span class=w> 		</span><span class=n>leaf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>[</span><span class=n>width</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>8</span><span class=w> 		</span><span class=nf>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>leaf</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>9</span><span class=w> 			</span><span class=n>leaf</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nodes</span><span class=o>[</span><span class=n>nodes</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>10</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>11</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>12</span><span class=w> 	</span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndIncrement</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>13</span><span class=w> 		</span><span class=n>Stack</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;</span><span class=w> </span><span class=n>stack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Stack</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>14</span><span class=w> 		</span><span class=n>Node</span><span class=w> </span><span class=n>myLeaf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>leaf</span><span class=o>[</span><span class=n>ThreadID</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=o>/</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>15</span><span class=w> 		</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myLeaf</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>16</span><span class=w> 		</span><span class=c1>// precombining phase</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>17</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>precombine</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>18</span><span class=w> 			</span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>parent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>19</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>20</span><span class=w> 		</span><span class=n>Node</span><span class=w> </span><span class=n>stop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>21</span><span class=w> 		</span><span class=c1>// combining phase</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>22</span><span class=w> 		</span><span class=kt>int</span><span class=w> </span><span class=n>combined</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>23</span><span class=w> 		</span><span class=nf>for</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myLeaf</span><span class=p>;</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>stop</span><span class=p>;</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>parent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>24</span><span class=w> 			</span><span class=n>combined</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>combine</span><span class=p>(</span><span class=n>combined</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>25</span><span class=w> 			</span><span class=n>stack</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>26</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>27</span><span class=w> 		</span><span class=c1>// operation phase</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>28</span><span class=w> 		</span><span class=kt>int</span><span class=w> </span><span class=n>prior</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stop</span><span class=p>.</span><span class=na>op</span><span class=p>(</span><span class=n>combined</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>29</span><span class=w> 		</span><span class=c1>// distribution phase</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>30</span><span class=w> 		</span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stack</span><span class=p>.</span><span class=na>empty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>31</span><span class=w> 			</span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stack</span><span class=p>.</span><span class=na>pop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>32</span><span class=w> 			</span><span class=n>node</span><span class=p>.</span><span class=na>distribute</span><span class=p>(</span><span class=n>prior</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>33</span><span class=w> 		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>34</span><span class=w> 		</span><span class=k>return</span><span class=w> </span><span class=n>prior</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>35</span><span class=w> 	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>对流程的理解还是得看图，a和b图时A处于preCombine阶段，c图时，A负责combine负责合并底下的每个节点，它先等待B线程释放锁。d图B释放了锁，然后A获得锁开始合并。A在operation阶段，如果是操作root节点，那就直接加了。如果不是，那就将值存到左值，然后通知每个被block的节点。结果返回了，A进入分发阶段，</p><p><figure><img class="my-0 rounded-md" loading=lazy src=imgs/figure_12_3_combine_tree.png alt=流程操作></figure></p><h3 class="relative group">12.5 计数网络<div id=125-%E8%AE%A1%E6%95%B0%E7%BD%91%E7%BB%9C class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#125-%E8%AE%A1%E6%95%B0%E7%BD%91%E7%BB%9C aria-label=锚点>#</a></span></h3><p>唉，尴尬</p><p><figure><img class="my-0 rounded-md" loading=lazy src=https://i.loli.net/2020/08/27/BFHNyfpx3EsIDUG.jpg alt=狗头的赞赏码.jpg></figure></p></div></div><script>var oid="views_posts\\2021-01-26-多处理编程的艺术第二版笔记\\index.md",oid_likes="likes_posts\\2021-01-26-多处理编程的艺术第二版笔记\\index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/2021-01-24-%E5%86%85%E5%AD%98%E5%AD%A6%E4%B9%A04-%E7%90%86%E8%A7%A3linux%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">内存学习(4)-理解linux虚拟内存管理</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-01-24T00:00:00+00:00>2021 年 1 月 24 日</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/2021-01-28-%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">代码整洁之道</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-01-28T00:00:00+00:00>2021 年 1 月 28 日</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">© 2025 - 2025 菜狗 All Rights Reserved.</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a> 强力驱动</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://hxndg.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>