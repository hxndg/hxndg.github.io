<!doctype html><html lang=cn dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>2023-03-25-去tm的八股文 &#183; 菜狗的blog</title>
<meta name=title content="2023-03-25-去tm的八股文 &#183; 菜狗的blog"><meta name=description content="菜狗's website"><meta name=keywords content="八股,"><link rel=canonical href=https://hxndg.github.io/posts/2023-03-25-%E5%8E%BBtm%E7%9A%84%E5%85%AB%E8%82%A1%E6%96%87/><link type=text/css rel=stylesheet href=/css/main.bundle.min.ba3775bebd52a2b4837f8da64e32ee36e5c52bf284a0ce2262562782398b701543947527ad1498487717b1b96fe2a4e48d365a02e0b5d00e224893052e99d83c.css integrity="sha512-ujd1vr1SorSDf42mTjLuNuXFK/KEoM4iYlYngjmLcBVDlHUnrRSYSHcXsblv4qTkjTZaAuC10A4iSJMFLpnYPA=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.764eb2fe8d6a6b086c7c58f87d12c64fa79a7585117fc27eb53f688f80c287a6eff16277f9d186cd223a39ff700e294d64482834faece5e07ee0498fa042d056.js integrity="sha512-dk6y/o1qawhsfFj4fRLGT6eadYURf8J+tT9oj4DCh6bv8WJ3+dGGzSI6Of9wDilNZEgoNPrs5eB+4EmPoELQVg==" data-copy data-copied></script><script src=/lib/zoom/zoom.min.3530c2657381259433194af312ec3d322a97a2ad85661810299757fe793b24c3b8e07ab97fa8e5cf96cff1208f271e75394b6eaa56c2e39e7e2c3ca49fb1921c.js integrity="sha512-NTDCZXOBJZQzGUrzEuw9MiqXoq2FZhgQKZdX/nk7JMO44Hq5f6jlz5bP8SCPJx51OUtuqlbC455+LDykn7GSHA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://hxndg.github.io/posts/2023-03-25-%E5%8E%BBtm%E7%9A%84%E5%85%AB%E8%82%A1%E6%96%87/"><meta property="og:site_name" content="菜狗的blog"><meta property="og:title" content="2023-03-25-去tm的八股文"><meta property="og:description" content="菜狗's website"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-25T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-25T00:00:00+00:00"><meta property="article:tag" content="八股"><meta property="og:image" content="https://hxndg.github.io/posts/2023-03-25-%E5%8E%BBtm%E7%9A%84%E5%85%AB%E8%82%A1%E6%96%87/featured.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hxndg.github.io/posts/2023-03-25-%E5%8E%BBtm%E7%9A%84%E5%85%AB%E8%82%A1%E6%96%87/featured.png"><meta name=twitter:title content="2023-03-25-去tm的八股文"><meta name=twitter:description content="菜狗's website"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"2023-03-25-去tm的八股文","headline":"2023-03-25-去tm的八股文","inLanguage":"zh-cn","url":"https:\/\/hxndg.github.io\/posts\/2023-03-25-%E5%8E%BBtm%E7%9A%84%E5%85%AB%E8%82%A1%E6%96%87\/","author":{"@type":"Person","name":"菜狗"},"copyrightYear":"2023","dateCreated":"2023-03-25T00:00:00\u002b00:00","datePublished":"2023-03-25T00:00:00\u002b00:00","dateModified":"2023-03-25T00:00:00\u002b00:00","keywords":["八股"],"mainEntityOfPage":"true","wordCount":"11711"}]</script><meta name=author content="菜狗"><script src=/lib/jquery/jquery.slim.min.03cb160e3cfdb2667a2e2c80d283bebcf63ff8bbc4b629c9ab2babf6fae1d0c07ad470edae783efa4fabda2ac01c58d60e63b98b3c336be8208460f08f4354f5.js integrity="sha512-A8sWDjz9smZ6LiyA0oO+vPY/+LvEtinJqyur9vrh0MB61HDtrng++k+r2irAHFjWDmO5izwza+gghGDwj0NU9Q=="></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>跳过正文</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">菜狗的blog</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Home</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Posts</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Tags</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Home</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Posts</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Tags</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/posts/2023-03-25-%E5%8E%BBtm%E7%9A%84%E5%85%AB%E8%82%A1%E6%96%87/featured_hu4932948635932552285.png)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">2023-03-25-去tm的八股文</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2023-03-25T00:00:00+00:00>2023 年 3 月 25 日</time><span class="px-2 text-primary-500">&#183;</span><span>11711 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>24 分钟</span></div></div><div class="flex author"><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">菜狗</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Focus</div><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-cc部分>1 C/C++部分</a></li><li><a href=#2-操作系统部分>2 操作系统部分</a></li><li><a href=#3-网络部分>3 网络部分</a><ul><li><a href=#4-编程题>4 编程题</a></li><li><a href=#5-面试题目收集>5 面试题目收集</a></li></ul></li><li><a href=#结尾>结尾</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-cc部分>1 C/C++部分</a></li><li><a href=#2-操作系统部分>2 操作系统部分</a></li><li><a href=#3-网络部分>3 网络部分</a><ul><li><a href=#4-编程题>4 编程题</a></li><li><a href=#5-面试题目收集>5 面试题目收集</a></li></ul></li><li><a href=#结尾>结尾</a></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h1 class="relative group">去tm的八股文<div id=%E5%8E%BBtm%E7%9A%84%E5%85%AB%E8%82%A1%E6%96%87 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%8E%BBtm%E7%9A%84%E5%85%AB%E8%82%A1%E6%96%87 aria-label=锚点>#</a></span></h1><p>打不过就加入。。。</p><h2 class="relative group">1 C/C++部分<div id=1-cc%E9%83%A8%E5%88%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-cc%E9%83%A8%E5%88%86 aria-label=锚点>#</a></span></h2><ul><li><p>const的作用</p><ul><li>修饰变量，说明变量不可被更改；</li><li>修饰指针要么是指向常量的指针const char* p，这个就是一个变量，它指向的是const char*即常量，要么是自身是常量的指针（常量指针）char* const p，这里的const修饰p；</li><li>修饰引用，指向常量的引用（reference to const），用于形参类型，即避免了拷贝，又避免了函数对值的修改；</li><li>修饰成员函数，说明该成员函数内部不能修改成员变量，写法为<code> int operator[](int idx) const</code></li></ul></li><li><p>Static的作用</p><ul><li><p>修饰普通变量，修改变量的存储区域和生命周期，使变量存储在静态区。且该变量不能在这个文件外面直接进行访问</p><ul><li><p>这里面有一个区别就是C++里面详细区分了local static storage和global static storage</p></li><li><p>如果是函数内部的Static类型变量，在函数内部使用 <code>static</code> 关键字声明局部变量。这样，该变量的值会在函数调用之间保留，但只能在函数内部访问。这个变量实际上也是存储在静态区<strong>静态数据区（static data segment）</strong></p></li></ul></li><li><p>修饰普通函数，使得外部文件不能直接使用该函数（这种文件范围的static可见性限制在C++里面通过嵌套一个匿名namespace废弃掉，但是这个feature估计短期还不会去掉）。</p></li><li><p>修饰成员变量，修饰成员变量使所有的对象只保存一个该变量，而且不需要生成对象就可以访问该成员。</p></li><li><p>修饰成员函数，使得不需要生成对象就可以访问该函数，但是在 static 函数内不能访问非静态成员。换言之就是类的static函数，别人可以直接使用。这个是C++新提供的</p></li></ul></li><li><p>单例模式（因为提到了static，所以直接给出单例模式），可以参考https://www.drdobbs.com/cpp/c-and-the-perils-of-double-checked-locki/184405726</p><ul><li><p>有问题的实现</p><ul><li><p>懒汉式：问题在于多个线程同时操作会有一致性+内存泄露的问题</p><ul><li><pre tabindex=0><code>class Singleton{
private:
    Singleton(){}
    Singleton(Singleton&amp;)=delete;
    Singleton&amp; operator=(const Singleton&amp;)=delete;
    static Singleton* m_instance_ptr;
public:
    ~Singleton(){}
    static Singleton* get_instance(){
        if(m_instance_ptr==nullptr){
              m_instance_ptr = new Singleton;
        }
        return m_instance_ptr;
    }
    void use() const { std::cout &lt;&lt; &#34;in use&#34; &lt;&lt; std::endl; }
};
</code></pre></li></ul></li><li><p>DCL（双检锁）懒汉式，这个实际上也有问题m_instance_ptr的判断实际上也可能受到一致性的问题</p><ul><li><pre tabindex=0><code>class Singleton{
public:
    typedef std::shared_ptr&lt;Singleton&gt; Ptr;
    ~Singleton(){}
    Singleton(Singleton&amp;)=delete;
    Singleton&amp; operator=(const Singleton&amp;)=delete;
    static Ptr get_instance(){
        // &#34;double checked lock&#34;
        if(m_instance_ptr==nullptr){
            std::lock_guard&lt;std::mutex&gt; lk(m_mutex);
            if(m_instance_ptr == nullptr){
              m_instance_ptr = std::shared_ptr&lt;Singleton&gt;(new Singleton);
            }
        }
        return m_instance_ptr;
    }


private:
    Singleton(){
        std::cout&lt;&lt;&#34;constructor called!&#34;&lt;&lt;std::endl;
    }
    static Ptr m_instance_ptr;
    static std::mutex m_mutex;
};
</code></pre></li></ul></li><li><p>饿汉式</p></li></ul></li><li><p>没问题的实现，使用了C++11保证的局部静态变量线程一致性。这里的Singleton的实例的生命周期从声明到程序结束，一直都存在，所以也是懒汉式，毕竟也是用到了才有</p><ul><li><p>懒汉式+CRTP（使用CRTP来保证肯定有方法）</p><ul><li><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SingletonCRTP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=n>T</span><span class=o>&amp;</span> <span class=n>GetInstance</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=n>T</span> <span class=n>instance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>instance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=c1>// why must be protected? Derived Singleton will call implicited 
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>protected</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=n>SingletonCRTP</span><span class=p>()</span> <span class=o>=</span> <span class=k>default</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>~</span><span class=n>SingletonCRTP</span><span class=p>()</span> <span class=o>=</span> <span class=k>default</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 禁止拷贝构造和赋值操作
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>SingletonCRTP</span><span class=p>(</span><span class=k>const</span> <span class=n>SingletonCRTP</span><span class=o>&amp;</span><span class=p>)</span> <span class=o>=</span> <span class=k>delete</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>SingletonCRTP</span><span class=o>&amp;</span> <span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>SingletonCRTP</span><span class=o>&amp;</span><span class=p>)</span> <span class=o>=</span> <span class=k>delete</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MySingleton</span> <span class=o>:</span> <span class=k>public</span> <span class=n>SingletonCRTP</span><span class=o>&lt;</span><span class=n>MySingleton</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=n>PrintMessage</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;This is a message from MySingleton.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div></li></ul><ul><li><p>关于上面的CRTP，有一个有趣的地方，我写过一个task_pool的代码，内部使用范型进行代码管理，发现一个尴尬的问题，这里内存分配太大，然后程序崩了。。。把kDefaultSize改小就可以了。。。说实话，这个我是真没想到。。。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;concepts&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;type_traits&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>constexpr</span> <span class=n>size_t</span> <span class=n>kDefaultSize</span> <span class=o>=</span> <span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=k>concept</span> <span class=n>HasXXXType</span> <span class=o>=</span> <span class=k>requires</span> <span class=p>{</span> <span class=k>typename</span> <span class=n>T</span><span class=o>::</span><span class=n>xxx</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>N</span> <span class=o>=</span> <span class=n>kDefaultSize</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Pool</span> <span class=o>:</span> <span class=k>public</span> <span class=n>SingletonCRTP</span><span class=o>&lt;</span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=k>class</span> <span class=nc>SingletonCRTP</span><span class=o>&lt;</span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Pool</span><span class=p>()</span> <span class=o>:</span> <span class=n>mpmc_</span><span class=p>(</span><span class=n>kDefaultSize</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34; mpmc create with &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>kDefaultSize</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>Push</span><span class=p>(</span><span class=n>T</span><span class=o>::</span><span class=n>xxx</span><span class=o>&amp;</span> <span class=n>task</span><span class=p>)</span> <span class=k>requires</span> <span class=n>HasXXXType</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span> <span class=k>return</span> <span class=n>mpmc_</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>task</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>Pop</span><span class=p>(</span><span class=n>T</span><span class=o>::</span><span class=n>xxx</span><span class=o>&amp;</span> <span class=n>task</span><span class=p>)</span> <span class=k>requires</span> <span class=n>HasXXXType</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span> <span class=k>return</span> <span class=n>mpmc_</span><span class=p>.</span><span class=n>pop</span><span class=p>(</span><span class=n>task</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=nf>TryPush</span><span class=p>(</span><span class=n>T</span><span class=o>::</span><span class=n>xxx</span> <span class=n>task</span><span class=p>)</span> <span class=k>requires</span> <span class=n>HasXXXType</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span> <span class=k>return</span> <span class=n>mpmc_</span><span class=p>.</span><span class=n>try_push</span><span class=p>(</span><span class=n>task</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=nf>TryPop</span><span class=p>(</span><span class=n>T</span><span class=o>::</span><span class=n>xxx</span> <span class=n>task</span><span class=p>)</span> <span class=k>requires</span> <span class=n>HasXXXType</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span> <span class=k>return</span> <span class=n>mpmc_</span><span class=p>.</span><span class=n>try_pop</span><span class=p>(</span><span class=n>task</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里就可以随便写了，比方说使用rigtorp的mpmc来存储对应T的某个类型
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div></li></ul></li></ul></li></ul></li><li><p>inline的作用</p><ul><li>内联函数展开，直接执行函数体，避免参数压栈，针栈开辟回收啥的，但会做安全检查或自动类型转换（同普通函数</li><li>只是建议编译器展开，具体是否展开不一定，编译器一般不内联包含循环、递归、switch 等复杂操作的内联函数；</li><li>在类声明中定义的函数，除了虚函数的其他函数都会自动隐式地当成内联函数。<ul><li>问题1:虚函数可以是内连函数吗？虚函数可以是内联函数，内联是可以修饰虚函数的，但是当虚函数表现多态性的时候不能内联。毕竟runtime鬼知道是谁</li></ul></li></ul></li><li><p>volatile的作用</p><ul><li>volatile 关键字是一种类型修饰符，用它声明的类型变量表示可以被某些编译器未知的因素（操作系统、硬件、其它线程等）更改。所以使用 volatile 告诉编译器不应对这样的对象进行优化。</li><li>volatile 关键字声明的变量，每次访问时都必须从内存中取出值</li><li>我基本不用这个，多线程下这个volatile没同步，没有内存屏障，甚至执行顺序都不保证。实际上C++11之后就基本都是什么内存序的东西，对这个也不吭声了，哈哈哈哈。这个除非是直接硬件底层编程，比方说嵌入式啥的有承诺才用</li></ul></li><li><p>#program pack(n)的作用</p><ul><li><p>设定结构体、联合以及类成员变量以 n 字节方式对齐。#program经常用来关闭特定类型的warn消息，也用来pack struct。一般来说，如果要设定的结构体是个精确控制的内存map结构，换言之要求多少多少字节的位置是成员变量的位置才需要这个东西</p></li><li><p>一般你以多少字节对齐？64位GCC一般是8字节对齐</p></li><li><p>补充对齐的基础知识：</p><ul><li>结构体第一个成员的<strong>偏移量（offset）<strong>为0，以后每个成员相对于结构体首地址的 offset 都是</strong>该成员大小与实际的对齐值 中较小那个</strong>的整数倍，如有需要编译器会在成员之间加上填充字节。</li><li><strong>结构体的总大小</strong>为 实际的对齐值 的<strong>整数倍</strong>，如有需要编译器会在最末一个成员之后加上填充字节。</li></ul><p>关于对齐值：</p><ul><li>基本类型的对齐值就是其sizeof值</li><li>结构体的对齐值是其成员的最大对齐值</li><li>编译器可以设置一个对齐值，但是类型的实际对齐值是该类型的对齐值与设定的对齐值取最小值得来。</li><li>结构体的成员为数组的时候，计算对齐值是根据数据元素的长度，而不是数组的整体大小</li></ul></li><li></li></ul></li><li><p>c++构造相关</p><ul><li><p>explict关键字</p><ul><li>explicit 修饰构造函数时，可以防止隐式转换和复制初始化</li><li>explicit 修饰转换函数时，可以防止隐式转换，但 <a href=https://zh.cppreference.com/w/cpp/language/implicit_conversion target=_blank>按语境转换</a> 除外</li></ul></li><li><p>成员初始化列表</p><ul><li><p>好处为初始化列表不需要定义默认构造函数，直接就会调用对应的构造函数</p></li><li><p>使用方法为</p><pre tabindex=0><code></code></pre></li><li><p>有些场合必须用初始化列表</p><ul><li>常量成员：常量成员只能初始化，不能赋值，所以必须放在初始化列表里</li><li>引用类型：引用类型必须在定义时初始化，切不能重新赋值</li><li>没有默认构造函数的类型：使用初始化列表不需要默认构造函数构造</li></ul></li></ul></li><li><p>如何定义一个只能在堆上生成对象的类：</p><ul><li>方法1(比较糟糕的方法）：将析构函数设置为私有，原因：C++ 是静态绑定语言，编译器管理栈上对象的生命周期，编译器在为类对象分配栈空间时，会先检查类的析构函数的访问性。若析构函数不可访问，则不能在栈上创建对象。初次之外，还需要<ul><li><strong>禁用拷贝构造:</strong> 防止通过拷贝构造函数在栈上创建对象的副本。</li><li><strong>禁用赋值操作符:</strong> 防止通过赋值操作符将一个堆对象赋值给栈对象。</li></ul></li><li>方法2：将构造函数全都定义为Protected/Privated类型，即禁用栈分配。然后创建一个Static函数，代表<strong>静态工厂方法:</strong> 提供一个静态的 <code>Create()</code> 方法，该方法在堆上分配内存并返回一个 <code>std::unique_ptr</code>，指向新创建的对象。</li></ul></li><li><p>如何定义一个只能在栈上生成对象的类：</p><ul><li>将 new 和 delete 重载为私有，原因：在堆上生成对象，使用 new 关键词操作，其过程分为两阶段：第一阶段，使用 new 在堆上寻找可用内存，分配给对象；第二阶段，调用构造函数生成对象。将 new 操作设置为私有，那么第一阶段就无法完成，就不能够在堆上生成对象。</li></ul></li></ul></li><li><p>多态 & 虚函数</p><ul><li>如何实现的？<ul><li>虚函数指针：在含有虚函数类的对象中，指向虚函数表，在运行时确定。</li><li>虚函数表：在程序只读数据段（<code>.rodata section</code>，见：<a href=https://github.com/huihut/interview#%e7%9b%ae%e6%a0%87%e6%96%87%e4%bb%b6%e5%ad%98%e5%82%a8%e7%bb%93%e6%9e%84 target=_blank>目标文件存储结构</a>），存放虚函数指针，如果派生类实现了基类的某个虚函数，则在虚表中覆盖原本基类的那个虚函数指针，在编译时根据类的声明创建。</li></ul></li><li>构造函数能是虚函数吗？奇怪的问题，因为构造的时候都是直接确定要哪个类型的对象，难道还能不确定是啥构造吗？另外In a constructor, the virtual call mechanism is disabled because overriding from derived classes hasn’t yet happened. Objects are constructed from the base up, “base before derived”.</li><li>构造函数里面调用虚函数靠谱吗？不靠谱Calling virtual functions from a constructor or destructor is dangerous and should be avoided whenever possible. All C++ implementations should call the version of the function defined at the level of the hierarchy in the current constructor and no further.</li><li>虚函数可以是inline的吗？虚函数可以是内联函数，内联是可以修饰虚函数的，但是当虚函数表现多态性的时候不能内联。因为inline是编译的时候确定，而虚函数表现为多态性时（运行期）确定，因此不可以内联。</li><li>析构函数能是虚函数吗？析构函数可以是虚函数，另外基类的析构函数一般建议声明为虚函数，否则析构的时候（如果是删除一个基类指针，这个指针指向一个子类对象）那么会造成内存泄漏，因为不定义虚函数，不会调用子类的析构函数。简单说为了解决基类的指针指向派生类对象，并用基类的指针删除派生类对象。</li></ul></li><li><p>Decltype</p><ul><li>decltype 关键字用于检查实体的声明类型或表达式的类型及值分类，说的似乎不是人话，简单说就是decltype is <em>useful when declaring types that are difficult or impossible to declare using standard notation</em>, like lambda-related types or types</li></ul></li><li><p>C++引用</p><ul><li><p>左值引用，常规引用表示对象的身份</p></li><li><p>右值引用，必须绑定到右值（一个临时对象、将要销毁的对象）的引用。实现转移语义（Move Sementics）和精确传递（Perfect Forwarding）</p><ul><li>它可以消除两个对象交互时不必要的对象拷贝；</li><li>能够更简洁明确地定义泛型函数。</li></ul></li></ul></li><li><p>C++左值 & 右值</p><ul><li><p>真正的理解，看https://en.cppreference.com/w/cpp/language/value_category， 左值和右值实际上定义看这里</p><ul><li><p>前置定义：</p><ul><li><p>a <a href=https://en.cppreference.com/w/cpp/language/value_category#glvalue target=_blank>glvalue</a> (“generalized” lvalue) is an expression whose evaluation determines the identity of an object or function; 这里实际上将对象和函数都视为了一类成员</p></li><li><p>a <a href=https://en.cppreference.com/w/cpp/language/value_category#prvalue target=_blank>prvalue</a> (“pure” rvalue) is an expression whose evaluation</p><ul><li><p>computes the value of an operand of a built-in operator (such prvalue has no <em>result object</em>), or</p></li><li><p>initializes an object (such prvalue is said to have a <em>result object</em>).</p><blockquote><p>The result object may be a variable, an object created by <a href=https://en.cppreference.com/w/cpp/language/new target=_blank>new-expression</a>, a temporary created by <a href=https://en.cppreference.com/w/cpp/language/implicit_conversion#Temporary_materialization target=_blank>temporary materialization</a>, or a member thereof. Note that non-void <a href=https://en.cppreference.com/w/cpp/language/expressions#Discarded-value_expressions target=_blank>discarded</a> expressions have a result object (the materialized temporary). Also, every class and array prvalue has a result object except when it is the operand of <a href=https://en.cppreference.com/w/cpp/language/decltype target=_blank><code>decltype</code></a>;</p></blockquote></li></ul></li></ul><ul><li>an <a href=https://en.cppreference.com/w/cpp/language/value_category#xvalue target=_blank>xvalue</a> (an “eXpiring” value) is a glvalue that denotes an object whose resources can be reused;</li></ul></li><li><p>根本定义</p><ul><li>an <a href=https://en.cppreference.com/w/cpp/language/value_category#lvalue target=_blank>lvalue</a> is a glvalue that is not an xvalue;</li><li>an <a href=https://en.cppreference.com/w/cpp/language/value_category#rvalue target=_blank>rvalue</a> is a prvalue or an xvalue;</li></ul></li></ul></li><li><p>概念上理解左值右值过于离谱，简单说就是</p><ul><li>右值就是纯右值+消亡值</li><li>左值就是上述的其他</li></ul></li><li><p>这里又引出来几个新的问题</p><ul><li><p>foo(T a)</p><ul><li><p><strong>Pass-by-Value</strong></p></li><li><p>传值会导致拷贝构造，这种情况下无论传递的是左值还是右值，都会导致出现一次</p><ul><li>对于右值，移动构造的语意优先级更高，所以对于右值而言通常优先调用移动构造函数。但是如果移动构造函数被=delete，就会调用拷贝构造函数</li></ul></li></ul></li><li><p>foo(T &amp;a)</p><ul><li><strong>Pass-by-Reference</strong></li><li>调用的时候，只有传递左值才能正确调用，操作也是在左值上操作</li></ul></li><li><p>foo(T &&amp;a)</p><ul><li><strong>Pass-by-Rvalue-Reference</strong></li></ul></li></ul></li></ul></li><li><p>C11相关的东西</p><ul><li><p>智能指针</p><ul><li><p>shared_ptr</p><ul><li><p>Class shared_ptr 实现共享式拥有（shared ownership）概念。多个智能指针指向相同对象，该对象和其相关资源会在 “最后一个 reference 被销毁” 时被释放。为了在结构较复杂的情景中执行上述工作，标准库提供 weak_ptr、bad_weak_ptr 和 enable_shared_from_this 等辅助类。</p></li><li><p>线程安全：计数器是原子的，但是包裹的对象不一定是</p></li><li><p>内存安全：</p><ul><li><p>可能存在的内存泄漏的点，参考https://stackoverflow.com/questions/38298008/possible-memory-leaks-with-smart-pointers</p><ul><li>shared_ptr环引用，最简单的情况是两个智能指针互指，稍微复杂一些就是， a <code>shared_ptr</code> to <code>A</code>, which directly or indirectly holds a <code>shared_ptr</code> back to <code>A</code>, <code>A</code>&rsquo;s use count will be 2.。英文是circular references like this，解决方式是把一个换成weak_ptr，one object should hold a <a href=http://www.boost.org/doc/libs/1_41_0/libs/smart_ptr/weak_ptr.htm target=_blank><code>weak_ptr</code></a> to the other, not a <code>shared_ptr</code>.</li><li>另一种内存泄露的点，在于shared_ptr可能在将new出来的对象真正转换为shared_ptr的时候，因为其他流程崩溃而造成内存泄露。比方说下面的代码，可能在第二步操作就抛异常退出了。不过C++17开始保证函数执行顺序了，所以理论上这个情况也避免了</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>processThing</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MyThing</span><span class=o>&gt;</span><span class=p>(</span><span class=k>new</span> <span class=n>MyThing</span><span class=p>()),</span> <span class=n>get_num_samples</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=c1>// 1 第一步操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>new</span> <span class=n>MyThing</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// 2 第二步操作，在这里crash了
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>get_num_samples</span><span class=p>()</span>  
</span></span><span class=line><span class=cl><span class=c1>// 3 第三步操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MyThing</span><span class=o>&gt;</span><span class=p>()</span>
</span></span></code></pre></div></li></ul></li></ul></li><li><p><code>std::enable_shared_from_this</code> 在 C++ 中的作用是：<strong>让一个类的成员函数能够安全地返回一个指向该类对象的 <code>shared_ptr</code>，从而避免潜在的内存问题。</strong></p><ul><li><p>问题背景：</p><ul><li>假设你有一个类 <code>Example</code>，你想在其成员函数 <code>get_shared_this()</code> 中返回一个指向自身的 <code>shared_ptr</code>，这个方法有个严重的问题是<strong>当外部有两个独立的 <code>shared_ptr</code> 分别管理 <code>this</code> 对象时，会出现 double-free 问题</strong>。因为这两个 <code>shared_ptr</code> 的引用计数是独立的，当它们都析构时，会重复释放 <code>this</code> 对象。</li></ul><pre tabindex=0><code>class Example {
public:
    std::shared_ptr&lt;Example&gt; get_shared_this() {
        return std::shared_ptr&lt;Example&gt;(this); // 潜在的危险！
    }
private:
    // ...
};
</code></pre></li><li><p>解决办法</p><ul><li><p><strong>继承</strong>: 让 <code>Example</code> 类继承自 <code>std::enable_shared_from_this&lt;Example></code>。</p></li><li><p><strong><code>weak_ptr</code></strong>: <code>enable_shared_from_this</code> 内部维护一个 <code>weak_ptr</code> 指向 <code>this</code> 对象。</p></li><li><p><strong><code>shared_from_this()</code></strong>: 提供 <code>shared_from_this()</code> 成员函数，它通过内部的 <code>weak_ptr</code> 安全地构造 <code>shared_ptr</code>。</p></li></ul></li></ul></li><li><p>unique_ptr</p><ul><li>Class unique_ptr 实现独占式拥有（exclusive ownership）或严格拥有（strict ownership）概念，保证同一时间内只有一个智能指针可以指向该对象。你可以移交拥有权。它对于避免内存泄漏（resource leak）——如 new 后忘记 delete ——特别有用。</li></ul></li><li><p>weak_ptr</p><ul><li>weak_ptr 允许你共享但不拥有某对象，一旦最末一个拥有该对象的智能指针失去了所有权，任何 weak_ptr 都会自动成空（empty）。因此，在 default 和 copy 构造函数之外，weak_ptr 只提供 “接受一个 shared_ptr” 的构造函数。</li></ul></li><li><p>auto_ptr（被 C++11 弃用）</p></li></ul></li><li><p>类型转换</p><ul><li>static_cast：1 用于非多态类型的转换 2 不执行运行时类型检查（转换安全性不如 dynamic_cast）</li><li>dynamic_cast：1 用于多态类型的转换 2 执行行运行时类型检查</li><li>const_cast: 用于删除 const、volatile 和 __unaligned 特性（如将 const int 类型转换为 int 类型 ）</li></ul></li><li><p>运行时类型信息(RTTI)</p><ul><li>typeid，typeid 运算符允许在运行时确定对象的类型；type_id 返回一个 type_info 对象的引用</li><li>typeinfo，type_info 类描述编译器在程序中生成的类型信息。 此类的对象可以有效存储指向类型的名称的指针。</li></ul></li></ul></li><li><p>多态</p><ul><li><p>静态多态，函数重载</p></li><li><p>动态多态，运行绑定</p></li></ul></li><li><p>原子操作怎么实现</p><ul><li><p>in pre-C++ 11 times, had to be performed using (for example) <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686360%28v=vs.85%29.aspx#interlocked_functions" target=_blank>interlocked functions</a> with MSVC or <a href=https://gcc.gnu.org/onlinedocs/gcc-4.4.3/gcc/Atomic-Builtins.html target=_blank>atomic bultins</a> in case of GCC.</p></li><li><p>A regular <code>int</code> has atomic loads and stores. Whats the point of wrapping it with <code>atomic&lt;></code>?our statement is only true for architectures that provide such guarantee of atomicity for stores and/or loads. There are architectures that do not do this. Also, it is usually required that operations must be performed on word-/dword-aligned address to be atomic</p></li><li><p>User level locks involve utilizing the atomic instructions of processor to atomically update a memory space. The atomic instructions involve utilizing a lock prefix on the instruction and having the destination operand assigned to a memory address. The following instructions can run atomically with a lock prefix on current Intel processors: ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, XADD, and XCHG. [&mldr;] On most instructions a lock prefix must be explicitly used except for the xchg instruction where the lock prefix is implied if the instruction involves a memory address</p><p>In the days of Intel 486 processors, the lock prefix used to assert a lock on the bus along with a large hit in performance. Starting with the Intel Pentium Pro architecture, the bus lock is transformed into a cache lock. A lock will still be asserted on the bus in the most modern architectures if the lock resides in uncacheable memory or if the lock extends beyond a cache line boundary splitting cache lines. Both of these scenarios are unlikely, so most lock prefixes will be transformed into a cache lock which is much less expensive.</p><p>This means the CPU delays responding to MESI requests to invalidate or share the cache line, keeping exclusive access so no other CPU can look at it. MESI cache coherency always requires exclusive ownership of a cache line before a core can modify it so this is cheap if we already owned the line</p></li></ul></li><li></li></ul><h2 class="relative group">2 操作系统部分<div id=2-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%83%A8%E5%88%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%83%A8%E5%88%86 aria-label=锚点>#</a></span></h2><ul><li><p>死锁的条件</p><ul><li></li></ul></li><li><p>进程和线程</p><ul><li><p>进程是资源分配的独立单位，线程是资源调度的独立单位</p></li><li><p>进程的内存布局</p><ul><li><pre tabindex=0><code>   高地址
  +------------------+
  |       栈         |   &lt;- ebp (高地址),
  +------------------+              //栈存放参数,局部变量。通常也就几MB大小
  |                  |   &lt;- esp
  |                  |
  +------------------+
  |       堆         |   &lt;- 堆顶 //
  |                  |
  |                  |
  +------------------+
  |  共享库区域        |
  +------------------+
  |                  |
  |   数据段(.bss)    |
  |                  |
  +------------------+
  |   数据段(.data)   |
  +------------------+
  |    代码段         |
  +------------------+
  | 命令行参数/环境变量 |
  +------------------+
     低地址
</code></pre></li><li><p>详细描述</p><ul><li>栈：由操作系统自动分配释放，存放函数的参数值、局部变量等的值，用于维护函数调用的上下文<ul><li>栈的大小一般是有限制的，用来避免占用过多内存资源，linux默认应该是<strong>8192 kb</strong></li></ul></li><li>堆：一般由程序员分配释放，若程序员不释放，程序结束时可能由操作系统回收，用来容纳应用程序动态分配的内存区域<ul><li>堆的大小是否有限制？<strong>理论上，堆的大小可以非常大，甚至可以达到 GB 级别</strong></li></ul></li><li>共享库：存储程序运行时动态加载的共享库代码和数据。</li><li>数据端：存储程序中已初始化的全局变量和静态变量。<ul><li>根据数据类型的不同，数据段进一步划分为：<ul><li>初始化数据段（.data）：存储已经初始化的非零全局变量和静态变量。</li><li>未初始化数据段（.bss）：存储未初始化或者初始化为零的全局变量和静态变量。</li></ul></li></ul></li><li>代码端：存储程序的可执行代码，也就是机器指令。</li></ul></li></ul></li><li><p>进程之间私有和共享的资源</p></li><li><p>线程之间共享和私有的资源</p><ul><li>私有：<ul><li><strong>栈(Stack):</strong> 每个线程拥有独立的栈空间，用于存储函数调用信息、局部变量以及函数参数等。这意味着不同线程的局部变量互不干扰，即使变量名相同，也位于不同的内存地址。</li><li><strong>寄存器:</strong> 线程在执行过程中需要使用CPU寄存器存储临时数据。每个线程拥有独立的寄存器组，确保线程切换时数据得以保存。</li><li><strong>线程本地存储(TLS, Thread Local Storage):</strong> 这是专门为线程私有数据设计的机制。通过TLS，可以创建全局变量，但每个线程访问的是该变量的私有副本。</li></ul></li><li>共享：<ul><li><strong>堆(Heap):</strong> 堆内存是所有线程共享的区域，用于动态分配内存。这意味着任何线程都可以访问和修改堆上的数据，因此需要特别注意数据同步和互斥访问。</li><li><strong>全局变量:</strong> 位于全局作用域的变量是所有线程共享的。对全局变量的读写操作需要进行同步控制，否则可能导致数据竞争和程序错误。</li><li><strong>静态变量:</strong> 静态变量的生命周期贯穿整个程序运行，所有线程都可以访问。与全局变量类似，对静态变量的操作也需要进行同步控制。</li><li><strong>文件、数据库等外部资源:</strong> 多个线程可能同时访问同一个文件、数据库连接等外部资源。为了避免数据混乱，需要协调线程对这些资源的访问。</li></ul></li></ul></li></ul></li><li><p>ELF相关：</p><ul><li>对应于</li></ul></li><li><p>程序通信的手段</p><ul><li>无名管道( pipe )；</li><li>高级管道(popen)；</li><li>有名管道 (named pipe)；</li><li>消息队列( message queue )；</li><li>信号量( semophore )；</li><li>共享内存( shared memory )；</li><li>套接字( socket )。</li></ul></li><li><p>线程通信的手段</p></li><li><p>大端序和小端序，x86 linux是小端</p><ul><li><p>Little-Endian就是低位字节排放在内存的低地址端，高位字节排放在内存的高地址端。</p></li><li><p>Big-Endian就是高位字节排放在内存的低地址端，低位字节排放在内存的高地址端。</p><p>举一个例子，比如数字0x12 34 56 78在内存中的表示形式为：</p><p><strong>1)大端模式：</strong></p><p>低地址 &mdash;&mdash;&mdash;&mdash;&mdash;&ndash;> 高地址
0x12 | 0x34 | 0x56 | 0x78</p><p><strong>2)小端模式：</strong></p><p>低地址 &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;> 高地址
0x78 | 0x56 | 0x34 | 0x12</p></li></ul></li><li><p>页面置换算法</p><ul><li>fifo</li><li>lru</li><li>opt</li></ul></li><li><p>内核部分</p><ul><li>上下文切换</li></ul></li></ul><h2 class="relative group">3 网络部分<div id=3-%E7%BD%91%E7%BB%9C%E9%83%A8%E5%88%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-%E7%BD%91%E7%BB%9C%E9%83%A8%E5%88%86 aria-label=锚点>#</a></span></h2><ul><li><p>基础，协议分层五层</p><ul><li>应用层，</li><li>传输层，端到端的报文传递，TCP，UDP</li><li>网络层，负责数据包从源到宿的传递，IP，ICMP，ARP</li><li>数据链路</li><li>物理层</li></ul></li><li><p>从浏览器输入网址，到网页返回发生的过程</p></li><li><p>TCP</p><ul><li><p>该协议的特点：面向连接；只能端到端；全双工；可靠交互；面向字节流</p></li><li><p>怎么保证可靠性</p><ul><li><p><strong>确认和重传机制：</strong></p><ul><li><strong>序列号和确认号：</strong> TCP 使用序列号对每个字节进行编号，接收方使用确认号来告知发送方已成功接收的数据。</li><li><strong>超时重传：</strong> 发送方在发送数据包后会启动一个计时器，如果在计时器超时前没有收到接收方的确认，则会重新发送该数据包。</li><li><strong>累积确认：</strong> 接收方不必为每个收到的数据包都发送确认，可以累积确认多个数据包，提高效率。</li></ul></li><li><p><strong>流量控制：</strong></p><ul><li><p><strong>滑动窗口机制：</strong> 接收方通过通告窗口大小来限制发送方发送数据的速率，避免发送方发送数据过快导致接收方缓冲区溢出。</p></li><li><p><strong>拥塞控制：</strong> 当网络出现拥塞时，TCP 会自动降低发送速率，避免加剧网络拥塞。</p><ul><li><p><strong>慢启动 (Slow Start)</strong></p><ul><li><strong>初始阶段：</strong> 连接建立之初，发送方维护一个拥塞窗口 (cwnd)，初始值很小，通常为 1 个报文段大小 (MSS)。</li><li><strong>指数增长：</strong> 每收到一个 ACK 确认，拥塞窗口大小就翻倍，实现发送速率的指数增长，快速探测网络容量。</li><li><strong>慢启动门限 (ssthresh)：</strong> 当拥塞窗口大小达到慢启动门限值时，慢启动阶段结束，进入拥塞避免阶段。</li></ul><p><strong>2. 拥塞避免 (Congestion Avoidance)</strong></p><ul><li><strong>线性增长：</strong> 拥塞窗口超过慢启动门限后，每收到一个 ACK，拥塞窗口大小只增加 1 个 MSS，实现发送速率的线性增长，避免网络拥塞。</li></ul><p><strong>3. 快速重传 (Fast Retransmit)</strong></p><ul><li><strong>重复 ACK：</strong> 当接收方发现数据包丢失时，会发送重复的 ACK，提示发送方进行重传。</li><li><strong>快速重传：</strong> 发送方如果连续收到 3 个重复 ACK，则认为数据包丢失，立即进行重传，无需等待超时计时器。</li></ul><p><strong>4. 快速恢复 (Fast Recovery)</strong></p><ul><li><strong>拥塞窗口减半：</strong> 快速重传发生后，将慢启动门限设置为当前拥塞窗口大小的一半。</li><li><strong>拥塞窗口调整：</strong> 将拥塞窗口设置为慢启动门限值 + 3 个 MSS，开始执行拥塞避免算法。</li></ul></li></ul></li></ul></li><li><p><strong>校验和：</strong></p><ul><li>TCP 报文段首部包含校验和字段，用于校验数据在传输过程中是否出现错误。</li></ul></li><li><p>连接管理：</p><ul><li><strong>三次握手：</strong> 在传输数据前，TCP 使用三次握手建立可靠的连接，确保双方都准备好进行数据传输。</li><li><strong>四次挥手：</strong> 数据传输结束后，TCP 使用四次挥手断开连接，确保数据传输完整。</li></ul></li></ul></li><li><p>三次握手</p><ul><li><p>为什么需要三次握手：因为信道不可靠，而 TCP 想在不可靠信道上建立可靠地传输，那么三次通信是理论上的最小值。（而 UDP 则不需建立可靠传输，因此 UDP 不需要三次握手。）简单来说就是攀岩，山上扽扽绳子，山下扽扽绳子</p></li><li><p>四次挥手</p><img src=imgs/tcp_close.png alt=tcp_close style=zoom:50%></li><li><p>TCP 为什么要进行四次挥手？ / 为什么 TCP 建立连接需要三次，而释放连接则需要四次？因为 TCP 是全双工模式，客户端请求关闭连接后，客户端向服务端的连接关闭（一二次挥手），服务端继续传输之前没传完的数据给客户端（数据传输），服务端向客户端的连接关闭（三四次挥手）。所以 TCP 释放连接时服务器的 ACK 和 FIN 是分开发送的（中间隔着数据传输），而 TCP 建立连接时服务器的 ACK 和 SYN 是一起发送的（第二次握手），所以 TCP 建立连接需要三次，而释放连接则需要四次。</p></li><li><p>为什么 TCP 连接时可以 ACK 和 SYN 一起发送，而释放时则 ACK 和 FIN 分开发送呢？（ACK 和 FIN 分开是指第二次和第三次挥手）因为客户端请求释放时，服务器可能还有数据需要传输给客户端，因此服务端要先响应客户端 FIN 请求（服务端发送 ACK），然后数据传输，传输完成后，服务端再提出 FIN 请求（服务端发送 FIN）；而连接时则没有中间的数据传输，因此连接时可以 ACK 和 SYN 一起发送。</p></li><li><p>为什么客户端释放最后需要 TIME-WAIT 等待 2MSL 呢？为了保证客户端发送的最后一个 ACK 报文能够到达服务端。若未成功到达，则服务端超时重传 FIN+ACK 报文段，客户端再重传 ACK，并重新计时；另外防止已失效的连接请求报文段出现在本连接中。TIME-WAIT 持续 2MSL 可使本连接持续的时间内所产生的所有报文段都从网络中消失，这样可使下次连接中不会出现旧的连接报文段。</p></li><li><p>如果有大量timewait，说明我们关闭了大量的连接，</p></li><li><p>如果有大量closewait，close_wait的大量出现说明我们作为服务端（关闭的被动方，客户端发起的关闭连接），用户层程序没有把连接关闭，因此占用了大量的closewait和端口。对于服务端而言，这种往往是因为负载均衡器发起了关闭，但是负载均衡器后面的服务没有执行关闭。</p></li></ul></li><li><p>为什么服务一般建议调整timewait和closewait，虽然端口数量和tcp连接数量没直接关系，毕竟tcp四元组嘛。但是每个进程能打开的文件描述符是有限制的，所以一般会建议调整timewait。不过也可以调整打开的文件描述符数量</p></li><li><p>IP报文最大报文和TCP报文最大报文什么区别，如果TCP报文长度大于IP报文呢</p></li></ul></li><li><p>UDP</p></li><li><p>TCP和UDP的区别</p><ul><li>TCP 面向连接，UDP 是无连接的；</li><li>TCP 提供可靠的服务，也就是说，通过 TCP 连接传送的数据，无差错，不丢失，不重复，且按序到达；UDP 尽最大努力交付，即不保证可靠交付</li><li>TCP 的逻辑通信信道是全双工的可靠信道；UDP 则是不可靠信道</li><li>每一条 TCP 连接只能是点到点的；UDP 支持一对一，一对多，多对一和多对多的交互通信</li><li>UDP 没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低（对实时应用很有用，如 IP 电话，实时视频会议等）</li></ul></li><li><p>DNS协议</p></li><li><p>HTTP错误码</p><ul><li>200</li><li>400</li><li>403</li><li>404</li><li>500</li><li>503</li></ul></li><li><p>网络编程</p></li></ul><h3 class="relative group">4 编程题<div id=4-%E7%BC%96%E7%A8%8B%E9%A2%98 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-%E7%BC%96%E7%A8%8B%E9%A2%98 aria-label=锚点>#</a></span></h3><ul><li><p>使用C++实现简单的智能指针</p><ul><li>uniqure_ptr</li></ul><pre tabindex=0><code>template &lt;typename T&gt;
class UniquePtr {
    T* ptr;

public:
    // 这里为什么要加上explicit？隐式转换可能会导致副作用，因此禁止
    // 
    // 假设 SomeClass 是已经定义的类
    //  SomeClass* raw_ptr = new SomeClass();
    //  UniquePtr&lt;SomeClass&gt; ptr1 = raw_ptr;  // 隐式转换
    // 
    //  void fn(UniquePtr&lt;SomeClass&gt; p) { /* ... */ };
    //  SomeClass* raw_ptr = new SomeClass();
    //  fn(raw_ptr);  // raw_ptr 会被隐式转换为 UniquePtr
    // 因此将接受原始指针、手动管理资源的智能指针的构造函数声明为 explicit
    explicit UniquePtr(T* p = nullptr) : ptr(p) {}

    ~UniquePtr() {
        delete ptr;
    }

    UniquePtr(UniquePtr &amp;&amp;up) : ptr(up.ptr) {
        up.ptr = nullptr;
    }

    UniquePtr &amp;operator=(UniquePtr &amp;&amp;up) {
        if (this != &amp;up) {
            delete ptr;
            ptr = up.ptr;
            up.ptr = nullptr;
        }
        return *this;
    }

    T &amp;operator* () const { return *ptr; }

    T *operator-&gt; () const { return ptr; }

    // disable copy 
    UniquePtr(const UniquePtr&amp;) = delete;
    UniquePtr&amp; operator=(const UniquePtr&amp;) = delete;
};
</code></pre><ul><li>shared_ptr</li></ul><pre tabindex=0><code>#include &lt;atomic&gt;

template&lt;typename T&gt;
class SharedPtr {
private:
	T* ptr_;
	std::atomic&lt;int&gt;* count_;
public:
	SharedPtr(T* ptr = nullptr): ptr_(ptr) {
		if (ptr != nullptr) {
			count_= new std::atomic&lt;int&gt;(1);
		}
	}
	~SharedPtr() {
		if(ptr_ != nullptr &amp;&amp; --*count==0) {
			delete ptr_;
			ptr_ = nullptr;
			delete count_;
			count_ = nullptr;
		}
	}
	// 拷贝构造函数不需要考虑是不是给自己赋值的情况
	SharedPtr(const SharedPtr&amp; rhs) {
		count_= rhs.count_;
		ptr_ = rhs.ptr_;
		if (count_ != nullptr) {
			++(*count_);
		}

	}

	SharedPtr&amp; operator=(const SharedPtr&amp; rhs) {
		if (this != &amp;rhs) {
      if (ptr_ !=nullptr &amp;&amp; --(*count_) == 0) {
        delete ptr_;
        ptr_ == nullptr;
        delete count_;
        count_ = nullptr;
      }
      ptr_ = rhs.ptr_;
      count_ = rhs.count_;
      if (count_ != nullptr) {
          ++(*count_);
      }
    }
    return *this;
	}

	T&amp; operator*() {
		return *ptr;
	}

	T* operator-&gt;(){
		return ptr;
	}
}


// 支持自定义删除器的shared_ptr
template &lt;typename T&gt;
class MySharedPtr {
 public:
  // 构造函数
  MySharedPtr(T* ptr = nullptr, void (*deleter)(T*) = nullptr) 
      : ptr_(ptr), 
        deleter_(deleter), 
        count_(ptr ? new std::atomic&lt;int&gt;(1) : nullptr) {}

  // 拷贝构造函数
  MySharedPtr(const MySharedPtr&amp; other) 
      : ptr_(other.ptr_), 
        deleter_(other.deleter_), 
        count_(other.count_) {
    if (count_) {
      (*count_)++;
    }
  }

  // 赋值运算符
  MySharedPtr&amp; operator=(const MySharedPtr&amp; other) {
    if (this != &amp;other) {
      // 减少当前对象的引用计数
      if (count_ &amp;&amp; --(*count_) == 0) {
        if (deleter_) {
          deleter_(ptr_);
        } else {
          delete ptr_;
        }
        delete count_;
      }

      // 复制新对象的指针和引用计数
      ptr_ = other.ptr_;
      deleter_ = other.deleter_;
      count_ = other.count_;
      if (count_) {
        (*count_)++;
      }
    }
    return *this;
  }

  // 析构函数
  ~MySharedPtr() {
    if (count_ &amp;&amp; --(*count_) == 0) {
      if (deleter_) {
        deleter_(ptr_);
      } else {
        delete ptr_;
      }
      delete count_;
    }
  }

  // 解引用运算符
  T&amp; operator*() const { return *ptr_; }
  T* operator-&gt;() const { return ptr_; }

  // 获取原始指针
  T* get() const { return ptr_; }

  // 获取引用计数
  int use_count() const { return count_ ? count_-&gt;load() : 0; }

 private:
  T* ptr_;                 // 指向管理对象的指针
  void (*deleter_)(T*);    // 自定义删除器
  std::atomic&lt;int&gt;* count_; // 引用计数
};
</code></pre></li><li><p>实现shared_ptr和weak_ptr，并且实现enable_shared_from_this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;memory&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;atomic&gt;</span><span class=cp> </span><span class=c1>// 引入 &lt;atomic&gt; 头文件
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 前向声明避免循环依赖
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span> <span class=k>class</span> <span class=nc>SharedPtr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span> <span class=k>class</span> <span class=nc>WeakPtr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ControlBlock</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>T</span><span class=o>*</span> <span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>size_t</span><span class=o>&gt;</span> <span class=n>strong_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>size_t</span><span class=o>&gt;</span> <span class=n>weak_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ControlBlock</span><span class=p>(</span><span class=n>T</span><span class=o>*</span> <span class=n>p</span><span class=p>)</span> <span class=o>:</span> <span class=n>ptr</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=n>strong_count</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=n>weak_count</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>ControlBlock</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>delete</span> <span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>enable_shared_from_this</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>SharedPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>shared_from_this</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>weak_this</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>WeakPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>weak_this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=k>class</span> <span class=nc>SharedPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WeakPtr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SharedPtr</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>SharedPtr</span><span class=p>()</span> <span class=o>:</span> <span class=n>control_block</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>explicit</span> <span class=nf>SharedPtr</span><span class=p>(</span><span class=n>T</span><span class=o>*</span> <span class=n>ptr</span><span class=p>)</span> <span class=o>:</span> <span class=n>control_block</span><span class=p>(</span><span class=k>new</span> <span class=n>ControlBlock</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ptr</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>auto</span> <span class=n>esf</span> <span class=o>=</span> <span class=k>dynamic_cast</span><span class=o>&lt;</span><span class=n>enable_shared_from_this</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;*&gt;</span><span class=p>(</span><span class=n>ptr</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>esf</span><span class=o>-&gt;</span><span class=n>weak_this</span> <span class=o>=</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SharedPtr</span><span class=p>(</span><span class=k>const</span> <span class=n>SharedPtr</span><span class=o>&amp;</span> <span class=n>other</span><span class=p>)</span> <span class=o>:</span> <span class=n>control_block</span><span class=p>(</span><span class=n>other</span><span class=p>.</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>++</span><span class=n>control_block</span><span class=o>-&gt;</span><span class=n>strong_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SharedPtr</span><span class=p>(</span><span class=k>const</span> <span class=n>WeakPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&amp;</span> <span class=n>weak_ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>SharedPtr</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>release</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>T</span><span class=o>*</span> <span class=k>operator</span><span class=o>-&gt;</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>control_block</span><span class=o>-&gt;</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>T</span><span class=o>&amp;</span> <span class=k>operator</span><span class=o>*</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>*</span><span class=p>(</span><span class=n>control_block</span><span class=o>-&gt;</span><span class=n>ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SharedPtr</span><span class=o>&amp;</span> <span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>SharedPtr</span><span class=o>&amp;</span> <span class=n>other</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>other</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>release</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>control_block</span> <span class=o>=</span> <span class=n>other</span><span class=p>.</span><span class=n>control_block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=o>++</span><span class=n>control_block</span><span class=o>-&gt;</span><span class=n>strong_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>size_t</span> <span class=n>use_count</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>control_block</span> <span class=o>?</span> <span class=n>control_block</span><span class=o>-&gt;</span><span class=n>strong_count</span><span class=p>.</span><span class=n>load</span><span class=p>()</span> <span class=o>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=n>release</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>--</span><span class=n>control_block</span><span class=o>-&gt;</span><span class=n>strong_count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>delete</span> <span class=n>control_block</span><span class=o>-&gt;</span><span class=n>ptr</span><span class=p>;</span> <span class=c1>// 仅删除对象
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>control_block</span><span class=o>-&gt;</span><span class=n>ptr</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span> <span class=c1>// 避免悬挂指针
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                <span class=c1>// 如果所有的 weak_ptr 也都不存在了，才删除控制块
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=n>control_block</span><span class=o>-&gt;</span><span class=n>weak_count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>delete</span> <span class=n>control_block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ControlBlock</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;*</span> <span class=n>control_block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=k>class</span> <span class=nc>WeakPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WeakPtr</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>WeakPtr</span><span class=p>()</span> <span class=o>:</span> <span class=n>control_block</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>WeakPtr</span><span class=p>(</span><span class=k>const</span> <span class=n>SharedPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&amp;</span> <span class=n>shared_ptr</span><span class=p>)</span> <span class=o>:</span> <span class=n>control_block</span><span class=p>(</span><span class=n>shared_ptr</span><span class=p>.</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>++</span><span class=n>control_block</span><span class=o>-&gt;</span><span class=n>weak_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>WeakPtr</span><span class=p>(</span><span class=k>const</span> <span class=n>WeakPtr</span><span class=o>&amp;</span> <span class=n>other</span><span class=p>)</span> <span class=o>:</span> <span class=n>control_block</span><span class=p>(</span><span class=n>other</span><span class=p>.</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>++</span><span class=n>control_block</span><span class=o>-&gt;</span><span class=n>weak_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>WeakPtr</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>release</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SharedPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>lock</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>control_block</span> <span class=o>&amp;&amp;</span> <span class=n>control_block</span><span class=o>-&gt;</span><span class=n>strong_count</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>SharedPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=o>*</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>SharedPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>WeakPtr</span><span class=o>&amp;</span> <span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>WeakPtr</span><span class=o>&amp;</span> <span class=n>other</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>other</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>release</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>control_block</span> <span class=o>=</span> <span class=n>other</span><span class=p>.</span><span class=n>control_block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=o>++</span><span class=n>control_block</span><span class=o>-&gt;</span><span class=n>weak_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=n>release</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>--</span><span class=n>control_block</span><span class=o>-&gt;</span><span class=n>weak_count</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>control_block</span><span class=o>-&gt;</span><span class=n>strong_count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>delete</span> <span class=n>control_block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ControlBlock</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;*</span> <span class=n>control_block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=k>class</span> <span class=nc>SharedPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>SharedPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>SharedPtr</span><span class=p>(</span><span class=k>const</span> <span class=n>WeakPtr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&amp;</span> <span class=n>weak_ptr</span><span class=p>)</span> <span class=o>:</span> <span class=n>control_block</span><span class=p>(</span><span class=n>weak_ptr</span><span class=p>.</span><span class=n>control_block</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>control_block</span> <span class=o>&amp;&amp;</span> <span class=n>control_block</span><span class=o>-&gt;</span><span class=n>strong_count</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>++</span><span class=n>control_block</span><span class=o>-&gt;</span><span class=n>strong_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>control_block</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=o>:</span> <span class=k>public</span> <span class=n>enable_shared_from_this</span><span class=o>&lt;</span><span class=n>Test</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=n>show</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Test::show() called&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SharedPtr</span><span class=o>&lt;</span><span class=n>Test</span><span class=o>&gt;</span> <span class=n>sp1</span><span class=p>(</span><span class=k>new</span> <span class=n>Test</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;sp1 use count: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>sp1</span><span class=p>.</span><span class=n>use_count</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>SharedPtr</span><span class=o>&lt;</span><span class=n>Test</span><span class=o>&gt;</span> <span class=n>sp2</span> <span class=o>=</span> <span class=n>sp1</span><span class=o>-&gt;</span><span class=n>shared_from_this</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;sp1 use count after shared_from_this: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>sp1</span><span class=p>.</span><span class=n>use_count</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span> <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>sp1</span><span class=o>-&gt;</span><span class=n>show</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>sp2</span><span class=o>-&gt;</span><span class=n>show</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li><p>在C++11实现信号量</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>//C++11 信号量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;mutex&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;condition_variable&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Semaphore</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Semaphore</span><span class=p>(</span><span class=kt>int</span> <span class=n>count_</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>:</span> <span class=n>count</span><span class=p>(</span><span class=n>count_</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>Signal</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span> <span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>++</span><span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=p>.</span><span class=n>notify_one</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>Wait</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span> <span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span><span class=p>(</span><span class=n>count</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cv</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>--</span><span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>mutex</span> <span class=n>mtx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>condition_variable</span> <span class=n>cv</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><ul><li><p>给你一个类：</p><pre tabindex=0><code>public class Foo {
  public void first() { print(&#34;first&#34;); }
  public void second() { print(&#34;second&#34;); }
  public void third() { print(&#34;third&#34;); }
}
</code></pre><p>三个不同的线程 A、B、C 将会共用一个 <code>Foo</code> 实例。</p><ul><li>线程 A 将会调用 <code>first()</code> 方法</li><li>线程 B 将会调用 <code>second()</code> 方法</li><li>线程 C 将会调用 <code>third()</code> 方法</li></ul><p>请设计修改程序，以确保 <code>second()</code> 方法在 <code>first()</code> 方法之后被执行，<code>third()</code> 方法在 <code>second()</code> 方法之后被执行。这个题目也可以看为“三个线程，交替打印x,y,z请问如何实现”的简单版本</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 两种解法，一种是利用条件变量，另一种利用信号量
</span></span></span><span class=line><span class=cl><span class=c1>// 解法1 利用条件变量的做法,这里的打印是循环打印
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Foo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>mutex</span> <span class=n>mtx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>condition_variable</span> <span class=n>cv</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>first</span><span class=p>(</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span> <span class=n>printFirst</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>mutex</span><span class=o>&gt;</span> <span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>cv</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>,</span> <span class=p>[</span><span class=k>this</span><span class=p>](){</span><span class=k>return</span> <span class=n>k</span> <span class=o>==</span> <span class=mi>0</span><span class=p>;});</span>
</span></span><span class=line><span class=cl>      <span class=n>printFirst</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>k</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>cv</span><span class=p>.</span><span class=n>notify_all</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>second</span><span class=p>(</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span> <span class=n>printSecond</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>mutex</span><span class=o>&gt;</span> <span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>,</span> <span class=p>[</span><span class=k>this</span><span class=p>](){</span><span class=k>return</span> <span class=n>k</span> <span class=o>==</span> <span class=mi>1</span><span class=p>;});</span>
</span></span><span class=line><span class=cl>        <span class=n>printSecond</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span> <span class=o>=</span> <span class=mi>2</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=p>.</span><span class=n>notify_all</span><span class=p>();</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>third</span><span class=p>(</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span> <span class=n>printThird</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>mutex</span><span class=o>&gt;</span> <span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>,</span> <span class=p>[</span><span class=k>this</span><span class=p>](){</span><span class=k>return</span> <span class=n>k</span> <span class=o>==</span> <span class=mi>2</span><span class=p>;});</span>
</span></span><span class=line><span class=cl>        <span class=n>printThird</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=p>.</span><span class=n>notify_all</span><span class=p>();</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// printThird() outputs &#34;third&#34;. Do not change or remove this line.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//这里cv wait的后面的条件可以参考
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>_Predicate</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>wait</span><span class=p>(</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>mutex</span><span class=o>&gt;&amp;</span> <span class=n>__lock</span><span class=p>,</span> <span class=n>_Predicate</span> <span class=n>__p</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>__p</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>wait</span><span class=p>(</span><span class=n>__lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//解法2 信号量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Foo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sem_t</span> <span class=n>sem_1</span><span class=p>,</span> <span class=n>sem_2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sem_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sem_1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span> <span class=n>sem_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sem_2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>first</span><span class=p>(</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span> <span class=n>printFirst</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printFirst</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sem_1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>second</span><span class=p>(</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span> <span class=n>printSecond</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sem_1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printSecond</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sem_2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>third</span><span class=p>(</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span> <span class=n>printThird</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sem_2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printThird</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><ul><li><p>Dining Philosophers Problem: 吃饭的哲学家问题是一个经典的并发问题和同步问题，介绍在五个哲学家坐在一张圆桌前，每两位哲学家之间放有一只餐叉。哲学家的生活形式固定，即「思考」和「进餐」的两种形式交替出现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 解法1：最简单或者说最愚蠢的解法，每次只让一个哲学家吃到饭
</span></span></span><span class=line><span class=cl><span class=c1>// 解法2: 限定同时吃饭的哲学家，让四个哲学家吃饭，那么根据抽屉原理，必然会有一个哲学家吃到饭
</span></span></span><span class=line><span class=cl><span class=c1>// 解法3: 奇偶侧拿不同的叉子
</span></span></span><span class=line><span class=cl><span class=c1>// 解法4: 限制哲学家必须同时拿起左右两个筷子
</span></span></span><span class=line><span class=cl><span class=c1>// 解法5: 引入服务员的概念，让服务员来确定哪个哲学家可以吃饭，但是这引入了第三方
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 解法1对应的方法，非常简单
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;mutex&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;array&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;thread&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DiningPhilosophers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=n>terminate</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>std</span><span class=o>::</span><span class=kr>thread</span> <span class=n>philosophers</span><span class=p>[</span><span class=n>kNumPhilosophers</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>std</span><span class=o>::</span><span class=n>mutex</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=k>const</span> <span class=kt>int</span> <span class=n>kNumPhilosophers</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=k>const</span> <span class=kt>int</span> <span class=n>kNumForks</span> <span class=o>=</span> <span class=n>kNumPhilosophers</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=n>Eat</span><span class=p>(</span><span class=kt>int</span> <span class=n>philosopher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span> <span class=n>lk</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>((</span><span class=s>&#34;Philosopher &#34;</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>philosopher</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34; starts eating.&#34;</span><span class=p>).</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>500</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>((</span><span class=s>&#34;Philosopher &#34;</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>philosopher</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34; ends eating.&#34;</span><span class=p>).</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 解法2，限定哲学家吃饭的数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>DiningPhilosophers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=n>terminate</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>mutext</span> <span class=n>lock</span><span class=p>[</span><span class=n>kNumForks</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=c1>//上面题目的信号量，初始化的时候需要初始化count为4
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Semaphore</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=k>const</span> <span class=kt>int</span> <span class=n>kNumPhilosophers</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=k>const</span> <span class=kt>int</span> <span class=n>kNumForks</span> <span class=o>=</span> <span class=n>kNumPhilosophers</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=n>Eat</span><span class=p>(</span><span class=kt>int</span> <span class=n>philosopher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span> <span class=n>lk</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>left_fork</span> <span class=o>=</span> <span class=n>philosopher</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>right_fork</span> <span class=o>=</span> <span class=p>(</span><span class=n>philosopher</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>%</span><span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=p>.</span><span class=n>Wait</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>lock</span><span class=p>[</span><span class=n>left_fork</span><span class=p>].</span><span class=n>lock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>lock</span><span class=p>[</span><span class=n>right_fork</span><span class=p>].</span><span class=n>lock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>((</span><span class=s>&#34;Philosopher &#34;</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>philosopher</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34; starts eating.&#34;</span><span class=p>).</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>500</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>((</span><span class=s>&#34;Philosopher &#34;</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>philosopher</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34; ends eating.&#34;</span><span class=p>).</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>lock</span><span class=p>[</span><span class=n>right_fork</span><span class=p>].</span><span class=n>lock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>lock</span><span class=p>[</span><span class=n>left_fork</span><span class=p>].</span><span class=n>lock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=p>.</span><span class=n>Signal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div></li><li><p>Producer-Consumer Problem: 制造者消费者问题是一个设置在共享固定大小缓冤断言的同步问题。理想情况于两个流程，一个消费者和一个生产者在同一时间里应用一堆存有项目的缓存。</p></li><li><p>Readers-Writers Problem: 读者写者问题是一个并发问题，这个问题考察了当并发进程试图访问同一共享资源时，基于读者优先和写者优先的策略的限制。</p></li><li><p>Sleeping Barber Problem: 睡眠理发师问题是一个经典的进程同步问题。该问题假设有一个理发师、一个理发椅和一些椅子供等待的顾客。如果没有客户，那么理发师就在理发椅上睡觉。当顾客到来时，他们需要唤醒理发师进行理发。如果所有椅子都被占用，那么进来的顾客就会离开。</p></li><li><p>Cigarette Smokers Problem: 烟瘾者问题是一个同步问题。假设有三个烟瘾者，每个人都有无尽的某种烟草配料（纸，烟草，火柴）。然后有一个代理人，他随机把两个配料放在桌上。正好的烟草配料 ont able的烟瘾者能做一支烟，然后要求代理人放下下一组配料。</p></li><li></li><li><p>给你一个类：</p><pre tabindex=0><code>class FooBar {
  public void foo() {
    for (int i = 0; i &lt; n; i++) {
      print(&#34;foo&#34;);
    }
  }

  public void bar() {
    for (int i = 0; i &lt; n; i++) {
      print(&#34;bar&#34;);
    }
  }
}
</code></pre><p>两个不同的线程将会共用一个 <code>FooBar</code> 实例：</p><ul><li>线程 A 将会调用 <code>foo()</code> 方法，而</li><li>线程 B 将会调用 <code>bar()</code> 方法</li></ul><p>请设计修改程序，以确保 <code>"foobar"</code> 被输出 <code>n</code> 次。</p></li><li></li></ul><h3 class="relative group">5 面试题目收集<div id=5-%E9%9D%A2%E8%AF%95%E9%A2%98%E7%9B%AE%E6%94%B6%E9%9B%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5-%E9%9D%A2%E8%AF%95%E9%A2%98%E7%9B%AE%E6%94%B6%E9%9B%86 aria-label=锚点>#</a></span></h3><ul><li>为什么Linux要区分用户态和Kernel态</li><li>上下文切换的时候发生了什么事情？</li><li>一次系统调用会发生几次上下文切换</li><li>进程的内存结构是什么样子的</li></ul><p>+字节面试题目</p><p>介绍</p><p>dns的过程</p><p>tcp和udp的区别</p><p>tcp三次握手和四次挥手的过程</p><p>进程和线程的区别</p><p>C里面栈和堆的区别</p><h2 class="relative group">结尾<div id=%E7%BB%93%E5%B0%BE class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%BB%93%E5%B0%BE aria-label=锚点>#</a></span></h2><p>唉，尴尬</p><p><figure><img class="my-0 rounded-md" loading=lazy src=https://i.loli.net/2020/08/27/BFHNyfpx3EsIDUG.jpg alt=狗头的赞赏码.jpg></figure></p></div></div><script>var oid="views_posts\\2023-03-25-去tm的八股文\\index.md",oid_likes="likes_posts\\2023-03-25-去tm的八股文\\index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/2023-03-14-reverse4fun/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">2023-03-14-reverse4fun</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2023-03-14T00:00:00+00:00>2023 年 3 月 14 日</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/2023-03-25-folly%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">2023-03-25-folly学习笔记</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2023-03-25T00:00:00+00:00>2023 年 3 月 25 日</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">© 2025 - 2025 菜狗 All Rights Reserved.</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a> 强力驱动</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://hxndg.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>